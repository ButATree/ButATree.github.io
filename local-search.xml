<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Hexo-Fluid 部署GitHub日历云</title>
    <link href="/posts/3a87b2cd/"/>
    <url>/posts/3a87b2cd/</url>
    
    <content type="html"><![CDATA[<a class="btn" href="https://blog.csdn.net/u013854486/article/details/104777219/"  title="相关链接" target="_blank">链接</a><h1 id="GitHub日历云"><a href="#GitHub日历云" class="headerlink" title="GitHub日历云"></a>GitHub日历云</h1><ol><li>点击 <a class="btn" href="https://cdn.jsdelivr.net/gh/InfiniteYinux/cloud@2.44/Hexo/themeConfig/echarts.min.js 按钮"  target="_blank">echarts.min.js</a> 下载 <code>echarts.min.js</code> 文件方置于 <code>../fluid/source/js</code> 文件夹中。</li><li>点击 <a class="btn" href="https://cdn.jsdelivr.net/gh/InfiniteYinux/cloud@2.44/Hexo/themeConfig/post-calendar.ejs 按钮"  target="_blank">post-calendar.ejs</a> 下载 <code>post-calendar.ejs</code> 文件方置于 <code>../fluid/layout/_widget</code> 文件夹中。</li><li>打开刚刚下载的 <code>post-calendar.ejs</code> 文件，将第七行</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container archive-calendar&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;post-calendar&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;card-content&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;&lt;%- theme.jsDelivr.url %&gt;&lt;%- theme.libs.js.echarts %&gt;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="javascript">    <span class="hljs-keyword">let</span> myChart = echarts.init(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;post-calendar&#x27;</span>));</span><br><br></code></pre></td></tr></table></figure><h6>替换为:</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/echarts.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>点击 <a class="btn" href="https://cdn.jsdelivr.net/gh/InfiniteYinux/cloud@2.44/Hexo/themeConfig/matery.css 按钮"  target="_blank">matery.css</a> 下载 <code>matery.css</code> 文件方置于 <code>../fluid/source/css</code> 文件夹中，然后在 <code>../fluid/layout/_partial/head.ejs</code> 中引入css文件，在<code>&lt;!-- link --&gt;</code>标记下方添加一行</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;link <span class="hljs-attribute">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attribute">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attribute">href</span>=<span class="hljs-string">&quot;/css/matery.css&quot;</span>&gt;<br></code></pre></td></tr></table></figure><p>之后你想让它显示的位置添加下面的代码就行了，我是放在 <code>../fluid/layout/archive.ejs</code>中。</p><h6>代码如下:</h6><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">&lt;<span class="hljs-meta">%</span>- partial<span class="hljs-comment">(&#x27;_widget/post-calendar&#x27;)</span> <span class="hljs-meta">%</span>&gt;<br></code></pre></td></tr></table></figure><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xl">&lt;%<br><span class="hljs-built_in">page</span>.layout = <span class="hljs-string">&quot;archive&quot;</span><br><span class="hljs-built_in">page</span>.<span class="hljs-built_in">title</span> = <span class="hljs-built_in">theme</span>.archive.<span class="hljs-built_in">title</span> || __(<span class="hljs-string">&#x27;archive.title&#x27;</span>)<br><span class="hljs-built_in">page</span>.<span class="hljs-built_in">subtitle</span> = <span class="hljs-built_in">theme</span>.archive.<span class="hljs-built_in">subtitle</span> || __(<span class="hljs-string">&#x27;archive.subtitle&#x27;</span>)<br><span class="hljs-built_in">page</span>.banner_img = <span class="hljs-built_in">theme</span>.archive.banner_img<br><span class="hljs-built_in">page</span>.banner_img_height = <span class="hljs-built_in">theme</span>.archive.banner_img_height<br><span class="hljs-built_in">page</span>.banner_mask_alpha = <span class="hljs-built_in">theme</span>.archive.banner_mask_alpha<br>%&gt;<br>&lt;%- partial(<span class="hljs-string">&#x27;_widget/post-calendar&#x27;</span>) %&gt; # ←在这<br>&lt;%- partial(<span class="hljs-string">&#x27;_partial/archive-list.ejs&#x27;</span>, &#123; params: &#123; postTotal: site.posts.length &#125; &#125;) %&gt;<br></code></pre></td></tr></table></figure><h6>展示:</h6><p><img src="/img/blog_image/hexo/hexo_post.png" alt="1.0 Linux网络数据包的接收过程"></p>]]></content>
    
    
    <categories>
      
      <category>Hexo博客搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo中的ssh报错</title>
    <link href="/posts/a15e2685/"/>
    <url>/posts/a15e2685/</url>
    
    <content type="html"><![CDATA[<p>只需在 <code>_config.yml</code> 中的 <code>deploy</code> 中添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>   <span class="hljs-attr">repository:</span> <span class="hljs-string">ssh://root@IP:Port/你的hooks.git</span><br>   <span class="hljs-attr">branch:</span> <span class="hljs-string">master</span><br><br><span class="hljs-string">hexo</span> <span class="hljs-string">clean</span><br><span class="hljs-string">hexo</span> <span class="hljs-string">g</span><br><span class="hljs-string">hexo</span> <span class="hljs-string">d</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hexo博客搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shell-2-练习</title>
    <link href="/posts/3b79c98c/"/>
    <url>/posts/3b79c98c/</url>
    
    <content type="html"><![CDATA[<h6>1. 判断一个机器是否存活，能 ping 通就算存活</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;HostIP:&quot;</span> hp<br>ping -c 2 <span class="hljs-variable">$hp</span> &amp;&gt;/dev/null<br><span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$hp</span> 是否存活: 是&quot;</span><br>   <span class="hljs-keyword">else</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$hp</span> 是否存活: 否 &quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h6>2. 判断服务器上的某个服务是否开启</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#检查服务状态，是否安装</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入要检测的服务：&quot;</span> SERVICE<br>netstat -anp | grep <span class="hljs-variable">$SERVICE</span> &amp;&gt; /dev/null<br><span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$SERVICE</span>服务已经启动！&quot;</span><br><span class="hljs-keyword">else</span><br>  rpm -q <span class="hljs-variable">$SERVICE</span> &amp;&gt; /dev/null<br> <br>  <span class="hljs-keyword">if</span> [ $? -eq 0 ]<br>  <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$SERVICE</span>服务已安装，正在启动....&quot;</span><br>      service  <span class="hljs-variable">$SERVICE</span>  start<br>  <span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;该服务未安装！&quot;</span><br> <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h6>3. 写一个Nginx安装脚本，加入判断，当上一步执行成功在执行下一步，否则退出脚本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>ping -W1 -c1 www.baidu.com &amp;&gt;/dev/null<br><span class="hljs-keyword">if</span> [ $? -ne 0 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;网络存在故障....&quot;</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">#2.源  记得要判断系统</span><br><span class="hljs-keyword">if</span> [ -f /etc/yum.repos.d/epel.repo ];<span class="hljs-keyword">then</span><br><span class="hljs-keyword">if</span> [ -s /etc/yum.repos.d/epel.repo ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;yum repos skip ....&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;epel 为空  wget ...&quot;</span><br><span class="hljs-comment">#wget .... </span><br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;epel文件不存在&quot;</span><br><span class="hljs-comment">#wget .......</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">#3.安装</span><br>rpm -q nginx &amp;&gt;/dev/null<br>rc=$?<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$rc</span> -eq 0 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;nginx已安装&quot;</span><br><span class="hljs-keyword">else</span><br>yum install nginx -y <br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h6>4. for 死循环 使用((;;))条件可以实现</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">for</span> ((;;))<br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h6>5. 脚本休眠N秒</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;倒计时: &quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `seq 9 -1 1`<br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">echo</span> -n -e <span class="hljs-string">&quot;\b<span class="hljs-variable">$i</span>&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h6>6 .手动写一个同步拉脚本，要求 B 机器每隔 10 分钟把A机器的 /opt/cache/ 下的内容拉取到 B 机器的 /opt/cache，并做完整性验证</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">方法一：<br>crontab -e<br><span class="hljs-number">10</span> * * * * sh <span class="hljs-regexp">/root/</span>sh<span class="hljs-regexp">/2021-03-11/g</span>et_cache.sh <br><span class="hljs-comment">#vi /root/sh/2021-03-11/get_cache.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>scp <span class="hljs-number">10.4</span>.<span class="hljs-number">7.101</span>:<span class="hljs-regexp">/opt/</span>cache<span class="hljs-regexp">/* /</span>opt<span class="hljs-regexp">/cache/</span><br></code></pre></td></tr></table></figure><h6>7. 新建 user01-user20 用户，要求密码是随机 6 位数 密码取值范围 a-zA-Z0-9，要求密码不能只是单一的数字或小写或大写字母</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> ((i=1;i&lt;=20;i++))<br>    <span class="hljs-keyword">do</span><br>        useradd <span class="hljs-string">&quot;user<span class="hljs-variable">$i</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;user<span class="hljs-variable">$i</span>&quot;</span> &gt;&gt; user.txt<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;`date +%s%N|md5sum|head -c 6`&quot;</span> &gt;&gt; user.txt<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;`tail -1 user.txt`&quot;</span> | passwd --stdin user<span class="hljs-variable">$i</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h6>8. 写一个猜数字脚本，数字范围是1-100，定制计数器，每次猜完都要告诉用户猜大或猜小了，如果猜对了跳出脚本并输出计数器的值</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">num=$[RANDOM%100]<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;猜测1-100的数字&quot;</span><br><span class="hljs-keyword">while</span> :<br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;所要猜的数字是:&quot;</span> g<br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$num</span> -eq <span class="hljs-variable">$g</span> ];<span class="hljs-keyword">then</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;猜对了&quot;</span><br>       <span class="hljs-built_in">break</span><br>    <span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$num</span> -gt <span class="hljs-variable">$g</span> ];<span class="hljs-keyword">then</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;猜小了&quot;</span><br>    <span class="hljs-keyword">else</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;猜大了&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h6>9. 99乘法表</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">方法一：<br><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">for</span> ((i=1;i&lt;=9;i++))<br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">for</span> ((j=1;j&lt;=9;j++))<br><span class="hljs-keyword">do</span><br><span class="hljs-keyword">if</span> [[ i -ge j ]];<span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$i</span>*<span class="hljs-variable">$j</span>=$[i*j] &quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; &quot;</span><br><span class="hljs-keyword">done</span><br><br>方法二：<br><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">for</span> ((i=1;i&lt;=9;i++))<br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">for</span> ((j=1;j&lt;=i;j++))<br>            <span class="hljs-keyword">do</span><br>                <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$j</span>*<span class="hljs-variable">$i</span>=$[<span class="hljs-variable">$i</span>*<span class="hljs-variable">$j</span>]&quot;</span><br>                <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$j</span> == <span class="hljs-variable">$i</span> ]];<span class="hljs-keyword">then</span><br>                    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n&quot;</span><br>                <span class="hljs-keyword">fi</span><br>        <span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h6>10. 写一个mysql分库备份脚本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>myuser=root<br>mypasswd=123456<br>mycmd=<span class="hljs-string">&quot;mysqldump -u<span class="hljs-variable">$myuser</span> -p<span class="hljs-variable">$mypasswd</span>&quot;</span><br><span class="hljs-keyword">for</span> dname <span class="hljs-keyword">in</span> `mysql -uroot -p123456 -e <span class="hljs-string">&quot;show databases;&quot;</span>| sed 1d | egrep -v <span class="hljs-string">&quot;schema|test|mysql&quot;</span>`<br><span class="hljs-keyword">do</span><br><span class="hljs-variable">$mycmd</span> --databases <span class="hljs-variable">$dname</span> &gt;/opt/<span class="hljs-variable">$&#123;dname&#125;</span>_`date +%F`.sql<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux-VSFTP部署</title>
    <link href="/posts/4801bbb8/"/>
    <url>/posts/4801bbb8/</url>
    
    <content type="html"><![CDATA[<blockquote><p><strong>闲话少说直接开整</strong>。</p></blockquote><h1 id="一、部署匿名-FTP-服务"><a href="#一、部署匿名-FTP-服务" class="headerlink" title="一、部署匿名 FTP 服务"></a>一、部署匿名 <code>FTP</code> 服务</h1><h2 id="1）-安装-FTP-服务"><a href="#1）-安装-FTP-服务" class="headerlink" title="1） 安装 FTP 服务"></a>1） 安装 <code>FTP</code> 服务</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># yum -y install vsftpd</span><br></code></pre></td></tr></table></figure><h2 id="2）进入配置文件中"><a href="#2）进入配置文件中" class="headerlink" title="2）进入配置文件中"></a>2）进入配置文件中</h2><h3 id="2-1-vsftpd-服务的配置删除"><a href="#2-1-vsftpd-服务的配置删除" class="headerlink" title="2.1 vsftpd 服务的配置删除"></a>2.1 <code>vsftpd</code> 服务的配置删除</h3><ul><li>默认发布目录： <code>/var/ftp</code></li><li>协议接口： <code>21/tcp</code></li><li>服务配置文件： <code>/etc/vsftpd/vsftpd.conf</code></li><li>报错 <code>id</code> 的解析：<ul><li><code>500</code> #文件系统权限过大</li><li><code>530</code> #用户认证失败</li><li><code>550</code> #服务本身功能未开放，服务本身的错误</li><li><code>553</code> #本地文件系统权限过小</li><li>默认登陆的用户是 <code>ftp</code></li><li>默认登陆的目录是 <code>/var/ftp</code></li></ul></li></ul><p><code>vsftpd</code> 服务的配置参数: <code>man 5 vsftpd.conf</code> 可以查看具体参数</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs routeros">匿名用户：<br><span class="hljs-attribute">anonymous_enable</span>=<span class="hljs-literal">YES</span>|NO #匿名用户登录 <br>    <span class="hljs-attribute">anon_root</span>=/direcotry #匿名用户家目录修改<br><span class="hljs-attribute">anon_upload_enable</span>=<span class="hljs-literal">YES</span> #匿名用户上传<br><span class="hljs-attribute">anon_mkdir_write_enable</span>=<span class="hljs-literal">YES</span>|NO #匿名用户建立目录<br><span class="hljs-attribute">anon_world_readable_only</span>=<span class="hljs-literal">NO</span> #匿名用户下载 <br><span class="hljs-attribute">anon_other_write_enable</span>=<span class="hljs-literal">YES</span> #匿名用户删除<br><span class="hljs-attribute">anon_max_rate</span>=需要设置的字节大小 #匿名用户最大传输速率，单位字节<br><span class="hljs-attribute">anon_umask</span>=022 #匿名用户上传文件权限<br><br>本地用户：<br><span class="hljs-attribute">local_enable</span>=<span class="hljs-literal">YES</span>|NO #本地用户登陆<br><span class="hljs-attribute">write_enable</span>=<span class="hljs-literal">YES</span>|NO #是否对登陆用户可写<br><span class="hljs-attribute">local_umask</span>=022 #本地用户上传文件权限<br><span class="hljs-attribute">userlist_enable</span>=<span class="hljs-literal">YES</span> #启用黑名单，名单文件为 user_list<br><span class="hljs-attribute">userlist_deny</span>=<span class="hljs-literal">YES</span> #拒绝 user_list 中的用户登录 【<span class="hljs-literal">NO</span> 运行 user_list 中用户登录】<br><br>限制本地用户浏览目录：<br><span class="hljs-attribute">chroot_local_user</span>=<span class="hljs-literal">YES</span> #所有用户被锁定到自己的家目录<br><br>用户黑名单建立（修改黑白名单不需要重启）<br><span class="hljs-attribute">chroot_local_user</span>=<span class="hljs-literal">NO</span><br><span class="hljs-attribute">chroot_list_enable</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attribute">chroot_list_file</span>=/etc/vsftpd/chroot_list<br><br>用户白名单建立<br><span class="hljs-attribute">chroot_local_user</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attribute">chroot_list_enable</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attribute">chroot_list_file</span>=/etc/vsftpd/chroot_list<br><br>限制本地用户登陆<br>/etc/vsftpd/ftpusers #永久黑名单，优先级高于一切<br>/etc/vsftpd/user_list #临时黑名单<br><br>用户白名单设定<br><span class="hljs-attribute">userlist_deny</span>=<span class="hljs-literal">NO</span> # /etc/vsftpd/user_list 文件改变成白名单，与黑名单 ftpusers 中相同的用户，按照黑名单对待<br></code></pre></td></tr></table></figure><h3 id="2-2-匿名用户配置"><a href="#2-2-匿名用户配置" class="headerlink" title="2.2 匿名用户配置"></a>2.2 匿名用户配置</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># vi /etc/vsftpd/vsftpd.conf</span><br> <span class="hljs-attr">anon_root=/directory</span>         <span class="hljs-comment">#匿名用户家目录设置</span><br> <span class="hljs-attr">anonymous_enable=YES</span>         <span class="hljs-comment">#是否允许匿名登录</span><br> <span class="hljs-attr">anon_upload_enable=YES</span>       <span class="hljs-comment">#是否允许匿名上传</span><br> <span class="hljs-attr">anon_umask=022</span>               <span class="hljs-comment">#umask值</span><br> <span class="hljs-attr">anon_other_write_enable=YES</span>  <span class="hljs-comment">#匿名用户删除</span><br> <span class="hljs-attr">anon_world_readable_only=YES</span> <span class="hljs-comment">#匿名用户下载</span><br><span class="hljs-comment"># chown -Rf ftp /var/ftp/pub</span><br><span class="hljs-comment"># chmod -Rf 775 /var/ftp/pub</span><br><span class="hljs-comment"># ll -d /var/ftp/pub/</span><br>drwxr-xr-x <span class="hljs-number">2</span> ftp root <span class="hljs-number">20</span> Mar <span class="hljs-number">10</span> <span class="hljs-number">16</span>:<span class="hljs-number">47</span> /var/ftp/pub/<br></code></pre></td></tr></table></figure><h5>测试：</h5><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># yum -y install lftp</span><br>[root<span class="hljs-variable">@a</span> ftp]<span class="hljs-comment"># lftp 10.4.7.100 -u ftp</span><br><span class="hljs-symbol">Password:</span> <br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:~&gt;</span> ls          <br>drwxr-xr-x    <span class="hljs-number">2</span> <span class="hljs-number">14</span>       0               <span class="hljs-number">6</span> Mar <span class="hljs-number">10</span> 08<span class="hljs-symbol">:</span><span class="hljs-number">14</span> pub<br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/&gt;</span> cd pub/<br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> ls<br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> mkdir a<br>mkdir ok, `a<span class="hljs-string">&#x27; created</span><br><span class="hljs-string">lftp ftp@10.4.7.100:/pub&gt; ls</span><br><span class="hljs-string">drwxr-xr-x    2 14       50              6 Mar 10 08:24 a</span><br><span class="hljs-string">lftp ftp@10.4.7.100:/pub&gt; rm -fr a/</span><br><span class="hljs-string">rm ok, `a/&#x27;</span> removed<br></code></pre></td></tr></table></figure><h4 id="1-匿名用户家目录修改"><a href="#1-匿名用户家目录修改" class="headerlink" title="1. 匿名用户家目录修改"></a>1. 匿名用户家目录修改</h4><blockquote><p><code>anon_root=/directory</code></p></blockquote><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># mkdir /directory</span><br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># touch /directory/a</span><br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># vi /etc/vsftpd/vsftpd.conf</span><br>anon_root=/directory<br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># systemctl restart vsftpd</span><br><span class="hljs-comment">#客户端</span><br>[root<span class="hljs-meta">@a</span> ftp]<span class="hljs-comment"># lftp 10.4.7.100 -u ftp</span><br>Password: <br>lftp ftp<span class="hljs-meta">@10.4.7.100:~&gt;</span> ls          <br>-rw-r--r--    1 0        0               0 Mar 10 08:27 a<br></code></pre></td></tr></table></figure><h4 id="2-匿名用户的上传-前提是本地用户可写"><a href="#2-匿名用户的上传-前提是本地用户可写" class="headerlink" title="2. 匿名用户的上传 前提是本地用户可写"></a>2. 匿名用户的上传 前提是本地用户可写</h4><blockquote><p><code>anon_upload_enable=YES|NO</code></p></blockquote><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># anon_upload_enable=YES</span><br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> put /etc/passwd<br><span class="hljs-number">1208</span> bytes transferred    <br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> ls<br>-rw-r--r--    <span class="hljs-number">1</span> <span class="hljs-number">14</span>       <span class="hljs-number">50</span>           <span class="hljs-number">1208</span> Mar <span class="hljs-number">10</span> 08<span class="hljs-symbol">:</span><span class="hljs-number">47</span> passwd<br></code></pre></td></tr></table></figure><h4 id="3-匿名用户建立目录"><a href="#3-匿名用户建立目录" class="headerlink" title="3. 匿名用户建立目录"></a>3. 匿名用户建立目录</h4><blockquote><p><code>anon_mkdir_write_enable=YES</code></p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-comment"># anon_mkdir_write_enable=YES</span><br>lftp ftp@10.4.7.100:/pub&gt; mkdir haha<br>mkdir ok, `haha&#x27; created<br>lftp ftp@10.4.7.100:/pub&gt; ls<br>drwxr-xr-x   <span class="hljs-number"> 2 </span>14      <span class="hljs-number"> 50 </span>            <span class="hljs-number"> 6 </span>Mar<span class="hljs-number"> 10 </span>08:49 haha<br>-rw-r--r--   <span class="hljs-number"> 1 </span>14      <span class="hljs-number"> 50 </span>         <span class="hljs-number"> 1208 </span>Mar<span class="hljs-number"> 10 </span>08:47 passwd<br></code></pre></td></tr></table></figure><h4 id="4-匿名用户下载"><a href="#4-匿名用户下载" class="headerlink" title="4. 匿名用户下载"></a>4. 匿名用户下载</h4><blockquote><p><code>anon_world_readable_only=YES</code></p></blockquote><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># anon_world_readable_only=YES</span><br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> ls<br>drwxr-xr-x    <span class="hljs-number">2</span> <span class="hljs-number">14</span>       <span class="hljs-number">50</span>              <span class="hljs-number">6</span> Mar <span class="hljs-number">10</span> 08<span class="hljs-symbol">:</span><span class="hljs-number">49</span> haha<br>-rw-r--r--    <span class="hljs-number">1</span> <span class="hljs-number">14</span>       <span class="hljs-number">50</span>           <span class="hljs-number">1208</span> Mar <span class="hljs-number">10</span> 08<span class="hljs-symbol">:</span><span class="hljs-number">47</span> passwd<br>lftp ftp<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/pub&gt;</span> get passwd <br><span class="hljs-number">1208</span> bytes transferred <br></code></pre></td></tr></table></figure><h4 id="5-匿名用户删除"><a href="#5-匿名用户删除" class="headerlink" title="5. 匿名用户删除"></a>5. 匿名用户删除</h4><blockquote><p><code>anon_other_write_enable=YES</code></p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-comment"># anon_other_write_enable=YES</span><br>lftp ftp@10.4.7.100:/pub&gt; ls<br>drwxr-xr-x   <span class="hljs-number"> 2 </span>14      <span class="hljs-number"> 50 </span>            <span class="hljs-number"> 6 </span>Mar<span class="hljs-number"> 10 </span>08:49 haha<br>-rw-r--r--   <span class="hljs-number"> 1 </span>14      <span class="hljs-number"> 50 </span>         <span class="hljs-number"> 1208 </span>Mar<span class="hljs-number"> 10 </span>08:47 passwd<br>lftp ftp@10.4.7.100:/pub&gt; rm passwd <br>rm ok, `passwd&#x27; removed<br>lftp ftp@10.4.7.100:/pub&gt; ls<br>drwxr-xr-x   <span class="hljs-number"> 2 </span>14      <span class="hljs-number"> 50 </span>            <span class="hljs-number"> 6 </span>Mar<span class="hljs-number"> 10 </span>08:49 haha<br></code></pre></td></tr></table></figure><h4 id="6-服务最大连接数"><a href="#6-服务最大连接数" class="headerlink" title="6. 服务最大连接数"></a>6. 服务最大连接数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> max_clients=2 <span class="hljs-comment">##服务的最大连接数</span></span><br></code></pre></td></tr></table></figure><h1 id="二、本地用户登录"><a href="#二、本地用户登录" class="headerlink" title="二、本地用户登录"></a>二、本地用户登录</h1><blockquote><p>设置白名单</p></blockquote><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># vi vsftpd.conf</span><br>anonymous_enable=NO <span class="hljs-comment">#拒绝匿名登录</span><br>local_enable=YES    <span class="hljs-comment">#开启本地登录</span><br>write_enable=YES    <span class="hljs-comment">#登录用户可写</span><br>local_umask=022     <span class="hljs-comment">#本地登录umask</span><br>userlist_enable=YES <span class="hljs-comment">#设置黑名单</span><br>userlist_deny=NO    <span class="hljs-comment">#设置白名单</span><br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># useradd lisi </span><br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># passwd lisi</span><br>[root<span class="hljs-meta">@a</span> vsftpd]<span class="hljs-comment"># tail -1 user_list </span><br>lisi<br>[root<span class="hljs-meta">@a</span> ftp]<span class="hljs-comment"># lftp 10.4.7.100 -u lisi</span><br>Password:    <br>lftp lisi<span class="hljs-meta">@10.4.7.100:~&gt;</span> mkdir a<br>mkdir ok, `a&#x27; created<br>lftp lisi<span class="hljs-meta">@10.4.7.100:~&gt;</span> ls<br>drwxr-xr-x    2 1002     1002            6 Mar 10 09:14 a<br>[root<span class="hljs-meta">@a</span> lisi]<span class="hljs-comment"># ll</span><br>drwxr-xr-x 2 lisi lisi 6 Mar 10 17:14 <br></code></pre></td></tr></table></figure><h1 id="三、虚拟用户模式"><a href="#三、虚拟用户模式" class="headerlink" title="三、虚拟用户模式"></a>三、虚拟用户模式</h1><p>​    虚拟用户模式是指登录 <code>FTP</code> 服务器的用户并不是操作系统中的账号，只是用于访问 <code>FTP</code> 服务器的存在于 <code>FTP</code> 服务器的账号。</p><p>配置步骤：</p><ul><li>建立虚拟 <code>FTP</code> 用户数据库文件。</li><li>创建 <code>FTP</code> 根目录及虚拟用户映射的系统用户。</li><li>建立支持虚拟用户的 <code>PAM</code> 认证文件。</li><li>在 <code>vsftpd.conf</code> 文件中添加支持配置。</li><li>为虚拟用户设置不同的权限。</li><li>重启 <code>vsftpd</code> 服务，验证试验效果。</li></ul><h2 id="1）建立虚拟-FTP-用户数据库文件"><a href="#1）建立虚拟-FTP-用户数据库文件" class="headerlink" title="1）建立虚拟 FTP 用户数据库文件"></a>1）建立虚拟 <code>FTP</code> 用户数据库文件</h2><blockquote><p>建立虚拟 <code>FTP</code> 用户数据库文件，其中奇数行为账号名，偶数行为密码。</p><p>新建两个账号 <code>zhangsan</code> 、<code>lisi</code>，密码都是 <code>123456</code>。</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@a</span> vsftpd]<span class="hljs-meta"># cat login.txt </span><br>zhangsan<br><span class="hljs-number">123456</span><br>lisi<br><span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><p>对 <code>login.txt</code> 文件进行哈希加密生成数据库文件。</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@a</span> vsftpd]<span class="hljs-meta"># db_load -T -t hash -f login.txt login.db</span><br>[root<span class="hljs-symbol">@a</span> vsftpd]<span class="hljs-meta"># chmod 600 login.db</span><br>[root<span class="hljs-symbol">@a</span> vsftpd]<span class="hljs-meta"># rm -rf login.txt</span><br></code></pre></td></tr></table></figure><h2 id="2）创建-vsftpd-服务程序系统本地用户"><a href="#2）创建-vsftpd-服务程序系统本地用户" class="headerlink" title="2）创建 vsftpd 服务程序系统本地用户"></a>2）创建 <code>vsftpd</code> 服务程序系统本地用户</h2><blockquote><p>创建 <code>vsftpd</code> 服务程序用于存储文件的根目录以及虚拟用户映射的系统本地用户</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@a vsftpd]# useradd -d <span class="hljs-regexp">/var/</span>vftp -s <span class="hljs-regexp">/sbin/</span>nologin vftp<br></code></pre></td></tr></table></figure><h2 id="3）设定策略文件"><a href="#3）设定策略文件" class="headerlink" title="3）设定策略文件"></a>3）设定策略文件</h2><blockquote><p>进入 <code>/etc/pam.d/</code> 新建文件 <code>vmusersfile</code>（名字任意）写入 <code>pam</code> 服务的配置，<code>pam</code> 就是一种认证服务</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@a vsftpd]<span class="hljs-comment"># cd /etc/pam.d/</span><br>[root@a pam.d]<span class="hljs-comment"># cat vftp </span><br>auth        required     pam_userdb.so     db=<span class="hljs-regexp">/etc/</span>vsftpd/login<br>account     required     pam_userdb.so     db=<span class="hljs-regexp">/etc/</span>vsftpd/login<br></code></pre></td></tr></table></figure><h2 id="4）修改配置"><a href="#4）修改配置" class="headerlink" title="4）修改配置"></a>4）修改配置</h2><blockquote><p>在 <code>vsftpd.conf</code> 中修改 <code>vstpd</code> 服务的配置</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">anonymous_enable</span>=<span class="hljs-literal">NO</span> <br><span class="hljs-attribute">local_enable</span>=<span class="hljs-literal">YES</span>    <br><span class="hljs-attribute">guest_enable</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attribute">guest_username</span>=vftp<br><span class="hljs-attribute">pam_service_name</span>=vftp.vu  #存放pam服务的策略文件<br><span class="hljs-attribute">allow_writeable_chroot</span>=<span class="hljs-literal">YES</span> #允许对禁锢的FTP根目录执行写入操作，而且不拒绝用户的登录请求<br><br><span class="hljs-comment"># 创建虚拟用户目录</span><br>mkdir /etc/vsftpd/vuser_dir<br><span class="hljs-attribute">user_config_dir</span>=/etc/vsftpd/vuser_dir<br></code></pre></td></tr></table></figure><h5>在指定的文件夹下创建虚拟用户配置文件：</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@a vuser_dir]<span class="hljs-comment"># ll</span><br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 0 </span>Mar<span class="hljs-number"> 10 </span>17:49 lisi<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 79 </span>Mar<span class="hljs-number"> 10 </span>17:50 zhangsan<br>[root@a vuser_dir]<span class="hljs-comment"># cat lisi </span><br>[root@a vuser_dir]<span class="hljs-comment"># cat zhangsan </span><br>anon_upload_enable=YES<br>anon_mkdir_write_enable=YES<br>anon_other_write_enable=YES<br></code></pre></td></tr></table></figure><h5>重启测试：</h5><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># systemctl restart vsftpd</span><br>[root<span class="hljs-variable">@c</span> ~]<span class="hljs-comment"># lftp 10.4.7.100 -u zhangsan</span><br><span class="hljs-symbol">Password:</span> <br>lftp zhangsan<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:~&gt;</span> ls     <br>lftp zhangsan<span class="hljs-variable">@10</span>.<span class="hljs-number">4.7</span>.<span class="hljs-number">100</span><span class="hljs-symbol">:/&gt;</span> mkdir a<br>mkdir ok, `a<span class="hljs-string">&#x27; created</span><br><span class="hljs-string">lftp zhangsan@10.4.7.100:/&gt; rm -r a</span><br><span class="hljs-string">rm ok, `a&#x27;</span> removed<br></code></pre></td></tr></table></figure><h5>虚拟用户配置解释：</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">listen</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]  <span class="hljs-comment">#是否以独立运行的方式监听服务</span><br><span class="hljs-attr">listen_address</span>=IP地址                 <span class="hljs-comment">#设置要监听的IP地址</span><br><span class="hljs-attr">listen_port</span>=<span class="hljs-number">21</span>                      <span class="hljs-comment">#设置FTP服务的监听端口</span><br><span class="hljs-attr">download_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]         <span class="hljs-comment">#是否允许下载文件</span><br><span class="hljs-attr">local_root</span>=/var/ftp/virtual/username  <span class="hljs-comment">#指定虚拟用户的具体主路径</span><br><span class="hljs-attr">anonymous_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]     <span class="hljs-comment">#是否允许匿名用户访问</span><br><span class="hljs-attr">write_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]     <span class="hljs-comment">#是否允许写操作</span><br><span class="hljs-attr">local_umask</span>=<span class="hljs-number">022</span>       <span class="hljs-comment">#设定上传文件权限掩码</span><br><span class="hljs-attr">userlist_enable</span>=<span class="hljs-literal">YES</span>                  <span class="hljs-comment">#启用“用户名单”，名单文件为user_list，在/etc/vsftpd下有两个名单，分别为ftpusers、user-list。ftpusers不受任何配制项的影响，总是有效，是一个黑名单。</span><br><span class="hljs-attr">userlist_deny</span>=<span class="hljs-literal">YES</span>                   <span class="hljs-comment">#拒绝user_list中用户登录【NO运行user_list中用户登录】</span><br><span class="hljs-attr">local_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]              <span class="hljs-comment">#是否允许本地用户登录FTP</span><br><span class="hljs-attr">anon_world_readable_only</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]     <span class="hljs-comment">#是否可以浏览ftp目录和下载文件</span><br><span class="hljs-attr">anon_upload_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]           <span class="hljs-comment">#是否允许用户上传</span><br><span class="hljs-attr">max_clients</span>=<span class="hljs-number">0</span>                      <span class="hljs-comment">#最大客户端连接数，0为不限制</span><br><span class="hljs-attr">max_per_ip</span>=<span class="hljs-number">0</span>                      <span class="hljs-comment">#同一IP地址的最大连接数，0为不限制</span><br><span class="hljs-attr">chroot_local_user</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]          <span class="hljs-comment">#是否将用户权限禁锢在FTP目录，以确保安全</span><br><span class="hljs-attr">anon_mkdir_write_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]      <span class="hljs-comment">#是否允许用户建立目录</span><br><span class="hljs-attr">anon_other_write_enable</span>=[<span class="hljs-literal">YES</span>|<span class="hljs-literal">NO</span>]      <span class="hljs-comment">#是否具有文件改名和删除文件的权限</span><br><span class="hljs-attr">idle_session_timeout</span>=<span class="hljs-number">600</span>              <span class="hljs-comment">#设定空闲连接超时时间</span><br><span class="hljs-attr">data_connection_timeout</span>=<span class="hljs-number">120</span>           <span class="hljs-comment">#设定单次连续传输最大时间</span><br><span class="hljs-attr">max_clients</span>=<span class="hljs-number">10</span>                        <span class="hljs-comment">#设定并发客户端访问个数</span><br><span class="hljs-attr">max_per_ip</span>=<span class="hljs-number">5</span>            <span class="hljs-comment">#设定单个客户端的最大线程数，这个配置主要来照顾Flashget、迅雷等多线程下载软件</span><br><span class="hljs-attr">local_max_rate</span>=<span class="hljs-number">0</span>        <span class="hljs-comment">#设定该用户的最大传输速率，单位（字节/秒），0为不限制</span><br></code></pre></td></tr></table></figure><p>这样就可以使用虚拟用户登录，但是登录的位置是 <code>virtual</code> 的家目录，由于 <code>vsftpd</code> 修改了安全策略，在登录到家目录的时候有很多限制，一般看不到文件，最好是将目录修改到其它地方。</p><p>我们这里将虚拟用户登录目录修改到其它地方，进入虚拟用户配置目录，修改虚拟用户配置文件：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@a vuser_dir]</span><span class="hljs-comment"># cat zhangsan </span><br><span class="hljs-attr">anon_upload_enable</span>=<span class="hljs-literal">YES</span>        <span class="hljs-comment">#zhangsan用户是否可以上传</span><br><span class="hljs-attr">anon_mkdir_write_enable</span>=<span class="hljs-literal">YES</span>   <span class="hljs-comment">#zhangsan用户是否可以创建目录</span><br><span class="hljs-attr">anon_other_write_enable</span>=<span class="hljs-literal">YES</span>   <span class="hljs-comment">#zhangsan用户能否更改文件名和删除文件的权限</span><br><span class="hljs-attr">anon_world_readable_only</span>=<span class="hljs-literal">YES</span>  <span class="hljs-comment">#zhangsan用户是否能够下载</span><br><span class="hljs-attr">local_root</span>=/ftp/lanzige       <span class="hljs-comment">#zhangsan用户家目录</span><br><span class="hljs-attr">allow_writeable_chroot</span>=<span class="hljs-literal">YES</span>     <span class="hljs-comment">#</span><br><br><span class="hljs-comment"># mkdir /ftp/lanzige</span><br><span class="hljs-comment"># chown -Rf vftp:vftp /ftp/lanzige/</span><br></code></pre></td></tr></table></figure><h5>测试：</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><span class="hljs-comment"># c.host.com</span><br>[root<span class="hljs-meta">@c</span> ~]<span class="hljs-comment"># lftp 10.4.7.100 -u zhangsan</span><br>Password: <br>lftp zhangsan<span class="hljs-meta">@10.4.7.100:~&gt;</span> mkdir c.host.com<br>mkdir ok, `c.host.com&#x27; created<br>lftp zhangsan<span class="hljs-meta">@10.4.7.100:/&gt;</span> ls<br>drwx------    2 1002     1002            6 Mar 10 11:42 c.host.com<br><br><span class="hljs-comment"># a.host.com</span><br>[root<span class="hljs-meta">@a</span> lanzige]<span class="hljs-comment"># pwd</span><br>/ftp/lanzige<br>[root<span class="hljs-meta">@a</span> lanzige]<span class="hljs-comment"># ls</span><br>c.host.com<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Vsftp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shell-1-练习</title>
    <link href="/posts/4bcddc4c/"/>
    <url>/posts/4bcddc4c/</url>
    
    <content type="html"><![CDATA[<h5>1. 创建 .sh 结尾文件时，自动添加注释信息</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@a ~]# <span class="hljs-keyword">cat</span> .vimrc <br><span class="hljs-keyword">set</span> ignorecase<br><span class="hljs-keyword">set</span> <span class="hljs-keyword">nu</span><br><span class="hljs-keyword">set</span> autoindent<br><span class="hljs-keyword">autocmd</span> BufNewFile *.<span class="hljs-keyword">sh</span> exec <span class="hljs-string">&quot;:call SetTitle()&quot;</span><br>func SetTitle()<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%:e&quot;</span>) == <span class="hljs-string">&#x27;sh&#x27;</span><br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;#!/bin/bash&quot;</span>)<br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;#Author: &quot;</span>)<br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">3</span>,<span class="hljs-string">&quot;#Date： &quot;</span>.<span class="hljs-built_in">strftime</span>(<span class="hljs-string">&quot;%Y-%m-%d&quot;</span>))<br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">4</span>,<span class="hljs-string">&quot;#FileName： &quot;</span>.<span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%&quot;</span>))<br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">5</span>,<span class="hljs-string">&quot;#Description： &quot;</span>)<br><span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">6</span>,<span class="hljs-string">&quot;&quot;</span>)<br><span class="hljs-keyword">endif</span><br>endfunc<br><span class="hljs-keyword">autocmd</span> BufNewFile * <span class="hljs-keyword">normal</span> G<br></code></pre></td></tr></table></figure><h5>2. 通过位置传参方式, 创建 Linux 系统账户及密码，执行 var1.sh username password，控制最多传递两个参数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 2 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;USAGE: <span class="hljs-variable">$0</span> 请传递两个参数: [username | password] &quot;</span><br><span class="hljs-built_in">exit</span><br><span class="hljs-keyword">fi</span><br><br>useradd <span class="hljs-variable">$1</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span> | passwd --stdin <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span><br></code></pre></td></tr></table></figure><h5>3. 使用 read 模拟 Linux 登录页面</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">echo</span> $(hostnamectl |awk -F <span class="hljs-string">&quot;: &quot;</span> <span class="hljs-string">&#x27;/Operating/ &#123;print $2&#125;&#x27;</span>)<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;kernel <span class="hljs-subst">$(uname -r)</span> on an <span class="hljs-subst">$(uname -m)</span>&quot;</span><br><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;<span class="hljs-subst">$(hostname)</span> login:&quot;</span> user<br><span class="hljs-built_in">read</span> -s -t3 -p <span class="hljs-string">&quot;Password:&quot;</span> pw<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你输入的用户名为:<span class="hljs-variable">$user</span>   密码为：<span class="hljs-variable">$pw</span>&quot;</span><br></code></pre></td></tr></table></figure><h5>4. 使用 read编写一个备份脚本，需要用户传递2个参数，源和目标。</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你要备份的源文件或目录：&quot;</span> Dest<br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你要备份的目标位置：&quot;</span> Path<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你要备份的源文件为: <span class="hljs-variable">$Dest</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你要备份的目标位置为：<span class="hljs-variable">$Path</span>&quot;</span><br><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;你确定要备份吗？ [yes | no ]&quot;</span> Action<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;yes&quot;</span> ];<span class="hljs-keyword">then</span><br>cp -rpv <span class="hljs-variable">$Dest</span> <span class="hljs-variable">$Path</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h5>5. 使用read编写一个探测主机存活脚本，需要用户传递测试的IP地址。</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入探测主机的ip地址：&quot;</span> ip<br><br>ping -W1 -c1 <span class="hljs-variable">$ip</span> &amp;&gt; /dev/null<br><br><span class="hljs-keyword">if</span> [ $? -eq 0 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span> is ok&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span> is error&quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h5>6. 使用read编写一个修改系统主机名称脚本。</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">    1.打印当前的主机名称<br>2.提示用户输入新的主机名称<br>3.询问用户是否修改?<br>4.确定修改,执行修改命令<br>5.不确定修改,退出脚本<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;当前的主机名为: <span class="hljs-subst">$(hostname)</span>&quot;</span><br><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入新的主机名：&quot;</span> new_host<br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;是否将<span class="hljs-subst">$(hostname)</span> 修改为<span class="hljs-variable">$&#123;new_host&#125;</span> [yes | no ]&quot;</span> Action<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;yes&quot;</span> ];<span class="hljs-keyword">then</span><br>hostname <span class="hljs-variable">$new_host</span><br>hostnamectl set-hostname <span class="hljs-variable">$new_host</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你的主机名称已修改为  <span class="hljs-variable">$&#123;new_host&#125;</span> &quot;</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h5>7. 如何替换 $PATH 中的/bin/替换为/BIN/</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># echo $&#123;PATH//bin/BIN&#125;</span><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sBIN:/u</span>sr<span class="hljs-regexp">/local/</span>BIN:<span class="hljs-regexp">/usr/</span>sBIN:<span class="hljs-regexp">/usr/</span>BIN:<span class="hljs-regexp">/root/</span>BIN<br></code></pre></td></tr></table></figure><h5>8. 变量string=“Bigdata process is Hadoop, Hadoop is open source project”，执行脚本后，打印输出string变量，并给出用户以下选项</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">1)、打印string长度<br>2)、删除字符串中所有的Hadoop<br>3)、替换第一个Hadoop为Linux<br>4)、替换全部Hadoop为Linux<br>用户输入数字1|2|3|4，可以执行对应项的功能<br><br>string=<span class="hljs-string">&quot;Bigdata process is Hadoop, Hadoop is open source project&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1)、打印string长度&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;2)、删除字符串中所有的Hadoop&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;3)、替换第一个Hadoop为Linux&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;4)、替换全部Hadoop为Linux&quot;</span><br>until [ <span class="hljs-variable">$Action</span> == q  ] 2&gt; /dev/null<br><br><span class="hljs-keyword">do</span> <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入对应的选项：[ 1| 2| 3| 4| ]&quot;</span> Action<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;1&quot;</span> ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;#string&#125;</span>&quot;</span><br><br><span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;2&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;string//Hadoop/&#125;</span>&quot;</span><br><br><span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;3&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;string/Hadoop/Linux&#125;</span>&quot;</span><br><br><span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$Action</span> == <span class="hljs-string">&quot;4&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;string//Hadoop/Linux&#125;</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h5>9. 查看内存/当前使用状态，如果使用率超过80%则报警发邮件，思路如下:</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.当前内存使用百分比是多少<br>2.进行判断比对  <br>如果大于80%  则触发邮件<br>否则,over<br>已使用的内存  /  总内存  * 100 = 使用的百分比<br>used=$(free -m |awk <span class="hljs-string">&#x27;/Mem/ &#123;print $3/$2*100&#125;&#x27;</span>)<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$&#123;used%.*&#125;</span> -ge 10 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;你的内存超过了80%，目前内存的使用率为：<span class="hljs-variable">$used</span>&quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h5>10. 根据系统时间，打印今年和明年时间</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;今年的时间为：<span class="hljs-subst">$(date +%Y)</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;明年的时间为: <span class="hljs-subst">$(($(date +%Y)</span>+1))&quot;</span><br></code></pre></td></tr></table></figure><h5>11. 根据系统时间获取今年还剩下多少星期，已经过了多少星期。思路如下:</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[date +%j  已经过了多少天]()<br><br>一年有365天   已经过了 301 = 还剩下   365-301 = 64  / 7 = 还剩下多少周<br> 已经过了 301 天 / 7 = 已经过了多少周<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;今年已经过了<span class="hljs-subst">$(date +%j)</span> 天&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;今年已经过了$[<span class="hljs-subst">$(date +%j)</span>/7] 周&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;今年还剩下$[365-<span class="hljs-subst">$(date +%j)</span>/7] 周&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;从现在距离下一年还剩下$[365-<span class="hljs-subst">$(date +%j)</span>] 天&quot;</span><br></code></pre></td></tr></table></figure><h5>12. 查看系统当前有几个登陆的用户</h5><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#List=w <span class="hljs-pattern-match">|awk &#x27;<span class="hljs-operator">/</span>up<span class="hljs-operator">/</span> &#123;print <span class="hljs-constructor">$4</span>&#125;&#x27;</span><br><span class="hljs-pattern-match">echo &quot;当前系统登录了<span class="hljs-constructor">$(<span class="hljs-params">w</span> |<span class="hljs-params">awk</span> &#x27;<span class="hljs-operator">/</span><span class="hljs-params">up</span><span class="hljs-operator">/</span> &#123;<span class="hljs-params">print</span> $4&#125;&#x27;)</span> 个用户 &quot;</span><br></code></pre></td></tr></table></figure><h5>13. 筛选出当前系统存在的僵尸进程</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">Zombie=$(<span class="hljs-keyword">ps</span> aux |<span class="hljs-keyword">grep</span> <span class="hljs-string">&#x27;Z&#x27;</span>|egrep -v <span class="hljs-string">&#x27;VSZ|grep&#x27;</span>)<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;僵尸进程的个数为:$(ps aux |grep &#x27;Z&#x27;|egrep -v &#x27;VSZ|grep&#x27; |wc -l)个&quot;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-comment">&quot;当前系统的僵尸进程为：</span><br>$Zombie<span class="hljs-comment">&quot;</span><br></code></pre></td></tr></table></figure><h5>14. 查看当前系统已使用磁盘的百分比</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">df</span> -h | awk &#x27;/<span class="hljs-number">40</span>G/ &#123;print $(NF-<span class="hljs-number">1</span>)&#125;&#x27;<br></code></pre></td></tr></table></figure><h5>15. 统计Nginx日志中每个IP的访问量有多少,日志如下:</h5><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.168.56.1</span> - - <span class="hljs-string">[21/May/2018:20:44:06 -0400]</span> <span class="hljs-string">&quot;<span class="hljs-keyword">GET</span> /index.html HTTP/1.0&quot;</span> <span class="hljs-number">404</span> <span class="hljs-number">169</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;ApacheBench/2.3&quot;</span> <span class="hljs-string">&quot;-&quot;</span>/code/index.html`<br><br>awk &#x27;&#123;print $<span class="hljs-number">1</span>&#125;&#x27; access.log |sort  |uniq -c|sort -nr<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Shell</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux网络IO流程</title>
    <link href="/posts/66e23140/"/>
    <url>/posts/66e23140/</url>
    
    <content type="html"><![CDATA[<h1 id="一、Linux-网络-IO-流程"><a href="#一、Linux-网络-IO-流程" class="headerlink" title="一、Linux - 网络 IO 流程"></a>一、<code>Linux</code> - 网络 <code>IO</code> 流程</h1><p>我们访问一个网站，从我们在浏览器上打开输入网址到网页被打开，中间经历的哪些流程？如果网络比较好的情况下，通常在几秒之内就可以打开一个内容非常丰富的网站，但是背后的执行过程是非常复杂的，我们简单对其中的某些过程进行描述。而我们要描述的地方就是服务器网卡接收到用户请求数据开始，如何处理这些请求并将报文响应给用户。</p><p>这个过程我们省略了从用户发起请求一直到请求到达服务端的过程，这中间还涉及到<code>DNS</code>解析、路由查找等技术细节。</p><p>接收数据包是一个复杂的过程，涉及很多底层的技术细节，但大致需要以下几个步骤：</p><ol><li>网卡收到数据包。</li><li>将数据包从网卡硬件缓存转移到服务器内存中。</li><li>通知内核处理。</li><li>经过 <code>TCP/IP</code> 协议逐层处理。</li><li>应用程序通过 <code>read()</code> 从 <code>socket buffer</code> 读取数据。</li></ol><h6>详解：</h6><ol><li>数据包从外面的网络进入物理网卡。如果目的地不是该网卡，并且该网卡没有开启混杂模式，该包会被网卡丢弃。</li><li>网卡通过硬件中断(<code>IRQ</code>)告知 <code>CPU</code> 有数据来了。</li><li><code>CPU</code> 根据中断表，调用已经注册的中断函数，这个中断函数会调用驱动程序中相应的函数对数据进行处理。</li><li>驱动会一个接一个的读取网卡写到内存中的数据包，内存中数据包的格式只有驱动知道。</li><li>驱动程序将内存中的数据包转换成内核网络模块能识别的格式，数据包会被先存入到 <code>CPU</code> 的<code>input_pkt_queue</code> 队列中，如果队列满了数据会被丢弃（注意：我们可以通过调整系统参数 <code>net.core.netdev_max_backlog</code> 来调整队列大小）。</li><li>此时 <code>CPU</code> 从队列中获取数据并调用 <code>Linux</code> 网络协议栈相应的函数，将数据包交给协议栈处理。</li><li>通过协议分析将数据包传给链路层，此时放在该协议栈中的 <code>netfilter</code> 钩子函数（也就是我们通过<code>iptables</code>）设置的一些规则会对数据包进行处理，可以进行修改，也可能会进行丢弃。如果没有丢弃，则会继续交由网络层协议。</li><li>网络层协议对报文进行处理，查看 <code>IP</code> 地址是否为本机，为本机则接收。如果不为本机，要看是否开启了 <code>ip_forward</code> 即 <code>IP 转发功能</code> ，如果开启则进行网络报文转发，如果未开启则丢弃报文。假设报文的目的地址是本机，则会交由传输层协议进行处理，比如 <code>TCP</code> 或者 <code>UDP</code> 等。</li><li>传输层协议会根据数据包中的 <code>IP</code> 和端口来查找相应的 <code>socket</code>，如果没有找到则丢弃该报文，如果找到则将数据放到 <code>socket</code> 的队列中（<strong>这里还涉及到连接的建立，半连接和全连接队列</strong>），然后由操作系统内核通知相关的应用来进行数据读。</li><li>应用层将请求报文打开后，假如请求读取某个文件，则应用会通过系统调用来读取该文件。</li><li>当内核完成数据的处理后，会将数据复制到应用内存中供应用读取（<strong>从内核缓存区拷贝到应用缓冲区</strong>）。应用读取到数据，构建响应包，通过网络协议簇将报文进行封装，通过链路层发送到网卡缓冲区队列中。</li><li>网卡再次通过中断函数调用网卡驱动完成数据的发送。</li></ol><blockquote><p><strong>注意：上述步骤知识进行了简单描述，很多细节均没有提及，同时也省略了很多和协议以及硬件有关的描述.</strong></p></blockquote><p><img src="/img/blog_image/Linux_internetIO/IO.png" alt="1.0 Linux网络数据包的接收过程"></p><h1 id="二、Linux-网络-IO-模型"><a href="#二、Linux-网络-IO-模型" class="headerlink" title="二、Linux 网络 IO 模型"></a>二、<code>Linux</code> 网络 <code>IO</code> 模型</h1><p>上述内容即为 <code>Linux</code> 最简单的网络流程描述，或许你觉得已经很复杂了，但是下面我们介绍的内容只是整个流程中的很小很小一部分。</p><p>即：当 <code>应用</code> 接收到 <code>用户</code> 请求时，如何对请求进行处理，这里就设计到 <code>Linux</code> 网络 <code>IO</code> 模型。先来简单回一下用户空间和内核空间的关系：</p><p><img src="/img/blog_image/Linux_internetIO/Space.png" alt="2.0 用户空间和内核空间的关系"></p><ol><li>用户空间（<code>user space</code>）的应用程序通过系统调用让内核处理。</li><li>进入内核空间（<code>kernel space</code>）将数据从硬盘读取到自己的内存缓冲区，拷贝到 <code>user space</code> 的内存缓冲区</li><li><code>user space</code> 对数据进行处理</li></ol><h6>详解:</h6><p>即当用户空间的应用程序需要读写硬盘上的数据时，会通过系统调用的方式让内核去处理，此时进入内核空间，内核去将数据从硬盘读取到自己的内存缓冲区中，然后进行数据的读写处理。将数据准备好之后，会把数据拷贝到应用程序的内存缓冲区，此时进入用户空间由应用程序再对数据进行处理，比如数据封包等。在这里会涉及到两个阶段：</p><ul><li><strong>等待数据准备就绪（<code>Waiting for the data to be ready</code>）</strong></li><li><strong>将数据从内核缓冲区拷贝到进程缓冲区中（<code>Copying the data from the kernel to the process</code>）</strong></li></ul><p>正是因为这两个阶段，Linux系统产生了下面五种网络模式的方案：</p><ul><li><strong>阻塞式IO模型（<code>blocking IO model</code>）</strong></li><li><strong>非阻塞式IO模型（<code>nonblocking IO model</code>）</strong></li><li><strong>IO复用式IO模型（<code>IO multiplexing model</code>）</strong></li><li><strong>信号驱动式IO模型（<code>signal-driven IO model</code>）</strong></li><li><strong>异步IO式IO模型（<code>asynchronous IO model</code>）</strong></li></ul><h4 id="2-1-阻塞式IO模型（blocking-IO-model）"><a href="#2-1-阻塞式IO模型（blocking-IO-model）" class="headerlink" title="2.1 阻塞式IO模型（blocking IO model）"></a>2.1 阻塞式IO模型（<code>blocking IO model</code>）</h4><p>在 <code>Linux</code> 中，默认情况下所有的 <code>IO</code> 操作都是 <code>blocking</code>，一个典型的读操作流程大概是这样:</p><p><img src="/img/blog_image/Linux_internetIO/Blocking.png" alt="2.1 Blocking I/O Model"></p><p>当用户进程调用了 <code>recvfrom</code> 这个系统调用，<code>kernel</code> 就开始了 <code>IO</code> 的第一个阶段：准备数据（对于网络 <code>IO</code> 来说，很多时候数据在一开始还没有到达。比如：还没有收到一个完整的 <code>UDP</code> 包。这个时候 <code>kernel</code> 就要等待足够的数据到来），而数据被拷贝到操作系统内核的缓冲区中是需要一个过程的，这个过程需要等待。此时用户进程会被阻塞（当然，是进程自己选择的阻塞）。当 <code>kernel</code> 一直等到数据准备好了，它就会将数据从 <code>kernel</code> 中拷贝到用户空间的缓冲区以后，然后 <code>kernel</code> 返回结果，用户进程才解除 <code>block</code> 的状态，重新运行起来。</p><p>所以：<code>blocking IO</code>的特点就是在 <code>IO</code> 执行的下两个阶段都被 <code>block</code> 了。</p><ul><li><strong>等待数据准备就绪（<code>waiting for the data to be ready</code>）<code>「阻塞」</code></strong></li><li><strong>将数据从内核拷贝到进程中（<code>Copying the data from the kernel to the process</code>）<code>「阻塞」</code></strong></li></ul><h4 id="2-2-非阻塞I-O（nonblocking-IO）"><a href="#2-2-非阻塞I-O（nonblocking-IO）" class="headerlink" title="2.2 非阻塞I/O（nonblocking IO）"></a>2.2 非阻塞I/O（<code>nonblocking IO</code>）</h4><p>在 <code>Linux</code> 中，可以通过设置 <code>socket</code> 使其变为 <code>non-blocking</code>。</p><p><code>Socket</code> 设置为 <code>NONBLOCK</code> （非阻塞）就是告诉内核，当所有请求的 <code>I/O</code> 操作无法完成时，不要将进程睡眠，而是返回一个错误码（<code>EWOULDBLOCK</code>），这样请求就不会阻塞。当对一个 <code>non-blocking socket</code> 执行读操作时，流程是这个样子：</p><p><img src="/img/blog_image/Linux_internetIO/Non-blocking.png" alt="2.2 Non-Blocking I/O Model"></p><p>当用户进程调用了 <code>recvfrom</code> 这个系统调用，如果 <code>kernel</code> 中的数据还没有准备好，那么它并不会 <code>block</code> 用户进程，而是立刻返回一个 <code>EWOULDBLOCK</code> 错误代码。从用户进程角度讲，它发起一个 <code>read</code> 操作后，并不需要等待，而是马上得到了一个结果。用户进程判断结果是一个 <code>EWOULDBLOCK</code> 时，它就知道数据还没有准备好，此时用户进程可以进行其他操作。一旦 <code>kernel</code> 中的数据准备好了，并且又再次收到了用户进程的 <code>system call</code> ，那么它马上就将数据拷贝到了用户空间缓冲区，然后返回。</p><p>可以看到， <code>I/O</code> 操作函数将不断的测试数据是否已经准备好，如果没有准备好，继续轮询，直到数据准备好为止。整个 <code>I/O</code> 请求的过程中，虽然用户线程每次发起 <code>I/O</code> 请求后可以立即返回，但是为了等到数据，仍需要不断地轮询、重复请求，消耗了大量的 <code>CPU</code> 的资源。</p><p>所以，**<code>non blocking IO</code> 的特点是用户进程需要不断的主动询问 <code>kernel</code> 数据好了没有**：</p><ul><li><strong>等待数据准备就绪（<code>waiting for the data to be ready</code>）<code>非阻塞</code></strong></li><li><strong>将数据从内核拷贝到进程中（<code>Copying the data from the kernel to the process</code>）<code>阻塞</code></strong></li></ul><p>一般很少直接使用这种模型，而是在其他 <code>I/O</code> 模型中使用非阻塞 <code>I/O</code> 这一特性。这种方式对单个 <code>I/O</code> 请求意义不大，但给 <code>I/O</code> 多路复用铺平了道路。</p><h4 id="2-3-I-O多路复用（I-O-multiplexing）"><a href="#2-3-I-O多路复用（I-O-multiplexing）" class="headerlink" title="2.3 I/O多路复用（I/O multiplexing）"></a>2.3 I/O多路复用（<code>I/O multiplexing</code>）</h4><p><code>IO multiplexing</code>在我们使用中基本这种模型的代表就是常见的<code>select，poll，epoll</code>，有些地方也称这种<code>IO</code>方式为事件驱动模型<code>event driven IO</code>。<code>select/poll/epoll</code>的好处就在于**单个系统<code>process</code>就可以同时处理多个网络连接的<code>IO</code>**。它的基本原理就是<code>select，poll，epool</code>这些个<code>function</code>会不断的轮询所负责的所有<code>socket</code>，当某个<code>socket</code>有数据到达了，就通知用户进程。</p><p><img src="/img/blog_image/Linux_internetIO/Multiple.png" alt="2.3 Multiple I/O Model"></p><p>当用户进程调用了 <code>select</code> ，那么整个进程会被 <code>block</code> ，而同时， <code>kernel</code> 会“监视”所有 <code>select</code> 负责的 <code>socket</code> ，当任何一个 <code>socket</code> 中的数据准备好了，<code>select</code> 就会返回。这个时候用户进程再调用 <code>read</code> 操作，将数据从 <code>kernel</code> 拷贝到用户进程。</p><p>所以，**<code>I/O</code> 多路复用的特点是通过一种机制一个进程能同时等待多个文件描述符，而这些文件描述符（套接字描述符）其中的任意一个进入读就绪状态，<code>select()</code> 函数就可以返回。**</p><p>这个图和 <code>blocking IO</code> 的图其实并没有太大的不同，事实上因为 <code>IO</code> 多路复用多了添加监视 <code>socket</code> ，以及调用 <code>select</code> 函数的额外操作，效率更差。还更差一些，因为这里需要使用两个 <code>system call</code> （<code>select</code>和<code>recvfrom</code>），而 <code>blocking IO</code> 只调用了一个 <code>system call</code> （<code>recvfrom</code>）。但是使用 <code>select</code> 以后最大的优势是用户可以在一个线程内同时处理多个 <code>socket</code> 的 <code>I/O</code> 请求。用户可以注册多个 <code>socket</code> ，然后不断地调用 <code>select</code> 读取被激活的 <code>socket</code> ，即可达到在同一个线程内同时处理多个 <code>I/O</code> 请求的目的。而在同步异阻塞模型中，必须通过多线程的凡是才能达到这个目的。</p><p><strong>所以，如果处理的连接数不是很高的话，使用 <code>select/epool</code> 的 <code>web server</code> 并没有性能优势，可能延迟还要更大。<code>select.epoll</code> 的优势并不是单个连接能处理得更快，而是在于能处理更多的连接</strong></p><p>在 <code>IO multipxing model</code> 中，实际中，对于每一个 <code>socket</code>，一般都设置为 <code>non-blocking</code>，但是，如上图所示，整个用户的 <code>process</code> 其实是一直被 <code>block</code> 的。只不过 <code>process</code> 是被 <code>select</code> 这个函数 <code>block</code>，而不是被 <code>socket IO</code> 给 <code>block</code>。</p><p>因此对于<code>IO</code>多路复用模型来说：</p><ul><li><strong>等待数据准备就绪（Waiting for the data to be ready）<code>阻塞</code></strong></li><li><strong>将数据从内核拷贝到进程中（Copying the data from the kernel to the process）<code>阻塞</code></strong></li></ul><blockquote><p><strong>对于 <code>select/poll/epoll</code>  可以根据调用时指定的参数不同，而决定是阻塞或者非阻塞.</strong></p></blockquote><h4 id="2-4-信号驱动式IO模型（signal-driven-IO-model）"><a href="#2-4-信号驱动式IO模型（signal-driven-IO-model）" class="headerlink" title="2.4 信号驱动式IO模型（signal-driven IO model）"></a>2.4 信号驱动式IO模型（<code>signal-driven IO model</code>）</h4><p>首先我们运行 <code>socket</code> 进行信号驱动 <code>I/O</code>，并安装一个信号处理函数，进程继续运行并不阻塞。当数据准备好时，进程会收到一个 <code>SIGIO</code> 信号，可以在信号处理函数中调用 <code>I/O</code> 操作函数处理数据。</p><p><img src="/img/blog_image/Linux_internetIO/Signal.png" alt="2.4 Signal I/O Model"></p><h4 id="2-5-异步I-O（asynchronous-IO）"><a href="#2-5-异步I-O（asynchronous-IO）" class="headerlink" title="2.5 异步I/O（asynchronous IO）"></a>2.5 异步I/O（<code>asynchronous IO</code>）</h4><p>接下来我们看看 <code>asynchronous IO</code> 的流程：</p><p><img src="/img/blog_image/Linux_internetIO/Asynchronous.png" alt="2.5 Asynchronous I/O Model"></p><p>用户进程发起 <code>aio_read</code> 调用之后，立刻就可以开始去做其它的事。而另一方面，从 <code>kernel</code> 的角度，当它发现一个 <code>asynchronous read</code> 之后，首先它会立即返回，所以不会对用户进程产生任何 <code>block</code> 。然后，<code>kernel</code> 会等待数据准备完成，然后将数据拷贝到用户内存，当这一切都完成之后，<code>kernel</code> 会给用户进程发送一个 <code>signal</code>，告诉它 <code>read</code> 操作完成了。</p><p>异步 <code>I/O</code> 模型使用了 <code>Proactor</code> 设计模式实现了这一机制。</p><p>因此对异步 <code>IO</code> 模型来说：</p><ul><li><strong>等待数据准备就绪（waiting for the data to be ready）<code>非阻塞</code></strong></li><li><strong>将数据从内核拷贝到进程中（Copying the data from the kernel to the process）<code>非阻塞</code></strong></li></ul><h4 id="2-6-各个-IO-model-的比较"><a href="#2-6-各个-IO-model-的比较" class="headerlink" title="2.6 各个 IO model 的比较"></a>2.6 各个 <code>IO model</code> 的比较</h4><p><img src="/img/blog_image/Linux_internetIO/every-model.png" alt="2.6 各个I/O Model的比较"></p><p>前四种模型的区别是阶段1不相同，阶段2基本相同（都是将数据从内核拷贝到调用者的缓冲区）。而异步<code>I/O</code>的两个阶段都不同于前四个模型。同步 <code>I/O</code> 操作引起请求进程阻塞，直到 <code>I/O</code> 操作完成。异步<code>I/O</code>操作不引起请求进程阻塞。</p><p>同时通过上面的图片，可以发现 <code>non-blocking IO</code> 和 <code>asynchronous IO</code> 的区别还是很明显的。在 <code>non-blocking IO</code> 中，虽然进程大部分时间都不会被 <code>block</code> ，但是它仍然要求进程主动的 <code>check</code>，并且当数据准备完成以后，也需要进程主动的再次调用 <code>recvfrom</code> 来将数据拷贝到用户内存。而 <code>asynchronous IO</code> 则完全不同。它就像是用户进程将整个 <code>IO</code> 操作交给了他人（<code>kernel</code>）完成，然后他人做完后发信号通知。在此期间，用户进程不需要去检查<code>IO</code>操作的状态，也不需要主动的去拷贝数据。</p><p>下面三种 <code>IO</code> 多路复用的对比，可以看到 <code>epool</code> 模型的性能比 <code>select/poll</code> 要高很多。</p><table><thead><tr><th>系统调用</th><th>select</th><th>poll</th><th>epoll</th></tr></thead><tbody><tr><td>操作方式</td><td>遍历</td><td>遍历</td><td>回调</td></tr><tr><td>底层实现</td><td>数组<code>bitmap</code></td><td>链表</td><td>哈希表</td></tr><tr><td>查找就绪<code>fd</code>时间复杂度</td><td>O(n)</td><td>O(n)</td><td>O(1)</td></tr><tr><td>最大支持文件描述符数</td><td>一般有最大值限制</td><td>65535</td><td>65535</td></tr><tr><td>工作模式</td><td>LT水平触发</td><td>LT水平触发</td><td>支持ET高效模式</td></tr><tr><td><code>fd</code>拷贝</td><td>每次调用 <code>select</code> 都需要把<code>fd</code>集合从用户态拷贝到内核态</td><td>每次调用 <code>poll</code> 都需要把<code>fd</code>集合从用户态拷贝到内核态</td><td>使用 <code>map()</code> 文件映射内存来加速与内核空间的消息传递，减少复制开销</td></tr></tbody></table><blockquote><p><strong>水平触发 LT：默认工作模式，即当epoll_wait检测到某描述符事件就绪并通知应用程序时，应用程序可以不立即处理该事件；下次调用epoll_wait时，会再次通知此事件。</strong></p><p><strong>边缘触发 ET：当epoll_wait检测到某描述符事件就绪并通知应用程序时，应用程序必须立即处理该事件。如果不处理，喜爱调用epoll_wait时，不会再次通知此事件。（直到你做了某些操作导致该描述符变成未就绪状态了，也就是说边缘触发只在状态由未就绪变为就绪时通知一次）。</strong></p></blockquote><p>下面是不同网络模型的性能对比：</p><p><img src="/img/blog_image/Linux_internetIO/Libevent_Benchmark.png" alt="2.7 Libevent_Benchmark"></p><blockquote><p>其中 <code>Kqueue</code> 是在 <code>FreeBSD</code> 平台上实现的 <code>I/O</code> 多路复用模型，跟 <code>Linux</code> 上的 <code>Epoll</code> 非常类似。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linux网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Nginx</tag>
      
      <tag>网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>将GitHub中的Hexo部署到云服务器上（CentOS7）</title>
    <link href="/posts/ce41cac3/"/>
    <url>/posts/ce41cac3/</url>
    
    <content type="html"><![CDATA[<h1 id="一、登录云服务器安装-Git-和-Nginx"><a href="#一、登录云服务器安装-Git-和-Nginx" class="headerlink" title="一、登录云服务器安装 Git 和 Nginx"></a>一、登录云服务器安装 <code>Git</code> 和 <code>Nginx</code></h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta"> root </span>]<span class="hljs-meta"># yum -y install git nginx</span><br></code></pre></td></tr></table></figure><h1 id="二、修改默认打开页面"><a href="#二、修改默认打开页面" class="headerlink" title="二、修改默认打开页面"></a>二、修改默认打开页面</h1><p>找到 <code>Nginx</code> 配置文件，我这里是 <code>/etc/nginx/nginx.conf</code> ，记得先备份一下。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 在server段下修改root的目录即可。</span><br>[ root ]#  vim nginx.conf<br>...<br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> default_server;<br>        <span class="hljs-attribute">listen</span>       [::]:<span class="hljs-number">80</span> default_server;<br>        <span class="hljs-attribute">server_name</span>  _;<br>        <span class="hljs-attribute">root</span>         /data/www/hexo;<br>        <span class="hljs-attribute">index</span>        index.html index.htm;<br>&#125;<br>...<br></code></pre></td></tr></table></figure><p>检测配置文件并重启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> nginx -t</span><br><span class="hljs-meta">#</span><span class="bash"> nginx -s reload</span><br></code></pre></td></tr></table></figure><h1 id="三、创建一个-Git-裸库，保存-Repository"><a href="#三、创建一个-Git-裸库，保存-Repository" class="headerlink" title="三、创建一个 Git 裸库，保存 Repository"></a>三、创建一个 <code>Git</code> 裸库，保存 <code>Repository</code></h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta"> root </span>]<span class="hljs-meta"># cd ~</span><br>[<span class="hljs-meta"> root </span>]<span class="hljs-meta"># git init --bare &#123;你的仓库名称&#125;.git #我的仓库名称: My_repository.git</span><br></code></pre></td></tr></table></figure><p>使用 <code>Git-Hook</code> 同步网站根目录，这里使用的是 <code>Git</code> 中的 <code>post-receive</code> ，当有 <code>Git</code> 收发的时候会调用该脚本，自动将最新内容同步到网站跟目录中。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta"> root </span>]<span class="hljs-meta"># vim My_repository.git/post-receive</span><br></code></pre></td></tr></table></figure><p>将下面的语句写入文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>git --work-tree=/data/www/hexo --git-dir=/data/hexo/My_repository.git checkout -f<br></code></pre></td></tr></table></figure><blockquote><p><code>--work-tree</code> ：博客文件存放目录。</p><p><code>--git-dir</code> ：<code>Git-Hook</code> 同步网站根目录。</p></blockquote><p>保存并赋予执行权限</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[ root ]# chmod +x <span class="hljs-regexp">/data/</span>hexo<span class="hljs-regexp">/My_repository.git/</span>hooks/post-receive<br></code></pre></td></tr></table></figure><h1 id="四、本地配置"><a href="#四、本地配置" class="headerlink" title="四、本地配置"></a>四、本地配置</h1><blockquote><p>这里以 <code>Windows</code> 为本地</p></blockquote><p>配置 <code>&quot;_config.yml&quot;</code></p><p>打开位于 <code>Hexo</code> 博客根目录下的 <code>&quot;_config.yml&quot;</code> ，在最后面知道到 <code>&quot;deploy&quot;</code> 并修改。</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">deploy:</span><br>-  <span class="hljs-symbol">type:</span> git<br>   <span class="hljs-symbol">repository:</span> git<span class="hljs-variable">@github</span>.<span class="hljs-symbol">com:</span>ButATree/ButATree.github.io.git<br>   <span class="hljs-symbol">branch:</span> master<br>-  <span class="hljs-symbol">type:</span> git<br>   <span class="hljs-symbol">repository:</span> root@你的服务器IP地址<span class="hljs-symbol">:/data/hexo/My_repository</span>.git<br>   <span class="hljs-symbol">branch:</span> master   <span class="hljs-comment"># 分支</span><br></code></pre></td></tr></table></figure><blockquote><p>**注意若原来 <code>type: git</code> 前面没有 <code>-</code> 符号，需要手动添加上，不然后面会报错。 </p></blockquote><p>本地 <code>git</code> 软件中执行下命令即可</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo clean</span><br><span class="hljs-attribute">hexo g</span><br><span class="hljs-attribute">hexo d</span><br></code></pre></td></tr></table></figure><p>以后 <code>hexo d</code> 的时候就会推到 <code>GitHub</code> 和个人服务器上了。</p><h1 id="五、Hexo-d-免密"><a href="#五、Hexo-d-免密" class="headerlink" title="五、Hexo d 免密"></a>五、<code>Hexo d</code> 免密</h1><p>上述 <code>hexo d</code> 每次推到服务器上，都需要密码，通过添加密钥免密推送。可以在本地建立密钥上传到 <code>GitHub</code> 和你的服务器下的 <code>~/.ssh</code> 即可。</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vala">ssh-keygen -t rsa<br><span class="hljs-meta"># 一直回车即可，然后将 id_rsa.pub 中的密钥信息拷贝到 authorized_keys 即可。</span><br><span class="hljs-meta"># GitHub 中添加密钥：右上角个人信息 → SSH and GPG keys → New SSH key</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hexo博客搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>GitHub</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iptables基础详解</title>
    <link href="/posts/fae948f1/"/>
    <url>/posts/fae948f1/</url>
    
    <content type="html"><![CDATA[<h1 id="iptables-概念"><a href="#iptables-概念" class="headerlink" title="iptables 概念"></a><code>iptables</code> 概念</h1><p>从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙<br>主机防火墙：针对于单个主机进行防护。网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。<br>网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p><p>从物理上讲，防火墙可以分为硬件防火墙和软件防火墙。<br>硬件防火墙：在硬件级别实现部分防火墙功能，另一部分功能基于软件实现，性能高，成本高。软件防火墙：应用软件处理逻辑运行于通用硬件平台之上的防火墙，性能低，成本低。</p><h2 id="iptables-用户→程序→内核→硬件"><a href="#iptables-用户→程序→内核→硬件" class="headerlink" title="iptables  (用户→程序→内核→硬件)"></a><code>iptables</code>  (用户→程序→内核→硬件)</h2><p><code>iptables</code> 其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过 <code>iptables</code> 这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫 <code>netfilter</code> 。</p><p><code>netfilter</code> 才是防火墙真正的安全框架（<code>framework</code>），<code>netfilter</code> 位于内核空间。<code>iptables</code> 其实是一个命令行工具，位于用户空间，我们用这个工具操作真正的框架。<code>netfilter/iptables</code>（下文中简称为<code>iptables</code>）组成 <code>Linux</code> 平台下的包过滤防火墙，与大多数的 <code>Linux</code> 软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（<code>NAT</code>）等功能。<code>Netfilter</code> 是 <code>Linux</code> 操作系统核心层内部的一个数据包处理模块，它具有如下功能：<br>网络地址转换(<code>Network Address Translate</code>)<br>数据包内容修改<br>以及数据包过滤的防火墙功能</p><p><code>iptables</code> 并没有一个守护进程，不能算是真正意义上的服务，而应该算是内核提供的功能。</p><h1 id="iptables-基础"><a href="#iptables-基础" class="headerlink" title="iptables 基础"></a><code>iptables</code> 基础</h1><h2 id="iptables-防火墙简介"><a href="#iptables-防火墙简介" class="headerlink" title="iptables 防火墙简介"></a><code>iptables</code> 防火墙简介</h2><p><code>Netfilter/iptables</code> (以下简称iptables)是<code>Unix/linux</code> 系统自带的优秀且完全免费的基于包过滤的防火墙工具、它的功能十分强大、使用非常灵活、可以对流入、流出及流经服务器的数据包进行精细的控制。特别是它可以在一台非常低配置下跑的非常好。提供400台机器的办公上网共享服务丝毫不逊色数万RMB企业级专业路由器防火墙</p><p><code>Iptables</code> 是 <code>linux 2.4</code>及<code>2.6</code>内核中集成的服务、其功能与安全性比老一辈<code>ipvfwadm</code> 、<code>ipchanins</code> 强大的多、一般认为 <code>iptables</code> 工作在OSI七层的、二、三层、四层。</p><p>首先介绍 <code>iptables</code> 的结构：<code>iptables</code>  → <code>Tables</code> → <code>Chains</code> → <code>Rules</code>. 简单地讲，<code>tables</code> 由 <code>chains</code> 组成，而 <code>chains</code> 又由 <code>rules</code> 组成。如下图所示。</p><p><img src="/img/blog_image/Linux_iptables_contentImage/tables_chain_rules.png"></p><h3 id="一、iptables-的表与链"><a href="#一、iptables-的表与链" class="headerlink" title="一、iptables 的表与链"></a>一、<code>iptables</code> 的表与链</h3><p><code>iptables</code> 具有 <code>Filter</code>、<code>NAT</code>、<code>Mangle</code>、<code>Raw</code> 四种内建表：</p><blockquote><p>4 个表的优先级由高到底：<code>Raw</code> &gt; <code>Mangle</code> &gt; <code>Nat</code> &gt; <code>Filter</code></p><ul><li><code>RAW</code> 表只使用在 <code>PREROUTING</code> 链和 <code>OUTPUT</code> 链上,因为优先级最高，从而可以对收到的数据包在连接跟踪前进行处理。一但用户使用了 <code>RAW</code> 表,在某个链上，<code>RAW</code> 表处理完后,将跳过 <code>NAT</code> 表和 <code>ip_conntrack</code> 处理,即不再做地址转换和数据包的链接跟踪处理了。</li><li><code>filter</code> 表是预设规则表，拥有 <code>INPUT</code>、<code>FORWARD</code> 和 <code>OUTPUT</code> 三个规则链，这个规则表顾名思义是用来进行封包过滤的理动作。</li><li><code>net</code> 表拥有 <code>prerouting</code> 和 <code>postrouting</code> 两个规则链， 主要功能为进行一对一、一对多、多对多等网址转译工作（<code>SNAT,DNAT</code>）。</li><li><code>mangle</code> 拥有 <code>prerouting</code>、<code>FORWARD</code>、<code>postrouting</code>三个规则链，除了进行网址转译工作会改写封包外，在某些特殊应用可能也必须去改写封包(<code>ITL</code>、<code>TOS</code>)或者是设定 <code>MARK</code> (将封包作记号，以进行后续的过滤)这时就必须将这些工作定义在 <code>mangles</code> 规则表中</li></ul></blockquote><h4 id="iptables-表"><a href="#iptables-表" class="headerlink" title="iptables 表"></a><code>iptables</code> 表</h4><h5 id="1-filter-表"><a href="#1-filter-表" class="headerlink" title="1. filter 表"></a>1. <code>filter</code> 表</h5><p><code>Filter</code> 表示 <code>iptables</code> 的默认表，因此如果你没有自定义表，那么就默认使用 <code>filter</code> 表，它具有以下三种内建链：</p><ul><li><code>INPUT</code>链 – 处理来自外部的数据。</li><li><code>FORWARD</code>链 – 将数据转发到本机的其他网卡设备上。</li><li><code>OUTPUT</code>链 – 处理向外发送的数据。</li></ul><h5 id="2-nat-表"><a href="#2-nat-表" class="headerlink" title="2. nat 表"></a>2. <code>nat</code> 表</h5><p><code>NAT</code>表有三种内建链：</p><ul><li><code>PREROUTING</code> 链 – 处理刚到达本机并在路由转发前的数据包。它会转换数据包中的目标IP地址（<code>destination ip address</code>），通常用于<code>DNAT</code>(<code>destination NAT</code>)。</li><li><code>OUTPUT</code> 链 – 处理本机产生的数据包。</li><li><code>POSTROUTING</code> 链 – 处理即将离开本机的数据包。它会转换数据包中的源IP地址（<code>source ip address</code>），通常用于<code>SNAT</code>（<code>source NAT</code>）。</li></ul><h5 id="3-mangle-表"><a href="#3-mangle-表" class="headerlink" title="3. mangle 表"></a>3. <code>mangle</code> 表</h5><p><code>Mangle</code> 表用于指定如何处理数据包。它能改变<code>TCP</code>头中的<code>QoS</code>位。<code>Mangle</code> 表具有5个内建链：</p><ul><li><code>PREROUTING</code></li><li><code>OUTPUT</code></li><li><code>FORWARD</code></li><li><code>INPUT</code></li><li><code>POSTROUTING</code></li></ul><h5 id="4-raw-表"><a href="#4-raw-表" class="headerlink" title="4. raw 表"></a>4. <code>raw</code> 表</h5><p><code>Raw</code>表用于处理异常，它具有2个内建链：</p><ul><li><code>PREROUTING chain</code></li><li><code>OUTPUT chain</code></li></ul><h6>常用命令</h6><ul><li><code>-A</code> ：追加 <code>iptables -A INPUT</code></li><li><code>-D</code> ：删除规则 <code>iptables -D INPUT 1(编号)</code></li><li><code>-R</code> ：修改规则 <code>iptables -R INPUT 1 -s 192.168.1.0 -j DROP</code> 取代取代现行规则，顺序不变(1是位置)</li><li><code>-I</code> ：插入规则 <code>iptables -I INPUT 1 --dport 80 -j ACCEPT</code>  插入一条规则，原本位置上的规则将会往后移动一个顺位</li><li><code>-L</code> ：查看规则 <code>iptables -L INPUT</code> 列出规则链中的所有规则</li><li><code>-N</code> ：新的规则 <code>iptables -N allowed</code> 定义新的规则</li></ul><h6>通用参数</h6><ul><li><code>-p</code> ：协议 <code>iptables -A INPUT -p tcp</code></li><li><code>-s</code> ：源地址 <code>iptables -A INPUT -s 192.168.1.1</code></li><li><code>-d</code> ：目的地址 <code>iptables -A INPUT -d 192.168.12.1</code></li><li><code>--sport</code> ：源端口 <code>iptables -A INPUT -p tcp --sport 22</code></li><li><code>--dport</code>：目的端口 <code>iptables -A INPUT -p tcp --dport 22</code></li><li><code>-i</code> ：指定入口网卡 <code>iptables -A INPUT -i eth0</code></li><li><code>-o</code> ：指定出口网卡 <code>iptables -A FORWARD -o eth0</code></li><li><code>-j</code> ： 定要进行的处理动作</li></ul><h6>常用的ACTION</h6><ul><li><code>DROP</code> ：丢弃</li><li><code>REJECT</code> ：明示拒绝</li><li><code>ACCEPT</code> ：接受</li><li><code>SNAT</code>： 基于原地址的转换</li><li><code>source</code> ：指定原地址</li></ul><blockquote><p>例子：</p><p> 比如我们现在要将所有 <code>192.168.10.0</code> 网段的 <code>IP</code> 在经过 <code>iptables</code> 的时候全都转换成 <code>172.16.100.1</code> 这个假设出来的外网地址：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A POSTROUTING -s <span class="hljs-number">192.168.10.0</span>/<span class="hljs-number">24</span> -j SNAT --to-source <span class="hljs-number">172.16.100.1</span>(外网有效ip)<br></code></pre></td></tr></table></figure><p>这样，只要是来自本地网络的试图通过网卡访问网络的，都会被统统转换成 <code>172.16.100.1</code> 这个 <code>IP</code>。</p><p><code>MASQUERADE</code> (动态伪装）— 家用带宽获取的外网 <code>ip</code>，就是用到了动态伪装</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A POSTROUTING -s <span class="hljs-number">192.168.10.0</span>/<span class="hljs-number">24</span> -j MASQUERADE<br></code></pre></td></tr></table></figure><p><code>DNAT</code> ： 目标地址转换<br><code>destination</code> ： 指定目标地址</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A PREROUTING -d <span class="hljs-number">192.168.10.18</span> -p tcp --dport <span class="hljs-number">80</span> -j DNAT --to-destination <span class="hljs-number">172.16.100.2</span><br></code></pre></td></tr></table></figure><p><code>192.168.10.18</code> 访问80端口转换到 <code>172.16.100.2</code> 上<br><code>MASQUERADE</code> ：源地址伪装<br><code>REDIRECT</code> ：重定向：主要用于实现端口重定向<br><code>MARK</code> ：打防火墙标记的<br><code>RETURN </code>：返回 在自定义链执行完毕后使用返回，来返回原规则链。</p></blockquote><h5 id="5-小结"><a href="#5-小结" class="headerlink" title="5.小结"></a>5.小结</h5><p>下图展示了 <code>iptables</code> 的三个内建表：</p><p><img src="/img/blog_image/Linux_iptables_contentImage/iptables_sum.png"></p><hr><h4 id="iptables-链"><a href="#iptables-链" class="headerlink" title="iptables 链"></a><code>iptables</code> 链</h4><h5 id="1-链-chain"><a href="#1-链-chain" class="headerlink" title="1. 链   (chain)"></a>1. 链   (chain)</h5><p>每个表都有自己的一组内置链，可以对链进行自定义，这样就可以建立一组规则，<code>filter</code> 表中的 <code>input</code> 、<code>output</code> 和 <code>forward</code> 链。</p><h5 id="2-匹配（match）"><a href="#2-匹配（match）" class="headerlink" title="2. 匹配（match）"></a>2. 匹配（match）</h5><p>每个 <code>iptables</code> 规则都包含一组匹配以及一个目标，<code>iptables</code> 匹配指的是数据包必须匹配的条件，只有当数据包满足所有的匹配条件时，<code>iptables</code> 才能根据由该规则的目标所指定的动作来处理该数据包，匹配都在 <code>iptable</code> 的命令行中指定。</p><ul><li><code>source</code> ：匹配源ip地址或网络</li><li><code>destination (-d)</code> ：匹配目标 <code>ip</code> 地址或网络</li><li><code>protocol (-p)</code> ：匹配 <code>ip</code> 值 （<code>TCP</code>/<code>UDP</code>）</li><li><code>in-interface (-i)</code> ：流入接口(例如，<code>eth0</code> 、<code>ens32</code>)</li><li><code>out-interface (-o)</code> ：流出接口</li><li><code>state</code> ：匹配一组连接状态</li><li><code>string</code> ：匹配应用层数据字节序列</li><li><code>comment</code> ：在内核内存中为一个规则关联多达 <code>256</code> 个字节的注释数据</li></ul><h5 id="3-目标（target）"><a href="#3-目标（target）" class="headerlink" title="3. 目标（target）"></a>3. 目标（target）</h5><p><code>iptables</code> 支持一组目标，用于数据包匹配一条规则时触发一个动作</p><ul><li><code>ACCEPT</code> ：允许数据包通过</li><li><code>DROP</code> ：丢弃数据包，不对该数据包做进一步的处理，对接收栈而言，就好像该数据包从来没有被接收一样</li><li><code>LOG</code> ：将数据包信息记录到 <code>syslog</code></li><li><code>REJECT</code> ：丢弃数据包，同时发送适当的响应报文(针对 <code>TCP</code> 连接的 <code>TCP</code> 重要数据包或针对 <code>UDP</code> 数据包的 <code>ICMP</code> 端口不可达消息)</li><li><code>RETURN</code> ：在调用链中继续处理数据包</li></ul><h4 id="链管理命令（立即生效）"><a href="#链管理命令（立即生效）" class="headerlink" title="链管理命令（立即生效）"></a>链管理命令（立即生效）</h4><ul><li><p><code>-P</code> ：设置默认策略的（设定默认门是关着的还是开着的</p><p>默认策略一般只有两种</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">iptables</span> <span class="hljs-selector-tag">-P</span> <span class="hljs-selector-tag">INPUT</span> (DROP|ACCEPT)<br></code></pre></td></tr></table></figure><p>这就把默认规则给拒绝了。并且没有定义哪个动作，所以关于外界连接的所有规则包括 <code>Xshell</code> 连接之类的，远程连接都被拒绝了</p></li><li><p><code>-F </code> ： <code>FLASH</code>，清空规则链的(注意每个链的管理权限)</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel">iptables -<span class="hljs-built_in">t</span> nat -F PREROUTING<br># iptables -<span class="hljs-built_in">t</span> nat -F 清空nat表的所有链<br></code></pre></td></tr></table></figure></li><li><p><code>-X</code> ： 用于删除用户自定义的空链<br>  使用方法跟 <code>-N</code> 相同，但是在删除之前必须要将里面的链给清空昂了</p></li><li><p><code>-N</code> ：<code>NEW</code> 支持用户新建一个链</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">iptables</span> -N inbound_tcp_web <br><span class="hljs-comment"># 表示附在tcp表上用于检查web的。</span><br></code></pre></td></tr></table></figure></li><li><p>-E：用来 <code>Rename chain</code> 主要是用来给用户自定义的链重命名</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -E oldname newname</span><br></code></pre></td></tr></table></figure></li><li><p><code>-Z</code> ：清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">iptables</span> -Z <br><span class="hljs-comment">#清空</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="规则管理命令"><a href="#规则管理命令" class="headerlink" title="规则管理命令"></a>规则管理命令</h4><ul><li><p><code>-A</code> ：追加，在当前链的最后新增一个规则</p></li><li><p><code>-I num</code> ：插入，把当前规则插入为第几条。</p></li><li><p><code>-I 3</code> ：插入为第三条</p></li><li><p><code>-R num</code> ：<code>Replays</code> 替换/修改第几条规则</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">iptables</span></span> -R <span class="hljs-number">3</span> ...<br></code></pre></td></tr></table></figure></li><li><p><code>-D num</code> ：删除，明确指定删除第几条规则</p></li></ul><h4 id="查看管理命令-“-L”"><a href="#查看管理命令-“-L”" class="headerlink" title="查看管理命令 “-L”"></a>查看管理命令 “-L”</h4><blockquote><p>附加子命令<br><code>-n </code>：以数字的方式显示 <code>ip</code> ，它会将 <code>ip</code> 直接显示出来，如果不加 <code>-n</code> ，则会将 <code>ip</code> 反向解析成主机名。<br><code>-v</code>：显示详细信息<br><code>-vv</code><br><code>-vvv</code> :越多越详细<br><code>-x</code>：在计数器上显示精确值，不做单位换算<br><code>--line-numbers</code> : 显示规则的行号<br><code>-t nat</code>：显示所有的关卡的信息</p></blockquote><h4 id="详解匹配标准"><a href="#详解匹配标准" class="headerlink" title="详解匹配标准"></a>详解匹配标准</h4><h6>扩展匹配</h6><ol><li><p>隐含扩展：对协议的扩展</p><p><code>-p tcp</code> ：<code>TCP</code> 协议的扩展。一般有三种扩展</p><p><code>--dport XX-XX</code> ：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如</p><ul><li><p><code>--dport 21</code> 或者 <code>--dport 21-23</code> (此时表示21,22,23)</p></li><li><p><code>--sport</code> ：指定源端口</p></li><li><p><code>--tcp-fiags</code> ：<code>TCP</code> 的标志位（<code>SYN</code>、<code>ACK</code>、<code>FIN</code>、<code>PSH</code>、<code>RST</code> 、<code>URG</code>）<br>  对于它，一般要跟两个参数：</p><ul><li><p>   1.检查的标志位</p></li><li><p> 2.必须为1的标志位</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck">--<span class="hljs-comment">tcpflags</span> <span class="hljs-comment">syn</span><span class="hljs-string">,</span><span class="hljs-comment">ack</span><span class="hljs-string">,</span><span class="hljs-comment">fin</span><span class="hljs-string">,</span><span class="hljs-comment">rst</span> <span class="hljs-comment">syn</span>  <span class="hljs-comment">=</span>  --<span class="hljs-comment">syn</span><br><span class="hljs-comment">#</span> <span class="hljs-comment">表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的SYN为1的包，还有一种简写方式，叫做</span>--<span class="hljs-comment">syn</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><code>-p udp</code> ：<code>UDP</code> 协议的扩展<br>  <code>--dport</code><br> <code>--sport</code></p></li><li><p><code>-p icmp</code> ：<code>icmp</code> 数据报文的扩展<br>  <code>--icmp-type</code>：<br>  <code>echo-request</code> (请求回显)，一般用 <code>8</code> 来表示<br>   所以 <code>--icmp-type 8</code> 匹配请求回显数据包<br>   <code>echo-reply</code>（响应的数据包）一般用 <code>0</code> 来表示</p></li></ul></li></ol><h6>显式扩展（-m）</h6><p><strong>扩展各种模块</strong><br><code>-m multiport</code> ：表示启用多端口扩展 之后我们就可以启用比如 </p><p><code>--dports 21,23,80</code></p><blockquote><p><strong>限制收发包的状态</strong></p><p><code>--state</code> ：<code>INVALID</code>, <code>ESTABLISHED</code>, <code>NEW</code>, <code>RELATED or UNTRACKED</code>。</p><p>​        <code>NEW</code> ：新连接请求；</p><p>​        <code>ESTABLISHED</code> ：已建立的连接；</p><p>​        <code>INVALID</code> ：无法识别的连接；</p><p>​        <code>RELATED</code> ：相关联的连接，当前连接是一个新请求，但附属于某个已存在的连接；</p><p>​        <code>UNTRACKED</code> ：未追踪的连接；</p><p><strong>state扩展：</strong></p><p>内核模块装载：<br>　　<code>nf_conntrack</code><br>　　<code>nf_conntrack_ipv4</code></p><p>手动装载：<br>　　<code>nf_conntrack_ftp</code></p><p>追踪到的连接：<br>　　<code>/proc/net/nf_conntrack</code></p><p>调整可记录的连接数量最大值：<br>　　<code>/proc/sys/net/nf_conntrack_max</code></p><p>超时时长：<br>　　<code>/proc/sys/net/netfilter/*timeout*</code></p></blockquote><h3 id="二、IPTABLES-规则-Rules"><a href="#二、IPTABLES-规则-Rules" class="headerlink" title="二、IPTABLES 规则(Rules)"></a>二、IPTABLES 规则(Rules)</h3><p>牢记以下三点式理解 <code>iptables</code> 规则的关键：</p><ul><li><code>Rules</code>包括一个条件和一个目标(<code>target</code>) </li><li>如果满足条件，就执行目标(<code>target</code>)中的规则或者特定值。</li><li>如果不满足条件，就判断下一条<code>Rules</code>。</li></ul><p><strong>目标值（<code>Target Values</code>）</strong></p><p>下面是你可以在 <code>target</code> 里指定的特殊值：</p><ul><li><code>ACCEPT</code> – 允许防火墙接收数据包</li><li><code>DROP</code> – 防火墙丢弃包</li><li><code>QUEUE</code> – 防火墙将数据包移交到用户空间</li><li><code>RETURN</code> – 防火墙停止执行当前链中的后续<code>Rules</code>，并返回到调用链(<code>the calling chain</code>)中。</li></ul><p>如果你执行 <code>iptables --list</code>你将看到防火墙上的可用规则。下例说明当前系统没有定义防火墙，你可以看到，它显示了默认的<code>filter</code>表，以及表内默认的<code>input</code>链, <code>forward</code>链, <code>output</code>链。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables --list</span><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination <br></code></pre></td></tr></table></figure><p>查看 <code>nat</code> 表：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t nat --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain POSTROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure><p>查看 <code>mangle</code> 表：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t mangle --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain POSTROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure><p>查看 <code>raw</code> 表：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t raw --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure><blockquote><p>注意：如果不指定 <code>-t</code>选项，就只会显示默认的 <code>filter</code> 表。因此，以下两种命令形式是一个意思：</p></blockquote><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">iptables</span> <span class="hljs-title">[</span><span class="hljs-literal">-</span><span class="hljs-comment">t</span> <span class="hljs-comment">filter</span><span class="hljs-title">]</span> --<span class="hljs-comment">list</span> <span class="hljs-comment">/</span> <span class="hljs-comment">iptables</span>  --<span class="hljs-comment">list</span><br></code></pre></td></tr></table></figure><p>以下例子表明在 <code>filter</code> 表的 <code>input</code>链, <code>forward</code> 链, <code>output</code> 链中存在规则：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># iptables –list </span><br><span class="hljs-attribute">Chain</span> INPUT (policy ACCEPT) <br><span class="hljs-attribute">num</span>     target         prot   opt     source       destination <br><span class="hljs-attribute">1</span>  RH-Firewall-<span class="hljs-number">1</span>-INPUT   <span class="hljs-literal">all</span>    —     <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><br><span class="hljs-attribute">Chain</span> FORWARD (policy ACCEPT)<br><span class="hljs-attribute">num</span>     target         prot   opt     source       destination<br><span class="hljs-attribute">1</span>    RH-Firewall-<span class="hljs-number">1</span>-INPUT  <span class="hljs-literal">all</span>     –    <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><br><span class="hljs-attribute">Chain</span> OUTPUT (policy ACCEPT)<br><span class="hljs-attribute">num</span> target  prot opt source       destination<br><br><span class="hljs-attribute">Chain</span> RH-Firewall-<span class="hljs-number">1</span>-INPUT (<span class="hljs-number">2</span> references)<br><span class="hljs-attribute">num</span> target  prot opt source       destination<br><span class="hljs-attribute">1</span>  ACCEPT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">2</span>  ACCEPT  icmp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     icmp type <span class="hljs-number">255</span><br><span class="hljs-attribute">3</span>  ACCEPT  esp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">4</span>  ACCEPT  ah – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">5</span>  ACCEPT  udp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">224.0.0.251</span>    udp dpt:<span class="hljs-number">5353</span><br><span class="hljs-attribute">6</span>  ACCEPT  udp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     udp dpt:<span class="hljs-number">631</span><br><span class="hljs-attribute">7</span>  ACCEPT  tcp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     tcp dpt:<span class="hljs-number">631</span><br><span class="hljs-attribute">8</span>  ACCEPT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     state RELATED,ESTABLISHED<br><span class="hljs-attribute">9</span>  ACCEPT  tcp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     state NEW tcp dpt:<span class="hljs-number">22</span><br><span class="hljs-attribute">10</span> REJECT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     reject-with icmp-host-prohibited<br></code></pre></td></tr></table></figure><p>以上输出包含下列字段：</p><ul><li> <code>num</code> – 指定链中的规则编号</li><li><code>target</code> – 前面提到的 <code>target</code>的特殊值</li><li><code>prot</code> – 协议：<code>tcp</code>,<code>udp</code>,<code>icmp</code>等</li><li><code>source</code> – 数据包的源<code>IP</code>地址</li><li><code>destination</code> – 数据包的目标<code>IP</code>地址</li></ul><h3 id="三、清空所有iptables规则"><a href="#三、清空所有iptables规则" class="headerlink" title="三、清空所有iptables规则"></a>三、清空所有iptables规则</h3><p>在配置<code>iptables</code>之前，你通常需要用<code>iptables --list</code>命令或者<code>iptables --save</code>命令查看有无现存规则，因为有时需要删除现有的<code>iptables</code>规则：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">iptables</span> -<span class="hljs-function"><span class="hljs-title">F</span>(--<span class="hljs-variable">flush</span>)</span><br></code></pre></td></tr></table></figure><p>这两条命令是等效的。但是并非执行后就万事大吉了。你仍然需要检查规则是不是真的清空了，因为有的 <code>linux</code> 发行版上这个命令不会清除 <code>NAT</code> 表中的规则，此时只能手动清除：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">iptables [-t FILTER<span class="hljs-regexp">/NAT/</span>MANGLE/RAW] -F<br></code></pre></td></tr></table></figure><h3 id="四、永久生效"><a href="#四、永久生效" class="headerlink" title="四、永久生效"></a>四、永久生效</h3><p>当你删除、添加规则后，这些更改并不能永久生效，这些规则很有可能在系统重启后恢复原样。为了让配置永久生效，根据平台的不同，具体操作也不同。下面进行简单介绍：</p><h4 id="1-Ubuntu"><a href="#1-Ubuntu" class="headerlink" title="1.Ubuntu"></a>1.Ubuntu</h4><p>首先，保存现有的规则：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">iptables-save &gt; <span class="hljs-regexp">/etc/i</span>ptables.rules<br></code></pre></td></tr></table></figure><p>然后新建一个<code>bash</code>脚本，并保存到 <code>/etc/network/if-pre-up.d/</code>目录下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash </span><br>iptables-restore &lt; /etc/iptables.rules<br></code></pre></td></tr></table></figure><p>这样，每次系统重启后 <code>iptables</code> 规则都会被自动加载。</p><blockquote><p>注意：不要尝试在 <code>.bashrc</code> 或者 <code>.profile</code> 中执行以上命令，因为用户通常不是 <code>root</code>，而且这只能在登录时加载 <code>iptables</code>规则。</p></blockquote><h4 id="2-CentOS-RedHat"><a href="#2-CentOS-RedHat" class="headerlink" title="2.CentOS, RedHat"></a>2.CentOS, RedHat</h4><p>保存 <code>iptables</code> 规则 </p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">service iptables save</span><br></code></pre></td></tr></table></figure><p>重启 <code>iptables</code> 服务</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">service iptables <span class="hljs-literal">stop</span><br>service iptables <span class="hljs-literal">start</span><br></code></pre></td></tr></table></figure><p>查看当前规则：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/etc/</span>sysconfig/iptables<br></code></pre></td></tr></table></figure><h3 id="五、追加iptables规则"><a href="#五、追加iptables规则" class="headerlink" title="五、追加iptables规则"></a>五、追加iptables规则</h3><p>可以使用 <code>iptables -A</code> 命令追加新规则，其中 <code>-A</code> 表示 <code>Append</code>。因此， 新的规则将追加到链尾。</p><p>一般而言，最后一条规则用于丢弃(<code>DROP</code>)所有数据包。如果你已经有这样的规则了，并且使用  <code>-A</code> 参数添加新规则，那么就是无用功。</p><h4 id="1-语法"><a href="#1-语法" class="headerlink" title="1. 语法"></a>1. 语法</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">iptables -A chain firewall-<span class="hljs-keyword">rule</span><br>-A chain – 指定要追加规则的链<br>firewall-<span class="hljs-keyword">rule</span> – 具体的规则参数<br></code></pre></td></tr></table></figure><h4 id="2-描述规则的基本参数"><a href="#2-描述规则的基本参数" class="headerlink" title="2. 描述规则的基本参数"></a>2. 描述规则的基本参数</h4><p>以下这些规则参数用于描述数据包的协议、源地址、目的地址、允许经过的网络接口，以及如何处理这些数据包。这些描述是对规则的基本描述。</p><h5 id="p-协议（protocol）"><a href="#p-协议（protocol）" class="headerlink" title="-p 协议（protocol）"></a>-p 协议（protocol）</h5><ul><li>指定规则的协议，如<code>tcp</code>, <code>udp</code>, <code>icmp</code>等，可以使用<code>all</code>来指定所有协议。</li><li>如果不指定<code>-p</code>参数，则默认是<code>all</code>值。这并不明智，请总是明确指定协议名称。</li><li>可以使用协议名(如<code>tcp</code>)，或者是协议值（比如6代表<code>tcp</code>）来指定协议。映射关系请查看<code>/etc/protocols</code>。</li><li>还可以使用<code>--protocol</code>参数代替<code>-p</code>参数。</li></ul><h5 id="s-源地址（source）"><a href="#s-源地址（source）" class="headerlink" title="-s 源地址（source）"></a>-s 源地址（source）</h5><ul><li>指定数据包的源地址</li><li>参数可以使<code>IP</code>地址、网络地址、主机名</li><li>例如：<code>-s 192.168.1.101</code>指定IP地址</li><li>例如：<code>-s 192.168.1.10/24</code>指定网络地址</li><li>如果不指定<code>-s</code>参数，就代表所有地址</li><li>还可以使用<code>–src</code>或者<code>--source</code></li></ul><h5 id="d-目的地址（destination）"><a href="#d-目的地址（destination）" class="headerlink" title="-d 目的地址（destination）"></a>-d 目的地址（destination）</h5><ul><li>指定目的地址</li><li>参数和<code>-s</code>相同</li><li>还可以使用<code>–dst</code>或者<code>--destination</code></li></ul><h5 id="j-执行目标（jump-to-target）"><a href="#j-执行目标（jump-to-target）" class="headerlink" title="-j 执行目标（jump to target）"></a>-j 执行目标（jump to target）</h5><ul><li><code>-j</code>代表”<code>jump to target</code>”</li><li><code>-j</code>指定了当与规则(<code>Rule</code>)匹配时如何处理数据包</li><li>可能的值是<code>ACCEPT</code>, <code>DROP</code>, <code>QUEUE</code>, <code>RETURN</code>, <code>MASQUERADE</code></li><li>还可以指定其他链（<code>Chain</code>）作为目标</li><li>注：<code>MASQUERADE</code>，地址伪装，算是<code>snat</code>中的一种特例，可以实现自动化的<code>snat</code></li></ul><h5 id="i-输入接口（input-interface）"><a href="#i-输入接口（input-interface）" class="headerlink" title="-i 输入接口（input interface）"></a>-i 输入接口（input interface）</h5><ul><li><code>-i</code>代表输入接口(<code>input interface</code>)</li><li><code>-i</code>指定了要处理来自哪个接口的数据包</li><li>这些数据包即将进入<code>INPUT</code>, <code>FORWARD</code>, <code>PREROUTE</code>链</li><li>例如：<code>-i eth0</code>指定了要处理经由<code>eth0</code>进入的数据包</li><li>如果不指定<code>-i</code>参数，那么将处理进入所有接口的数据包</li><li>如果出现<code>! -i eth0</code>，那么将处理所有经由<code>eth0</code>以外的接口进入的数据包</li><li>如果出现<code>-i eth+</code>，那么将处理所有经由<code>eth开头的接口</code>进入的数据包</li><li>还可以使用<code>-in-interface</code>参数</li></ul><h5 id="o-输出（out-interface）"><a href="#o-输出（out-interface）" class="headerlink" title="-o 输出（out interface）"></a>-o 输出（out interface）</h5><ul><li><code>-o</code>代表<code>output interface</code></li><li><code>-o</code>指定了数据包由哪个接口输出</li><li>这些数据包即将进入<code>FORWARD</code>, <code>OUTPUT</code>, <code>POSTROUTING</code>链</li><li>如果不指定<code>-o</code>选项，那么系统上的所有接口都可以作为输出接口</li><li>如果出现<code>! -o eth0</code>，那么将从<code>eth0以外的接口</code>输出</li><li>如果出现<code>-i eth+</code>，那么将仅从<code>eth开头的接口</code>输出</li><li>还可以使用<code>-out-interface</code>参数</li></ul><h4 id="3-描述规则的扩展参数"><a href="#3-描述规则的扩展参数" class="headerlink" title="3. 描述规则的扩展参数"></a>3. 描述规则的扩展参数</h4><p>对规则有了一个基本描述之后，有时候我们还希望指定端口、<code>TCP</code>标志、<code>ICMP</code>类型等内容。</p><h5 id="–sport-源端口（source-port）针对-p-tcp-或者-p-udp"><a href="#–sport-源端口（source-port）针对-p-tcp-或者-p-udp" class="headerlink" title="–sport 源端口（source port）针对 -p tcp 或者 -p udp"></a>–sport 源端口（source port）针对 -p tcp 或者 -p udp</h5><ul><li>缺省情况下，将匹配所有端口</li><li>可以指定端口号或者端口名称，例如”<code>--sport 22</code>″与”<code>--sport ssh</code>”。</li><li><em>/etc/services</em>文件描述了上述映射关系。</li><li>从性能上讲，使用端口号更好</li><li>使用冒号可以匹配端口范围，如”<code>--sport 22:100</code>″</li><li>还可以使用”<code>--source-port</code>”</li></ul><h5 id="–dport-目的端口（destination-port）针对-p-tcp-或者-p-udp"><a href="#–dport-目的端口（destination-port）针对-p-tcp-或者-p-udp" class="headerlink" title="–dport 目的端口（destination port）针对-p tcp 或者 -p udp"></a>–dport 目的端口（destination port）针对-p tcp 或者 -p udp</h5><ul><li>参数和<code>--sport</code>类似</li><li>还可以使用”<code>--destination-port</code>”</li></ul><h5 id="–tcp-flags-TCP标志-针对-p-tcp"><a href="#–tcp-flags-TCP标志-针对-p-tcp" class="headerlink" title="–tcp-flags TCP标志 针对-p tcp"></a>–tcp-flags TCP标志 针对-p tcp</h5><ul><li>可以指定由逗号分隔的多个参数</li><li>有效值可以是：<code>SYN</code>,<code>ACK</code>, <code>FIN</code>, <code>RST</code>, <code>URG</code>, <code>PSH</code></li><li>可以使用<code>ALL</code>或者<code>NONE</code></li></ul><h5 id="–icmp-type-ICMP类型-针对-p-icmp"><a href="#–icmp-type-ICMP类型-针对-p-icmp" class="headerlink" title="–icmp-type ICMP类型 针对-p icmp"></a>–icmp-type ICMP类型 针对-p icmp</h5><ul><li><code>–icmp-type 0</code> 表示<code>Echo Reply</code></li><li><code>–icmp-type 8 </code> 表示<code>Echo</code></li></ul><h4 id="4-追加规则的完整实例：仅允许SSH服务"><a href="#4-追加规则的完整实例：仅允许SSH服务" class="headerlink" title="4. 追加规则的完整实例：仅允许SSH服务"></a>4. 追加规则的完整实例：仅允许SSH服务</h4><p>本例实现的规则将仅允许<code>SSH</code>数据包通过本地计算机，其他一切连接（包括<code>ping</code>）都将被拒绝。</p><h5 id="1-清空所有iptables规则"><a href="#1-清空所有iptables规则" class="headerlink" title="1. 清空所有iptables规则"></a>1. 清空所有iptables规则</h5><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -F</span><br></code></pre></td></tr></table></figure><h5 id="2-接收目标端口为22的数据包"><a href="#2-接收目标端口为22的数据包" class="headerlink" title="2. 接收目标端口为22的数据包"></a>2. 接收目标端口为22的数据包</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">i</span> eth0 -<span class="hljs-selector-tag">p</span> tcp --dport <span class="hljs-number">22</span> -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="3-拒绝所有其他数据包"><a href="#3-拒绝所有其他数据包" class="headerlink" title="3.拒绝所有其他数据包"></a>3.拒绝所有其他数据包</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -j DROP<br></code></pre></td></tr></table></figure><h3 id="六、更改默认策略"><a href="#六、更改默认策略" class="headerlink" title="六、更改默认策略"></a>六、更改默认策略</h3><p>上例的例子仅对接收的数据包过滤，而对于要发送出去的数据包却没有任何限制。本节主要介绍如何更改链策略，以改变链的行为。</p><h4 id="1-默认链策略"><a href="#1-默认链策略" class="headerlink" title="1. 默认链策略"></a>1. 默认链策略</h4><p><code>警告</code>：请勿在远程连接的服务器、虚拟机上测试！</p><p>当我们使用<code>-L</code>选项验证当前规则是发现，所有的链旁边都有 <code>policy ACCEPT</code>标注，这表明当前链的默认策略为<code>ACCEPT</code>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -L</span><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination <br></code></pre></td></tr></table></figure><p>这种情况下，如果没有明确添加DROP规则，那么默认情况下将采用ACCEPT策略进行过滤。除非：</p><h6 id="a-为以上三个链单独添加DROP规则："><a href="#a-为以上三个链单独添加DROP规则：" class="headerlink" title="a)为以上三个链单独添加DROP规则："></a>a)为以上三个链单独添加DROP规则：</h6><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -A <span class="hljs-meta">INPUT</span> -j <span class="hljs-meta">DROP</span> <br>iptables -A <span class="hljs-meta">OUTPUT</span> -j <span class="hljs-meta">DROP</span> <br>iptables -A FORWARD -j <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure><h6 id="b-更改默认策略："><a href="#b-更改默认策略：" class="headerlink" title="b)更改默认策略："></a>b)更改默认策略：</h6><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -P <span class="hljs-meta">INPUT</span> <span class="hljs-meta">DROP</span> <br>iptables -P <span class="hljs-meta">OUTPUT</span> <span class="hljs-meta">DROP</span> <br>iptables -P FORWARD <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure><p>糟糕！！如果你严格按照上一节的例子配置了<code>iptables</code>，并且现在使用的是<code>SSH</code>进行连接的，那么会话恐怕已经被迫终止了！</p><p>为什么呢？因为我们已经把<code>OUTPUT</code>链策略更改为<code>DROP</code>了。此时虽然服务器能接收数据，但是无法发送数据：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@test ~]#iptables -L <br>Chain <span class="hljs-keyword">INPUT</span> (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination <br>ACCEPT  tcp – anywhere      anywhere      tcp dpt:ssh <br><span class="hljs-keyword">DROP</span>   <span class="hljs-keyword">all</span> – anywhere      anywhere<br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination<br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination<br></code></pre></td></tr></table></figure><h3 id="七、配置应用程序规则"><a href="#七、配置应用程序规则" class="headerlink" title="七、配置应用程序规则"></a>七、配置应用程序规则</h3><h4 id="1-SSH"><a href="#1-SSH" class="headerlink" title="1. SSH"></a>1. SSH</h4><p>尽管已经介绍了如何初步限制除<code>SSH</code>以外的其他连接，但是那是在链默认策略为<code>ACCEPT</code>的情况下实现的，并且没有对输出数据包进行限 制。本节在上一节基础上，以<code>SSH</code>和<code>HTTP</code>所使用的端口为例，教大家如何在默认链策略为<code>DROP</code>的情况下，进行防火墙设置。在这里，我们将引进一种新的 参数<code>-m state</code>，并检查数据包的状态字段。</p><h5 id="1-1-允许接收远程主机的SSH请求"><a href="#1-1-允许接收远程主机的SSH请求" class="headerlink" title="1.1. 允许接收远程主机的SSH请求"></a>1.1. 允许接收远程主机的SSH请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="1-2-允许发送本地主机的SSH响应"><a href="#1-2-允许发送本地主机的SSH响应" class="headerlink" title="1.2. 允许发送本地主机的SSH响应"></a>1.2. 允许发送本地主机的SSH响应</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><ul><li><code>-m state</code>: 启用状态匹配模块（<code>state matching module</code>）</li><li><code>--state</code>: 状态匹配模块的参数。当<code>SSH</code>客户端第一个数据包到达服务器时，状态字段为<code>NEW</code>；建立连接后数据包的状态字段都是<code>ESTABLISHED</code></li><li><code>--sport 22</code>: <code>sshd</code>监听<code>22</code>端口，同时也通过该端口和客户端建立连接、传送数据。因此对于<code>SSH</code>服务器而言，源端口就是<code>22</code></li><li><code>--dport 22</code>: <code>ssh</code>客户端程序可以从本机的随机端口与<code>SSH</code>服务器的<code>22</code>端口建立连接。因此对于<code>SSH</code>客户端而言，目的端口就是<code>22</code></li></ul><p>如果服务器也需要使用<code>SSH</code>连接其他远程主机，则还需要增加以下配置：</p><h5 id="1-3-送出的数据包目的端口为22"><a href="#1-3-送出的数据包目的端口为22" class="headerlink" title="1.3. 送出的数据包目的端口为22"></a>1.3. 送出的数据包目的端口为22</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="1-4-接收的数据包源端口为22"><a href="#1-4-接收的数据包源端口为22" class="headerlink" title="1.4. 接收的数据包源端口为22"></a>1.4. 接收的数据包源端口为22</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h4 id="2-HTTP"><a href="#2-HTTP" class="headerlink" title="2. HTTP"></a>2. HTTP</h4><p><code>HTTP</code>的配置与<code>SSH</code>类似：</p><h5 id="1-允许接收远程主机的HTTP请求"><a href="#1-允许接收远程主机的HTTP请求" class="headerlink" title="1. 允许接收远程主机的HTTP请求"></a>1. 允许接收远程主机的HTTP请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="2-允许发送本地主机的HTTP响应"><a href="#2-允许发送本地主机的HTTP响应" class="headerlink" title="2. 允许发送本地主机的HTTP响应"></a>2. 允许发送本地主机的HTTP响应</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h4 id="3-完整的配"><a href="#3-完整的配" class="headerlink" title="3. 完整的配"></a>3. 完整的配</h4><h5 id="1-删除现有规则"><a href="#1-删除现有规则" class="headerlink" title="1. 删除现有规则"></a>1. 删除现有规则</h5><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -F</span><br></code></pre></td></tr></table></figure><h5 id="2-配置默认链策略"><a href="#2-配置默认链策略" class="headerlink" title="2. 配置默认链策略"></a>2. 配置默认链策略</h5><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -P <span class="hljs-meta">INPUT</span> <span class="hljs-meta">DROP</span><br>iptables -P FORWARD <span class="hljs-meta">DROP</span><br>iptables -P <span class="hljs-meta">OUTPUT</span> <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure><h5 id="3-允许远程主机进行SSH连接"><a href="#3-允许远程主机进行SSH连接" class="headerlink" title="3. 允许远程主机进行SSH连接"></a>3. 允许远程主机进行SSH连接</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="4-允许本地主机进行SSH连接"><a href="#4-允许本地主机进行SSH连接" class="headerlink" title="4. 允许本地主机进行SSH连接"></a>4. 允许本地主机进行SSH连接</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A INPUT -i eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><h5 id="5-允许HTTP请求"><a href="#5-允许HTTP请求" class="headerlink" title="5.允许HTTP请求"></a>5.允许HTTP请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure><p><code>iptables</code>命令是<code>Linux</code>上常用的防火墙软件，是<code>netfilter</code>项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。</p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>iptables</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx-配置详解</title>
    <link href="/posts/5c96f5b1/"/>
    <url>/posts/5c96f5b1/</url>
    
    <content type="html"><![CDATA[<h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><blockquote><footer><strong>https://www.cnblogs.com/knowledgesea/p/5175711.html 转载文章</strong></footer></blockquote><p><code>Nginx(engine x)</code> 是一个高性能的 <code>HTTP</code> 和反向代理 <code>Web</code> 服务器，同时也提供了 <code>IMAP/POP3/SMTP</code> 服务。<code>Nginx</code> 是由伊戈尔·赛索耶夫为俄罗斯访问量第二的 <code>Rambler.ru</code> 站点（俄文：<code>Рамблер</code> ）开发的，第一个公开版本 <code>0.1.0</code> 发布于 <code>2004</code> 年 <code>10</code> 月 <code>4</code> 日。</p><p>其将源代码以类 <code>BSD</code> 许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。<code>2011</code> 年 <code>6</code> 月 <code>1</code> 日，<code>nginx 1.0.4</code> 发布。</p><p><code>Nginx</code> 是一款轻量级的 <code>Web</code> 服务器/反向代理服务器及电子邮件（<code>IMAP/POP3</code>）代理服务器，在 <code>BSD-like</code> 协议下发行。其特点是占有内存少，并发能力强，事实上 <code>nginx</code> 的并发能力在同类型的网页服务器中表现较好。</p><h1 id="Nginx-常用功能"><a href="#Nginx-常用功能" class="headerlink" title="Nginx 常用功能"></a><code>Nginx</code> 常用功能</h1><p>1<strong>、<code>Http</code> 代理，反向代理：作为 <code>web</code> 服务器最常用的功能之一，尤其是反向代理。</strong></p><p>这里我给来 <code>2</code> 张图，对正向代理与反响代理做个诠释，具体细节，大家可以翻阅下资料。</p><p><img src="/img/blog_image/Linux_Nginx_contentImage/1_1.jpg"></p><p><code>Nginx</code> 在做反向代理时，提供性能稳定，并且能够提供配置灵活的转发功能。<code>Nginx</code> 可以根据不同的正则匹配，采取不同的转发策略，比如图片文件结尾的走文件服务器，动态页面走 <code>Web</code> 服务器，只要你正则写的没问题，又有相对应的服务器解决方案，你就可以随心所欲的玩。并且 <code>Nginx</code> 对返回结果进行错误页跳转，异常判断等。如果被分发的服务器存在异常，他可以将请求重新转发给另外一台服务器，然后自动去除异常服务器。</p><p><strong>2、负载均衡</strong></p><p><code>Nginx</code> 提供的负载均衡策略有 <code>2</code> 种：内置策略和扩展策略。内置策略为轮询，加权轮询，<code>Ip hash</code> 。扩展策略，就天马行空，只有你想不到的没有他做不到的啦，你可以参照所有的负载均衡算法，给他一一找出来做下实现。</p><p>上3个图，理解这三种负载均衡算法的实现</p><p><img src="/img/blog_image/Linux_Nginx_contentImage/2_1.jpg"></p><p><strong>3、web缓存</strong></p><p><code>Nginx</code> 可以对不同的文件做不同的缓存处理，配置灵活，并且支持<code>FastCGI_Cache</code>，主要用于对 <code>FastCGI</code> 的动态程序进行缓存。配合着第三方的<code>ngx_cache_purge</code> ，对制定的 <code>URL</code> 缓存内容可以的进行增删管理。</p><p><strong>4、<code>Nginx</code> 相关地址</strong></p><p>源码：<a href="https://trac.nginx.org/nginx/browser">https://trac.nginx.org/nginx/browser</a></p><p>官网：<a href="http://www.nginx.org/">http://www.nginx.org/</a></p><h1 id="Nginx-配置文件结构"><a href="#Nginx-配置文件结构" class="headerlink" title="Nginx 配置文件结构"></a><code>Nginx</code> 配置文件结构</h1><p>如果你下载好啦，你的安装文件，不妨打开 <code>conf</code> 文件夹的 <code>nginx.conf</code> 文件，<code>Nginx</code> 服务器的基础配置，默认的配置也存放在此。</p><p>在 <code>nginx.conf</code> 的注释符号位 <code>#</code></p><p><code>nginx</code> 文件的结构，这个对刚入门的同学，可以多看两眼。 </p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-comment">#pid        logs/nginx.pid;</span><br><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><br>    <span class="hljs-comment">#access_log  logs/access.log  main;</span><br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br><br>        <span class="hljs-comment">#charset koi8-r;</span><br><br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br><br>        <span class="hljs-attribute">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br><br>        <span class="hljs-comment">#error_page  404              /404.html;</span><br><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-attribute">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br><br>        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123;</span><br>        <span class="hljs-comment">#    proxy_pass   http://127.0.0.1;</span><br>        <span class="hljs-comment">#&#125;</span><br><br>        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ \.php$ &#123;</span><br>        <span class="hljs-comment">#    root           html;</span><br>        <span class="hljs-comment">#    fastcgi_pass   127.0.0.1:9000;</span><br>        <span class="hljs-comment">#    fastcgi_index  index.php;</span><br>        <span class="hljs-comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br>        <span class="hljs-comment">#    include        fastcgi_params;</span><br>        <span class="hljs-comment">#&#125;</span><br><br>        <span class="hljs-comment"># deny access to .htaccess files, if Apache&#x27;s document root</span><br>        <span class="hljs-comment"># concurs with nginx&#x27;s one</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment">#location ~ /\.ht &#123;</span><br>        <span class="hljs-comment">#    deny  all;</span><br>        <span class="hljs-comment">#&#125;</span><br>    &#125;<br><br><br>    <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123;</span><br>    <span class="hljs-comment">#    listen       8000;</span><br>    <span class="hljs-comment">#    listen       somename:8080;</span><br>    <span class="hljs-comment">#    server_name  somename  alias  another.alias;</span><br><br>    <span class="hljs-comment">#    location / &#123;</span><br>    <span class="hljs-comment">#        root   html;</span><br>    <span class="hljs-comment">#        index  index.html index.htm;</span><br>    <span class="hljs-comment">#    &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br><br><br>    <span class="hljs-comment"># HTTPS server</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#server &#123;</span><br>    <span class="hljs-comment">#    listen       443 ssl;</span><br>    <span class="hljs-comment">#    server_name  localhost;</span><br><br>    <span class="hljs-comment">#    ssl_certificate      cert.pem;</span><br>    <span class="hljs-comment">#    ssl_certificate_key  cert.key;</span><br><br>    <span class="hljs-comment">#    ssl_session_cache    shared:SSL:1m;</span><br>    <span class="hljs-comment">#    ssl_session_timeout  5m;</span><br><br>    <span class="hljs-comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br>    <span class="hljs-comment">#    ssl_prefer_server_ciphers  on;</span><br><br>    <span class="hljs-comment">#    location / &#123;</span><br>    <span class="hljs-comment">#        root   html;</span><br>    <span class="hljs-comment">#        index  index.html index.htm;</span><br>    <span class="hljs-comment">#    &#125;</span><br>    <span class="hljs-comment">#&#125;</span><br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>nginx</code> 文件结构</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nginx">...              #全局块<br><br><span class="hljs-section">events</span> &#123;         <span class="hljs-comment">#events块</span><br>   ...<br>&#125;<br><br><span class="hljs-attribute">http</span>      <span class="hljs-comment">#http块</span><br>&#123;<br>    ...   #http全局块<br>    <span class="hljs-attribute">server</span>        <span class="hljs-comment">#server块</span><br>    &#123; <br>        ...       #server全局块<br>        <span class="hljs-attribute">location</span> [PATTERN]   <span class="hljs-comment">#location块</span><br>        &#123;<br>            ...<br>        &#125;<br>        <span class="hljs-attribute">location</span> [PATTERN] <br>        &#123;<br>            ...<br>        &#125;<br>    &#125;<br>    server<br>    &#123;<br>      ...<br>    &#125;<br>    ...     #http全局块<br>&#125;<br></code></pre></td></tr></table></figure><p>1、全局块：配置影响 <code>nginx</code> 全局的指令。一般有运行 <code>nginx</code> 服务器的用户组，<code>nginx</code> 进程 <code>pid</code> 存放路径，日志存放路径，配置文件引入，允许生成<code>worker process</code> 数等。</p><p>2、<code>events</code> 块：配置影响 <code>nginx</code> 服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</p><p>3、<code>http</code> 块：可以嵌套多个 <code>server</code> ，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，<code>mime-type</code> 定义，日志自定义，是否使用 <code>sendfile</code> 传输文件，连接超时时间，单连接请求数等。</p><p>4、<code>server</code> 块：配置虚拟主机的相关参数，一个 <code>http</code> 中可以有多个 <code>server</code>。</p><p>5、<code>location</code> 块：配置请求的路由，以及各种页面的处理情况。</p><p>下面给大家上一个配置文件，作为理解，同时也配入我搭建的一台测试机中，给大家示例。 </p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">########### 每个指令必须有分号结束。#################</span><br><span class="hljs-comment">#user administrator administrators;  #配置用户或者组，默认为nobody nobody。</span><br><span class="hljs-comment">#worker_processes 2;  #允许生成的进程数，默认为1</span><br><span class="hljs-comment">#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址</span><br><span class="hljs-attribute">error_log</span> log/error.log <span class="hljs-literal">debug</span>;  <span class="hljs-comment">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">accept_mutex</span> <span class="hljs-literal">on</span>;   <span class="hljs-comment">#设置网路连接序列化，防止惊群现象发生，默认为on</span><br>    <span class="hljs-attribute">multi_accept</span> <span class="hljs-literal">on</span>;  <span class="hljs-comment">#设置一个进程是否同时接受多个网络连接，默认为off</span><br>    <span class="hljs-comment">#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span><br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;    <span class="hljs-comment">#最大连接数，默认为512</span><br>&#125;<br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;   <span class="hljs-comment">#文件扩展名与文件类型映射表</span><br>    <span class="hljs-attribute">default_type</span>  application/octet-stream; <span class="hljs-comment">#默认文件类型，默认为text/plain</span><br>    <span class="hljs-comment">#access_log off; #取消服务日志    </span><br>    <span class="hljs-attribute">log_format</span> myFormat <span class="hljs-string">&#x27;$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for&#x27;</span>; <span class="hljs-comment">#自定义格式</span><br>    <span class="hljs-attribute">access_log</span> log/access.log myFormat;  <span class="hljs-comment">#combined为日志格式的默认值</span><br>    <span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;   <span class="hljs-comment">#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span><br>    <span class="hljs-attribute">sendfile_max_chunk</span> <span class="hljs-number">100k</span>;  <span class="hljs-comment">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span><br>    <span class="hljs-attribute">keepalive_timeout</span> <span class="hljs-number">65</span>;  <span class="hljs-comment">#连接超时时间，默认为75s，可以在http，server，location块。</span><br><br>    <span class="hljs-attribute">upstream</span> mysvr &#123;   <br>      <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:7878</span>;<br>      <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.10.121:3333</span> backup;  <span class="hljs-comment">#热备</span><br>    &#125;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> https://www.baidu.com; <span class="hljs-comment">#错误页</span><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">keepalive_requests</span> <span class="hljs-number">120</span>; <span class="hljs-comment">#单连接请求上限次数。</span><br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">4545</span>;   <span class="hljs-comment">#监听端口</span><br>        <span class="hljs-attribute">server_name</span>  <span class="hljs-number">127.0.0.1</span>;   <span class="hljs-comment">#监听地址       </span><br>        <span class="hljs-attribute">location</span>  ~*^.+$ &#123;       <span class="hljs-comment">#请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span><br>           <span class="hljs-comment">#root path;  #根目录</span><br>           <span class="hljs-comment">#index vv.txt;  #设置默认页</span><br>           <span class="hljs-attribute">proxy_pass</span>  http://mysvr;  <span class="hljs-comment">#请求转向mysvr 定义的服务器列表</span><br>           <span class="hljs-attribute">deny</span> <span class="hljs-number">127.0.0.1</span>;  <span class="hljs-comment">#拒绝的ip</span><br>           <span class="hljs-attribute">allow</span> <span class="hljs-number">172.18.5.54</span>; <span class="hljs-comment">#允许的ip           </span><br>        &#125; <br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>一、上面是 <code>nginx</code> 的基本配置，需要注意的有以下几点：</p><p>​    1、<code>$remote_addr</code> 与 <code>$http_x_forwarded_for</code> 用以记录客户端的ip地址； </p><p>​    2、<code>$remote_user</code> ：用来记录客户端用户名称； </p><p>​    3、<code>$time_local</code> ： 用来记录访问时间与时区；</p><p>​    4、<code>$request</code> ： 用来记录请求的 <code>url</code> 与 <code>http</code> 协议；</p><p>​    5、<code>$status</code> ： 用来记录请求状态；成功是 <code>200</code>；</p><p>​    6、<code>$body_bytes_sent</code> ：记录发送给客户端文件主体内容大小；</p><p>​    7、<code>$http_referer</code> ：用来记录从那个页面链接访问过来的； </p><p>​    8、<code>$http_user_agent</code> ：记录客户端浏览器的相关信息；</p><p>二、惊群现象：一个网路连接到来，多个睡眠的进程被同事叫醒，但只有一个进程能获得链接，这样会影响系统性能。</p><p>3、每个指令必须有分号结束。</p><p><strong><font color=6633FF>未完待续…</font></strong></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes-二进制部署</title>
    <link href="/posts/4f0e9cbe/"/>
    <url>/posts/4f0e9cbe/</url>
    
    <content type="html"><![CDATA[<h1 id="二进制部署Kubernetes集群-上"><a href="#二进制部署Kubernetes集群-上" class="headerlink" title="二进制部署Kubernetes集群(上)"></a>二进制部署Kubernetes集群(上)</h1><blockquote><footer><strong>Jarvis的BLOG</strong><cite><a href="https://www.cnblogs.com/wangchaolinux/p/11875124.html">转载文章</a></cite></footer></blockquote><h2 id="1-实验架构"><a href="#1-实验架构" class="headerlink" title="1.实验架构"></a>1.实验架构</h2><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119205100565.png" alt="实验架构"></p><h3 id="1-1-硬件环境"><a href="#1-1-硬件环境" class="headerlink" title="1.1.硬件环境"></a>1.1.硬件环境</h3><p>准备5台2c/2g/50g虚拟机，使用10.4.7.0/24 网络 。//因后期要直接向k8s交付java服务，因此运算节点需要4c8g。不交付服务，全部2c2g足够。</p><h3 id="1-2-软件环境"><a href="#1-2-软件环境" class="headerlink" title="1.2.软件环境"></a>1.2.软件环境</h3><p>操作系统：预装CentOS7.6操作系统。//因docker完美支持对内核有需求，所有操作系统全部CentOS 7.x（需要内核3.8以上），做好系统基础优化。</p><p><strong>关闭selinux，关闭firewalld服务</strong><br><strong>时间同步（chronyd）</strong><br><strong>调整Base源，Epel源</strong><br><strong>内核优化（文件描述符大小，内核转发，等等）</strong></p><h3 id="1-3-IP及架构规划"><a href="#1-3-IP及架构规划" class="headerlink" title="1.3.IP及架构规划"></a>1.3.IP及架构规划</h3><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th><th>部署服务与组件</th><th>硬件配置</th></tr></thead><tbody><tr><td>hdss7-11.host.com</td><td>k8s proxy 主</td><td>10.4.7.11</td><td>bind9、nginx（L4）、keepalived、supervisor</td><td>2C 2G 50G</td></tr><tr><td>hdss7-12.host.com</td><td>k8s proxy 备</td><td>10.4.7.12</td><td>etcd、nginx（L4）、keepalived、supervisor</td><td>2C 2G 50G</td></tr><tr><td>hdss7-21.host.com</td><td>k8s 运算节点1</td><td>10.4.7.21</td><td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler kube-kubelet、kube-proxy，supervisor</td><td>4C 8G 50G</td></tr><tr><td>hdss7-22.host.com</td><td>k8s 运算节点2</td><td>10.4.7.22</td><td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler、kube-kubelet、kube-proxy，supervisor</td><td>4C 8G 50G</td></tr><tr><td>hdss7-200.host.com</td><td>k8s 运维节点，docker仓库</td><td>10.4.7.200</td><td>docker 私有仓库、资源配置清单仓库、提供共享存储（NFS）、签发证书</td><td>2C 2G 50G</td></tr></tbody></table><h2 id="2-基础环境准备及网络设置"><a href="#2-基础环境准备及网络设置" class="headerlink" title="2.基础环境准备及网络设置"></a>2.基础环境准备及网络设置</h2><h3 id="2-1-网络设置"><a href="#2-1-网络设置" class="headerlink" title="2.1.网络设置"></a>2.1.网络设置</h3><h4 id="2-1-1-VM虚拟网络编辑器设置"><a href="#2-1-1-VM虚拟网络编辑器设置" class="headerlink" title="2.1.1.VM虚拟网络编辑器设置"></a>2.1.1.VM虚拟网络编辑器设置</h4><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119205830113.png" alt="VM虚拟网络编辑器设置"></p><h4 id="2-1-2-Windows网卡设置"><a href="#2-1-2-Windows网卡设置" class="headerlink" title="2.1.2.Windows网卡设置"></a>2.1.2.Windows网卡设置</h4><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119210222054.png" alt="Windows网卡设置"></p><h3 id="2-2-虚拟机操作系统设置"><a href="#2-2-虚拟机操作系统设置" class="headerlink" title="2.2.虚拟机操作系统设置"></a>2.2.虚拟机操作系统设置</h3><h4 id="2-2-1-设置主机名"><a href="#2-2-1-设置主机名" class="headerlink" title="2.2.1.设置主机名"></a>2.2.1.设置主机名</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">~]# hostnamectl <span class="hljs-keyword">set</span>-<span class="hljs-built_in">hostname</span> hdss7-xx.host.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><h4 id="2-2-2-关闭防火墙和selinux"><a href="#2-2-2-关闭防火墙和selinux" class="headerlink" title="2.2.2.关闭防火墙和selinux"></a>2.2.2.关闭防火墙和selinux</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~]# systemctl stop firewalld<br>~]# systemctl disable firewalld<br>~]# setenforce <span class="hljs-number">0</span><br>~]# sed –i ‘s<span class="hljs-regexp">/SELINUX=enforcing/</span>SELINUX=disabled<span class="hljs-regexp">/g’ /</span>etc<span class="hljs-regexp">/selinux/</span>config<br></code></pre></td></tr></table></figure><h4 id="2-2-3-设置网卡"><a href="#2-2-3-设置网卡" class="headerlink" title="2.2.3.设置网卡"></a>2.2.3.设置网卡</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0 <br><span class="hljs-attribute">TYPE</span>=Ethernet<br><span class="hljs-attribute">BOOTPROTO</span>=none<br><span class="hljs-attribute">NAME</span>=eth0<br><span class="hljs-attribute">DEVICE</span>=eth0<br><span class="hljs-attribute">ONBOOT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPADDR</span>=10.4.7.xx<br><span class="hljs-attribute">NETMASK</span>=255.255.255.0<br><span class="hljs-attribute">GATEWAY</span>=10.4.7.254<br><span class="hljs-attribute">DNS1</span>=10.4.7.xx<br></code></pre></td></tr></table></figure><h4 id="2-2-4-设置yum源"><a href="#2-2-4-设置yum源" class="headerlink" title="2.2.4.设置yum源"></a>2.2.4.设置yum源</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~]# yum install epel-release<br>或者<br>~]# wget -O <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/CentOS-Base.repo  http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>repo/Centos-<span class="hljs-number">7</span>.repo<br>~]# wget -O <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/epel.repo  http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>repo/epel-<span class="hljs-number">7</span>.repo<br>~]# yum clean all<br>~]# yum makecache<br></code></pre></td></tr></table></figure><h4 id="2-2-5-安装常用工具"><a href="#2-2-5-安装常用工具" class="headerlink" title="2.2.5.安装常用工具"></a>2.2.5.安装常用工具</h4><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">~]# yum install wget <span class="hljs-built_in">net</span>-tools telnet <span class="hljs-built_in">tree</span> nmap sysstat lrzsz dos2unix bind-utils -y<br></code></pre></td></tr></table></figure><h3 id="2-3安装bind服务"><a href="#2-3安装bind服务" class="headerlink" title="2.3安装bind服务"></a>2.3安装bind服务</h3>            <input type="checkbox" disabled checked="checked">主节点hdss7-11.host.com 上          <h4 id="2-3-1-安装bind-9"><a href="#2-3-1-安装bind-9" class="headerlink" title="2.3.1.安装bind 9"></a>2.3.1.安装bind 9</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">~]#</span><span class="bash"> yum install <span class="hljs-built_in">bind</span> -y</span><br></code></pre></td></tr></table></figure><h4 id="2-3-2-配置bind-9"><a href="#2-3-2-配置bind-9" class="headerlink" title="2.3.2.配置bind 9"></a>2.3.2.配置bind 9</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs clean"><span class="hljs-comment">//主配置文件</span><br>~]# vi /etc/named.conf<br>listen-on port <span class="hljs-number">53</span> &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;; <br>allow-query     &#123; any; &#125;;<br>forwarders      &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.254</span>; &#125;;<br>recursion yes;<br>dnssec-enable no;<br>dnssec-validation no<br><br>##########参数说明#########<br>* dnssec-enable yes; ----&gt; dnssec-enable no; # 是否支持DNSSEC开关 PS：dnssec作用：<span class="hljs-number">1.</span>为DNS数据提供来源验证 <span class="hljs-number">2.</span>为数据提供完整性性验证 <span class="hljs-number">3.</span>为查询提供否定存在验证<br>* dnssec-validation yes; ----&gt; dnssec-validation no; #是否进行DNSSEC确认开关<br>* forwarders      &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.1</span>; &#125;; #用来指定上一层DNS地址，一般指定网关，确保服务能够访问公网<br>* listen-on-v6 port <span class="hljs-number">53</span> &#123; ::<span class="hljs-number">1</span>; &#125;; 如果不用IPV6，可以删除<br>*recursion 递归查询<br>#########################<br><br>~]# named-checkconf<br><br><span class="hljs-comment">//区域配置文件</span><br>~]# vi /etc/named.rfc1912.zones<br>zone <span class="hljs-string">&quot;host.com&quot;</span> IN &#123;<br>        type  master;<br>        file  <span class="hljs-string">&quot;host.com.zone&quot;</span>;<br>        allow-update &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;;<br>&#125;;<br><br>zone <span class="hljs-string">&quot;od.com&quot;</span> IN &#123;<br>        type  master;<br>        file  <span class="hljs-string">&quot;od.com.zone&quot;</span>;<br>        allow-update &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;;<br>&#125;;<br><br><span class="hljs-comment">//配置区域数据文件</span><br>    <span class="hljs-number">1.</span>配置主机域数据文件<br>~]# vi  /var/named/host.com.zone<br>$ORIGIN host.com.<br>$TTL <span class="hljs-number">600</span>; <span class="hljs-number">10</span> minutes<br>@       IN SOAdns.host.com. dnsadmin.host.com. (<br><span class="hljs-number">2019111001</span> ; serial<br><span class="hljs-number">10800</span>      ; refresh (<span class="hljs-number">3</span> hours)<br><span class="hljs-number">900</span>        ; retry (<span class="hljs-number">15</span> minutes)<br><span class="hljs-number">604800</span>     ; expire (<span class="hljs-number">1</span> week)<br><span class="hljs-number">86400</span>      ; minimum (<span class="hljs-number">1</span> day)<br>)<br>NS   dns.host.com.<br>$TTL <span class="hljs-number">60</span>; <span class="hljs-number">1</span> minute<br>dns                A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br>HDSS7<span class="hljs-number">-11</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br>HDSS7<span class="hljs-number">-12</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.12</span><br>HDSS7<span class="hljs-number">-21</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.21</span><br>HDSS7<span class="hljs-number">-22</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.22</span><br>HDSS7<span class="hljs-number">-200</span>          A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span>  <br>    <span class="hljs-number">2.</span>配置业务域数据文件<br>~]# vi  /var/named/od.com.zone<br>$ORIGIN od.com.<br>$TTL <span class="hljs-number">600</span>; <span class="hljs-number">10</span> minutes<br>@   IN SOAdns.od.com. dnsadmin.od.com. (<br><span class="hljs-number">2019111001</span> ; serial<br><span class="hljs-number">10800</span>      ; refresh (<span class="hljs-number">3</span> hours)<br><span class="hljs-number">900</span>        ; retry (<span class="hljs-number">15</span> minutes)<br><span class="hljs-number">604800</span>     ; expire (<span class="hljs-number">1</span> week)<br><span class="hljs-number">86400</span>      ; minimum (<span class="hljs-number">1</span> day)<br>)<br>NS   dns.od.com.<br>$TTL <span class="hljs-number">60</span>; <span class="hljs-number">1</span> minute<br>dns                A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>    <br></code></pre></td></tr></table></figure><h4 id="2-3-3-检查配置并启动bind-9"><a href="#2-3-3-检查配置并启动bind-9" class="headerlink" title="2.3.3.检查配置并启动bind 9"></a>2.3.3.检查配置并启动bind 9</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir">~]<span class="hljs-comment"># named-checkconf</span><br>~]<span class="hljs-comment"># systemctl start named</span><br>~]<span class="hljs-comment"># netstat -nltup|grep 53</span><br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><span class="hljs-symbol">:</span><span class="hljs-number">53</span>            0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">953</span>           0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">53</span>                   ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp6       0      0 ::<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">953</span>                 ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">18279</span>/named         <br>udp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><span class="hljs-symbol">:</span><span class="hljs-number">53</span>            0.0.0.0<span class="hljs-symbol">:*</span>                           <span class="hljs-number">18279</span>/named         <br>udp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">53</span>                   ::<span class="hljs-symbol">:*</span>                                <span class="hljs-number">18279</span>/named <br></code></pre></td></tr></table></figure><h4 id="2-3-4-检查"><a href="#2-3-4-检查" class="headerlink" title="2.3.4.检查"></a>2.3.4.检查</h4><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">21</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span> +short<br><span class="hljs-number">10.4.7.21</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">200</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.200</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">11</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.11</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A dns.od.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.11</span><br></code></pre></td></tr></table></figure><h4 id="2-3-5-配置DNS客户端"><a href="#2-3-5-配置DNS客户端" class="headerlink" title="2.3.5.配置DNS客户端"></a>2.3.5.配置DNS客户端</h4><h5 id="linux主机所有"><a href="#linux主机所有" class="headerlink" title="linux主机所有"></a>linux主机所有</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-11</span> ~]# vi /etc/resolv.conf <br># <span class="hljs-keyword">Generated</span> <span class="hljs-keyword">by</span> NetworkManager<br><span class="hljs-keyword">search</span> host.com<br>nameserver <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br><br>~] systemctl <span class="hljs-keyword">restart</span> network 五台都设置重启<br></code></pre></td></tr></table></figure><h5 id="windows主机"><a href="#windows主机" class="headerlink" title="windows主机"></a>windows主机</h5><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">更改适配器设置  → 属性 → ipv4 → 更改dns <br>自动跃点 10 优先从vmnet 8出网<br></code></pre></td></tr></table></figure><h4 id="2-3-6-检查"><a href="#2-3-6-检查" class="headerlink" title="2.3.6.检查"></a>2.3.6.检查</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">~]<span class="hljs-comment"># ping hdss7-200.host.com</span><br>~]<span class="hljs-comment"># ping dns.od.com</span><br><span class="hljs-comment">#若windows ping不到，把本地网卡dns设置成10.4.7.11</span><br></code></pre></td></tr></table></figure><h3 id="2-4-准备签发证书环境"><a href="#2-4-准备签发证书环境" class="headerlink" title="2.4.准备签发证书环境"></a>2.4.准备签发证书环境</h3>            <input type="checkbox" disabled checked="checked">运维主机hdss7-200.host.com 上          <h4 id="2-4-1-安装CFSSL"><a href="#2-4-1-安装CFSSL" class="headerlink" title="2.4.1.安装CFSSL"></a>2.4.1.安装CFSSL</h4><p><strong>证书签发工具CFSSL：R1.2</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">HDSS7<span class="hljs-number">-200</span>上:<br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl          //cfssl下载地址</span></span><br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json    //cfssl-json下载地址</span></span><br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo     //cfssl-certinfo下载地址</span></span><br>~]<span class="hljs-meta"># chmod +x /usr/bin/cfssl*</span><br></code></pre></td></tr></table></figure><h4 id="2-4-2-创建生成CA证书签名请求（csr）的json配置文件"><a href="#2-4-2-创建生成CA证书签名请求（csr）的json配置文件" class="headerlink" title="2.4.2.创建生成CA证书签名请求（csr）的json配置文件"></a>2.4.2.创建生成CA证书签名请求（csr）的json配置文件</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs clean">vi  /opt/certs/ca-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;OldboyEdu&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-string">&quot;ca&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span><br>    &#125;<br>&#125;<br><br>##############配置说明###########<br>CN：Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名，很重要，浏览器使用该字段验证网站是否合法<br>C：Country 国家<br>ST：State 州，省<br>L：Locality 地区，城市<br>O：Organization Name 组织名称，公司名称<br>OU：Organization Unit Name 组织单位名称，部门<br></code></pre></td></tr></table></figure><h4 id="2-4-3-生成CA证书和私钥"><a href="#2-4-3-生成CA证书和私钥" class="headerlink" title="2.4.3.生成CA证书和私钥"></a>2.4.3.生成CA证书和私钥</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs clean">mkdir /opt/certs<br>cd /opt/certs<br>certs]#  cfssl gencert -initca ca-csr.json | cfssl-json -bare ca<br>certs]# ll<br>ca.csr  <br>ca-csr.json  <br>ca-key.pem                                 <span class="hljs-comment">//根证书的私钥  </span><br>ca.pem                                      <span class="hljs-comment">//根证书</span><br>##########<br>ca.pem     <span class="hljs-comment">//根证书</span><br>ca-key.pem:<br></code></pre></td></tr></table></figure><h3 id="2-5-部署docker环境"><a href="#2-5-部署docker环境" class="headerlink" title="2.5.部署docker环境"></a>2.5.部署docker环境</h3>            <input type="checkbox" disabled checked="checked">hdss7-200.host.com 上                      <input type="checkbox" disabled checked="checked">hdss7-21.host.com 上                      <input type="checkbox" disabled checked="checked">hdss7-22.host.com 上          <h4 id="2-5-1-安装"><a href="#2-5-1-安装" class="headerlink" title="2.5.1.安装"></a>2.5.1.安装</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> ~]<span class="hljs-comment"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><br><span class="hljs-comment"># Executing docker install script, commit: f45d7c11389849ff46a6b4d94e0dd1ffebca32c1</span><br>+ sh -c <span class="hljs-string">&#x27;yum install -y -q yum-utils&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&#x27;</span><br>Loaded plugins: fastestmirror<br>adding repo from: https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo<br>grabbing file https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo to <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br>repo saved to <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br>+ <span class="hljs-string">&#x27;[&#x27;</span> stable <span class="hljs-string">&#x27;!=&#x27;</span> stable <span class="hljs-string">&#x27;]&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum makecache&#x27;</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: mirrors.aliyun.com<br>base                                                                                                   | <span class="hljs-number">3.6</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>docker-ce-stable                                                                                       | <span class="hljs-number">3.5</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>epel                                                                                                   | <span class="hljs-number">5.4</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>extras                                                                                                 | <span class="hljs-number">2.9</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>updates                                                                                                | <span class="hljs-number">2.9</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">1</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/updateinfo                                                             |   <span class="hljs-number">55</span> B  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">2</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/filelists_db                                                           |  <span class="hljs-number">18</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">3</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/primary_db                                                             |  <span class="hljs-number">37</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">4</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/other_db                                                               | <span class="hljs-number">111</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">5</span><span class="hljs-regexp">/14): epel/</span>x86_64/prestodelta                                                                        | <span class="hljs-number">4.0</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">6</span><span class="hljs-regexp">/14): base/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                         | <span class="hljs-number">2.6</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">7</span><span class="hljs-regexp">/14): epel/</span>x86_64/other_db                                                                           | <span class="hljs-number">3.3</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">02</span>     <br>(<span class="hljs-number">8</span><span class="hljs-regexp">/14): extras/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                       | <span class="hljs-number">100</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">9</span><span class="hljs-regexp">/14): extras/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                   | <span class="hljs-number">207</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">10</span><span class="hljs-regexp">/14): updates/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                     | <span class="hljs-number">243</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">11</span><span class="hljs-regexp">/14): epel/</span>x86_64/updateinfo_zck                                                                    | <span class="hljs-number">1.5</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">12</span><span class="hljs-regexp">/14): updates/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                 | <span class="hljs-number">2.1</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">13</span><span class="hljs-regexp">/14): base/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                    | <span class="hljs-number">7.3</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">04</span>     <br>(<span class="hljs-number">14</span><span class="hljs-regexp">/14): epel/</span>x86_64/filelists_db                                                                      |  <span class="hljs-number">12</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span>     <br>Metadata Cache Created<br>+ <span class="hljs-string">&#x27;[&#x27;</span> -n <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-string">&#x27;]&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum install -y -q docker-ce&#x27;</span><br>warning: <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/yum/</span>x86_64<span class="hljs-regexp">/7/</span>docker-ce-stable<span class="hljs-regexp">/packages/</span>docker-ce-<span class="hljs-number">19.03</span>.<span class="hljs-number">5</span>-<span class="hljs-number">3</span>.el7.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID <span class="hljs-number">621</span>e9f35: NOKEY<br>Public key <span class="hljs-keyword">for</span> docker-ce-<span class="hljs-number">19.03</span>.<span class="hljs-number">5</span>-<span class="hljs-number">3</span>.el7.x86_64.rpm is not installed<br>Importing GPG key <span class="hljs-number">0</span>x621E9F35:<br> Userid     : <span class="hljs-string">&quot;Docker Release (CE rpm) &lt;docker@docker.com&gt;&quot;</span><br> Fingerprint: <span class="hljs-number">060</span>a <span class="hljs-number">61</span>c5 <span class="hljs-number">1</span>b55 <span class="hljs-number">8</span>a7f <span class="hljs-number">742</span>b <span class="hljs-number">77</span>aa c52f eb6b <span class="hljs-number">621</span>e <span class="hljs-number">9</span>f35<br> From       : https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/g</span>pg<br>setsebool:  SELinux is disabled.<br>If you would like to use Docker as a non-root user, you should now consider<br>adding your user to the <span class="hljs-string">&quot;docker&quot;</span> group with something like:<br><br>  sudo usermod -aG docker your-user<br><br>Remember that you will have to log out and back <span class="hljs-keyword">in</span> <span class="hljs-keyword">for</span> this to take effect!<br><br>WARNING: Adding a user to the <span class="hljs-string">&quot;docker&quot;</span> group will grant the ability to run<br>         containers which can be used to obtain root privileges on the<br>         docker host.<br>         Refer to https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>security<span class="hljs-regexp">/security/</span><span class="hljs-comment">#docker-daemon-attack-surface</span><br>         <span class="hljs-keyword">for</span> more information.<br></code></pre></td></tr></table></figure><p>报错：<br><img src="/img/blog_image/Linux_k8S_Bin_contentImage/error.png" alt="报错"></p><p>解决：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -f  <span class="hljs-regexp">/etc/yum</span>.repos.d/local.repo   <span class="hljs-comment">#再重新安装</span><br></code></pre></td></tr></table></figure><h4 id="2-5-2-配置"><a href="#2-5-2-配置" class="headerlink" title="2.5.2.配置"></a>2.5.2.配置</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">mkdir  /etc/docker<br>vi  /etc/docker/daemon.json<br>&#123;<br>  <span class="hljs-string">&quot;graph&quot;</span>: <span class="hljs-string">&quot;/data/docker&quot;</span>,<br>  <span class="hljs-string">&quot;storage-driver&quot;</span>: <span class="hljs-string">&quot;overlay2&quot;</span>,<br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;registry.access.redhat.com&quot;</span>,<span class="hljs-string">&quot;quay.io&quot;</span>,<span class="hljs-string">&quot;harbor.od.com&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;</span>],<br>  <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;172.7.21.1/24&quot;</span>,<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;live-restore&quot;</span>: true<br>&#125;<br>############配置说明###############<br>bip要根据宿主机ip变化 <br>注意：hdss7<span class="hljs-number">-21.</span>host.com   bip <span class="hljs-number">172.7</span><span class="hljs-number">.21</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>     hdss7<span class="hljs-number">-22.</span>host.com   bip <span class="hljs-number">172.7</span><span class="hljs-number">.22</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>     hdss7<span class="hljs-number">-200.</span>host.com  bip <span class="hljs-number">172.7</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>#################################<br></code></pre></td></tr></table></figure><h4 id="2-5-3-启动"><a href="#2-5-3-启动" class="headerlink" title="2.5.3.启动"></a>2.5.3.启动</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">docker]#</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">/data/docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">start</span> <span class="hljs-string">docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">enable</span> <span class="hljs-string">docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">docker</span> <span class="hljs-string">--version</span><br><span class="hljs-string">Docker</span> <span class="hljs-string">version</span> <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><span class="hljs-string">,</span> <span class="hljs-string">build</span> <span class="hljs-string">9013bf583a</span><br>[<span class="hljs-string">root@hdss7-200</span> <span class="hljs-string">docker</span>]<span class="hljs-comment"># docker version</span><br><span class="hljs-attr">Client:</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Engine</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Community</span><br> <span class="hljs-attr">Version:</span>           <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><br> <span class="hljs-attr">API version:</span>       <span class="hljs-number">1.40</span><br> <span class="hljs-attr">Go version:</span>        <span class="hljs-string">go1.12.10</span><br> <span class="hljs-attr">Git commit:</span>        <span class="hljs-string">9013bf583a</span><br> <span class="hljs-attr">Built:</span>             <span class="hljs-string">Fri</span> <span class="hljs-string">Oct</span> <span class="hljs-number">18</span> <span class="hljs-number">15</span><span class="hljs-string">:52:22</span> <span class="hljs-number">2019</span><br> <span class="hljs-attr">OS/Arch:</span>           <span class="hljs-string">linux/amd64</span><br> <span class="hljs-attr">Experimental:</span>      <span class="hljs-literal">false</span><br><br><span class="hljs-attr">Server:</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Engine</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Community</span><br> <span class="hljs-attr">Engine:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">19.03</span><span class="hljs-number">.5</span><br>  <span class="hljs-attr">API version:</span>      <span class="hljs-number">1.40</span> <span class="hljs-string">(minimum</span> <span class="hljs-string">version</span> <span class="hljs-number">1.12</span><span class="hljs-string">)</span><br>  <span class="hljs-attr">Go version:</span>       <span class="hljs-string">go1.12.12</span><br>  <span class="hljs-attr">Git commit:</span>       <span class="hljs-string">633a0ea</span><br>  <span class="hljs-attr">Built:</span>            <span class="hljs-string">Wed</span> <span class="hljs-string">Nov</span> <span class="hljs-number">13</span> <span class="hljs-number">07</span><span class="hljs-string">:24:18</span> <span class="hljs-number">2019</span><br>  <span class="hljs-attr">OS/Arch:</span>          <span class="hljs-string">linux/amd64</span><br>  <span class="hljs-attr">Experimental:</span>     <span class="hljs-literal">false</span><br> <span class="hljs-attr">containerd:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">1.2</span><span class="hljs-number">.10</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">b34a5c8af56e510852c35414db4c1f4fa6172339</span><br> <span class="hljs-attr">runc:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-string">-rc8+dev</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br> <span class="hljs-attr">docker-init:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">0.18</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">fec3683</span><br></code></pre></td></tr></table></figure><h3 id="2-6-部署docker镜像私有仓库harbor"><a href="#2-6-部署docker镜像私有仓库harbor" class="headerlink" title="2.6.部署docker镜像私有仓库harbor"></a>2.6.部署docker镜像私有仓库harbor</h3>            <input type="checkbox" disabled checked="checked">运维主机hdss7-200.host.com 上          <h4 id="2-6-1-下载软件二进制包并解压"><a href="#2-6-1-下载软件二进制包并解压" class="headerlink" title="2.6.1.下载软件二进制包并解压"></a>2.6.1.下载软件二进制包并解压</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vim">强烈建议下载<span class="hljs-number">1.7</span>.<span class="hljs-number">5</span>以上版本<br>harbor官网github地址<br>http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/goharbor/harbor<br><br>src]# tar xf harbor-offline-installer-v1.<span class="hljs-number">8.3</span>.tgz -C /<span class="hljs-keyword">opt</span>/<br><span class="hljs-keyword">opt</span>]# mv harbor/ harbor-v1.<span class="hljs-number">8.3</span><br><span class="hljs-keyword">opt</span>]# <span class="hljs-keyword">ln</span> -s /<span class="hljs-keyword">opt</span>/harbor-v1.<span class="hljs-number">8.3</span>/ /<span class="hljs-keyword">opt</span>/harbor<br></code></pre></td></tr></table></figure><h4 id="2-6-2-配置"><a href="#2-6-2-配置" class="headerlink" title="2.6.2.配置"></a>2.6.2.配置</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts">[root@hdss7<span class="hljs-number">-200</span> opt]<span class="hljs-meta"># vi /opt/harbor/harbor.yml</span><br><span class="hljs-symbol">hostname:</span> harbor.od.com<br><span class="hljs-symbol">http:</span><br><span class="hljs-symbol">  port:</span> <span class="hljs-number">180</span><br><span class="hljs-symbol"> harbor_admin_password:</span>Harbor12345<br><span class="hljs-symbol">data_volume:</span> <span class="hljs-meta-keyword">/data/</span>harbor<br><span class="hljs-symbol">log:</span><br><span class="hljs-symbol">    level:</span>  info<br><span class="hljs-symbol">    rotate_count:</span>  <span class="hljs-number">50</span><br><span class="hljs-symbol">    rotate_size:</span><span class="hljs-number">200</span>M<br><span class="hljs-symbol">    location:</span> <span class="hljs-meta-keyword">/data/</span>harbor/logs<br><br>[root@hdss7<span class="hljs-number">-200</span> opt]<span class="hljs-meta"># mkdir -p /data/harbor/logs</span><br></code></pre></td></tr></table></figure><h4 id="2-6-3-安装docker-compose"><a href="#2-6-3-安装docker-compose" class="headerlink" title="2.6.3.安装docker-compose"></a>2.6.3.安装docker-compose</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> <span class="hljs-keyword">opt</span>]# yum install docker-compose -<span class="hljs-keyword">y</span><br>Loaded plugin<span class="hljs-variable">s:</span> fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.<span class="hljs-keyword">com</span><br> * extra<span class="hljs-variable">s:</span> mirrors.aliyun.<span class="hljs-keyword">com</span><br> * <span class="hljs-keyword">update</span><span class="hljs-variable">s:</span> mirrors.aliyun.<span class="hljs-keyword">com</span><br>Package docker-compose-<span class="hljs-number">1.18</span>.<span class="hljs-number">0</span>-<span class="hljs-number">4</span>.el7.noarch already installed <span class="hljs-built_in">and</span> latest <span class="hljs-keyword">version</span><br>Nothing <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span><br></code></pre></td></tr></table></figure><h4 id="2-6-4-安装harbor"><a href="#2-6-4-安装harbor" class="headerlink" title="2.6.4.安装harbor"></a>2.6.4.安装harbor</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs gams">[root@hdss7<span class="hljs-number">-200</span> harbor]# ./install.sh <br><br>[Step <span class="hljs-number">0</span>]: checking installation environment ...<br><br>Note: docker version: <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><br><br>Note: docker-compose version: <span class="hljs-number">1.18</span><span class="hljs-number">.0</span><br>................<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-portal ... done<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> nginx ... done<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> registry ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> registryctl ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-db ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> redis ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-core ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-portal ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-jobservice ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> nginx ... <br><br>?.----Harbor has been installed <span class="hljs-keyword">and</span> started successfully.----<br><br>Now you should be able to visit the admin portal at http:<span class="hljs-comment">//harbor.od.com. </span><br><span class="hljs-keyword">For</span> more details, please visit https:<span class="hljs-comment">//github.com/goharbor/harbor .</span><br></code></pre></td></tr></table></figure><h4 id="2-6-5-检查harbor启动情况"><a href="#2-6-5-检查harbor启动情况" class="headerlink" title="2.6.5.检查harbor启动情况"></a>2.6.5.检查harbor启动情况</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs stata">[root@hdss7-200 harbor]# docker-compose ps                     <span class="hljs-comment">//docker给起了一堆容器，单机编排</span><br>      Name                     Command               State             Ports          <br>--------------------------------------------------------------------------------------<br>harbor-core         /harbor/start.<span class="hljs-keyword">sh</span>                 Up                               <br>harbor-<span class="hljs-keyword">db</span>           /entrypoint.<span class="hljs-keyword">sh</span> postgres          Up      5432/tcp                 <br>harbor-jobservice   /harbor/start.<span class="hljs-keyword">sh</span>                 Up                               <br>harbor-<span class="hljs-keyword">log</span>          /bin/<span class="hljs-keyword">sh</span> -c /usr/<span class="hljs-keyword">local</span>/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp<br>harbor-portal       nginx -<span class="hljs-keyword">g</span> daemon off;             Up      80/tcp                   <br>nginx               nginx -<span class="hljs-keyword">g</span> daemon off;             Up      0.0.0.0:180-&gt;80/tcp      <br>redis               docker-entrypoint.<span class="hljs-keyword">sh</span> redis ...   Up      6379/tcp                 <br>registry            /entrypoint.<span class="hljs-keyword">sh</span> /etc/regist ...   Up      5000/tcp   <br><br><br>[root@hdss7-200 harbor]# docker ps -a                               <span class="hljs-comment">//可以看到180映射到本机80port                     </span><br>CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS                   PORTS                       NAMES<br>d6880cca7143        goharbor/nginx-photon:v1.8.3                        &quot;nginx -<span class="hljs-keyword">g</span> &#x27;daemon of??   3 minutes ago       Up 3 minutes (healthy)   0.0.0.0:180-&gt;80/tcp         nginx<br>a5d166ffb68e        goharbor/harbor-jobservice:v1.8.3                   <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes                                         harbor-jobservice<br>e0ab65359cc4        goharbor/harbor-portal:v1.8.3                       &quot;nginx -<span class="hljs-keyword">g</span> &#x27;daemon of??   3 minutes ago       Up 3 minutes (healthy)   80/tcp                      harbor-portal<br>ef032bf896c0        goharbor/harbor-core:v1.8.3                         <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes (healthy)                               harbor-core<br>6c334c42ac9d        goharbor/redis-photon:v1.8.3                        &quot;docker-entrypoint.s??   3 minutes ago       Up 3 minutes             6379/tcp                    redis<br>257f4c4ef4d7        goharbor/harbor-<span class="hljs-keyword">db</span>:v1.8.3                           &quot;/entrypoint.<span class="hljs-keyword">sh</span> <span class="hljs-keyword">post</span>??   3 minutes ago       Up 3 minutes (healthy)   5432/tcp                    harbor-<span class="hljs-keyword">db</span><br>7e741324bb39        goharbor/registry-photon:v2.7.1-patch-2819-v1.8.3   &quot;/entrypoint.<span class="hljs-keyword">sh</span> /etc??   3 minutes ago       Up 3 minutes (healthy)   5000/tcp                    registry<br>a468bf625584        goharbor/harbor-registryctl:v1.8.3                  <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes (healthy)                               registryctl<br>41a1e79fc5d1        goharbor/harbor-<span class="hljs-keyword">log</span>:v1.8.3                          &quot;/bin/<span class="hljs-keyword">sh</span> -c /usr/<span class="hljs-keyword">loc</span>??   3 minutes ago       Up 3 minutes (healthy)   127.0.0.1:1514-&gt;10514/tcp   harbor-<span class="hljs-keyword">log</span><br></code></pre></td></tr></table></figure><h4 id="2-6-6-配置harbor的dns内网解析"><a href="#2-6-6-配置harbor的dns内网解析" class="headerlink" title="2.6.6.配置harbor的dns内网解析"></a>2.6.6.配置harbor的dns内网解析</h4>            <input type="checkbox" disabled checked="checked">hdss7-11.host.com 上          <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># vi /var/named/od.com.zone</span><br><span class="hljs-number">2019111002</span> ; serial<br>harbor             A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span><br><span class="hljs-comment">//注意serial前滚一个序号</span><br><br>[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># systemctl restart named</span><br>[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># dig -t A harbor.od.com +short</span><br><span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span><br></code></pre></td></tr></table></figure><h4 id="2-6-7-安装nginx并配置"><a href="#2-6-7-安装nginx并配置" class="headerlink" title="2.6.7.安装nginx并配置"></a>2.6.7.安装nginx并配置</h4><blockquote><p>注意所在主机</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># yum install nginx</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># vi /etc/nginx/conf.d/harbor.od.com.conf</span><br>server &#123;<br>    listen       <span class="hljs-number">80</span>;<br>    server_name  harbor.od.com;<br><br>    client_max_body_size <span class="hljs-number">1000</span>m;<br><br>    location / &#123;<br>        proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">180</span>;<br>    &#125;<br>&#125;<br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># systemctl start nginx</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># systemctl enable nginx</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/nginx.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>nginx.service.<br></code></pre></td></tr></table></figure><h4 id="2-6-8-浏览器打开http：-harbor-od-com"><a href="#2-6-8-浏览器打开http：-harbor-od-com" class="headerlink" title="2.6.8.浏览器打开http：//harbor.od.com"></a>2.6.8.浏览器打开http：<a href="http://harbor.od.com/">//harbor.od.com</a></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-11 ~]# curl harbor.od.com<br><span class="hljs-meta">&lt;!doctype <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Harbor<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">base</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;image/x-icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;favicon.ico?v=2&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;styles.c1fdd265f24063370a49.css&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">harbor-app</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;spinner spinner-lg app-loading&quot;</span>&gt;</span><br>            Loading...<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">harbor-app</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;runtime.26209474bfa8dc87a77c.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;scripts.c04548c4e6d1db502313.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;main.144e8ccd474a28572e81.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>1、浏览器输入：harbor.od.com 用户名：admin 密码：Harbor12345</strong></p><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/login.png" alt="登录"></p><p><strong>2、新建项目</strong></p><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/new_P.png" alt="新建项目"></p><p><strong>3、下载测试镜像并打给镜像打一个tag</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> harbor]# docker pull nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br><span class="hljs-number">1.7</span>.<span class="hljs-number">9</span>: Pulling from library/nginx<br>Image docker.io/library/nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span> uses outdated schema1 manifest format. Please upgrade <span class="hljs-keyword">to</span> <span class="hljs-keyword">a</span> schema2 image <span class="hljs-keyword">for</span> better future compatibility. More information at http<span class="hljs-variable">s:</span>//docs.docker.<span class="hljs-keyword">com</span>/registry/spec/deprecated-schema-v1/<br>a3ed95caeb02: Pull <span class="hljs-built_in">complete</span> <br><span class="hljs-number">6</span>f5424ebd796: Pull <span class="hljs-built_in">complete</span> <br>d15444df170<span class="hljs-variable">a:</span> Pull <span class="hljs-built_in">complete</span> <br>e83f073daa67: Pull <span class="hljs-built_in">complete</span> <br>a4d93e421023: Pull <span class="hljs-built_in">complete</span> <br><span class="hljs-number">084</span>adbca2647: Pull <span class="hljs-built_in">complete</span> <br>c9cec474c523: Pull <span class="hljs-built_in">complete</span> <br>Diges<span class="hljs-variable">t:</span> <span class="hljs-built_in">sha256</span>:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451<br>Statu<span class="hljs-variable">s:</span> Downloaded newer image <span class="hljs-keyword">for</span> nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>docker.io/library/nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]# docker images |<span class="hljs-keyword">grep</span> <span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>nginx                           <span class="hljs-number">1.7</span>.<span class="hljs-number">9</span>                      <span class="hljs-number">84581</span>e99d807        <span class="hljs-number">4</span> years ago         <span class="hljs-number">91.7</span>MB<br>[root@hdss7-<span class="hljs-number">200</span> harbor]# docker <span class="hljs-keyword">tag</span> <span class="hljs-number">84581</span>e99d807 harbor.od.<span class="hljs-keyword">com</span>/public/nginx:v1.<span class="hljs-number">7.9</span><br></code></pre></td></tr></table></figure><p><strong>4、登陆harbor并推送到仓库</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># docker login harbor.od.com</span><br>Username: admin<br>Password: <br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> <span class="hljs-regexp">/root/</span>.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>reference<span class="hljs-regexp">/commandline/</span>login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># docker push harbor.od.com/public/nginx:v1.7.9</span><br>The push refers to repository [harbor.od.com<span class="hljs-regexp">/public/</span>nginx]<br><span class="hljs-number">5</span>f70bf18a086: Pushed <br><span class="hljs-number">4</span>b26ab29a475: Pushed <br>ccb1d68e3fb7: Pushed <br>e387107e2065: Pushed <br><span class="hljs-number">63</span>bf84221cce: Pushed <br>e02dce553481: Pushed <br>dea2e4984e29: Pushed <br>v1.<span class="hljs-number">7.9</span>: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: <span class="hljs-number">3012</span><br></code></pre></td></tr></table></figure><h4 id="2-6-9-检查"><a href="#2-6-9-检查" class="headerlink" title="2.6.9.检查"></a>2.6.9.检查</h4><p><strong>可以看到nginx镜像已推送到public下</strong></p><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/nginx.png" alt="Public"></p><h2 id="3-部署Master节点服务"><a href="#3-部署Master节点服务" class="headerlink" title="3.部署Master节点服务"></a>3.部署Master节点服务</h2><h3 id="3-1-部署etcd集群"><a href="#3-1-部署etcd集群" class="headerlink" title="3.1.部署etcd集群"></a>3.1.部署etcd集群</h3><h4 id="3-1-1-集群规划"><a href="#3-1-1-集群规划" class="headerlink" title="3.1.1.集群规划"></a>3.1.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip地址</th></tr></thead><tbody><tr><td>hdss7-12.host.com</td><td>etcd lead</td><td>10.4.7.12</td></tr><tr><td>hdss7-21.host.com</td><td>etcd follow</td><td>10.4.7.21</td></tr><tr><td>hdss7-22.host.com</td><td>etcd follow</td><td>10.4.7.22</td></tr></tbody></table><p><strong>注意：这里部署文档以hdss7-12.host.com为例，另外两台部署方法类似</strong></p><h4 id="3-1-2-创建基于根证书的config配置文件"><a href="#3-1-2-创建基于根证书的config配置文件" class="headerlink" title="3.1.2.创建基于根证书的config配置文件"></a>3.1.2.创建基于根证书的config配置文件</h4>            <input type="checkbox" disabled checked="checked">hdss7-200.host.com 上          <figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> ~]# vi /opt/certs/ca-config.json<br>&#123;<br>    <span class="hljs-string">&quot;signing&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;default&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;profiles&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;server&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;server auth&quot;</span><br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;client&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;client auth&quot;</span><br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;peer&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;server auth&quot;</span>,<br>                    <span class="hljs-string">&quot;client auth&quot;</span><br>                ]<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;    <br></code></pre></td></tr></table></figure><h4 id="3-1-3-创建生成自签证书的签名请求（csr）的-json配置文件"><a href="#3-1-3-创建生成自签证书的签名请求（csr）的-json配置文件" class="headerlink" title="3.1.3.创建生成自签证书的签名请求（csr）的 json配置文件"></a>3.1.3.创建生成自签证书的签名请求（csr）的 json配置文件</h4><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> ~]# vi /opt/certs/etcd-peer-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-etcd&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>        <span class="hljs-string">&quot;10.4.7.11&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.12&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.22&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-1-4-生成etcd证书和私钥"><a href="#3-1-4-生成etcd证书和私钥" class="headerlink" title="3.1.4.生成etcd证书和私钥"></a>3.1.4.生成etcd证书和私钥</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-200</span> ~]# cd /opt/certs/<br>[root@hdss7<span class="hljs-number">-200</span> certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-<span class="hljs-type">json</span> -bare etcd-peer<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] generate received request<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] received CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] generating key: rsa<span class="hljs-number">-2048</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] encoded CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] signed certificate <span class="hljs-keyword">with</span> <span class="hljs-type">serial</span> number <span class="hljs-number">319260464385476820097369736582871670367101389147</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-built_in">WARNING</span>] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable <span class="hljs-keyword">for</span><br>websites. <span class="hljs-keyword">For</span> more information see the Baseline Requirements <span class="hljs-keyword">for</span> the Issuance <span class="hljs-keyword">and</span> Management<br><span class="hljs-keyword">of</span> Publicly-<span class="hljs-keyword">Trusted</span> Certificates, v<span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.6</span>, <span class="hljs-keyword">from</span> the CA/Browser Forum (https://cabforum.org);<br>specifically, section <span class="hljs-number">10.2</span><span class="hljs-number">.3</span> (&quot;Information Requirements&quot;).<br></code></pre></td></tr></table></figure><h4 id="3-1-5-检查生成的证书和私钥"><a href="#3-1-5-检查生成的证书和私钥" class="headerlink" title="3.1.5.检查生成的证书和私钥"></a>3.1.5.检查生成的证书和私钥</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 36<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure><h4 id="3-1-6-创建etcd用户"><a href="#3-1-6-创建etcd用户" class="headerlink" title="3.1.6.创建etcd用户"></a>3.1.6.创建etcd用户</h4>            <input type="checkbox" disabled checked="checked">hdss7-12.host.com 上          <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-12 opt]</span><span class="hljs-comment"># useradd -s /sbin/nologin -M etcd</span><br><span class="hljs-section">[root@hdss7-12 opt]</span><span class="hljs-comment"># id etcd</span><br><span class="hljs-attr">uid</span>=<span class="hljs-number">1000</span>(etcd) gid=<span class="hljs-number">1000</span>(etcd) groups=<span class="hljs-number">1000</span>(etcd)<br></code></pre></td></tr></table></figure><h4 id="3-1-7-下载软件，解压，做软链接"><a href="#3-1-7-下载软件，解压，做软链接" class="headerlink" title="3.1.7.下载软件，解压，做软链接"></a>3.1.7.下载软件，解压，做软链接</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">https://github.com/etcd-io/etcd/tags   //这里用的3.1.20版本，目前不建议超过3.3的版本<br>[root@hdss7-12 src]<span class="hljs-comment"># tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/</span><br>[root@hdss7-12 src]<span class="hljs-comment"># cd ..</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># ll</span><br>total 0<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root   root  <span class="hljs-number"> 18 </span>Nov<span class="hljs-number"> 16 </span>14:22 etcd -&gt; /opt/etcd-v3.1.20/<br>drwxr-xr-x<span class="hljs-number"> 3 </span>478493<span class="hljs-number"> 89939 </span>123 Oct<span class="hljs-number"> 11 </span><span class="hljs-number"> 2018 </span>etcd-v3.1.20<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root   root  <span class="hljs-number"> 45 </span>Nov<span class="hljs-number"> 16 </span>14:20 src<br></code></pre></td></tr></table></figure><h4 id="3-1-8-创建目录，拷贝证书，私钥"><a href="#3-1-8-创建目录，拷贝证书，私钥" class="headerlink" title="3.1.8.创建目录，拷贝证书，私钥"></a>3.1.8.创建目录，拷贝证书，私钥</h4><h5 id="创建证书目录、数据目录、日志目录"><a href="#创建证书目录、数据目录、日志目录" class="headerlink" title="创建证书目录、数据目录、日志目录"></a>创建证书目录、数据目录、日志目录</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">12</span> opt]# mkdir -p <span class="hljs-regexp">/opt/</span>etcd<span class="hljs-regexp">/certs /</span>data<span class="hljs-regexp">/etcd /</span>data<span class="hljs-regexp">/logs/</span>etcd-server<br></code></pre></td></tr></table></figure><h5 id="拷贝3-1-4生成的证书文件"><a href="#拷贝3-1-4生成的证书文件" class="headerlink" title="拷贝3.1.4生成的证书文件"></a>拷贝3.1.4生成的证书文件</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/etcd-peer.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/etcd-peer-kry.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 16 </span>14:31 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:34 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:33 etcd-peer.pem<br></code></pre></td></tr></table></figure><h4 id="3-1-9-创建etcd服务启动脚本"><a href="#3-1-9-创建etcd服务启动脚本" class="headerlink" title="3.1.9.创建etcd服务启动脚本"></a>3.1.9.创建etcd服务启动脚本</h4><p><strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># vi /opt/etcd/etcd-server-startup.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br>./etcd --name etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span> \<br>       --data-dir <span class="hljs-regexp">/data/</span>etcd/etcd-server \<br>       --listen-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --listen-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --quota-backend-bytes <span class="hljs-number">8000000000</span> \<br>       --initial-advertise-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --advertise-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --initial-cluster  etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> \<br>       --ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --client-cert-auth  \<br>       --trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --peer-key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --peer-client-cert-auth \<br>       --peer-trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --log-output stdout<br>       <br>       <span class="hljs-comment">#############配置说明#########</span><br>       --listen-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \            <span class="hljs-regexp">//</span>内部通信起的<span class="hljs-number">2380</span>端口                                                   <br>       --listen-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \ <span class="hljs-regexp">//</span>对外通信起的<span class="hljs-number">2379</span>端口<br>       --quota-backend-bytes <span class="hljs-number">8000000000</span> \                        <span class="hljs-regexp">//</span> 后端配额       <br>       --initial-advertise-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --advertise-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --initial-cluster  etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> \<br>       --ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --client-cert-auth  \<br>       --trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --peer-key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --peer-client-cert-auth \<br>       --peer-trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --log-output stdout<br> <br>[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># chmod +x /opt/etcd/etcd-server.startup.sh </span><br>[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># ll /opt/etcd/etcd-server.startup.sh </span><br>-rwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">981</span> Nov <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">39</span> <span class="hljs-regexp">/opt/</span>etcd/etcd-server.startup.sh   <br></code></pre></td></tr></table></figure><h4 id="3-1-10-调整目录权限"><a href="#3-1-10-调整目录权限" class="headerlink" title="3.1.10.调整目录权限"></a>3.1.10.调整目录权限</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">12</span> ~]# chown -R etcd.etcd <span class="hljs-regexp">/opt/</span>etcd-v3.<span class="hljs-number">1.20</span><span class="hljs-regexp">/   /</span>data<span class="hljs-regexp">/etcd/</span>  <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/etcd-server/</span><br></code></pre></td></tr></table></figure><h4 id="3-1-11-安装supervison软件"><a href="#3-1-11-安装supervison软件" class="headerlink" title="3.1.11.安装supervison软件"></a>3.1.11.安装supervison软件</h4><p><strong>supervison是一个管理后台进程的软件，etcd进程掉了会自动拉起来</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># yum install supervisor -y</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># systemctl start supervisord</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># systemctl enable supervisord</span><br></code></pre></td></tr></table></figure><h4 id="3-1-12-创建etcd-server的启动配置"><a href="#3-1-12-创建etcd-server的启动配置" class="headerlink" title="3.1.12.创建etcd-server的启动配置"></a>3.1.12.创建etcd-server的启动配置</h4><p><strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-12 ~]</span><span class="hljs-comment"># vi /etc/supervisord.d/etcd-server.ini</span><br><br><span class="hljs-section">[program:etcd-server-7-12]</span><br><span class="hljs-attr">command</span>=/opt/etcd/etcd-server-startup.sh                        <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                      <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/etcd                                             <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                  <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                    <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                  <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                   <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                 <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                 <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=etcd                                                       <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                            <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/etcd-server/etcd.stdout.log           <span class="hljs-comment">; stdout log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                    <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                        <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                     <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                     <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><h4 id="3-1-13-启动etcd服务并检查"><a href="#3-1-13-启动etcd服务并检查" class="headerlink" title="3.1.13.启动etcd服务并检查"></a>3.1.13.启动etcd服务并检查</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl update</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>: added process group<br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>                 STARTING  <br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>                 RUNNING   pid <span class="hljs-number">20350</span>, uptime 0<span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">14</span><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># netstat -luntp|grep etcd</span><br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><span class="hljs-symbol">:</span><span class="hljs-number">2379</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd        <br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">2379</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd        <br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><span class="hljs-symbol">:</span><span class="hljs-number">2380</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd RTING  <br></code></pre></td></tr></table></figure><h4 id="3-1-14-安装部署启动检查所有集群"><a href="#3-1-14-安装部署启动检查所有集群" class="headerlink" title="3.1.14.安装部署启动检查所有集群"></a>3.1.14.安装部署启动检查所有集群</h4><p><strong>和上述无区别,最主要是修改两个配置文件:</strong><br>1、/opt/etcd/etcd-server-startup.sh的ip地址，<br>2、/etc/supervisord.d/etcd-server.ini</p><p><strong>//修改supervisord启动ini文件的program标签，是为了更好区分主机，生产规范，强迫症患者的福音，不修改不会造成启动失败</strong></p><h4 id="3-1-15-检查集群状态"><a href="#3-1-15-检查集群状态" class="headerlink" title="3.1.15.检查集群状态"></a>3.1.15.检查集群状态</h4><p><strong>任意节点输入</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> etcd]<span class="hljs-comment"># ./etcdctl  cluster-health</span><br>member <span class="hljs-number">988139385</span>f78284 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>member <span class="hljs-number">5</span>a0ef2a004fc4349 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>member f4a0cb0a765574a8 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>cluster is healthy<br><br><br>[root@hdss7-<span class="hljs-number">21</span> etcd]<span class="hljs-comment"># ./etcdctl member list</span><br><span class="hljs-number">988139385</span>f78284: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2379</span> isLeader=false<br><span class="hljs-number">5</span>a0ef2a004fc4349: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2379</span> isLeader=false<br>f4a0cb0a765574a8: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span> isLeader=true<br></code></pre></td></tr></table></figure><h3 id="3-2-部署kube-apiserver集群"><a href="#3-2-部署kube-apiserver集群" class="headerlink" title="3.2.部署kube-apiserver集群"></a>3.2.部署kube-apiserver集群</h3><h4 id="3-2-1-集群规划"><a href="#3-2-1-集群规划" class="headerlink" title="3.2.1.集群规划"></a>3.2.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th><th>vip</th></tr></thead><tbody><tr><td>hdss7-21.host.com</td><td>kube-apiserver</td><td>10.4.7.21</td><td>无</td></tr><tr><td>hdss7-22.host.com</td><td>kube-apiserver</td><td>10.4.7.22</td><td>无</td></tr><tr><td>hdss7-11.host.com</td><td>L4</td><td>10.4.7.11</td><td>10.4.7.10</td></tr><tr><td>hdss7-12.host.com</td><td>L4</td><td>10.4.7.12</td><td>10.4.7.10</td></tr></tbody></table><p>注意：hdss7-11和hdss7-12使用nginx做4层负载均衡器，keepalived跑一个VIP：10.4.7.10，代理两个kube-apiserver，实现高可用。<br><strong>这里以hdss21为例，另外一台运算节点部署方法类似</strong></p><h4 id="3-2-2-下载软件，解压，做软链接"><a href="#3-2-2-下载软件，解压，做软链接" class="headerlink" title="3.2.2.下载软件，解压，做软链接"></a>3.2.2.下载软件，解压，做软链接</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs tap">官方github地址：github.com/kubernetes/releasses/tag/v1.15.4    //这里是v1.15.2版本<br>下载方法：点击版本号 → CHANGELOG-1.15.md → DOWNLOAD → server binaries → 找到kubenetes-server-linux-amd64.tar.gz<br><br>[root@hdss7-21 src]<span class="hljs-comment"># tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz  -C /opt</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># mv kubernetes/ kubernetes-v1.15.2</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># ll</span><br>total 0<br>drwx--x--x<span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 28 </span>Nov<span class="hljs-number"> 16 </span>03:06 containerd<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 18 </span>Nov<span class="hljs-number"> 16 </span>15:44 etcd -&gt; /opt/etcd-v3.1.20/<br>drwxr-xr-x<span class="hljs-number"> 4 </span>etcd etcd<span class="hljs-number"> 166 </span>Nov<span class="hljs-number"> 17 </span>00:39 etcd-v3.1.20<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 24 </span>Nov<span class="hljs-number"> 17 </span>01:35 kubernetes -&gt; /opt/kubernetes-v1.15.2/<br>drwxr-xr-x<span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 79 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubernetes-v1.15.2<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 306 </span>Nov<span class="hljs-number"> 16 </span>15:41 src<br><br><br>//删掉无用的源码包，bin下无用的tag，tar文件，不用adm方式部署，所以可以删除<br>[root@hdss7-21 opt]<span class="hljs-comment"># cd kubernetes</span><br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># ls</span><br>addons  kubernetes-src.tar.gz  LICENSES  server<br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># rm -rf kubernetes-src.tar.gz </span><br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># ll</span><br>total 1180<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root      <span class="hljs-number"> 6 </span>Aug <span class="hljs-number"> 5 </span>18:01 addons<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1205293 </span>Aug <span class="hljs-number"> 5 </span>18:01 LICENSES<br>drwxr-xr-x<span class="hljs-number"> 3 </span>root root     <span class="hljs-number"> 17 </span>Aug <span class="hljs-number"> 5 </span>17:57 server<br>[root@hdss7-21 bin]<span class="hljs-comment"># rm -f *.tar</span><br>[root@hdss7-21 bin]<span class="hljs-comment"># rm -f *_tag</span><br>[root@hdss7-21 bin]<span class="hljs-comment"># ll</span><br>total 884636<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 43534816 </span>Aug <span class="hljs-number"> 5 </span>18:01 apiextensions-apiserver<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 100548640 </span>Aug <span class="hljs-number"> 5 </span>18:01 cloud-controller-manager<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 200648416 </span>Aug <span class="hljs-number"> 5 </span>18:01 hyperkube<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 40182208 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubeadm<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 164501920 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-apiserver<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 116397088 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-controller-manager<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 42985504 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubectl<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 119616640 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubelet<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 36987488 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-proxy<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 38786144 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-scheduler<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 1648224 </span>Aug <span class="hljs-number"> 5 </span>18:01 mounter<br></code></pre></td></tr></table></figure><h4 id="3-2-3-签发client证书"><a href="#3-2-3-签发client证书" class="headerlink" title="3.2.3.签发client证书"></a>3.2.3.签发client证书</h4>            <input type="checkbox" disabled checked="checked">运维主机hdss7-200上          <h5 id="3-2-3-1-创建生成证书签名请求（csr）的json配置文件"><a href="#3-2-3-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="3.2.3.1.创建生成证书签名请求（csr）的json配置文件"></a>3.2.3.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]#  vi /opt/certs/client-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-node&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-2-3-2-生成clent证书和私钥"><a href="#3-2-3-2-生成clent证书和私钥" class="headerlink" title="3.2.3.2.生成clent证书和私钥"></a>3.2.3.2.生成clent证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=client client-csr.json |cfssl-json -bare client<br></code></pre></td></tr></table></figure><h5 id="3-2-3-3-检查生成的证书和私钥"><a href="#3-2-3-3-检查生成的证书和私钥" class="headerlink" title="3.2.3.3.检查生成的证书和私钥"></a>3.2.3.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 52<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 280 </span>Nov<span class="hljs-number"> 16 </span>17:45 client-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:47 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure><h4 id="3-2-4-签发kube-apiserver证书"><a href="#3-2-4-签发kube-apiserver证书" class="headerlink" title="3.2.4.签发kube-apiserver证书"></a>3.2.4.签发kube-apiserver证书</h4>            <input type="checkbox" disabled checked="checked">运维主机hdss7-200上          <h5 id="3-2-4-1-创建生成证书签名请求（csr）的-json配置文件"><a href="#3-2-4-1-创建生成证书签名请求（csr）的-json配置文件" class="headerlink" title="3.2.4.1.创建生成证书签名请求（csr）的 json配置文件"></a>3.2.4.1.创建生成证书签名请求（csr）的 json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]# vi /opt/certs/apiserver-csr.json <br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-apiserver&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br><span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br><span class="hljs-string">&quot;192.168.0.1&quot;</span>,<br><span class="hljs-string">&quot;kubernetes.default&quot;</span>,<br><span class="hljs-string">&quot;kubernetes.default.svc&quot;</span>,<br><span class="hljs-string">&quot;kubernetes.default.svc.cluster&quot;</span>,<br><span class="hljs-string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,<br><span class="hljs-string">&quot;10.4.7.10&quot;</span>,<br><span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br><span class="hljs-string">&quot;10.4.7.22&quot;</span>,<br><span class="hljs-string">&quot;10.4.7.23&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-2-4-2-生成kube-apiserver证书和私钥"><a href="#3-2-4-2-生成kube-apiserver证书和私钥" class="headerlink" title="3.2.4.2.生成kube-apiserver证书和私钥"></a>3.2.4.2.生成kube-apiserver证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=server apiserver-csr.json |cfssl-json -bare apiserver<br></code></pre></td></tr></table></figure><h5 id="3-2-4-3-检查生成的证书和私钥"><a href="#3-2-4-3-检查生成的证书和私钥" class="headerlink" title="3.2.4.3.检查生成的证书和私钥"></a>3.2.4.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 68<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1249 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 567 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 280 </span>Nov<span class="hljs-number"> 16 </span>17:45 client-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:47 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure><h4 id="3-2-5-拷贝证书至各运算节点，并创建配置"><a href="#3-2-5-拷贝证书至各运算节点，并创建配置" class="headerlink" title="3.2.5.拷贝证书至各运算节点，并创建配置"></a>3.2.5.拷贝证书至各运算节点，并创建配置</h4><h5 id="3-2-5-1-拷贝3套证书到…-bin-cert目录"><a href="#3-2-5-1-拷贝3套证书到…-bin-cert目录" class="headerlink" title="3.2.5.1.拷贝3套证书到…/bin/cert目录"></a>3.2.5.1.拷贝3套证书到…/bin/cert目录</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/client.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/client-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/apiserver.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/apiserver-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 24<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:11 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 17 </span>02:08 apiserver.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:07 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 17 </span>02:06 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:08 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 17 </span>02:07 client.pem<br></code></pre></td></tr></table></figure><h5 id="3-2-5-2-创建配置"><a href="#3-2-5-2-创建配置" class="headerlink" title="3.2.5.2.创建配置"></a>3.2.5.2.创建配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">bin</span>]<span class="hljs-comment"># mkdir conf</span><br>[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">conf</span>]<span class="hljs-comment"># vi audit.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">audit.k8s.io/v1beta1</span> <span class="hljs-comment"># This is required.</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span><br><span class="hljs-comment"># Don&#x27;t generate audit events for all requests in RequestReceived stage.</span><br><span class="hljs-attr">omitStages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Log pod changes at RequestResponse level</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">RequestResponse</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-comment"># Resource &quot;pods&quot; doesn&#x27;t match requests to any subresource of pods,</span><br>      <span class="hljs-comment"># which is consistent with the RBAC policy.</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>  <span class="hljs-comment"># Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods/log&quot;</span>, <span class="hljs-string">&quot;pods/status&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log requests to a configmap called &quot;controller-leader&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>      <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;controller-leader&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">users:</span> [<span class="hljs-string">&quot;system:kube-proxy&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;watch&quot;</span>]<br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>, <span class="hljs-string">&quot;services&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log authenticated requests to certain non-resource URL paths.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">userGroups:</span> [<span class="hljs-string">&quot;system:authenticated&quot;</span>]<br>    <span class="hljs-attr">nonResourceURLs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/api*&quot;</span> <span class="hljs-comment"># Wildcard matching.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/version&quot;</span><br><br>  <span class="hljs-comment"># Log the request body of configmap changes in kube-system.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Request</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>    <span class="hljs-comment"># This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br>    <span class="hljs-comment"># The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br>    <span class="hljs-attr">namespaces:</span> [<span class="hljs-string">&quot;kube-system&quot;</span>]<br><br>  <span class="hljs-comment"># Log configmap and secret changes in all other namespaces at the Metadata level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;secrets&quot;</span>, <span class="hljs-string">&quot;configmaps&quot;</span>]<br><br>  <span class="hljs-comment"># Log all other resources in core and extensions at the Request level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Request</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;extensions&quot;</span> <span class="hljs-comment"># Version of group should NOT be included.</span><br><br>  <span class="hljs-comment"># A catch-all rule to log all other requests at the Metadata level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-comment"># Long-running requests like watches that fall under this rule will not</span><br>    <span class="hljs-comment"># generate an audit event in RequestReceived.</span><br>    <span class="hljs-attr">omitStages:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br></code></pre></td></tr></table></figure><h4 id="3-2-6-创建apiserver启动脚本"><a href="#3-2-6-创建apiserver启动脚本" class="headerlink" title="3.2.6.创建apiserver启动脚本"></a>3.2.6.创建apiserver启动脚本</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@hdss7-21 bin]<span class="hljs-comment"># vi /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-string">./kube-apiserver</span> \<br>  <span class="hljs-params">--apiserver-count</span> 2 \<br>  <span class="hljs-params">--audit-log-path</span> <span class="hljs-string">/data/logs/kubernetes/kube-apiserver/audit-log</span> \<br>  <span class="hljs-params">--audit-policy-file</span> <span class="hljs-string">./conf/audit.yaml</span> \<br>  <span class="hljs-params">--authorization-mode</span> RBAC \<br>  <span class="hljs-params">--client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--requestheader-client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--enable-admission-plugins</span> NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \<br>  <span class="hljs-params">--etcd-cafile</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--etcd-certfile</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--etcd-keyfile</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--etcd-servers</span> https:<span class="hljs-string">//10.4.7.12</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.21</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.22</span><span class="hljs-function">:2379</span> \<br>  <span class="hljs-params">--service-account-key-file</span> <span class="hljs-string">./cert/ca-key.pem</span> \<br>  <span class="hljs-params">--service-cluster-ip-range</span> 192.168.0.0/16 \<br>  <span class="hljs-params">--service-node-port-range</span> 3000-29999 \<br>  <span class="hljs-params">--target-ram-mb=1024</span> \<br>  <span class="hljs-params">--kubelet-client-certificate</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--kubelet-client-key</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--log-dir</span>  <span class="hljs-string">/data/logs/kubernetes/kube-apiserver</span> \<br>  <span class="hljs-params">--tls-cert-file</span> <span class="hljs-string">./cert/apiserver.pem</span> \<br>  <span class="hljs-params">--tls-private-key-file</span> <span class="hljs-string">./cert/apiserver-key.pem</span> \<br>  <span class="hljs-params">--v</span> 2<br> <br> <span class="hljs-comment">#################参数说明############</span><br>    <span class="hljs-params">--apiserver-count</span> 2 \                     <span class="hljs-string">//</span> apiserver数量，有资源可以给3个                 <br>  <span class="hljs-params">--audit-log-path</span> <span class="hljs-string">/data/logs/kubernetes/kube-apiserver/audit-log</span> \   <span class="hljs-string">//</span>日志目录<br>  <span class="hljs-params">--audit-policy-file</span> <span class="hljs-string">./conf/audit.yaml</span> \                   <span class="hljs-string">//</span>日志审计规则<br>  <span class="hljs-params">--authorization-mode</span> RBAC \                           <span class="hljs-string">//RBAC</span> --基于角色访问的控制<br>  <span class="hljs-params">--client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--requestheader-client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--enable-admission-plugins</span> NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \<br>  <span class="hljs-params">--etcd-cafile</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--etcd-certfile</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--etcd-keyfile</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--etcd-servers</span> https:<span class="hljs-string">//10.4.7.12</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.21</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.22</span><span class="hljs-function">:2379</span> \<br>  <span class="hljs-params">--service-account-key-file</span> <span class="hljs-string">./cert/ca-key.pem</span> \<br>  <span class="hljs-params">--service-cluster-ip-range</span> 192.168.0.0/16 \<br>  <span class="hljs-params">--service-node-port-range</span> 3000-29999 \<br>  <span class="hljs-params">--target-ram-mb=1024</span> \                                              <br>  <span class="hljs-params">--kubelet-client-certificate</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--kubelet-client-key</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--log-dir</span>  <span class="hljs-string">/data/logs/kubernetes/kube-apiserver</span> \<br>  <span class="hljs-params">--tls-cert-file</span> <span class="hljs-string">./cert/apiserver.pem</span> \<br>  <span class="hljs-params">--tls-private-key-file</span> <span class="hljs-string">./cert/apiserver-key.pem</span> \<br>  <span class="hljs-params">--v</span> 2                                 <span class="hljs-string">//log</span> Level  是v 2 <br>  更多说明请看例子：<br>  [root@hdss7-21 bin]<span class="hljs-comment"># ./kube-apiserver  --help|grep -A 5 target-ram-mb</span><br>      <span class="hljs-params">--target-ram-mb</span> int                            Memory limit for apiserver in MB <span class="hljs-params">(used to configure sizes of caches, etc.)</span><br><br>Etcd flags:<br><br>      <span class="hljs-params">--default-watch-cache-size</span> int             Default watch cache size. If zero, watch cache will be disabled for resources that do not have a default watch size <span class="hljs-keyword">set</span>. <span class="hljs-params">(default 100)</span><br>      <span class="hljs-params">--delete-collection-workers</span> int            Number of workers spawned for DeleteCollection call. These are used to speed up namespace cleanup. <span class="hljs-params">(default 1)</span><br></code></pre></td></tr></table></figure><h4 id="3-2-7-调整权限和目录"><a href="#3-2-7-调整权限和目录" class="headerlink" title="3.2.7.调整权限和目录"></a>3.2.7.调整权限和目录</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-meta"># chmod +x kube-apiserver.sh</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-meta"># mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></code></pre></td></tr></table></figure><h4 id="3-2-8-创建supervisor配置"><a href="#3-2-8-创建supervisor配置" class="headerlink" title="3.2.8.创建supervisor配置"></a>3.2.8.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment">#  vi /etc/supervisord.d/kube-apiserver.ini</span><br><span class="hljs-section">[program:kube-apiserver-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-apiserver.sh            <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                      <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                            <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                  <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                    <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                  <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                   <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                 <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                 <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                       <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                            <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                    <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                        <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                     <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                     <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><h4 id="3-2-9-启动服务并检查"><a href="#3-2-9-启动服务并检查" class="headerlink" title="3.2.9.启动服务并检查"></a>3.2.9.启动服务并检查</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># supervisorctl update</span><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-21</span>                 RUNNING   pid <span class="hljs-number">1716</span>, uptime <span class="hljs-number">2</span><span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">19</span><br>kube-apiserver<span class="hljs-number">-7</span><span class="hljs-number">-21</span>              RUNNING   pid <span class="hljs-number">2032</span>, uptime 0<span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">33</span><br><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># netstat -nltup|grep kube-api</span><br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">8080</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">2033</span>/./kube-apiserv <br>tcp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">6443</span>                 ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">2033</span>/./kube-apiserv <br></code></pre></td></tr></table></figure><h4 id="3-2-10-安装部署启动检查所有集群"><a href="#3-2-10-安装部署启动检查所有集群" class="headerlink" title="3.2.10.安装部署启动检查所有集群"></a>3.2.10.安装部署启动检查所有集群</h4><p><strong>hdss7-22 跟上述基本相同</strong><br>/etc/supervisord.d/kube-apiserver.ini<br>需要更改成[program:kube-apiserver-7-22]</p><h4 id="3-2-11-配四层反向代理"><a href="#3-2-11-配四层反向代理" class="headerlink" title="3.2.11.配四层反向代理"></a>3.2.11.配四层反向代理</h4><p><strong>VIP 10.4.7.10：7443代理 两台apiserver的6443端口，此处会用到keepalived</strong></p><h5 id="3-2-11-1安装nginx和keepalived"><a href="#3-2-11-1安装nginx和keepalived" class="headerlink" title="3.2.11.1安装nginx和keepalived"></a>3.2.11.1安装nginx和keepalived</h5><h6 id="hdss7-11和hdss7-12都安装nginx和keepalived"><a href="#hdss7-11和hdss7-12都安装nginx和keepalived" class="headerlink" title="hdss7-11和hdss7-12都安装nginx和keepalived"></a>hdss7-11和hdss7-12都安装nginx和keepalived</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> etcd]<span class="hljs-meta"># yum install nginx -y</span><br></code></pre></td></tr></table></figure><h6 id="hdss7-11和hdss7-12配置nginx-conf"><a href="#hdss7-11和hdss7-12配置nginx-conf" class="headerlink" title="hdss7-11和hdss7-12配置nginx.conf"></a>hdss7-11和hdss7-12配置nginx.conf</h6><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dts">[root@hdss7<span class="hljs-number">-11</span> conf.d]<span class="hljs-meta"># vi /etc/nginx/nginx.conf        <span class="hljs-comment">//最后追加</span></span><br><span class="hljs-class">stream </span>&#123;<br>    upstream kube-<span class="hljs-class">apiserver </span>&#123;<br>        server <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.21</span>:<span class="hljs-number">6443</span>     max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s;<br>        server <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.22</span>:<span class="hljs-number">6443</span>     max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s;<br>    &#125;<br>    <span class="hljs-class">server </span>&#123;<br>        listen <span class="hljs-number">7443</span>;<br>        proxy_connect_timeout <span class="hljs-number">2</span>s;<br>        proxy_timeout <span class="hljs-number">900</span>s;<br>        proxy_pass kube-apiserver;<br>    &#125;<br>&#125;<br>[root@hdss7<span class="hljs-number">-12</span> etcd]<span class="hljs-meta"># nginx -t</span><br><span class="hljs-symbol">nginx:</span> the configuration file <span class="hljs-meta-keyword">/etc/</span>nginx/nginx.conf syntax is ok<br><span class="hljs-symbol">nginx:</span> configuration file <span class="hljs-meta-keyword">/etc/</span>nginx/nginx.conf test is successful<br></code></pre></td></tr></table></figure><h6 id="hdss7-11和hdss7-12配置keepalived"><a href="#hdss7-11和hdss7-12配置keepalived" class="headerlink" title="hdss7-11和hdss7-12配置keepalived"></a>hdss7-11和hdss7-12配置keepalived</h6><p>检查脚本</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># vi /etc/keepalived/check_port.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#keepalived 监控端口脚本</span><br><span class="hljs-comment">#使用方法：</span><br><span class="hljs-comment">#在keepalived的配置文件中</span><br><span class="hljs-comment">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="hljs-comment">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span><br><span class="hljs-comment">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="hljs-comment">#&#125;</span><br>CHK_PORT=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;$CHK_PORT&quot;</span> ];then<br>        PORT_PROCESS=`ss -lnt|grep <span class="hljs-variable">$CHK_PORT</span>|wc -l`<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$PORT_PROCESS</span> -eq <span class="hljs-number">0</span> ];then<br>                echo <span class="hljs-string">&quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br>                <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>        fi<br><span class="hljs-keyword">else</span><br>        echo <span class="hljs-string">&quot;Check Port Cant Be Empty!&quot;</span><br>fi<br><br>[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># chmod +x /etc/keepalived/check_port.sh </span><br></code></pre></td></tr></table></figure><p>配置文件</p><blockquote><p>interface eth0  eth0要和系统网卡名称匹配</p></blockquote><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs puppet">keepalived 主:<br>[root@hdss7-11 conf.d]<span class="hljs-comment"># vi /etc/keepalived/keepalived.conf </span><br><br>! Configuration File for keepalived<br><br><span class="hljs-keyword">global_defs</span> &#123;<br>   router_id <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><br><br>&#125;<br><br><span class="hljs-keyword">vrrp_script</span> <span class="hljs-keyword">chk_nginx</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_port.sh 7443&quot;</span><br>    interval <span class="hljs-number">2</span><br>    weight -<span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-keyword">vrrp_instance</span> <span class="hljs-keyword">VI_1</span> &#123;<br>    state MASTER<br>    interface eth<span class="hljs-number">0</span> ←----------------------------这个要和系统网卡名称匹配<br>    virtual_router_id <span class="hljs-number">251</span><br>    <span class="hljs-literal">priority</span> <span class="hljs-number">100</span><br>    advert_int <span class="hljs-number">1</span><br>    mcast_src_ip <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><br>    nopreempt<br><br>    authentication &#123;<br>        <span class="hljs-literal">auth_type</span> PASS<br>        auth_pass <span class="hljs-number">11111111</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>         chk_nginx<br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span><br>    &#125;<br>&#125;<br><br><br><br>keepalived从:<br>[root@hdss7-12 conf.d]<span class="hljs-comment"># vi /etc/keepalived/keepalived.conf </span><br><br>! Configuration File for keepalived<br><span class="hljs-keyword">global_defs</span> &#123;<br>router_id <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><br>&#125;<br><span class="hljs-keyword">vrrp_script</span> <span class="hljs-keyword">chk_nginx</span> &#123;<br>script <span class="hljs-string">&quot;/etc/keepalived/check_port.sh 7443&quot;</span><br>interval <span class="hljs-number">2</span><br>weight -<span class="hljs-number">20</span><br>&#125;<br><span class="hljs-keyword">vrrp_instance</span> <span class="hljs-keyword">VI_1</span> &#123;<br>state BACKUP<br>interface eth<span class="hljs-number">0</span><br>virtual_router_id <span class="hljs-number">251</span><br>mcast_src_ip <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><br><span class="hljs-literal">priority</span> <span class="hljs-number">90</span><br>advert_int <span class="hljs-number">1</span><br>authentication &#123;<br><span class="hljs-literal">auth_type</span> PASS<br>auth_pass <span class="hljs-number">11111111</span><br>&#125;<br><span class="hljs-keyword">track_script</span> &#123;<br>chk_nginx<br>&#125;<br><span class="hljs-keyword">virtual_ipaddress</span> &#123;<br><span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-12-启动代理并检查"><a href="#3-2-12-启动代理并检查" class="headerlink" title="3.2.12.启动代理并检查"></a>3.2.12.启动代理并检查</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>hdss7-<span class="hljs-number">11</span>和hdss7-<span class="hljs-number">12</span>上启动nginx<br>~]<span class="hljs-comment"># systemctl start nginx</span><br>~]<span class="hljs-comment"># systemctl enable nginx</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/nginx.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>nginx.service.<br>~]<span class="hljs-comment"># netstat -nltup|grep nginx</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">80</span>              <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">21520</span>/nginx: master <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">7443</span>            <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">21520</span>/nginx: master <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">21520</span>/nginx: master <br><br><span class="hljs-regexp">//</span>hdss7-<span class="hljs-number">11</span>和hdss7-<span class="hljs-number">12</span>上启动keepalived<br>~]<span class="hljs-comment"># systemctl start keepalived.service</span><br>~]<span class="hljs-comment"># systemctl enable  keepalived</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/keepalived.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>keepalived.service.<br><br><span class="hljs-regexp">//</span>检查<br>[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># ip addr</span><br><span class="hljs-number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">4</span>c:f4:<span class="hljs-number">9</span>e brd ff:ff:ff:ff:ff:ff<br>    inet <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.4</span>.<span class="hljs-number">7.255</span> scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet <span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>/<span class="hljs-number">32</span> scope global eth0<br>       valid_lft forever preferred_lft forever<br><br><span class="hljs-regexp">//</span>VIP漂移测试<br>nginx -s stop测试，略。。。<br></code></pre></td></tr></table></figure><p><strong>注意：keepalived hdss7-11配置 nopreempt，意为非抢占式</strong><br><strong>原因：如果抢占式，假如生产网络抖动原因，check_port脚本探测不到，VIP有可能会动触发报警，VIP漂移在生产上属于重大生产事故，是要写故障报告的，是无法忍受的</strong></p><h3 id="3-3-部署controller-manager"><a href="#3-3-部署controller-manager" class="headerlink" title="3.3.部署controller-manager"></a>3.3.部署controller-manager</h3><h4 id="3-3-1-集群规划"><a href="#3-3-1-集群规划" class="headerlink" title="3.3.1.集群规划"></a>3.3.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th></tr></thead><tbody><tr><td>hdss7-21.host.com</td><td>controller-manager</td><td>10.4.7.21</td></tr><tr><td>hdss7-22.host.com</td><td>controller-manager</td><td>10.4.7.21</td></tr></tbody></table><p>注意：这里部署文档以hdss7-21为例，另外一台类似</p><h4 id="3-3-2-创建启动脚本"><a href="#3-3-2-创建启动脚本" class="headerlink" title="3.3.2.创建启动脚本"></a>3.3.2.创建启动脚本</h4><ul><li><input disabled="" type="checkbox"> <strong>hdss7-21.host.com上</strong></li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-controller-manager.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kube-controller-manager \<br>  --cluster-cidr <span class="hljs-number">172.7</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span> \<br>  --leader-elect <span class="hljs-keyword">true</span> \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-controller-manager \<br>  --master http:<span class="hljs-comment">//127.0.0.1:8080 \</span><br>  --service-account-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca-key.pem \<br>  --service-cluster-ip-range <span class="hljs-number">192.168</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span> \<br>  --root-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --v <span class="hljs-number">2</span> <br></code></pre></td></tr></table></figure><h4 id="3-3-3-调整文件权限，创建目录"><a href="#3-3-3-调整文件权限，创建目录" class="headerlink" title="3.3.3.调整文件权限，创建目录"></a>3.3.3.调整文件权限，创建目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-controller-manager.sh <br>[root@hdss7-<span class="hljs-number">21</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-controller-manager<br></code></pre></td></tr></table></figure><h4 id="3-3-4-创建supervisor配置"><a href="#3-3-4-创建supervisor配置" class="headerlink" title="3.3.4.创建supervisor配置"></a>3.3.4.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-conntroller-manager.ini</span><br><span class="hljs-section">[program:kube-controller-manager-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-controller-manager.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                                        <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                              <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                                    <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                                  <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                                      <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                                    <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                                     <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                                   <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                                   <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                                         <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                              <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                                      <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                                          <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                                       <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                                       <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><h4 id="3-3-5-启动服务并检查"><a href="#3-3-5-启动服务并检查" class="headerlink" title="3.3.5.启动服务并检查"></a>3.3.5.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br><br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 1716, uptime 3:44:21<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 2032, uptime 1:44:35<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 2196, uptime 0:00:50<br></code></pre></td></tr></table></figure><h4 id="3-3-6-安装部署启动检查所有集群规划主机"><a href="#3-3-6-安装部署启动检查所有集群规划主机" class="headerlink" title="3.3.6.安装部署启动检查所有集群规划主机"></a>3.3.6.安装部署启动检查所有集群规划主机</h4><ul><li><input disabled="" type="checkbox"> <strong>hdss7-22.host.com 跟上述基本相同</strong><br>/etc/supervisord.d/ kube-conntroller-manager.ini<br>需要更改成[program:kube-conntroller-manager-7-22]</li></ul><h3 id="3-4-部署kube-scheduler"><a href="#3-4-部署kube-scheduler" class="headerlink" title="3.4.部署kube-scheduler"></a>3.4.部署kube-scheduler</h3><h4 id="3-4-1-集群规划"><a href="#3-4-1-集群规划" class="headerlink" title="3.4.1.集群规划"></a>3.4.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th></tr></thead><tbody><tr><td>hdss7-21.host.com</td><td>kube-scheduler</td><td>10.4.7.21</td></tr><tr><td>hdss7-22.host.com</td><td>kube-scheduler</td><td>10.4.7.22</td></tr></tbody></table><p><strong>注意：这里部署文档以hdss7-21为例，另一运算节点类似</strong></p><h4 id="3-4-2-创建启动脚本"><a href="#3-4-2-创建启动脚本" class="headerlink" title="3.4.2.创建启动脚本"></a>3.4.2.创建启动脚本</h4><p><strong>hdss7-21上</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-scheduler.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kube-scheduler \<br>  --leader-elect  \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-scheduler \<br>  --master http:<span class="hljs-comment">//127.0.0.1:8080 \</span><br>  --v <span class="hljs-number">2</span><br>  <br>  <br>  <br>  <span class="hljs-comment">//如果主控节点组件在不同的地方，是需要证书验证的，实验环境是在一个宿主机，所以这里无需证书</span><br></code></pre></td></tr></table></figure><h4 id="3-4-3-调整文件权限，创建目录"><a href="#3-4-3-调整文件权限，创建目录" class="headerlink" title="3.4.3.调整文件权限，创建目录"></a>3.4.3.调整文件权限，创建目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x  <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-scheduler.sh<br>[root@hdss7-<span class="hljs-number">21</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-scheduler<br></code></pre></td></tr></table></figure><h4 id="3-4-4-创建supervisor配置"><a href="#3-4-4-创建supervisor配置" class="headerlink" title="3.4.4.创建supervisor配置"></a>3.4.4.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-scheduler.ini</span><br><span class="hljs-section">[program:kube-scheduler-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-scheduler.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                               <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                     <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                           <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                         <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                             <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                           <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                            <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                          <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                          <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                                <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                     <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                             <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                                 <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                              <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                              <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><h4 id="3-4-5-启动服务并检查"><a href="#3-4-5-启动服务并检查" class="headerlink" title="3.4.5.启动服务并检查"></a>3.4.5.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 1716, uptime 4:11:22<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2032, uptime 2:11:36<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2196, uptime 0:27:51<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2284, uptime 0:00:33<br></code></pre></td></tr></table></figure><h4 id="3-4-6-安装部署启动检查所有集群规划主机"><a href="#3-4-6-安装部署启动检查所有集群规划主机" class="headerlink" title="3.4.6.安装部署启动检查所有集群规划主机"></a>3.4.6.安装部署启动检查所有集群规划主机</h4>            <input type="checkbox" disabled checked="checked">hdss7-22.host.com跟上述基本相同          <p>  /etc/supervisord.d/ kube-scheduler.ini<br>  需要更改成[program:kube-scheduler-7-22]</p><h3 id="3-5-检查主控节点"><a href="#3-5-检查主控节点" class="headerlink" title="3.5.检查主控节点"></a>3.5.检查主控节点</h3><h4 id="3-5-1-建立kubectl软链接"><a href="#3-5-1-建立kubectl软链接" class="headerlink" title="3.5.1.建立kubectl软链接"></a>3.5.1.建立kubectl软链接</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> bin]#  ln -s <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/kubectl /u</span>sr<span class="hljs-regexp">/bin/</span>kubectl<br></code></pre></td></tr></table></figure><h4 id="3-5-2-检查主控节点"><a href="#3-5-2-检查主控节点" class="headerlink" title="3.5.2.检查主控节点"></a>3.5.2.检查主控节点</h4><h5 id="检查集群健康状态-cs（cluster-status）"><a href="#检查集群健康状态-cs（cluster-status）" class="headerlink" title="检查集群健康状态 cs（cluster status）"></a>检查集群健康状态 cs（cluster status）</h5><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs puppet">[root@hdss7-21 bin]<span class="hljs-comment"># kubectl get cs</span><br>NAME                 STATUS    MESSAGE              ERROR<br>controller-manager   Healthy   ok                   <br>scheduler            Healthy   ok                   <br>etcd-2               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br><span class="hljs-keyword">etcd</span>-0               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br><span class="hljs-keyword">etcd</span>-1               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125; <br></code></pre></td></tr></table></figure><h2 id="4-部署node节点服务"><a href="#4-部署node节点服务" class="headerlink" title="4.部署node节点服务"></a>4.部署node节点服务</h2><h3 id="4-1-部署kubelet"><a href="#4-1-部署kubelet" class="headerlink" title="4.1.部署kubelet"></a>4.1.部署kubelet</h3><h4 id="4-1-1-集群规划"><a href="#4-1-1-集群规划" class="headerlink" title="4.1.1.集群规划"></a>4.1.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th></tr></thead><tbody><tr><td>hdss7-21.host.com</td><td>kubelet</td><td>10.4.7.21</td></tr><tr><td>hdss7-22.host.com</td><td>kubelet</td><td>10.4.7.22</td></tr></tbody></table><p><strong>注意：这里部署文档以 hdss7-21主机为例，另外一台运算节点安装部署方法类似</strong></p><h4 id="4-1-2-签发kubelet证书"><a href="#4-1-2-签发kubelet证书" class="headerlink" title="4.1.2.签发kubelet证书"></a>4.1.2.签发kubelet证书</h4><ul><li><input disabled="" type="checkbox"> <strong>运维主机hdss7-200上</strong></li></ul><h5 id="4-1-2-1-创建生成证书签名请求（csr）的json配置文件"><a href="#4-1-2-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="4.1.2.1.创建生成证书签名请求（csr）的json配置文件"></a>4.1.2.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]# vi kubelet-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-kubelet&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.10&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.22&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.23&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.24&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.25&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.26&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.27&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.28&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-1-2-2-生成kubelet证书和私钥"><a href="#4-1-2-2-生成kubelet证书和私钥" class="headerlink" title="4.1.2.2.生成kubelet证书和私钥"></a>4.1.2.2.生成kubelet证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=server kubelet-csr.json | cfssl-json -bare kubelet<br></code></pre></td></tr></table></figure><h5 id="4-1-2-3-检查生成的证书和私钥"><a href="#4-1-2-3-检查生成的证书和私钥" class="headerlink" title="4.1.2.3.检查生成的证书和私钥"></a>4.1.2.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 84<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1115 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 452 </span>Nov<span class="hljs-number"> 16 </span>21:59 kubelet-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1468 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet.pem<br></code></pre></td></tr></table></figure><h4 id="4-1-3-拷贝证书到各运算节点，并创建配置"><a href="#4-1-3-拷贝证书到各运算节点，并创建配置" class="headerlink" title="4.1.3.拷贝证书到各运算节点，并创建配置"></a>4.1.3.拷贝证书到各运算节点，并创建配置</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com 上          <h5 id="4-1-3-1-拷贝证书，私钥，注意私钥文件属性600"><a href="#4-1-3-1-拷贝证书，私钥，注意私钥文件属性600" class="headerlink" title="4.1.3.1.拷贝证书，私钥，注意私钥文件属性600"></a>4.1.3.1.拷贝证书，私钥，注意私钥文件属性600</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kubelet.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kubelet-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 32<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:11 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 17 </span>02:08 apiserver.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:07 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 17 </span>02:06 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:08 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 17 </span>02:07 client.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>06:12 kubelet-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1468 </span>Nov<span class="hljs-number"> 17 </span>06:11 kubelet.pem<br></code></pre></td></tr></table></figure><h5 id="4-1-3-2-创建配置—分四步"><a href="#4-1-3-2-创建配置—分四步" class="headerlink" title="4.1.3.2.创建配置—分四步"></a>4.1.3.2.创建配置—分四步</h5>            <input type="checkbox" disabled checked="checked">都在conf目录下          <h6 id="4-1-3-2-1-set-cluster"><a href="#4-1-3-2-1-set-cluster" class="headerlink" title="4.1.3.2.1.set-cluster"></a>4.1.3.2.1.set-cluster</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-cluster myk8s \</span><br>--certificate-authority=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>ca.pem \<br>--embed-certs=true \<br>--server=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>:<span class="hljs-number">7443</span> \<br>--kubeconfig=kubelet.kubeconfig<br><br>返回结果：<br>Cluster <span class="hljs-string">&quot;myk8s&quot;</span> set.<br></code></pre></td></tr></table></figure><h6 id="4-1-3-2-2-set-credentials"><a href="#4-1-3-2-2-set-credentials" class="headerlink" title="4.1.3.2.2.set-credentials"></a>4.1.3.2.2.set-credentials</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-credentials k8s-node \</span><br>--client-certificate=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>client.pem \<br>--client-key=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>client-key.pem \<br>--embed-certs=true \<br>--kubeconfig=kubelet.kubeconfig <br><br>返回结果：<br>User <span class="hljs-string">&quot;k8s-node&quot;</span> set.<br></code></pre></td></tr></table></figure><h6 id="4-1-3-2-3-set-context"><a href="#4-1-3-2-3-set-context" class="headerlink" title="4.1.3.2.3.set-context"></a>4.1.3.2.3.set-context</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-21 conf]# kubectl<span class="hljs-built_in"> config </span>set-context myk8s-context \<br><span class="hljs-attribute">--cluster</span>=myk8s \<br><span class="hljs-attribute">--user</span>=k8s-node \<br><span class="hljs-attribute">--kubeconfig</span>=kubelet.kubeconfig<br><br>返回结果：<br>Context <span class="hljs-string">&quot;myk8s-context&quot;</span> created.<br></code></pre></td></tr></table></figure><h6 id="4-1-3-2-4-use-context"><a href="#4-1-3-2-4-use-context" class="headerlink" title="4.1.3.2.4.use-context"></a>4.1.3.2.4.use-context</h6><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">[root@hdss7-<span class="hljs-number">21</span> conf]# kubectl config <span class="hljs-keyword">use</span>-<span class="hljs-keyword">context</span> myk8s-<span class="hljs-keyword">context</span> <span class="hljs-comment">--kubeconfig=kubelet.kubeconfig</span><br><br>返回结果：<br>Switched <span class="hljs-keyword">to</span> <span class="hljs-keyword">context</span> <span class="hljs-string">&quot;myk8s-context&quot;</span>.<br></code></pre></td></tr></table></figure><h6 id="4-1-3-2-5-查看生成的kubelet-kubeconfig"><a href="#4-1-3-2-5-查看生成的kubelet-kubeconfig" class="headerlink" title="4.1.3.2.5.查看生成的kubelet.kubeconfig"></a>4.1.3.2.5.查看生成的kubelet.kubeconfig</h6><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 conf]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2223 </span>Nov<span class="hljs-number"> 17 </span>02:18 audit.yaml<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 6199 </span>Nov<span class="hljs-number"> 17 </span>06:32 kubelet.kubeconfig<br></code></pre></td></tr></table></figure><p><strong>cat下面的这段实际上就是ca.pem 经过base64编译以后的编码</strong></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code1.png"></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code2.png"></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code3.png"></div></div></div><h6 id="4-1-3-2-6-k8s-node-yaml"><a href="#4-1-3-2-6-k8s-node-yaml" class="headerlink" title="4.1.3.2.6.k8s-node.yaml"></a>4.1.3.2.6.k8s-node.yaml</h6><p><strong>1、创建配置文件</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">conf</span>]<span class="hljs-comment"># vi k8s-node.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s-node</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:node</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s-node</span><br></code></pre></td></tr></table></figure><p><strong>2、根据配置文件创建用户</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl create -f k8s-node.yaml            //-f 指定配置文件</span><br>clusterrolebinding.rbac.authorization.k8s.io/k8s-<span class="hljs-keyword">node</span> <span class="hljs-title">created</span>    //创建角色后会存到etcd里<br></code></pre></td></tr></table></figure><p><strong>3、查询集群角色和查看角色属性</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl get clusterrolebinding k8s-node</span><br>NAME       AGE<br>k8s-<span class="hljs-keyword">node</span>   <span class="hljs-title">7m54s</span><br><br>[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl get clusterrolebinding k8s-node -o yaml</span><br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding                       //定义了一个集群绑定资源，k8s一切皆资源<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2019-11-16T22:53:06Z&quot;</span><br>  name: k8s-<span class="hljs-keyword">node</span>                                <span class="hljs-title">//资源的名称为k8s-node</span><br>  resourceVersion: <span class="hljs-string">&quot;11262&quot;</span><br>  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-<span class="hljs-keyword">node</span><span class="hljs-title"></span><br><span class="hljs-title">  uid</span>: <span class="hljs-number">2</span>b87d554-de37-<span class="hljs-number">494</span>d-b6dd-<span class="hljs-number">7</span>c5d0ecdd5d6<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:<span class="hljs-keyword">node</span>                                  <span class="hljs-title">//给k8s-node</span>集群用户绑定了一个集群角色，叫system：<span class="hljs-keyword">node</span><span class="hljs-title">，意思是让下面k8s-node</span>用户具备这个集群里运算节点的权限<br>subjects:<br>- apiGroup: rbac.authorization.k8s.io<br>  kind: User<br>  name: k8s-<span class="hljs-keyword">node</span>                                 <span class="hljs-title"></span><br></code></pre></td></tr></table></figure><p><strong>4、拷贝kubelet.kubeconfig 到hdss7-22上</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-22 conf]<span class="hljs-comment"># scp hdss7-21:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .</span><br>[root@hdss7-22 conf]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2223 </span>Nov<span class="hljs-number"> 16 </span>18:48 audit.yaml<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 6199 </span>Nov<span class="hljs-number"> 16 </span>23:14 kubelet.kubeconfig<br></code></pre></td></tr></table></figure><h4 id="4-1-4-准备pause基础镜像"><a href="#4-1-4-准备pause基础镜像" class="headerlink" title="4.1.4.准备pause基础镜像"></a>4.1.4.准备pause基础镜像</h4>            <input type="checkbox" disabled checked="checked">运维主机 hdss7-200.host.com上          <p><strong>为什么需要这个pause基础镜像？</strong><br>原因：需要用一个pause基础镜像把这台机器的pod拉起来，因为kubelet是干活的节点，它帮我们调度docker引擎，边车模式，让kebelet控制一个小镜像，先于我们的业务容器起来，让它帮我们业务容器去设置：UTC、NET、IPC，让它先把命名空间占上，业务容易还没起来的时候，pod的ip已经分配出来了。</p><h5 id="4-1-4-1-下载pause镜像"><a href="#4-1-4-1-下载pause镜像" class="headerlink" title="4.1.4.1.下载pause镜像"></a>4.1.4.1.下载pause镜像</h5>            <input type="checkbox" disabled checked="checked">运维主机 hdss7-200.host.com上          <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> ~]# docker pull kubernetes/pause<br>Using default <span class="hljs-keyword">ta</span><span class="hljs-variable">g:</span> latest<br>lates<span class="hljs-variable">t:</span> Pulling from kubernetes/pause<br><span class="hljs-number">4</span>f4fb700ef54: Pull <span class="hljs-built_in">complete</span> <br>b9c8ec465f6<span class="hljs-variable">b:</span> Pull <span class="hljs-built_in">complete</span> <br>Diges<span class="hljs-variable">t:</span> <span class="hljs-built_in">sha256</span>:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105<br>Statu<span class="hljs-variable">s:</span> Downloaded newer image <span class="hljs-keyword">for</span> kubernetes/pause:latest<br>docker.io/kubernetes/pause:latest<br></code></pre></td></tr></table></figure><h5 id="4-1-4-2-提交至docker私有仓库（harbor）中"><a href="#4-1-4-2-提交至docker私有仓库（harbor）中" class="headerlink" title="4.1.4.2.提交至docker私有仓库（harbor）中"></a>4.1.4.2.提交至docker私有仓库（harbor）中</h5><h6 id="4-1-4-2-1-给镜像打tag"><a href="#4-1-4-2-1-给镜像打tag" class="headerlink" title="4.1.4.2.1.给镜像打tag"></a>4.1.4.2.1.给镜像打tag</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">200</span> ~]<span class="hljs-comment"># docker tag f9d5de079539 harbor.od.com/public/pause:latest</span><br>[root@hdss7-<span class="hljs-number">200</span> ~]<span class="hljs-comment"># docker images -a</span><br>REPOSITORY                      <span class="hljs-keyword">TAG</span>                        <span class="hljs-title">IMAGE</span> ID            CREATED             SIZE<br>...                                                                     <br>kubernetes/pause                latest                     f9d5de079539        <span class="hljs-number">5</span> years ago         <span class="hljs-number">240</span>kB<br>harbor.od.com/public/pause      latest                     f9d5de079539        <span class="hljs-number">5</span> years ago         <span class="hljs-number">240</span>kB<br></code></pre></td></tr></table></figure><h6 id="4-1-4-2-2-推到harbor上"><a href="#4-1-4-2-2-推到harbor上" class="headerlink" title="4.1.4.2.2.推到harbor上"></a>4.1.4.2.2.推到harbor上</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">200</span> ~]# docker <span class="hljs-keyword">push</span> harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest<br>The <span class="hljs-keyword">push</span> refers to repository [harbor.od.com<span class="hljs-regexp">/public/</span>pause]<br><span class="hljs-number">5</span>f70bf18a086: Mounted <span class="hljs-keyword">from</span> <span class="hljs-keyword">public</span>/nginx <br>e16a89738269: Pushed <br>latest: digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105 <span class="hljs-keyword">size</span>: <span class="hljs-number">938</span><br></code></pre></td></tr></table></figure><h4 id="4-1-5-创建kubelet启动脚本"><a href="#4-1-5-创建kubelet启动脚本" class="headerlink" title="4.1.5.创建kubelet启动脚本"></a>4.1.5.创建kubelet启动脚本</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> conf]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kubelet.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kubelet \<br>  --anonymous-auth=<span class="hljs-keyword">false</span> \<br>  --cgroup-driver systemd \<br>  --cluster-dns <span class="hljs-number">192.168</span>.<span class="hljs-number">0.2</span> \<br>  --cluster-domain cluster.local \<br>  --<span class="hljs-keyword">runtime</span>-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --kubelet-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --fail-swap-on=<span class="hljs-string">&quot;false&quot;</span> \<br>  --client-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --tls-cert-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet.pem \<br>  --tls-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet-key.pem \<br>  --hostname-override hdss7-<span class="hljs-number">21</span>.host.com \<br>  --image-gc-high-threshold <span class="hljs-number">20</span> \<br>  --image-gc-low-threshold <span class="hljs-number">10</span> \<br>  --kubeconfig .<span class="hljs-regexp">/conf/</span>kubelet.kubeconfig \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet \<br>  --pod-infra-container-image harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest \<br>  --root-dir <span class="hljs-regexp">/data/</span>kubelet<br>  <br>  ###################参数说明############<br>    --anonymous-auth=<span class="hljs-keyword">false</span> \                                  <span class="hljs-comment">//匿名登陆，这里不允许</span><br>  --cgroup-driver systemd \                                    <span class="hljs-comment">//这里和docker的daemon.json保持一直</span><br>  --cluster-dns <span class="hljs-number">192.168</span>.<span class="hljs-number">0.2</span> \                                   <br>  --cluster-domain cluster.local \<br>  --<span class="hljs-keyword">runtime</span>-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --kubelet-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --fail-swap-on=<span class="hljs-string">&quot;false&quot;</span> \                                  <span class="hljs-comment">//正常是关闭swap分区的。这里不关，没有关闭swap分区正常启动，没有报错</span><br>  --client-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --tls-cert-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet.pem \<br>  --tls-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet-key.pem \<br>  --hostname-override hdss7-<span class="hljs-number">21</span>.host.com \           <br>  --image-gc-high-threshold <span class="hljs-number">20</span> \<br>  --image-gc-low-threshold <span class="hljs-number">10</span> \<br>  --kubeconfig .<span class="hljs-regexp">/conf/</span>kubelet.kubeconfig \          <br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet \<br>  --pod-infra-container-image harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest \<br>  --root-dir <span class="hljs-regexp">/data/</span>kubelet<br></code></pre></td></tr></table></figure><p><strong>注意：kubelet集群个主机的启动脚本略不同，其他节点注意修改：–hostname-override</strong></p><h4 id="4-1-6-检查配置，权限，创建日志目录"><a href="#4-1-6-检查配置，权限，创建日志目录" class="headerlink" title="4.1.6.检查配置，权限，创建日志目录"></a>4.1.6.检查配置，权限，创建日志目录</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> conf]# ls -l|<span class="hljs-keyword">grep</span> kubelet<br>-rw------- <span class="hljs-number">1</span> root root <span class="hljs-number">6199</span> Nov <span class="hljs-number">17</span> <span class="hljs-number">06</span>:<span class="hljs-number">32</span> kubelet.kubeconfig<br><br>[root@hdss7-<span class="hljs-number">21</span> conf]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kubelet.sh <br>[root@hdss7-<span class="hljs-number">21</span> conf]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet   <span class="hljs-regexp">/data/</span>kubelet<br></code></pre></td></tr></table></figure><h4 id="4-1-7-创建supervisor配置"><a href="#4-1-7-创建supervisor配置" class="headerlink" title="4.1.7.创建supervisor配置"></a>4.1.7.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 conf]</span><span class="hljs-comment">#  vi /etc/supervisord.d/kube-kubelet.ini</span><br><span class="hljs-section">[program:kube-kubelet-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kubelet.sh     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                        <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin              <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                    <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                  <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                      <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                    <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                     <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                   <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                   <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                         <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                              <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                      <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                          <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                       <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                       <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><p><strong>注意：其他主机部署时请注意修改program标签</strong></p><h4 id="4-1-8-启动服务并检查"><a href="#4-1-8-启动服务并检查" class="headerlink" title="4.1.8.启动服务并检查"></a>4.1.8.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> conf]# supervisorctl  update<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 3270, uptime 0:00:46<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3273, uptime 0:00:46<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 3267, uptime 0:00:46<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                RUNNING   pid 3268, uptime 0:00:46<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3269, uptime 0:00:46<br><br>遇到一个问题，没起来：<br>查看日志原来是我的docker服务没起，systemctl  start docker    systemctl enable docker<br></code></pre></td></tr></table></figure><h4 id="4-1-9-检查运算节点"><a href="#4-1-9-检查运算节点" class="headerlink" title="4.1.9.检查运算节点"></a>4.1.9.检查运算节点</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-21</span> bin]# tailf /data/logs/kubernetes/kube-kubelet/kubelet.stdout.<span class="hljs-keyword">log</span> <br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.074479</span>    <span class="hljs-number">3272</span> kubelet_node_status.go:<span class="hljs-number">72</span>] Attempting <span class="hljs-keyword">to</span> register node hdss7<span class="hljs-number">-21.</span>host.com<br>E1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.088198</span>    <span class="hljs-number">3272</span> kubelet.go:<span class="hljs-number">2248</span>] node &quot;hdss7-21.host.com&quot; <span class="hljs-keyword">not</span> <span class="hljs-built_in">found</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.088590</span>    <span class="hljs-number">3272</span> kubelet_node_status.go:<span class="hljs-number">75</span>] Successfully registered node hdss7<span class="hljs-number">-21.</span>host.com<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119351</span>    <span class="hljs-number">3272</span> cpu_manager.go:<span class="hljs-number">155</span>] [cpumanager] starting <span class="hljs-keyword">with</span> <span class="hljs-keyword">none</span> <span class="hljs-keyword">policy</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119363</span>    <span class="hljs-number">3272</span> cpu_manager.go:<span class="hljs-number">156</span>] [cpumanager] reconciling every <span class="hljs-number">10</span>s<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119382</span>    <span class="hljs-number">3272</span> policy_none.go:<span class="hljs-number">42</span>] [cpumanager] <span class="hljs-keyword">none</span> <span class="hljs-keyword">policy</span>: <span class="hljs-keyword">Start</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.155413</span>    <span class="hljs-number">3272</span> kubelet.go:<span class="hljs-number">1822</span>] skipping pod synchronization - container runtime status <span class="hljs-keyword">check</span> may <span class="hljs-keyword">not</span> have completed yet<br>W1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.374787</span>    <span class="hljs-number">3272</span> manager.go:<span class="hljs-number">546</span>] Failed <span class="hljs-keyword">to</span> retrieve <span class="hljs-keyword">checkpoint</span> <span class="hljs-keyword">for</span> &quot;kubelet_internal_checkpoint&quot;: <span class="hljs-keyword">checkpoint</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">found</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.375126</span>    <span class="hljs-number">3272</span> plugin_manager.go:<span class="hljs-number">116</span>] Starting Kubelet Plugin Manager<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.690595</span>    <span class="hljs-number">3272</span> reconciler.go:<span class="hljs-number">150</span>] Reconciler: <span class="hljs-keyword">start</span> <span class="hljs-keyword">to</span> sync state<br></code></pre></td></tr></table></figure><h4 id="4-1-10-安装部署启动检查所有集群规划主机"><a href="#4-1-10-安装部署启动检查所有集群规划主机" class="headerlink" title="4.1.10.安装部署启动检查所有集群规划主机"></a>4.1.10.安装部署启动检查所有集群规划主机</h4><p><strong>其他节点类似，有些需要稍许调整，上面有标注：</strong><br>/opt/kubernetes/server/bin/conf/kubelet.kubeconfig<br>/opt/kubernetes/server/bin/kubelet.sh<br>/etc/supervisord.d/kube-kubelet.ini</p><h4 id="4-1-11-检查所有运算节点"><a href="#4-1-11-检查所有运算节点" class="headerlink" title="4.1.11.检查所有运算节点"></a>4.1.11.检查所有运算节点</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES    AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br><br>// 角色是none，打个标签，标签是特色管理功能之一<br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=</span><br><span class="hljs-keyword">node</span><span class="hljs-title">/hdss7-21</span>.host.com labeled<br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES    AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-keyword">master</span>   <span class="hljs-title">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=</span><br><span class="hljs-keyword">node</span><span class="hljs-title">/hdss7-21</span>.host.com labeled<br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES         AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>        <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br></code></pre></td></tr></table></figure><h3 id="4-2-部署kube-proxy"><a href="#4-2-部署kube-proxy" class="headerlink" title="4.2.部署kube-proxy"></a>4.2.部署kube-proxy</h3><p><strong>联结pod网络和集群网络</strong></p><h4 id="4-2-1-集群规划"><a href="#4-2-1-集群规划" class="headerlink" title="4.2.1.集群规划"></a>4.2.1.集群规划</h4><table><thead><tr><th>主机名</th><th>角色</th><th>ip</th></tr></thead><tbody><tr><td>hdss7-21.host.com</td><td>kube-proxy</td><td>10.4.7.21</td></tr><tr><td>hdss7-22.host.com</td><td>kube-proxy</td><td>10.4.7.21</td></tr></tbody></table><p><strong>注意：这里部署以hdss7-21主机为例，其他运算节点类似</strong></p><h4 id="4-2-2-签发kube-proxy证书"><a href="#4-2-2-签发kube-proxy证书" class="headerlink" title="4.2.2.签发kube-proxy证书"></a>4.2.2.签发kube-proxy证书</h4>            <input type="checkbox" disabled checked="checked">hdss7-200.host.com上          <h5 id="4-2-2-1-创建生成证书签名请求（csr）的json配置文件"><a href="#4-2-2-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="4.2.2.1.创建生成证书签名请求（csr）的json配置文件"></a>4.2.2.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-200</span> certs]<span class="hljs-meta"># vi kube-proxy-csr.json</span><br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;system:kube-proxy&quot;</span>,<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-2-2-2-生成kubelet证书和私钥"><a href="#4-2-2-2-生成kubelet证书和私钥" class="headerlink" title="4.2.2.2.生成kubelet证书和私钥"></a>4.2.2.2.生成kubelet证书和私钥</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-200</span> certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-<span class="hljs-type">json</span> -bare kube-proxy-client<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] generate received request<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] received CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] generating key: rsa<span class="hljs-number">-2048</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] encoded CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] signed certificate <span class="hljs-keyword">with</span> <span class="hljs-type">serial</span> number <span class="hljs-number">490532965938220149616881213802710440162344647640</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-built_in">WARNING</span>] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable <span class="hljs-keyword">for</span><br>websites. <span class="hljs-keyword">For</span> more information see the Baseline Requirements <span class="hljs-keyword">for</span> the Issuance <span class="hljs-keyword">and</span> Management<br><span class="hljs-keyword">of</span> Publicly-<span class="hljs-keyword">Trusted</span> Certificates, v<span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.6</span>, <span class="hljs-keyword">from</span> the CA/Browser Forum (https://cabforum.org);<br>specifically, section <span class="hljs-number">10.2</span><span class="hljs-number">.3</span> (&quot;Information Requirements&quot;).<br></code></pre></td></tr></table></figure><h5 id="4-2-2-3-检查生成的证书和私钥"><a href="#4-2-2-3-检查生成的证书和私钥" class="headerlink" title="4.2.2.3.检查生成的证书和私钥"></a>4.2.2.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1005 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client.csr<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1675 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1375 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 267 </span>Nov<span class="hljs-number"> 17 </span>00:57 kube-proxy-csr.json<br></code></pre></td></tr></table></figure><h4 id="4-2-3-拷贝证书至各运算节点，并创建配置"><a href="#4-2-3-拷贝证书至各运算节点，并创建配置" class="headerlink" title="4.2.3.拷贝证书至各运算节点，并创建配置"></a>4.2.3.拷贝证书至各运算节点，并创建配置</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <h5 id="4-2-3-1-拷贝证书-私钥，注意私钥文件属性600"><a href="#4-2-3-1-拷贝证书-私钥，注意私钥文件属性600" class="headerlink" title="4.2.3.1.拷贝证书,私钥，注意私钥文件属性600"></a>4.2.3.1.拷贝证书,私钥，注意私钥文件属性600</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kube-proxy-client.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kube-proxy-client-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 40<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1675 </span>Nov<span class="hljs-number"> 17 </span>09:10 kube-proxy-client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1375 </span>Nov<span class="hljs-number"> 17 </span>09:10 kube-proxy-client.pem<br></code></pre></td></tr></table></figure><h5 id="4-2-3-2-创建配置"><a href="#4-2-3-2-创建配置" class="headerlink" title="4.2.3.2.创建配置"></a>4.2.3.2.创建配置</h5><p><strong>注意必须在conf目录下，否则报错</strong></p><h6 id="4-2-3-2-1-set-cluster"><a href="#4-2-3-2-1-set-cluster" class="headerlink" title="4.2.3.2.1.set-cluster"></a>4.2.3.2.1.set-cluster</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-cluster myk8s \</span><br>--certificate-authority=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>ca.pem \<br>--embed-certs=true \<br>--server=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>:<span class="hljs-number">7443</span> \<br>--kubeconfig=kube-proxy.kubeconfig<br><br>返回结果：<br>Cluster <span class="hljs-string">&quot;myk8s&quot;</span> set.<br></code></pre></td></tr></table></figure><h6 id="4-2-3-2-2-set-credentials"><a href="#4-2-3-2-2-set-credentials" class="headerlink" title="4.2.3.2.2.set-credentials"></a>4.2.3.2.2.set-credentials</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment">#  kubectl config set-credentials kube-proxy \</span><br>  --client-certificate=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>kube-proxy-client.pem \<br>  --client-key=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>kube-proxy-client-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=kube-proxy.kubeconfig<br>  <br>  返回结果：<br>  User <span class="hljs-string">&quot;kube-proxy&quot;</span> set.<br></code></pre></td></tr></table></figure><h6 id="4-2-3-2-3-set-context"><a href="#4-2-3-2-3-set-context" class="headerlink" title="4.2.3.2.3.set-context"></a>4.2.3.2.3.set-context</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-21 conf]# kubectl<span class="hljs-built_in"> config </span>set-context myk8s-context \<br><span class="hljs-attribute">--cluster</span>=myk8s \<br><span class="hljs-attribute">--user</span>=kube-proxy \<br><span class="hljs-attribute">--kubeconfig</span>=kube-proxy.kubeconfig<br><br>返回结果：<br>Context <span class="hljs-string">&quot;myk8s-context&quot;</span> created.<br></code></pre></td></tr></table></figure><h6 id="4-2-3-2-4-use-context"><a href="#4-2-3-2-4-use-context" class="headerlink" title="4.2.3.2.4.use-context"></a>4.2.3.2.4.use-context</h6><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">[root@hdss7-<span class="hljs-number">21</span> conf]# kubectl config <span class="hljs-keyword">use</span>-<span class="hljs-keyword">context</span> myk8s-<span class="hljs-keyword">context</span> <span class="hljs-comment">--kubeconfig=kube-proxy.kubeconfig</span><br><br>返回结果<br>Switched <span class="hljs-keyword">to</span> <span class="hljs-keyword">context</span> <span class="hljs-string">&quot;myk8s-context&quot;</span>.<br></code></pre></td></tr></table></figure><h6 id="4-2-3-2-5-拷贝kube-proxy-kubeconfig-到-hdss7-22的conf目录下"><a href="#4-2-3-2-5-拷贝kube-proxy-kubeconfig-到-hdss7-22的conf目录下" class="headerlink" title="4.2.3.2.5.拷贝kube-proxy.kubeconfig 到 hdss7-22的conf目录下"></a>4.2.3.2.5.拷贝kube-proxy.kubeconfig 到 hdss7-22的conf目录下</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> conf]# scp hdss7-<span class="hljs-number">21</span>:<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/conf/</span>kube-proxy.kubeconfig .<br></code></pre></td></tr></table></figure><h4 id="4-2-4-创建kube-proxy启动脚本"><a href="#4-2-4-创建kube-proxy启动脚本" class="headerlink" title="4.2.4.创建kube-proxy启动脚本"></a>4.2.4.创建kube-proxy启动脚本</h4>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <h5 id="4-2-4-1-加载ipvs模块"><a href="#4-2-4-1-加载ipvs模块" class="headerlink" title="4.2.4.1.加载ipvs模块"></a>4.2.4.1.加载ipvs模块</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# lsmod |<span class="hljs-keyword">grep</span> ip_vs<br>[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/root/i</span>pvs.sh<br>#!<span class="hljs-regexp">/bin/</span>bash<br>ipvs_mods_dir=<span class="hljs-string">&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</span><br><span class="hljs-keyword">for</span> i in $(ls $ipvs_mods_dir|<span class="hljs-keyword">grep</span> -o <span class="hljs-string">&quot;^[^.]*&quot;</span>)<br><span class="hljs-keyword">do</span><br>  <span class="hljs-regexp">/sbin/m</span>odinfo -F filename $i &amp;&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>  <span class="hljs-keyword">if</span> [ $? -eq <span class="hljs-number">0</span> ];then<br>    <span class="hljs-regexp">/sbin/m</span>odprobe $i<br>  fi<br>done    <br><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x <span class="hljs-regexp">/root/i</span>pvs.sh <br>[root@hdss7-<span class="hljs-number">21</span> bin]# sh <span class="hljs-regexp">/root/i</span>pvs.sh <br><br>[root@hdss7-<span class="hljs-number">21</span> bin]# lsmod |<span class="hljs-keyword">grep</span> ip_vs<br>ip_vs_wrr              <span class="hljs-number">12697</span>  <span class="hljs-number">0</span> <br>ip_vs_wlc              <span class="hljs-number">12519</span>  <span class="hljs-number">0</span> <br>ip_vs_sh               <span class="hljs-number">12688</span>  <span class="hljs-number">0</span> <br>ip_vs_sed              <span class="hljs-number">12519</span>  <span class="hljs-number">0</span> <br>......<br></code></pre></td></tr></table></figure><h5 id="4-2-4-2-创建启动脚本"><a href="#4-2-4-2-创建启动脚本" class="headerlink" title="4.2.4.2.创建启动脚本"></a>4.2.4.2.创建启动脚本</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@hdss7-21 bin]<span class="hljs-comment"># vi /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br><span class="hljs-string">./kube-proxy</span> \<br>  <span class="hljs-params">--cluster-cidr</span> 172.7.0.0/16 \<br>  <span class="hljs-params">--hostname-override</span> hdss7-21.host.com \<br>  <span class="hljs-params">--proxy-mode=ipvs</span> \<br>  <span class="hljs-params">--ipvs-scheduler=nq</span> \<br>  <span class="hljs-params">--kubeconfig</span> <span class="hljs-string">./conf/kube-proxy.kubeconfig</span><br></code></pre></td></tr></table></figure><h4 id="4-2-5-检查配置，权限，创建日志目录"><a href="#4-2-5-检查配置，权限，创建日志目录" class="headerlink" title="4.2.5.检查配置，权限，创建日志目录"></a>4.2.5.检查配置，权限，创建日志目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> bin]# ls -l <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/conf/</span>|<span class="hljs-keyword">grep</span> kube-proxy<br>-rw------- <span class="hljs-number">1</span> root root <span class="hljs-number">6215</span> Nov <span class="hljs-number">17</span> <span class="hljs-number">01</span>:<span class="hljs-number">22</span> kube-proxy.kubeconfig<br><br>[root@hdss7-<span class="hljs-number">22</span> bin]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-proxy.sh <br>[root@hdss7-<span class="hljs-number">22</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-proxy<br></code></pre></td></tr></table></figure><h4 id="4-2-6-创建supervisor配置"><a href="#4-2-6-创建supervisor配置" class="headerlink" title="4.2.6.创建supervisor配置"></a>4.2.6.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-proxy.ini</span><br><span class="hljs-section">[program:kube-proxy-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-proxy.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                           <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                 <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                       <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                     <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                         <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                       <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                        <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                      <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                      <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                            <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                 <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                         <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                             <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                          <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                          <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure><h4 id="4-2-7-启动服务并检查"><a href="#4-2-7-启动服务并检查" class="headerlink" title="4.2.7.启动服务并检查"></a>4.2.7.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 3270, uptime 1:22:21<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3273, uptime 1:22:21<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 3267, uptime 1:22:21<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                RUNNING   pid 3268, uptime 1:22:21<br>kube-proxy<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                  RUNNING   pid 19580, uptime 0:00:31<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3269, uptime 1:22:21<br><br>[root@hdss7<span class="hljs-string">-21</span> bin]# yum install ipvsadm -y<br>[root@hdss7<span class="hljs-string">-21</span> bin]# ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  192.168.0.1:443 nq<br>  -&gt; 10.4.7.21:6443               Masq    1      0          0         <br>  -&gt; 10.4.7.22:6443               Masq    1      0          0   <br>  <br>  <br>[root@hdss7<span class="hljs-string">-21</span> bin]# kubectl get svc<br>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   192.168.0.1   &lt;none&gt;        443/TCP   7h11m<br></code></pre></td></tr></table></figure><h4 id="4-2-8-安装部署启动检查所有集群规划主机"><a href="#4-2-8-安装部署启动检查所有集群规划主机" class="headerlink" title="4.2.8.安装部署启动检查所有集群规划主机"></a>4.2.8.安装部署启动检查所有集群规划主机</h4><p><strong>hdss7-22 跟上述基本相同</strong><br>/etc/supervisord.d/kube-proxy.ini<br>需要更改成[program:kube-proxy-7-21]</p><p>/opt/kubernetes/server/bin/kube-proxy.sh<br>需要改成 –hostname-override hdss7-22.host.com</p><h2 id="5-验证kubernetes集群"><a href="#5-验证kubernetes集群" class="headerlink" title="5.验证kubernetes集群"></a>5.验证kubernetes集群</h2><h3 id="5-1-在任意一个运算节点，创建一个资源配置清单"><a href="#5-1-在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="5.1.在任意一个运算节点，创建一个资源配置清单"></a>5.1.在任意一个运算节点，创建一个资源配置清单</h3>            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上          <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vi /root/nginx-ds.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ds</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-ds</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">harbor.od.com/public/nginx:v1.7.9</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h3 id="5-2-应用资源配置，并检查"><a href="#5-2-应用资源配置，并检查" class="headerlink" title="5.2.应用资源配置，并检查"></a>5.2.应用资源配置，并检查</h3><h4 id="5-2-1-hdss7-21上的操作"><a href="#5-2-1-hdss7-21上的操作" class="headerlink" title="5.2.1.hdss7-21上的操作"></a>5.2.1.hdss7-21上的操作</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-21 bin]# kubectl create -f /root/nginx-ds.yaml<br><br>返回结果：<br>daemonset.extensions/nginx-ds created<br><br><br><br>[root@hdss7-21 bin]# kubectl get pods<br>NAME             READY   STATUS    RESTARTS   AGE<br>nginx-ds-mcvxt   1/1     Running   0          8h<br>nginx-ds-zsnz9   1/1     Running   0          8h<br><br><br>[root@hdss7-21 bin]# kubectl get pods -o wide<br>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES<br>nginx-ds-mcvxt   1/1     Running   0          8h    172.7.21.2   hdss7-21.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>nginx-ds-zsnz9   1/1     Running   0          8h    172.7.22.2   hdss7-22.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br><br>[root@hdss7-21 bin]# curl 172.7.21.2<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br>[root@hdss7-21 bin]# curl 172.7.22.2<br>^C   <br>//curl 不到？<br>原因是跨宿主机，docker容器还不能通信，下篇：flannel解决这个问题<br></code></pre></td></tr></table></figure><h4 id="5-2-2-hdss7-22上的操作"><a href="#5-2-2-hdss7-22上的操作" class="headerlink" title="5.2.2.hdss7-22上的操作"></a>5.2.2.hdss7-22上的操作</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-22 bin]# kubectl get pods -o wide<br>NAME             READY   STATUS    RESTARTS   AGE     IP           NODE                NOMINATED NODE   READINESS GATES<br>nginx-ds-mcvxt   1/1     Running   0          6m45s   172.7.21.2   hdss7-21.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>nginx-ds-zsnz9   1/1     Running   0          6m45s   172.7.22.2   hdss7-22.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>[root@hdss7-22 bin]# curl 172.7.22.2<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br>[root@hdss7-22 bin]# curl 172.7.21.2<br>^C<br>//curl 不到，上述已有解释<br></code></pre></td></tr></table></figure><h4 id="5-2-3-查看kubernetes集群上篇是否搭建好"><a href="#5-2-3-查看kubernetes集群上篇是否搭建好" class="headerlink" title="5.2.3.查看kubernetes集群上篇是否搭建好"></a>5.2.3.查看kubernetes集群上篇是否搭建好</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get cs</span><br>NAME                 STATUS    MESSAGE              ERROR<br>controller-manager   Healthy   ok                   <br>scheduler            Healthy   ok                   <br>etcd-<span class="hljs-number">1</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-<span class="hljs-number">2</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-<span class="hljs-number">0</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125; <br><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get node</span><br>NAME                STATUS   ROLES         AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">9h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">10h</span>   v1.<span class="hljs-number">15.2</span><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get pods</span><br>NAME             READY   STATUS    RESTARTS   AGE<br>nginx-ds-mcvxt   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">8h</span><br>nginx-ds-zsnz9   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">8h</span><br></code></pre></td></tr></table></figure><h4 id="5-2-4-FAQ"><a href="#5-2-4-FAQ" class="headerlink" title="5.2.4.FAQ:"></a>5.2.4.FAQ:</h4><h5 id="5-2-4-1-：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错"><a href="#5-2-4-1-：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错" class="headerlink" title="5.2.4.1.：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错"></a>5.2.4.1.：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">E1111</span> <span class="hljs-number">12</span>:<span class="hljs-number">27</span>:<span class="hljs-number">38</span>.<span class="hljs-number">031263</span>   <span class="hljs-number">23086</span> server_others.go:<span class="hljs-number">259</span>] can&#x27;t determine whether to use ipvs proxy, error: error getting ipset version, error: executable file not found in $PATH<br><span class="hljs-attribute">W1111</span> <span class="hljs-number">12</span>:<span class="hljs-number">27</span>:<span class="hljs-number">38</span>.<span class="hljs-number">049355</span>   <span class="hljs-number">23086</span> node.go:<span class="hljs-number">113</span>] Failed to retrieve node info: Get https://<span class="hljs-number">10.4.7.10:7443</span>/api/v<span class="hljs-number">1</span>/nodes/hdss<span class="hljs-number">7</span>-<span class="hljs-number">21</span>.host.com: EOF<br><br><span class="hljs-attribute">yum</span> install   ipset  -y，用supervisor重启服务，问题解决<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>K8S</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>k8S</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux-SAMBA服务</title>
    <link href="/posts/7012af2a/"/>
    <url>/posts/7012af2a/</url>
    
    <content type="html"><![CDATA[<h1 id="一、安装-Samba-服务，以及基础配置"><a href="#一、安装-Samba-服务，以及基础配置" class="headerlink" title="一、安装 Samba 服务，以及基础配置"></a>一、安装 <code>Samba</code> 服务，以及基础配置</h1><h2 id="Samba"><a href="#Samba" class="headerlink" title="Samba"></a><strong><code>Samba</code></strong></h2><p><code>Samba</code> 基于 <code>SMB/CIFS</code> 协议开发的软件，为不同操作系统提供文件服务和打印服务。<code>Samba</code> 由 <code>smba</code> 和 <code>nmbd</code> 两个守护进程组成，使用服务端和客户端模式。</p><p><code>smbd</code> 进程除了为客户端提供文件共享与打印服务，还负责用户权限验证及锁功能。<code>smbd</code> 默认监听的端口是 <code>TCP</code> 协议的 <code>139</code> 与 <code>445</code> ，<code>Samba</code> 通过 <code>smb</code> 服务启动 <code>smbd</code> 进程。</p><p><code>nmbd</code> 进程提供 <code>NetBIOS</code> 名称服务，类似于 <code>DNS</code> 实现的功能，可以把 <code>Linux</code> 系统共享的工作组名称与其 <code>IP</code> 对应起来，<code>Samba</code> 通过 <code>nmb</code> 服务启动 <code>nmbd</code> 进程，该进程默认使用<code>UDP 137</code>端口</p><p>本地用户验证登录：<code>Linux</code> 账户+ <code>samba</code> 的密码密码在 <code>passdb.tdb</code></p><h2 id="Samba服务端配置步骤："><a href="#Samba服务端配置步骤：" class="headerlink" title="Samba服务端配置步骤："></a>Samba服务端配置步骤：</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1.基础操作<br>systemctl stop firewalld<br>setenforce 0 &amp;&amp; sed -i <span class="hljs-string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config<br>2.安装samba服务<br>yum -y install samba<br>3.创建共享目录并修改权限<br>mkdir /common<br>chmod 777 /common/<br>4.创建samba用户<br>useradd -s /sbin/nologin zhangsan<br>pdbedit -a zhangsan<br>5.设置samba的配置文件<br>[common]<br>        <span class="hljs-attribute">comment</span>=share #备注信息<br>        <span class="hljs-attribute">path</span>=/common #绝对路径<br>        write <span class="hljs-attribute">list</span>=zhangsan #允许读写的用户，@用户组<br>        <span class="hljs-attribute">browseable</span>=<span class="hljs-literal">yes</span> #共享是否被查看<br>        <span class="hljs-attribute">writable</span>=<span class="hljs-literal">no</span> #只读<br>        create <span class="hljs-attribute">mask</span>=0664<br>        directory <span class="hljs-attribute">mask</span>=0770<br>6.重启samba服务，并开机自启<br>systemctl restart<span class="hljs-built_in"> smb </span>&amp;&amp; systemctl <span class="hljs-builtin-name">enable</span> smb<br></code></pre></td></tr></table></figure><h2 id="Samba客户端配置步骤："><a href="#Samba客户端配置步骤：" class="headerlink" title="Samba客户端配置步骤："></a>Samba客户端配置步骤：</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">客户端登录方式：<br>linux端：<br>smbclient -U 用户名 -L <span class="hljs-regexp">//</span>服务器ip<br>smbclient -U 用户名  <span class="hljs-regexp">//</span>服务器ip/共享名<br>Windows端：<br>\\服务器ip\共享名<br>net use * /del  清除smb登录信息<br><span class="hljs-number">1</span>.在linux客户端上使用yum -y install samba-client 安、装samba客户端<br>[root@localhost ~]<span class="hljs-comment"># yum -y install samba-client</span><br><span class="hljs-number">2</span>.查看指定服务器共享资源<br>[root@Clare ~]<span class="hljs-comment"># smbclient -L //192.168.66.11 -U zhangsan%123456</span><br><span class="hljs-number">3</span>.挂载共享目录并设置开机自动项<br>    mkdir /common<br>    vim <span class="hljs-regexp">/etc/</span>fstab<br><span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">210.130</span><span class="hljs-regexp">/common /</span>common cifs  username=zhangsan,password=<span class="hljs-number">123456</span>,_netdev <span class="hljs-number">0</span> <span class="hljs-number">0</span> <br><br>mount -a<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux-链路聚合</title>
    <link href="/posts/a2ef5425/"/>
    <url>/posts/a2ef5425/</url>
    
    <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>链路聚合：将多个物理端口汇聚在一起，形成一个逻辑端口，以实现流量的负载分担。</p><p>网卡的链路聚合就是将多个网卡绑定在一起，一张网卡损坏，网络依旧运行。</p><p>网卡的链路聚合一般常用的有<code>“bond”“team”</code>两种模式。<code>“bond”</code>最多可以添加两张网卡，<code>“team”</code>最多可以添加八张网卡。</p><h1 id="一、bond"><a href="#一、bond" class="headerlink" title="一、bond"></a>一、<code>bond</code></h1><h2 id="bond-的七种模式："><a href="#bond-的七种模式：" class="headerlink" title="bond 的七种模式："></a><code>bond</code> 的七种模式：</h2><ul><li><code>mode=0(balance-rr)(平衡抡循环策略)</code></li><li><code>mode=1(active-backup)(主-备份策略)</code></li><li><code>mode=2(balance-xor)(平衡策略)</code></li><li><code>mode=3(broadcast)(广播策略)</code></li><li><code>mode=4(802.3ad)(IEEE 802.3ad动态链路聚合)</code></li><li><code>mode=5(balance-tlb)(适配器传输负载均衡)</code></li><li><code>mode=6(balance-alb)(适配器适应性负载均衡)</code></li></ul><h2 id="1、查看目前的网卡的名称和状态"><a href="#1、查看目前的网卡的名称和状态" class="headerlink" title="1、查看目前的网卡的名称和状态"></a>1、查看目前的网卡的名称和状态</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@test ~]# nmcli device status <br>DEVICE <span class="hljs-built_in"> TYPE </span>     STATE     <span class="hljs-built_in"> CONNECTION </span><br>ens32  <span class="hljs-built_in"> ethernet </span> connected  ens32      <br>ens34  <span class="hljs-built_in"> ethernet </span> connected  ens34      <br>ens35  <span class="hljs-built_in"> ethernet </span> connected  ens35      <br>lo      loopback  unmanaged  -- <br></code></pre></td></tr></table></figure><h2 id="2、创建-bond0-端口"><a href="#2、创建-bond0-端口" class="headerlink" title="2、创建 bond0 端口"></a>2、创建 <code>bond0</code> 端口</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmcli</span> connection add type bond con-name bond<span class="hljs-number">0</span> ifname bond<span class="hljs-number">0</span> ipv<span class="hljs-number">4</span>.addresses <span class="hljs-number">172.24.8.10</span>/<span class="hljs-number">24</span> ipv<span class="hljs-number">4</span>.gateway  <span class="hljs-number">172.25.8.254</span> ipv<span class="hljs-number">4</span>.method manual<br></code></pre></td></tr></table></figure><h2 id="3、将接口-ens34-和-ens35-加入到-bond"><a href="#3、将接口-ens34-和-ens35-加入到-bond" class="headerlink" title="3、将接口 ens34 和 ens35 加入到 bond"></a>3、将接口 <code>ens34</code> 和 <code>ens35</code> 加入到 <code>bond</code></h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">nmcli connection add <span class="hljs-keyword">type</span> bond-<span class="hljs-literal">slave</span> ifname ens34 con-name bond_port1 <span class="hljs-keyword">master</span> <span class="hljs-title">bond0</span> <br>nmcli connection add <span class="hljs-keyword">type</span> bond-<span class="hljs-literal">slave</span> ifname ens35 con-name bond_port2 <span class="hljs-keyword">master</span> <span class="hljs-title">bond0</span><br></code></pre></td></tr></table></figure><h2 id="4、启动"><a href="#4、启动" class="headerlink" title="4、启动"></a>4、启动</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmcli</span> connection up bond<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h2 id="5、验证"><a href="#5、验证" class="headerlink" title="5、验证"></a>5、验证</h2><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@test ~]</span># ip addr show bond0 <br><span class="hljs-number">5</span>: bond0: &lt;NO-CARRIER,BROADCAST,MULTICAST,MASTER,UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state DOWN group default qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">56</span>:<span class="hljs-number">66</span>:<span class="hljs-number">09</span>:9f:fd:cb brd ff:ff:ff:ff:ff:ff<br>    inet <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">10</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">255</span> scope global noprefixroute bond0<br>       valid_lft forever preferred_lft forever<br>       <br><span class="hljs-string">[root@test ~]</span># ip route <br>default via <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">254</span> dev ens32 proto static metric <span class="hljs-number">100</span> <br>default via <span class="hljs-number">172</span>.<span class="hljs-number">25</span>.<span class="hljs-number">8</span>.<span class="hljs-number">254</span> dev bond0 proto static metric <span class="hljs-number">300</span> <br><span class="hljs-number">172.24.8.0</span>/<span class="hljs-number">24</span> dev ens32 proto kernel scope link src <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">138</span> metric <span class="hljs-number">100</span> <br><span class="hljs-number">172.24.8.0</span>/<span class="hljs-number">24</span> dev ens34 proto kernel scope link src <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">142</span> metric <span class="hljs-number">101</span> <br><span class="hljs-number">172.24.8.0</span>/<span class="hljs-number">24</span> dev ens35 proto kernel scope link src <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">141</span> metric <span class="hljs-number">102</span> <br><span class="hljs-number">172.24.8.0</span>/<span class="hljs-number">24</span> dev bond0 proto kernel scope link src <span class="hljs-number">172</span>.<span class="hljs-number">24</span>.<span class="hljs-number">8</span>.<span class="hljs-number">10</span> metric <span class="hljs-number">300</span> <br><span class="hljs-number">172.25.8.254</span> dev bond0 proto static scope link metric <span class="hljs-number">300</span><br></code></pre></td></tr></table></figure><h2 id="6、测试"><a href="#6、测试" class="headerlink" title="6、测试"></a>6、测试</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#断开一块网卡进行测试</span><br>[root<span class="hljs-symbol">@test</span> ~]<span class="hljs-meta"># ifdown ens34</span><br></code></pre></td></tr></table></figure><h1 id="二、team"><a href="#二、team" class="headerlink" title="二、team"></a>二、<code>team</code></h1><h2 id="1、查看网卡的连接信息"><a href="#1、查看网卡的连接信息" class="headerlink" title="1、查看网卡的连接信息"></a>1、查看网卡的连接信息</h2><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@test ~]# nmcli connection show <br>NAME   UUID                                  TYPE      DEVICE <br>ens32  a4302588<span class="hljs-string">-30</span>ea<span class="hljs-string">-4</span>bc2-a8a8<span class="hljs-string">-00680</span>c2c08d6  ethernet  ens32  <br>ens34  150ea8a5<span class="hljs-string">-78</span>d4<span class="hljs-string">-3495</span>-a62f<span class="hljs-string">-79</span>f12989d4f8  ethernet  ens34  <br>ens35  0f677720<span class="hljs-string">-3221</span><span class="hljs-string">-3</span>a8b-a86d-adec6fcf7b99  ethernet  ens35 <br></code></pre></td></tr></table></figure><h2 id="2、创建-team，名称为-team0"><a href="#2、创建-team，名称为-team0" class="headerlink" title="2、创建 team，名称为 team0"></a>2、创建 <code>team</code>，名称为 <code>team0</code></h2><p>按照下面的语法，用 <code>nmcli</code> 命令为网络组接口创建一个连接。</p><p><code># nmcli con add type team con-name CNAME ifname INAME [config JSON]</code></p><p><code>CNAME</code> 指代连接的名称，<code>INAME</code> 是接口名称，<code>JSON (JavaScript Object Notation)</code> 指定所使用的处理器(<code>runner</code>)。<code>JSON</code> 语法格式如下：</p><p><code>&#39;&#123;&quot;runner&quot;:&#123;&quot;name&quot;:&quot;METHOD&quot;&#125;&#125;&#39;</code></p><p>METHOD 是以下的其中一个：<code>broadcast</code>、<code>activebackup</code>、<code>roundrobin</code>、<code>loadbalance</code> 或者 <code>lacp</code>。</p><p>最常见的双网卡绑定模式：<br>      （1） <code>roundrobin</code> - 轮询模式<br>所有链路处于负载均衡状态，这种模式的特点增加了带宽，同时支持容错能力。<br>      （2） <code>activebackup</code> - 主备模式<br>一个网卡处于活动状态，另一个处于备份状态，所有流量都在主链路上处理，当活动网卡 <code>down</code> 掉时，启用备份网卡。</p><p>这里我们创建<code>roundrobin</code>为例</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">[root<span class="hljs-title">@test</span> ~]# nmcli con <span class="hljs-keyword">add</span> <span class="hljs-keyword">type</span> team con-name team<span class="hljs-number">0</span> ifname team<span class="hljs-number">0</span> config &#x27;&#123;<span class="hljs-string">&quot;runner&quot;</span>:&#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;roundrobin&quot;</span>&#125;&#125;&#x27;<br></code></pre></td></tr></table></figure><h2 id="3、设置-team0-的-ip、gateway、dns"><a href="#3、设置-team0-的-ip、gateway、dns" class="headerlink" title="3、设置 team0 的 ip、gateway、dns"></a>3、设置 <code>team0</code> 的 <code>ip</code>、<code>gateway</code>、<code>dns</code></h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmcli</span> con modify team<span class="hljs-number">0</span> ipv<span class="hljs-number">4</span>.address <span class="hljs-number">172.24.8.11</span>/<span class="hljs-number">24</span> ipv<span class="hljs-number">4</span>.gateway <span class="hljs-number">172.24.8.254</span> <br><span class="hljs-attribute">nmcli</span> connection modify team<span class="hljs-number">0</span> ipv<span class="hljs-number">4</span>.dns <span class="hljs-number">114.114.114.114</span><br></code></pre></td></tr></table></figure><h2 id="4、设置-team-的属性为-manual"><a href="#4、设置-team-的属性为-manual" class="headerlink" title="4、设置 team 的属性为 manual"></a>4、设置 <code>team</code> 的属性为 <code>manual</code></h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmcli</span> con modify team<span class="hljs-number">0</span> ipv<span class="hljs-number">4</span>.method manual<br></code></pre></td></tr></table></figure><h2 id="5、添加网卡-ens34-、ens35-到-team0-中"><a href="#5、添加网卡-ens34-、ens35-到-team0-中" class="headerlink" title="5、添加网卡 ens34 、ens35 到 team0 中"></a>5、添加网卡 <code>ens34</code> 、<code>ens35</code> 到 <code>team0</code> 中</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">nmcli con add <span class="hljs-keyword">type</span> team-<span class="hljs-literal">slave</span> con-name team0-port1 ifname ens34 <span class="hljs-keyword">master</span> <span class="hljs-title">team0</span><br><br>nmcli con add <span class="hljs-keyword">type</span> team-<span class="hljs-literal">slave</span> con-name team0-port2 ifname ens35 <span class="hljs-keyword">master</span> <span class="hljs-title">team0</span><br></code></pre></td></tr></table></figure><h2 id="6、启动-team0"><a href="#6、启动-team0" class="headerlink" title="6、启动 team0"></a>6、启动 <code>team0</code></h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nmcli</span> connection up team<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h2 id="7、查看-team0-状态"><a href="#7、查看-team0-状态" class="headerlink" title="7、查看 team0 状态"></a>7、查看 <code>team0</code> 状态</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@test</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># teamdctl team0 state view</span><br><span class="hljs-attr">setup:</span><br>  <span class="hljs-attr">runner:</span> <span class="hljs-string">roundrobin</span><br><span class="hljs-attr">ports:</span><br>  <span class="hljs-string">ens34</span><br>    <span class="hljs-attr">link watches:</span><br>      <span class="hljs-attr">link summary:</span> <span class="hljs-string">up</span><br>      <span class="hljs-string">instance[link_watch_0]:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">ethtool</span><br>        <span class="hljs-attr">link:</span> <span class="hljs-string">up</span><br>        <span class="hljs-attr">down count:</span> <span class="hljs-number">0</span><br>  <span class="hljs-string">ens35</span><br>    <span class="hljs-attr">link watches:</span><br>      <span class="hljs-attr">link summary:</span> <span class="hljs-string">up</span><br>      <span class="hljs-string">instance[link_watch_0]:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">ethtool</span><br>        <span class="hljs-attr">link:</span> <span class="hljs-string">up</span><br>        <span class="hljs-attr">down count:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>通过以上就完成了通过nmcli创建roundrobin的网络team</p><p>参考内容：<a href="https://blog.csdn.net/ghwzjz/article/details/109468437">https://blog.csdn.net/ghwzjz/article/details/109468437</a></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo+GitHub搭建博客</title>
    <link href="/posts/ccbc0313/"/>
    <url>/posts/ccbc0313/</url>
    
    <content type="html"><![CDATA[<h1 id="一、安装Git"><a href="#一、安装Git" class="headerlink" title="一、安装Git"></a>一、安装Git</h1><blockquote><p>Git官网：<a href="https://git-scm.com/">https://git-scm.com</a></p></blockquote><h1 id="二、安装Node-js"><a href="#二、安装Node-js" class="headerlink" title="二、安装Node.js"></a>二、安装Node.js</h1><blockquote><p>Node.js官网：<a href="https://nodejs.org/">https://nodejs.org</a></p></blockquote><h1 id="三、申请GitHub账号"><a href="#三、申请GitHub账号" class="headerlink" title="三、申请GitHub账号"></a>三、申请GitHub账号</h1><blockquote><p>GitHub官网：<a href="https://github.com/">https://github.com</a></p></blockquote><ul><li><p><strong>申请GitHub账号</strong></p></li><li><p><strong>new repository</strong></p><p>​    <em>您所创建的Repository name必须是：RepositoryName.github.io</em></p></li><li><p><strong>点击Public</strong></p></li><li><p><strong>create Repository</strong></p></li></ul><h1 id="四、安装Hexo"><a href="#四、安装Hexo" class="headerlink" title="四、安装Hexo"></a>四、安装Hexo</h1><blockquote><p>​    Hexo是基于Node.js的静态博客</p></blockquote><ol><li><strong>在电脑新建一个blog文件夹，该文件夹用于存放你的博客文件，然后右键单击选择“Git Bash”</strong></li><li><strong>使用淘宝的NPM镜像，输入以下命令等待安装</strong></li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ npm install -g cnpm --registry=https:<span class="hljs-regexp">//</span>registry.npm.taobao.org<br></code></pre></td></tr></table></figure><ol start="3"><li><strong>使用淘宝NPM安装Hexo</strong></li></ol><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-comment">#与原先的npm完全一样，只是命令改为cnpm</span><br>$ cnpm <span class="hljs-keyword">install</span> -g hexo-cli<br>$ cnpm <span class="hljs-keyword">install</span> hexo --save<br></code></pre></td></tr></table></figure><ol start="4"><li><strong>安装完成后，在输入命令，验证是否安装正确</strong></li></ol><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>hexo -v<br></code></pre></td></tr></table></figure><ol start="5"><li><strong>本地运行hexo</strong></li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> /hexo/<br><span class="hljs-variable">$</span> hexo init<br></code></pre></td></tr></table></figure><ol start="6"><li><strong>安装生成器</strong></li></ol><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">$ cnpm <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><ol start="7"><li><strong>运行hexo，以后要在本地运行博客只要输入该命令即可</strong></li></ol><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog">#生成静态文件<br>$ hexo <span class="hljs-keyword">generate</span><br>#运行服务器<br>$ hexo server<br></code></pre></td></tr></table></figure><blockquote><p>访问测试：<a href="http://localhost:4000/">http://localhost:4000</a></p></blockquote><h1 id="五、配置SHH-Key"><a href="#五、配置SHH-Key" class="headerlink" title="五、配置SHH Key"></a>五、配置SHH Key</h1><h2 id="1-使用ssh-key"><a href="#1-使用ssh-key" class="headerlink" title="1. 使用ssh key"></a>1. 使用ssh key</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> ~/.ssh<br><span class="hljs-variable">$</span> ssh<span class="hljs-literal">-keygen</span> <span class="hljs-literal">-t</span> rsa <span class="hljs-literal">-C</span> <span class="hljs-string">&quot;邮件地址&quot;</span><br></code></pre></td></tr></table></figure><p>​    接下来一直回车，最终会在你的家目录中.ssh\id_rsa.pub文件，复制里面的内容，打开GitHub主页，进入个人设置→ SSH and GPG keys→New SSH key。</p><p>​    将id_rsa.pub中的内容复制到Key中，Title可以随便写，保存</p><h2 id="2-测试"><a href="#2-测试" class="headerlink" title="2. 测试"></a>2. 测试</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>ssh -T git<span class="hljs-variable">@github</span>.com<br><br><span class="hljs-comment">#还需要以下配置：</span><br><span class="hljs-variable">$ </span>git config --global user.name <span class="hljs-string">&quot;你的GitHub用户名&quot;</span><br><span class="hljs-variable">$ </span>git config -global user.email <span class="hljs-string">&quot;你的GitHub注册邮箱&quot;</span><br></code></pre></td></tr></table></figure><h1 id="六、部署到GitHub上"><a href="#六、部署到GitHub上" class="headerlink" title="六、部署到GitHub上"></a>六、部署到GitHub上</h1><p>在你的创建的blog下可以看到_config.yml文件，配置# Deployment这块</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta"># Deployment</span><br><span class="hljs-meta">## Docs: https:<span class="hljs-comment">//hexo.io/docs/one-command-deployment</span></span><br><span class="hljs-symbol">deploy:</span><br><span class="hljs-symbol">  type:</span> git<br><span class="hljs-symbol">  repository:</span> https:<span class="hljs-comment">//github.com/ButATree/ButATree.github.io.git</span><br><span class="hljs-symbol">  branch:</span> master<br><br><span class="hljs-meta">#安装插件</span><br>$ cnpm install hexo-deployer-git --save<br><span class="hljs-meta">#部署到GitHub</span><br>$ hexo d<br></code></pre></td></tr></table></figure><h1 id="七、hexo常用命令"><a href="#七、hexo常用命令" class="headerlink" title="七、hexo常用命令"></a>七、hexo常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> hexo new <span class="hljs-string">&quot;PostName&quot;</span> <span class="hljs-comment">#新建文章</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo new page <span class="hljs-string">&quot;PageName&quot;</span> <span class="hljs-comment">#新建页面</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo generate <span class="hljs-comment">#s生成静态页面到Public目录</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo server <span class="hljs-comment">#开启预览访问端口（默认端口4000）</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo deploy <span class="hljs-comment">#部署到GitHub</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo <span class="hljs-built_in">help</span> <span class="hljs-comment">#帮助</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo version <span class="hljs-comment">#查看hexo的版本</span></span><br><br><span class="hljs-meta">$</span><span class="bash"> hexo s -g <span class="hljs-comment">#生成并本地预览</span></span><br><span class="hljs-meta">$</span><span class="bash"> hexo d -g <span class="hljs-comment">#生成并上传</span></span><br></code></pre></td></tr></table></figure><h1 id="八、主题"><a href="#八、主题" class="headerlink" title="八、主题"></a>八、主题</h1><blockquote><p>Hexo 主题地址：<a href="https://hexo.io/themes">https://hexo.io/themes</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">git</span> <span class="hljs-string">clon</span> <span class="hljs-string">https://github.com/litten/hexo-theme-yilia.git</span> <span class="hljs-string">themes/yilia</span><br><span class="hljs-comment">#修改_config.yml文件中和theme</span><br><span class="hljs-attr">theme:</span> <span class="hljs-string">yilia</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hexo博客搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
