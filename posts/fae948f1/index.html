

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="ButATree">
  <meta name="keywords" content="">
  <title>iptables基础详解 - ButATree&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ButATree</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/about/">
                    <i class="iconfont icon-user-fill"></i>
                    个人
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                相关链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/4l2p20.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="iptables基础详解">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      ButATree
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-30 20:35" pubdate>
        2021年1月30日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      77
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">iptables基础详解</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年3月12日 晚上
                
              </p>
            
            <div class="markdown-body">
              <h1 id="iptables-概念"><a href="#iptables-概念" class="headerlink" title="iptables 概念"></a><code>iptables</code> 概念</h1><p>从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙<br>主机防火墙：针对于单个主机进行防护。网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。<br>网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p>
<p>从物理上讲，防火墙可以分为硬件防火墙和软件防火墙。<br>硬件防火墙：在硬件级别实现部分防火墙功能，另一部分功能基于软件实现，性能高，成本高。软件防火墙：应用软件处理逻辑运行于通用硬件平台之上的防火墙，性能低，成本低。</p>
<h2 id="iptables-用户→程序→内核→硬件"><a href="#iptables-用户→程序→内核→硬件" class="headerlink" title="iptables  (用户→程序→内核→硬件)"></a><code>iptables</code>  (用户→程序→内核→硬件)</h2><p><code>iptables</code> 其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过 <code>iptables</code> 这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫 <code>netfilter</code> 。</p>
<p><code>netfilter</code> 才是防火墙真正的安全框架（<code>framework</code>），<code>netfilter</code> 位于内核空间。<code>iptables</code> 其实是一个命令行工具，位于用户空间，我们用这个工具操作真正的框架。<code>netfilter/iptables</code>（下文中简称为<code>iptables</code>）组成 <code>Linux</code> 平台下的包过滤防火墙，与大多数的 <code>Linux</code> 软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（<code>NAT</code>）等功能。<code>Netfilter</code> 是 <code>Linux</code> 操作系统核心层内部的一个数据包处理模块，它具有如下功能：<br>网络地址转换(<code>Network Address Translate</code>)<br>数据包内容修改<br>以及数据包过滤的防火墙功能</p>
<p><code>iptables</code> 并没有一个守护进程，不能算是真正意义上的服务，而应该算是内核提供的功能。</p>
<h1 id="iptables-基础"><a href="#iptables-基础" class="headerlink" title="iptables 基础"></a><code>iptables</code> 基础</h1><h2 id="iptables-防火墙简介"><a href="#iptables-防火墙简介" class="headerlink" title="iptables 防火墙简介"></a><code>iptables</code> 防火墙简介</h2><p><code>Netfilter/iptables</code> (以下简称iptables)是<code>Unix/linux</code> 系统自带的优秀且完全免费的基于包过滤的防火墙工具、它的功能十分强大、使用非常灵活、可以对流入、流出及流经服务器的数据包进行精细的控制。特别是它可以在一台非常低配置下跑的非常好。提供400台机器的办公上网共享服务丝毫不逊色数万RMB企业级专业路由器防火墙</p>
<p><code>Iptables</code> 是 <code>linux 2.4</code>及<code>2.6</code>内核中集成的服务、其功能与安全性比老一辈<code>ipvfwadm</code> 、<code>ipchanins</code> 强大的多、一般认为 <code>iptables</code> 工作在OSI七层的、二、三层、四层。</p>
<p>首先介绍 <code>iptables</code> 的结构：<code>iptables</code>  → <code>Tables</code> → <code>Chains</code> → <code>Rules</code>. 简单地讲，<code>tables</code> 由 <code>chains</code> 组成，而 <code>chains</code> 又由 <code>rules</code> 组成。如下图所示。</p>
<p><img src="/img/blog_image/Linux_iptables_contentImage/tables_chain_rules.png" srcset="/img/loading.gif"></p>
<h3 id="一、iptables-的表与链"><a href="#一、iptables-的表与链" class="headerlink" title="一、iptables 的表与链"></a>一、<code>iptables</code> 的表与链</h3><p><code>iptables</code> 具有 <code>Filter</code>、<code>NAT</code>、<code>Mangle</code>、<code>Raw</code> 四种内建表：</p>
<blockquote>
<p>4 个表的优先级由高到底：<code>Raw</code> &gt; <code>Mangle</code> &gt; <code>Nat</code> &gt; <code>Filter</code></p>
<ul>
<li><code>RAW</code> 表只使用在 <code>PREROUTING</code> 链和 <code>OUTPUT</code> 链上,因为优先级最高，从而可以对收到的数据包在连接跟踪前进行处理。一但用户使用了 <code>RAW</code> 表,在某个链上，<code>RAW</code> 表处理完后,将跳过 <code>NAT</code> 表和 <code>ip_conntrack</code> 处理,即不再做地址转换和数据包的链接跟踪处理了。</li>
<li><code>filter</code> 表是预设规则表，拥有 <code>INPUT</code>、<code>FORWARD</code> 和 <code>OUTPUT</code> 三个规则链，这个规则表顾名思义是用来进行封包过滤的理动作。</li>
<li><code>net</code> 表拥有 <code>prerouting</code> 和 <code>postrouting</code> 两个规则链， 主要功能为进行一对一、一对多、多对多等网址转译工作（<code>SNAT,DNAT</code>）。</li>
<li><code>mangle</code> 拥有 <code>prerouting</code>、<code>FORWARD</code>、<code>postrouting</code>三个规则链，除了进行网址转译工作会改写封包外，在某些特殊应用可能也必须去改写封包(<code>ITL</code>、<code>TOS</code>)或者是设定 <code>MARK</code> (将封包作记号，以进行后续的过滤)这时就必须将这些工作定义在 <code>mangles</code> 规则表中</li>
</ul>
</blockquote>
<h4 id="iptables-表"><a href="#iptables-表" class="headerlink" title="iptables 表"></a><code>iptables</code> 表</h4><h5 id="1-filter-表"><a href="#1-filter-表" class="headerlink" title="1. filter 表"></a>1. <code>filter</code> 表</h5><p><code>Filter</code> 表示 <code>iptables</code> 的默认表，因此如果你没有自定义表，那么就默认使用 <code>filter</code> 表，它具有以下三种内建链：</p>
<ul>
<li><code>INPUT</code>链 – 处理来自外部的数据。</li>
<li><code>FORWARD</code>链 – 将数据转发到本机的其他网卡设备上。</li>
<li><code>OUTPUT</code>链 – 处理向外发送的数据。</li>
</ul>
<h5 id="2-nat-表"><a href="#2-nat-表" class="headerlink" title="2. nat 表"></a>2. <code>nat</code> 表</h5><p><code>NAT</code>表有三种内建链：</p>
<ul>
<li><code>PREROUTING</code> 链 – 处理刚到达本机并在路由转发前的数据包。它会转换数据包中的目标IP地址（<code>destination ip address</code>），通常用于<code>DNAT</code>(<code>destination NAT</code>)。</li>
<li><code>OUTPUT</code> 链 – 处理本机产生的数据包。</li>
<li><code>POSTROUTING</code> 链 – 处理即将离开本机的数据包。它会转换数据包中的源IP地址（<code>source ip address</code>），通常用于<code>SNAT</code>（<code>source NAT</code>）。</li>
</ul>
<h5 id="3-mangle-表"><a href="#3-mangle-表" class="headerlink" title="3. mangle 表"></a>3. <code>mangle</code> 表</h5><p><code>Mangle</code> 表用于指定如何处理数据包。它能改变<code>TCP</code>头中的<code>QoS</code>位。<code>Mangle</code> 表具有5个内建链：</p>
<ul>
<li><code>PREROUTING</code></li>
<li><code>OUTPUT</code></li>
<li><code>FORWARD</code></li>
<li><code>INPUT</code></li>
<li><code>POSTROUTING</code></li>
</ul>
<h5 id="4-raw-表"><a href="#4-raw-表" class="headerlink" title="4. raw 表"></a>4. <code>raw</code> 表</h5><p><code>Raw</code>表用于处理异常，它具有2个内建链：</p>
<ul>
<li><code>PREROUTING chain</code></li>
<li><code>OUTPUT chain</code></li>
</ul>
<h6>常用命令</h6>

<ul>
<li><code>-A</code> ：追加 <code>iptables -A INPUT</code></li>
<li><code>-D</code> ：删除规则 <code>iptables -D INPUT 1(编号)</code></li>
<li><code>-R</code> ：修改规则 <code>iptables -R INPUT 1 -s 192.168.1.0 -j DROP</code> 取代取代现行规则，顺序不变(1是位置)</li>
<li><code>-I</code> ：插入规则 <code>iptables -I INPUT 1 --dport 80 -j ACCEPT</code>  插入一条规则，原本位置上的规则将会往后移动一个顺位</li>
<li><code>-L</code> ：查看规则 <code>iptables -L INPUT</code> 列出规则链中的所有规则</li>
<li><code>-N</code> ：新的规则 <code>iptables -N allowed</code> 定义新的规则</li>
</ul>
<h6>通用参数</h6>

<ul>
<li><code>-p</code> ：协议 <code>iptables -A INPUT -p tcp</code></li>
<li><code>-s</code> ：源地址 <code>iptables -A INPUT -s 192.168.1.1</code></li>
<li><code>-d</code> ：目的地址 <code>iptables -A INPUT -d 192.168.12.1</code></li>
<li><code>--sport</code> ：源端口 <code>iptables -A INPUT -p tcp --sport 22</code></li>
<li><code>--dport</code>：目的端口 <code>iptables -A INPUT -p tcp --dport 22</code></li>
<li><code>-i</code> ：指定入口网卡 <code>iptables -A INPUT -i eth0</code></li>
<li><code>-o</code> ：指定出口网卡 <code>iptables -A FORWARD -o eth0</code></li>
<li><code>-j</code> ： 定要进行的处理动作</li>
</ul>
<h6>常用的ACTION</h6>

<ul>
<li><code>DROP</code> ：丢弃</li>
<li><code>REJECT</code> ：明示拒绝</li>
<li><code>ACCEPT</code> ：接受</li>
<li><code>SNAT</code>： 基于原地址的转换</li>
<li><code>source</code> ：指定原地址</li>
</ul>
<blockquote>
<p>例子：</p>
<p> 比如我们现在要将所有 <code>192.168.10.0</code> 网段的 <code>IP</code> 在经过 <code>iptables</code> 的时候全都转换成 <code>172.16.100.1</code> 这个假设出来的外网地址：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A POSTROUTING -s <span class="hljs-number">192.168.10.0</span>/<span class="hljs-number">24</span> -j SNAT --to-source <span class="hljs-number">172.16.100.1</span>(外网有效ip)<br></code></pre></td></tr></table></figure>

<p>这样，只要是来自本地网络的试图通过网卡访问网络的，都会被统统转换成 <code>172.16.100.1</code> 这个 <code>IP</code>。</p>
<p><code>MASQUERADE</code> (动态伪装）— 家用带宽获取的外网 <code>ip</code>，就是用到了动态伪装</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A POSTROUTING -s <span class="hljs-number">192.168.10.0</span>/<span class="hljs-number">24</span> -j MASQUERADE<br></code></pre></td></tr></table></figure>

<p><code>DNAT</code> ： 目标地址转换<br><code>destination</code> ： 指定目标地址</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iptables</span> -t nat -A PREROUTING -d <span class="hljs-number">192.168.10.18</span> -p tcp --dport <span class="hljs-number">80</span> -j DNAT --to-destination <span class="hljs-number">172.16.100.2</span><br></code></pre></td></tr></table></figure>

<p><code>192.168.10.18</code> 访问80端口转换到 <code>172.16.100.2</code> 上<br><code>MASQUERADE</code> ：源地址伪装<br><code>REDIRECT</code> ：重定向：主要用于实现端口重定向<br><code>MARK</code> ：打防火墙标记的<br><code>RETURN </code>：返回 在自定义链执行完毕后使用返回，来返回原规则链。</p>
</blockquote>
<h5 id="5-小结"><a href="#5-小结" class="headerlink" title="5.小结"></a>5.小结</h5><p>下图展示了 <code>iptables</code> 的三个内建表：</p>
<p><img src="/img/blog_image/Linux_iptables_contentImage/iptables_sum.png" srcset="/img/loading.gif"></p>
<hr>
<h4 id="iptables-链"><a href="#iptables-链" class="headerlink" title="iptables 链"></a><code>iptables</code> 链</h4><h5 id="1-链-chain"><a href="#1-链-chain" class="headerlink" title="1. 链   (chain)"></a>1. 链   (chain)</h5><p>每个表都有自己的一组内置链，可以对链进行自定义，这样就可以建立一组规则，<code>filter</code> 表中的 <code>input</code> 、<code>output</code> 和 <code>forward</code> 链。</p>
<h5 id="2-匹配（match）"><a href="#2-匹配（match）" class="headerlink" title="2. 匹配（match）"></a>2. 匹配（match）</h5><p>每个 <code>iptables</code> 规则都包含一组匹配以及一个目标，<code>iptables</code> 匹配指的是数据包必须匹配的条件，只有当数据包满足所有的匹配条件时，<code>iptables</code> 才能根据由该规则的目标所指定的动作来处理该数据包，匹配都在 <code>iptable</code> 的命令行中指定。</p>
<ul>
<li><code>source</code> ：匹配源ip地址或网络</li>
<li><code>destination (-d)</code> ：匹配目标 <code>ip</code> 地址或网络</li>
<li><code>protocol (-p)</code> ：匹配 <code>ip</code> 值 （<code>TCP</code>/<code>UDP</code>）</li>
<li><code>in-interface (-i)</code> ：流入接口(例如，<code>eth0</code> 、<code>ens32</code>)</li>
<li><code>out-interface (-o)</code> ：流出接口</li>
<li><code>state</code> ：匹配一组连接状态</li>
<li><code>string</code> ：匹配应用层数据字节序列</li>
<li><code>comment</code> ：在内核内存中为一个规则关联多达 <code>256</code> 个字节的注释数据</li>
</ul>
<h5 id="3-目标（target）"><a href="#3-目标（target）" class="headerlink" title="3. 目标（target）"></a>3. 目标（target）</h5><p><code>iptables</code> 支持一组目标，用于数据包匹配一条规则时触发一个动作</p>
<ul>
<li><code>ACCEPT</code> ：允许数据包通过</li>
<li><code>DROP</code> ：丢弃数据包，不对该数据包做进一步的处理，对接收栈而言，就好像该数据包从来没有被接收一样</li>
<li><code>LOG</code> ：将数据包信息记录到 <code>syslog</code></li>
<li><code>REJECT</code> ：丢弃数据包，同时发送适当的响应报文(针对 <code>TCP</code> 连接的 <code>TCP</code> 重要数据包或针对 <code>UDP</code> 数据包的 <code>ICMP</code> 端口不可达消息)</li>
<li><code>RETURN</code> ：在调用链中继续处理数据包</li>
</ul>
<h4 id="链管理命令（立即生效）"><a href="#链管理命令（立即生效）" class="headerlink" title="链管理命令（立即生效）"></a>链管理命令（立即生效）</h4><ul>
<li><p><code>-P</code> ：设置默认策略的（设定默认门是关着的还是开着的</p>
<p>默认策略一般只有两种</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">iptables</span> <span class="hljs-selector-tag">-P</span> <span class="hljs-selector-tag">INPUT</span> (DROP|ACCEPT)<br></code></pre></td></tr></table></figure>

<p>这就把默认规则给拒绝了。并且没有定义哪个动作，所以关于外界连接的所有规则包括 <code>Xshell</code> 连接之类的，远程连接都被拒绝了</p>
</li>
<li><p><code>-F </code> ： <code>FLASH</code>，清空规则链的(注意每个链的管理权限)</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel">iptables -<span class="hljs-built_in">t</span> nat -F PREROUTING<br># iptables -<span class="hljs-built_in">t</span> nat -F 清空nat表的所有链<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>-X</code> ： 用于删除用户自定义的空链<br>  使用方法跟 <code>-N</code> 相同，但是在删除之前必须要将里面的链给清空昂了</p>
</li>
<li><p><code>-N</code> ：<code>NEW</code> 支持用户新建一个链</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">iptables</span> -N inbound_tcp_web <br><span class="hljs-comment"># 表示附在tcp表上用于检查web的。</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>-E：用来 <code>Rename chain</code> 主要是用来给用户自定义的链重命名</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -E oldname newname</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><code>-Z</code> ：清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">iptables</span> -Z <br><span class="hljs-comment">#清空</span><br></code></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="规则管理命令"><a href="#规则管理命令" class="headerlink" title="规则管理命令"></a>规则管理命令</h4><ul>
<li><p><code>-A</code> ：追加，在当前链的最后新增一个规则</p>
</li>
<li><p><code>-I num</code> ：插入，把当前规则插入为第几条。</p>
</li>
<li><p><code>-I 3</code> ：插入为第三条</p>
</li>
<li><p><code>-R num</code> ：<code>Replays</code> 替换/修改第几条规则</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">iptables</span></span> -R <span class="hljs-number">3</span> ...<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>-D num</code> ：删除，明确指定删除第几条规则</p>
</li>
</ul>
<h4 id="查看管理命令-“-L”"><a href="#查看管理命令-“-L”" class="headerlink" title="查看管理命令 “-L”"></a>查看管理命令 “-L”</h4><blockquote>
<p>附加子命令<br><code>-n </code>：以数字的方式显示 <code>ip</code> ，它会将 <code>ip</code> 直接显示出来，如果不加 <code>-n</code> ，则会将 <code>ip</code> 反向解析成主机名。<br><code>-v</code>：显示详细信息<br><code>-vv</code><br><code>-vvv</code> :越多越详细<br><code>-x</code>：在计数器上显示精确值，不做单位换算<br><code>--line-numbers</code> : 显示规则的行号<br><code>-t nat</code>：显示所有的关卡的信息</p>
</blockquote>
<h4 id="详解匹配标准"><a href="#详解匹配标准" class="headerlink" title="详解匹配标准"></a>详解匹配标准</h4><h6>扩展匹配</h6>

<ol>
<li><p>隐含扩展：对协议的扩展</p>
<p><code>-p tcp</code> ：<code>TCP</code> 协议的扩展。一般有三种扩展</p>
<p><code>--dport XX-XX</code> ：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如</p>
<ul>
<li><p><code>--dport 21</code> 或者 <code>--dport 21-23</code> (此时表示21,22,23)</p>
</li>
<li><p><code>--sport</code> ：指定源端口</p>
</li>
<li><p><code>--tcp-fiags</code> ：<code>TCP</code> 的标志位（<code>SYN</code>、<code>ACK</code>、<code>FIN</code>、<code>PSH</code>、<code>RST</code> 、<code>URG</code>）<br>  对于它，一般要跟两个参数：</p>
<ul>
<li><p>   1.检查的标志位</p>
</li>
<li><p> 2.必须为1的标志位</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck">--<span class="hljs-comment">tcpflags</span> <span class="hljs-comment">syn</span><span class="hljs-string">,</span><span class="hljs-comment">ack</span><span class="hljs-string">,</span><span class="hljs-comment">fin</span><span class="hljs-string">,</span><span class="hljs-comment">rst</span> <span class="hljs-comment">syn</span>  <span class="hljs-comment">=</span>  --<span class="hljs-comment">syn</span><br><span class="hljs-comment">#</span> <span class="hljs-comment">表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的SYN为1的包，还有一种简写方式，叫做</span>--<span class="hljs-comment">syn</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>-p udp</code> ：<code>UDP</code> 协议的扩展<br>  <code>--dport</code><br> <code>--sport</code></p>
</li>
<li><p><code>-p icmp</code> ：<code>icmp</code> 数据报文的扩展<br>  <code>--icmp-type</code>：<br>  <code>echo-request</code> (请求回显)，一般用 <code>8</code> 来表示<br>   所以 <code>--icmp-type 8</code> 匹配请求回显数据包<br>   <code>echo-reply</code>（响应的数据包）一般用 <code>0</code> 来表示</p>
</li>
</ul>
</li>
</ol>
<h6>显式扩展（-m）</h6>

<p><strong>扩展各种模块</strong><br><code>-m multiport</code> ：表示启用多端口扩展 之后我们就可以启用比如 </p>
<p><code>--dports 21,23,80</code></p>
<blockquote>
<p><strong>限制收发包的状态</strong></p>
<p><code>--state</code> ：<code>INVALID</code>, <code>ESTABLISHED</code>, <code>NEW</code>, <code>RELATED or UNTRACKED</code>。</p>
<p>​        <code>NEW</code> ：新连接请求；</p>
<p>​        <code>ESTABLISHED</code> ：已建立的连接；</p>
<p>​        <code>INVALID</code> ：无法识别的连接；</p>
<p>​        <code>RELATED</code> ：相关联的连接，当前连接是一个新请求，但附属于某个已存在的连接；</p>
<p>​        <code>UNTRACKED</code> ：未追踪的连接；</p>
<p><strong>state扩展：</strong></p>
<p>内核模块装载：<br>　　<code>nf_conntrack</code><br>　　<code>nf_conntrack_ipv4</code></p>
<p>手动装载：<br>　　<code>nf_conntrack_ftp</code></p>
<p>追踪到的连接：<br>　　<code>/proc/net/nf_conntrack</code></p>
<p>调整可记录的连接数量最大值：<br>　　<code>/proc/sys/net/nf_conntrack_max</code></p>
<p>超时时长：<br>　　<code>/proc/sys/net/netfilter/*timeout*</code></p>
</blockquote>
<h3 id="二、IPTABLES-规则-Rules"><a href="#二、IPTABLES-规则-Rules" class="headerlink" title="二、IPTABLES 规则(Rules)"></a>二、IPTABLES 规则(Rules)</h3><p>牢记以下三点式理解 <code>iptables</code> 规则的关键：</p>
<ul>
<li><code>Rules</code>包括一个条件和一个目标(<code>target</code>) </li>
<li>如果满足条件，就执行目标(<code>target</code>)中的规则或者特定值。</li>
<li>如果不满足条件，就判断下一条<code>Rules</code>。</li>
</ul>
<p><strong>目标值（<code>Target Values</code>）</strong></p>
<p>下面是你可以在 <code>target</code> 里指定的特殊值：</p>
<ul>
<li><code>ACCEPT</code> – 允许防火墙接收数据包</li>
<li><code>DROP</code> – 防火墙丢弃包</li>
<li><code>QUEUE</code> – 防火墙将数据包移交到用户空间</li>
<li><code>RETURN</code> – 防火墙停止执行当前链中的后续<code>Rules</code>，并返回到调用链(<code>the calling chain</code>)中。</li>
</ul>
<p>如果你执行 <code>iptables --list</code>你将看到防火墙上的可用规则。下例说明当前系统没有定义防火墙，你可以看到，它显示了默认的<code>filter</code>表，以及表内默认的<code>input</code>链, <code>forward</code>链, <code>output</code>链。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables --list</span><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination <br></code></pre></td></tr></table></figure>

<p>查看 <code>nat</code> 表：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t nat --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain POSTROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure>

<p>查看 <code>mangle</code> 表：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t mangle --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain POSTROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure>

<p>查看 <code>raw</code> 表：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -t raw --list</span><br>Chain PREROUTING (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果不指定 <code>-t</code>选项，就只会显示默认的 <code>filter</code> 表。因此，以下两种命令形式是一个意思：</p>
</blockquote>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">iptables</span> <span class="hljs-title">[</span><span class="hljs-literal">-</span><span class="hljs-comment">t</span> <span class="hljs-comment">filter</span><span class="hljs-title">]</span> --<span class="hljs-comment">list</span> <span class="hljs-comment">/</span> <span class="hljs-comment">iptables</span>  --<span class="hljs-comment">list</span><br></code></pre></td></tr></table></figure>

<p>以下例子表明在 <code>filter</code> 表的 <code>input</code>链, <code>forward</code> 链, <code>output</code> 链中存在规则：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># iptables –list </span><br><span class="hljs-attribute">Chain</span> INPUT (policy ACCEPT) <br><span class="hljs-attribute">num</span>     target         prot   opt     source       destination <br><span class="hljs-attribute">1</span>  RH-Firewall-<span class="hljs-number">1</span>-INPUT   <span class="hljs-literal">all</span>    —     <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><br><span class="hljs-attribute">Chain</span> FORWARD (policy ACCEPT)<br><span class="hljs-attribute">num</span>     target         prot   opt     source       destination<br><span class="hljs-attribute">1</span>    RH-Firewall-<span class="hljs-number">1</span>-INPUT  <span class="hljs-literal">all</span>     –    <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><br><span class="hljs-attribute">Chain</span> OUTPUT (policy ACCEPT)<br><span class="hljs-attribute">num</span> target  prot opt source       destination<br><br><span class="hljs-attribute">Chain</span> RH-Firewall-<span class="hljs-number">1</span>-INPUT (<span class="hljs-number">2</span> references)<br><span class="hljs-attribute">num</span> target  prot opt source       destination<br><span class="hljs-attribute">1</span>  ACCEPT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">2</span>  ACCEPT  icmp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     icmp type <span class="hljs-number">255</span><br><span class="hljs-attribute">3</span>  ACCEPT  esp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">4</span>  ACCEPT  ah – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-attribute">5</span>  ACCEPT  udp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">224.0.0.251</span>    udp dpt:<span class="hljs-number">5353</span><br><span class="hljs-attribute">6</span>  ACCEPT  udp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     udp dpt:<span class="hljs-number">631</span><br><span class="hljs-attribute">7</span>  ACCEPT  tcp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     tcp dpt:<span class="hljs-number">631</span><br><span class="hljs-attribute">8</span>  ACCEPT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     state RELATED,ESTABLISHED<br><span class="hljs-attribute">9</span>  ACCEPT  tcp – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     state NEW tcp dpt:<span class="hljs-number">22</span><br><span class="hljs-attribute">10</span> REJECT  <span class="hljs-literal">all</span> – <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>      <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>     reject-with icmp-host-prohibited<br></code></pre></td></tr></table></figure>

<p>以上输出包含下列字段：</p>
<ul>
<li> <code>num</code> – 指定链中的规则编号</li>
<li><code>target</code> – 前面提到的 <code>target</code>的特殊值</li>
<li><code>prot</code> – 协议：<code>tcp</code>,<code>udp</code>,<code>icmp</code>等</li>
<li><code>source</code> – 数据包的源<code>IP</code>地址</li>
<li><code>destination</code> – 数据包的目标<code>IP</code>地址</li>
</ul>
<h3 id="三、清空所有iptables规则"><a href="#三、清空所有iptables规则" class="headerlink" title="三、清空所有iptables规则"></a>三、清空所有iptables规则</h3><p>在配置<code>iptables</code>之前，你通常需要用<code>iptables --list</code>命令或者<code>iptables --save</code>命令查看有无现存规则，因为有时需要删除现有的<code>iptables</code>规则：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">iptables</span> -<span class="hljs-function"><span class="hljs-title">F</span>(--<span class="hljs-variable">flush</span>)</span><br></code></pre></td></tr></table></figure>

<p>这两条命令是等效的。但是并非执行后就万事大吉了。你仍然需要检查规则是不是真的清空了，因为有的 <code>linux</code> 发行版上这个命令不会清除 <code>NAT</code> 表中的规则，此时只能手动清除：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">iptables [-t FILTER<span class="hljs-regexp">/NAT/</span>MANGLE/RAW] -F<br></code></pre></td></tr></table></figure>

<h3 id="四、永久生效"><a href="#四、永久生效" class="headerlink" title="四、永久生效"></a>四、永久生效</h3><p>当你删除、添加规则后，这些更改并不能永久生效，这些规则很有可能在系统重启后恢复原样。为了让配置永久生效，根据平台的不同，具体操作也不同。下面进行简单介绍：</p>
<h4 id="1-Ubuntu"><a href="#1-Ubuntu" class="headerlink" title="1.Ubuntu"></a>1.Ubuntu</h4><p>首先，保存现有的规则：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">iptables-save &gt; <span class="hljs-regexp">/etc/i</span>ptables.rules<br></code></pre></td></tr></table></figure>

<p>然后新建一个<code>bash</code>脚本，并保存到 <code>/etc/network/if-pre-up.d/</code>目录下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash </span><br>iptables-restore &lt; /etc/iptables.rules<br></code></pre></td></tr></table></figure>

<p>这样，每次系统重启后 <code>iptables</code> 规则都会被自动加载。</p>
<blockquote>
<p>注意：不要尝试在 <code>.bashrc</code> 或者 <code>.profile</code> 中执行以上命令，因为用户通常不是 <code>root</code>，而且这只能在登录时加载 <code>iptables</code>规则。</p>
</blockquote>
<h4 id="2-CentOS-RedHat"><a href="#2-CentOS-RedHat" class="headerlink" title="2.CentOS, RedHat"></a>2.CentOS, RedHat</h4><p>保存 <code>iptables</code> 规则 </p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">service iptables save</span><br></code></pre></td></tr></table></figure>

<p>重启 <code>iptables</code> 服务</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">service iptables <span class="hljs-literal">stop</span><br>service iptables <span class="hljs-literal">start</span><br></code></pre></td></tr></table></figure>

<p>查看当前规则：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/etc/</span>sysconfig/iptables<br></code></pre></td></tr></table></figure>

<h3 id="五、追加iptables规则"><a href="#五、追加iptables规则" class="headerlink" title="五、追加iptables规则"></a>五、追加iptables规则</h3><p>可以使用 <code>iptables -A</code> 命令追加新规则，其中 <code>-A</code> 表示 <code>Append</code>。因此， 新的规则将追加到链尾。</p>
<p>一般而言，最后一条规则用于丢弃(<code>DROP</code>)所有数据包。如果你已经有这样的规则了，并且使用  <code>-A</code> 参数添加新规则，那么就是无用功。</p>
<h4 id="1-语法"><a href="#1-语法" class="headerlink" title="1. 语法"></a>1. 语法</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">iptables -A chain firewall-<span class="hljs-keyword">rule</span><br>	-A chain – 指定要追加规则的链<br>	firewall-<span class="hljs-keyword">rule</span> – 具体的规则参数<br></code></pre></td></tr></table></figure>

<h4 id="2-描述规则的基本参数"><a href="#2-描述规则的基本参数" class="headerlink" title="2. 描述规则的基本参数"></a>2. 描述规则的基本参数</h4><p>以下这些规则参数用于描述数据包的协议、源地址、目的地址、允许经过的网络接口，以及如何处理这些数据包。这些描述是对规则的基本描述。</p>
<h5 id="p-协议（protocol）"><a href="#p-协议（protocol）" class="headerlink" title="-p 协议（protocol）"></a>-p 协议（protocol）</h5><ul>
<li>指定规则的协议，如<code>tcp</code>, <code>udp</code>, <code>icmp</code>等，可以使用<code>all</code>来指定所有协议。</li>
<li>如果不指定<code>-p</code>参数，则默认是<code>all</code>值。这并不明智，请总是明确指定协议名称。</li>
<li>可以使用协议名(如<code>tcp</code>)，或者是协议值（比如6代表<code>tcp</code>）来指定协议。映射关系请查看<code>/etc/protocols</code>。</li>
<li>还可以使用<code>--protocol</code>参数代替<code>-p</code>参数。</li>
</ul>
<h5 id="s-源地址（source）"><a href="#s-源地址（source）" class="headerlink" title="-s 源地址（source）"></a>-s 源地址（source）</h5><ul>
<li>指定数据包的源地址</li>
<li>参数可以使<code>IP</code>地址、网络地址、主机名</li>
<li>例如：<code>-s 192.168.1.101</code>指定IP地址</li>
<li>例如：<code>-s 192.168.1.10/24</code>指定网络地址</li>
<li>如果不指定<code>-s</code>参数，就代表所有地址</li>
<li>还可以使用<code>–src</code>或者<code>--source</code></li>
</ul>
<h5 id="d-目的地址（destination）"><a href="#d-目的地址（destination）" class="headerlink" title="-d 目的地址（destination）"></a>-d 目的地址（destination）</h5><ul>
<li>指定目的地址</li>
<li>参数和<code>-s</code>相同</li>
<li>还可以使用<code>–dst</code>或者<code>--destination</code></li>
</ul>
<h5 id="j-执行目标（jump-to-target）"><a href="#j-执行目标（jump-to-target）" class="headerlink" title="-j 执行目标（jump to target）"></a>-j 执行目标（jump to target）</h5><ul>
<li><code>-j</code>代表”<code>jump to target</code>”</li>
<li><code>-j</code>指定了当与规则(<code>Rule</code>)匹配时如何处理数据包</li>
<li>可能的值是<code>ACCEPT</code>, <code>DROP</code>, <code>QUEUE</code>, <code>RETURN</code>, <code>MASQUERADE</code></li>
<li>还可以指定其他链（<code>Chain</code>）作为目标</li>
<li>注：<code>MASQUERADE</code>，地址伪装，算是<code>snat</code>中的一种特例，可以实现自动化的<code>snat</code></li>
</ul>
<h5 id="i-输入接口（input-interface）"><a href="#i-输入接口（input-interface）" class="headerlink" title="-i 输入接口（input interface）"></a>-i 输入接口（input interface）</h5><ul>
<li><code>-i</code>代表输入接口(<code>input interface</code>)</li>
<li><code>-i</code>指定了要处理来自哪个接口的数据包</li>
<li>这些数据包即将进入<code>INPUT</code>, <code>FORWARD</code>, <code>PREROUTE</code>链</li>
<li>例如：<code>-i eth0</code>指定了要处理经由<code>eth0</code>进入的数据包</li>
<li>如果不指定<code>-i</code>参数，那么将处理进入所有接口的数据包</li>
<li>如果出现<code>! -i eth0</code>，那么将处理所有经由<code>eth0</code>以外的接口进入的数据包</li>
<li>如果出现<code>-i eth+</code>，那么将处理所有经由<code>eth开头的接口</code>进入的数据包</li>
<li>还可以使用<code>-in-interface</code>参数</li>
</ul>
<h5 id="o-输出（out-interface）"><a href="#o-输出（out-interface）" class="headerlink" title="-o 输出（out interface）"></a>-o 输出（out interface）</h5><ul>
<li><code>-o</code>代表<code>output interface</code></li>
<li><code>-o</code>指定了数据包由哪个接口输出</li>
<li>这些数据包即将进入<code>FORWARD</code>, <code>OUTPUT</code>, <code>POSTROUTING</code>链</li>
<li>如果不指定<code>-o</code>选项，那么系统上的所有接口都可以作为输出接口</li>
<li>如果出现<code>! -o eth0</code>，那么将从<code>eth0以外的接口</code>输出</li>
<li>如果出现<code>-i eth+</code>，那么将仅从<code>eth开头的接口</code>输出</li>
<li>还可以使用<code>-out-interface</code>参数</li>
</ul>
<h4 id="3-描述规则的扩展参数"><a href="#3-描述规则的扩展参数" class="headerlink" title="3. 描述规则的扩展参数"></a>3. 描述规则的扩展参数</h4><p>对规则有了一个基本描述之后，有时候我们还希望指定端口、<code>TCP</code>标志、<code>ICMP</code>类型等内容。</p>
<h5 id="–sport-源端口（source-port）针对-p-tcp-或者-p-udp"><a href="#–sport-源端口（source-port）针对-p-tcp-或者-p-udp" class="headerlink" title="–sport 源端口（source port）针对 -p tcp 或者 -p udp"></a>–sport 源端口（source port）针对 -p tcp 或者 -p udp</h5><ul>
<li>缺省情况下，将匹配所有端口</li>
<li>可以指定端口号或者端口名称，例如”<code>--sport 22</code>″与”<code>--sport ssh</code>”。</li>
<li><em>/etc/services</em>文件描述了上述映射关系。</li>
<li>从性能上讲，使用端口号更好</li>
<li>使用冒号可以匹配端口范围，如”<code>--sport 22:100</code>″</li>
<li>还可以使用”<code>--source-port</code>”</li>
</ul>
<h5 id="–dport-目的端口（destination-port）针对-p-tcp-或者-p-udp"><a href="#–dport-目的端口（destination-port）针对-p-tcp-或者-p-udp" class="headerlink" title="–dport 目的端口（destination port）针对-p tcp 或者 -p udp"></a>–dport 目的端口（destination port）针对-p tcp 或者 -p udp</h5><ul>
<li>参数和<code>--sport</code>类似</li>
<li>还可以使用”<code>--destination-port</code>”</li>
</ul>
<h5 id="–tcp-flags-TCP标志-针对-p-tcp"><a href="#–tcp-flags-TCP标志-针对-p-tcp" class="headerlink" title="–tcp-flags TCP标志 针对-p tcp"></a>–tcp-flags TCP标志 针对-p tcp</h5><ul>
<li>可以指定由逗号分隔的多个参数</li>
<li>有效值可以是：<code>SYN</code>,<code>ACK</code>, <code>FIN</code>, <code>RST</code>, <code>URG</code>, <code>PSH</code></li>
<li>可以使用<code>ALL</code>或者<code>NONE</code></li>
</ul>
<h5 id="–icmp-type-ICMP类型-针对-p-icmp"><a href="#–icmp-type-ICMP类型-针对-p-icmp" class="headerlink" title="–icmp-type ICMP类型 针对-p icmp"></a>–icmp-type ICMP类型 针对-p icmp</h5><ul>
<li><code>–icmp-type 0</code> 表示<code>Echo Reply</code></li>
<li><code>–icmp-type 8 </code> 表示<code>Echo</code></li>
</ul>
<h4 id="4-追加规则的完整实例：仅允许SSH服务"><a href="#4-追加规则的完整实例：仅允许SSH服务" class="headerlink" title="4. 追加规则的完整实例：仅允许SSH服务"></a>4. 追加规则的完整实例：仅允许SSH服务</h4><p>本例实现的规则将仅允许<code>SSH</code>数据包通过本地计算机，其他一切连接（包括<code>ping</code>）都将被拒绝。</p>
<h5 id="1-清空所有iptables规则"><a href="#1-清空所有iptables规则" class="headerlink" title="1. 清空所有iptables规则"></a>1. 清空所有iptables规则</h5><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -F</span><br></code></pre></td></tr></table></figure>

<h5 id="2-接收目标端口为22的数据包"><a href="#2-接收目标端口为22的数据包" class="headerlink" title="2. 接收目标端口为22的数据包"></a>2. 接收目标端口为22的数据包</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">i</span> eth0 -<span class="hljs-selector-tag">p</span> tcp --dport <span class="hljs-number">22</span> -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="3-拒绝所有其他数据包"><a href="#3-拒绝所有其他数据包" class="headerlink" title="3.拒绝所有其他数据包"></a>3.拒绝所有其他数据包</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -j DROP<br></code></pre></td></tr></table></figure>

<h3 id="六、更改默认策略"><a href="#六、更改默认策略" class="headerlink" title="六、更改默认策略"></a>六、更改默认策略</h3><p>上例的例子仅对接收的数据包过滤，而对于要发送出去的数据包却没有任何限制。本节主要介绍如何更改链策略，以改变链的行为。</p>
<h4 id="1-默认链策略"><a href="#1-默认链策略" class="headerlink" title="1. 默认链策略"></a>1. 默认链策略</h4><p><code>警告</code>：请勿在远程连接的服务器、虚拟机上测试！</p>
<p>当我们使用<code>-L</code>选项验证当前规则是发现，所有的链旁边都有 <code>policy ACCEPT</code>标注，这表明当前链的默认策略为<code>ACCEPT</code>：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake">[root@<span class="hljs-keyword">test</span> ~]<span class="hljs-comment"># iptables -L</span><br>Chain INPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination         <br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> ACCEPT)<br><span class="hljs-keyword">target</span>     prot opt source               destination <br></code></pre></td></tr></table></figure>

<p>这种情况下，如果没有明确添加DROP规则，那么默认情况下将采用ACCEPT策略进行过滤。除非：</p>
<h6 id="a-为以上三个链单独添加DROP规则："><a href="#a-为以上三个链单独添加DROP规则：" class="headerlink" title="a)为以上三个链单独添加DROP规则："></a>a)为以上三个链单独添加DROP规则：</h6><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -A <span class="hljs-meta">INPUT</span> -j <span class="hljs-meta">DROP</span> <br>iptables -A <span class="hljs-meta">OUTPUT</span> -j <span class="hljs-meta">DROP</span> <br>iptables -A FORWARD -j <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure>

<h6 id="b-更改默认策略："><a href="#b-更改默认策略：" class="headerlink" title="b)更改默认策略："></a>b)更改默认策略：</h6><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -P <span class="hljs-meta">INPUT</span> <span class="hljs-meta">DROP</span> <br>iptables -P <span class="hljs-meta">OUTPUT</span> <span class="hljs-meta">DROP</span> <br>iptables -P FORWARD <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure>

<p>糟糕！！如果你严格按照上一节的例子配置了<code>iptables</code>，并且现在使用的是<code>SSH</code>进行连接的，那么会话恐怕已经被迫终止了！</p>
<p>为什么呢？因为我们已经把<code>OUTPUT</code>链策略更改为<code>DROP</code>了。此时虽然服务器能接收数据，但是无法发送数据：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@test ~]#iptables -L <br>Chain <span class="hljs-keyword">INPUT</span> (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination <br>ACCEPT  tcp – anywhere      anywhere      tcp dpt:ssh <br><span class="hljs-keyword">DROP</span>   <span class="hljs-keyword">all</span> – anywhere      anywhere<br><br>Chain FORWARD (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination<br><br>Chain OUTPUT (<span class="hljs-keyword">policy</span> <span class="hljs-keyword">DROP</span>)<br>target  prot opt source       destination<br></code></pre></td></tr></table></figure>

<h3 id="七、配置应用程序规则"><a href="#七、配置应用程序规则" class="headerlink" title="七、配置应用程序规则"></a>七、配置应用程序规则</h3><h4 id="1-SSH"><a href="#1-SSH" class="headerlink" title="1. SSH"></a>1. SSH</h4><p>尽管已经介绍了如何初步限制除<code>SSH</code>以外的其他连接，但是那是在链默认策略为<code>ACCEPT</code>的情况下实现的，并且没有对输出数据包进行限 制。本节在上一节基础上，以<code>SSH</code>和<code>HTTP</code>所使用的端口为例，教大家如何在默认链策略为<code>DROP</code>的情况下，进行防火墙设置。在这里，我们将引进一种新的 参数<code>-m state</code>，并检查数据包的状态字段。</p>
<h5 id="1-1-允许接收远程主机的SSH请求"><a href="#1-1-允许接收远程主机的SSH请求" class="headerlink" title="1.1. 允许接收远程主机的SSH请求"></a>1.1. 允许接收远程主机的SSH请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="1-2-允许发送本地主机的SSH响应"><a href="#1-2-允许发送本地主机的SSH响应" class="headerlink" title="1.2. 允许发送本地主机的SSH响应"></a>1.2. 允许发送本地主机的SSH响应</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<ul>
<li><code>-m state</code>: 启用状态匹配模块（<code>state matching module</code>）</li>
<li><code>--state</code>: 状态匹配模块的参数。当<code>SSH</code>客户端第一个数据包到达服务器时，状态字段为<code>NEW</code>；建立连接后数据包的状态字段都是<code>ESTABLISHED</code></li>
<li><code>--sport 22</code>: <code>sshd</code>监听<code>22</code>端口，同时也通过该端口和客户端建立连接、传送数据。因此对于<code>SSH</code>服务器而言，源端口就是<code>22</code></li>
<li><code>--dport 22</code>: <code>ssh</code>客户端程序可以从本机的随机端口与<code>SSH</code>服务器的<code>22</code>端口建立连接。因此对于<code>SSH</code>客户端而言，目的端口就是<code>22</code></li>
</ul>
<p>如果服务器也需要使用<code>SSH</code>连接其他远程主机，则还需要增加以下配置：</p>
<h5 id="1-3-送出的数据包目的端口为22"><a href="#1-3-送出的数据包目的端口为22" class="headerlink" title="1.3. 送出的数据包目的端口为22"></a>1.3. 送出的数据包目的端口为22</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="1-4-接收的数据包源端口为22"><a href="#1-4-接收的数据包源端口为22" class="headerlink" title="1.4. 接收的数据包源端口为22"></a>1.4. 接收的数据包源端口为22</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h4 id="2-HTTP"><a href="#2-HTTP" class="headerlink" title="2. HTTP"></a>2. HTTP</h4><p><code>HTTP</code>的配置与<code>SSH</code>类似：</p>
<h5 id="1-允许接收远程主机的HTTP请求"><a href="#1-允许接收远程主机的HTTP请求" class="headerlink" title="1. 允许接收远程主机的HTTP请求"></a>1. 允许接收远程主机的HTTP请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="2-允许发送本地主机的HTTP响应"><a href="#2-允许发送本地主机的HTTP响应" class="headerlink" title="2. 允许发送本地主机的HTTP响应"></a>2. 允许发送本地主机的HTTP响应</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h4 id="3-完整的配"><a href="#3-完整的配" class="headerlink" title="3. 完整的配"></a>3. 完整的配</h4><h5 id="1-删除现有规则"><a href="#1-删除现有规则" class="headerlink" title="1. 删除现有规则"></a>1. 删除现有规则</h5><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iptables -F</span><br></code></pre></td></tr></table></figure>

<h5 id="2-配置默认链策略"><a href="#2-配置默认链策略" class="headerlink" title="2. 配置默认链策略"></a>2. 配置默认链策略</h5><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sas">iptables -P <span class="hljs-meta">INPUT</span> <span class="hljs-meta">DROP</span><br>iptables -P FORWARD <span class="hljs-meta">DROP</span><br>iptables -P <span class="hljs-meta">OUTPUT</span> <span class="hljs-meta">DROP</span><br></code></pre></td></tr></table></figure>

<h5 id="3-允许远程主机进行SSH连接"><a href="#3-允许远程主机进行SSH连接" class="headerlink" title="3. 允许远程主机进行SSH连接"></a>3. 允许远程主机进行SSH连接</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="4-允许本地主机进行SSH连接"><a href="#4-允许本地主机进行SSH连接" class="headerlink" title="4. 允许本地主机进行SSH连接"></a>4. 允许本地主机进行SSH连接</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A OUTPUT -o eth0 -p tcp --dport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A INPUT -i eth0 -p tcp --sport <span class="hljs-number">22</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<h5 id="5-允许HTTP请求"><a href="#5-允许HTTP请求" class="headerlink" title="5.允许HTTP请求"></a>5.允许HTTP请求</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -A INPUT -i eth0 -p tcp --dport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state NEW,ESTABLISHED -j ACCEPT<br>iptables -A OUTPUT -o eth0 -p tcp --sport <span class="hljs-number">80</span> -m <span class="hljs-keyword">state</span> --state ESTABLISHED -j ACCEPT<br></code></pre></td></tr></table></figure>

<p><code>iptables</code>命令是<code>Linux</code>上常用的防火墙软件，是<code>netfilter</code>项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Linux/">Linux</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Linux/">Linux</a>
                    
                      <a class="hover-with-bg" href="/tags/iptables/">iptables</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/ce41cac3/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">将GitHub中的Hexo部署到云服务器上（CentOS7）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/5c96f5b1/">
                        <span class="hidden-mobile">Nginx-配置详解</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "Mwdu7VOQpQQD3cKW6SsRSt4f-gzGzoHsz",
          app_key: "XAg4RThXdR3JX0BNAF0axveE",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "mp",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
