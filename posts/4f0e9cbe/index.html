

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="ButATree">
  <meta name="keywords" content="">
  <title>Kubernetes-二进制部署 - ButATree&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"butatree.site","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ButATree</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-notebook"></i>
                关于
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/about/">
                    <i class="iconfont icon-user-fill"></i>
                    个人
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" target="_blank" rel="noopener" href="http://download.butatree.site">
                    
                    下载
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                相关链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/4l2p20.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Kubernetes-二进制部署">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      ButATree
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-19 19:41" pubdate>
        2021年1月19日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      263
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Kubernetes-二进制部署</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年3月8日 晚上
                
              </p>
            
            <div class="markdown-body">
              <h1 id="二进制部署Kubernetes集群-上"><a href="#二进制部署Kubernetes集群-上" class="headerlink" title="二进制部署Kubernetes集群(上)"></a>二进制部署Kubernetes集群(上)</h1><blockquote><footer><strong>Jarvis的BLOG</strong><cite><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangchaolinux/p/11875124.html">转载文章</a></cite></footer></blockquote>


<h2 id="1-实验架构"><a href="#1-实验架构" class="headerlink" title="1.实验架构"></a>1.实验架构</h2><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119205100565.png" srcset="/img/loading.gif" alt="实验架构"></p>
<h3 id="1-1-硬件环境"><a href="#1-1-硬件环境" class="headerlink" title="1.1.硬件环境"></a>1.1.硬件环境</h3><p>准备5台2c/2g/50g虚拟机，使用10.4.7.0/24 网络 。//因后期要直接向k8s交付java服务，因此运算节点需要4c8g。不交付服务，全部2c2g足够。</p>
<h3 id="1-2-软件环境"><a href="#1-2-软件环境" class="headerlink" title="1.2.软件环境"></a>1.2.软件环境</h3><p>操作系统：预装CentOS7.6操作系统。//因docker完美支持对内核有需求，所有操作系统全部CentOS 7.x（需要内核3.8以上），做好系统基础优化。</p>
<p><strong>关闭selinux，关闭firewalld服务</strong><br><strong>时间同步（chronyd）</strong><br><strong>调整Base源，Epel源</strong><br><strong>内核优化（文件描述符大小，内核转发，等等）</strong></p>
<h3 id="1-3-IP及架构规划"><a href="#1-3-IP及架构规划" class="headerlink" title="1.3.IP及架构规划"></a>1.3.IP及架构规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
<th>部署服务与组件</th>
<th>硬件配置</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-11.host.com</td>
<td>k8s proxy 主</td>
<td>10.4.7.11</td>
<td>bind9、nginx（L4）、keepalived、supervisor</td>
<td>2C 2G 50G</td>
</tr>
<tr>
<td>hdss7-12.host.com</td>
<td>k8s proxy 备</td>
<td>10.4.7.12</td>
<td>etcd、nginx（L4）、keepalived、supervisor</td>
<td>2C 2G 50G</td>
</tr>
<tr>
<td>hdss7-21.host.com</td>
<td>k8s 运算节点1</td>
<td>10.4.7.21</td>
<td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler kube-kubelet、kube-proxy，supervisor</td>
<td>4C 8G 50G</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>k8s 运算节点2</td>
<td>10.4.7.22</td>
<td>etcd、kube-apiserver、kube-controller-manager、kube-scheduler、kube-kubelet、kube-proxy，supervisor</td>
<td>4C 8G 50G</td>
</tr>
<tr>
<td>hdss7-200.host.com</td>
<td>k8s 运维节点，docker仓库</td>
<td>10.4.7.200</td>
<td>docker 私有仓库、资源配置清单仓库、提供共享存储（NFS）、签发证书</td>
<td>2C 2G 50G</td>
</tr>
</tbody></table>
<h2 id="2-基础环境准备及网络设置"><a href="#2-基础环境准备及网络设置" class="headerlink" title="2.基础环境准备及网络设置"></a>2.基础环境准备及网络设置</h2><h3 id="2-1-网络设置"><a href="#2-1-网络设置" class="headerlink" title="2.1.网络设置"></a>2.1.网络设置</h3><h4 id="2-1-1-VM虚拟网络编辑器设置"><a href="#2-1-1-VM虚拟网络编辑器设置" class="headerlink" title="2.1.1.VM虚拟网络编辑器设置"></a>2.1.1.VM虚拟网络编辑器设置</h4><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119205830113.png" srcset="/img/loading.gif" alt="VM虚拟网络编辑器设置"></p>
<h4 id="2-1-2-Windows网卡设置"><a href="#2-1-2-Windows网卡设置" class="headerlink" title="2.1.2.Windows网卡设置"></a>2.1.2.Windows网卡设置</h4><p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/image-20210119210222054.png" srcset="/img/loading.gif" alt="Windows网卡设置"></p>
<h3 id="2-2-虚拟机操作系统设置"><a href="#2-2-虚拟机操作系统设置" class="headerlink" title="2.2.虚拟机操作系统设置"></a>2.2.虚拟机操作系统设置</h3><h4 id="2-2-1-设置主机名"><a href="#2-2-1-设置主机名" class="headerlink" title="2.2.1.设置主机名"></a>2.2.1.设置主机名</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">~]# hostnamectl <span class="hljs-keyword">set</span>-<span class="hljs-built_in">hostname</span> hdss7-xx.host.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-关闭防火墙和selinux"><a href="#2-2-2-关闭防火墙和selinux" class="headerlink" title="2.2.2.关闭防火墙和selinux"></a>2.2.2.关闭防火墙和selinux</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~]# systemctl stop firewalld<br>~]# systemctl disable firewalld<br>~]# setenforce <span class="hljs-number">0</span><br>~]# sed –i ‘s<span class="hljs-regexp">/SELINUX=enforcing/</span>SELINUX=disabled<span class="hljs-regexp">/g’ /</span>etc<span class="hljs-regexp">/selinux/</span>config<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-设置网卡"><a href="#2-2-3-设置网卡" class="headerlink" title="2.2.3.设置网卡"></a>2.2.3.设置网卡</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0 <br><span class="hljs-attribute">TYPE</span>=Ethernet<br><span class="hljs-attribute">BOOTPROTO</span>=none<br><span class="hljs-attribute">NAME</span>=eth0<br><span class="hljs-attribute">DEVICE</span>=eth0<br><span class="hljs-attribute">ONBOOT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPADDR</span>=10.4.7.xx<br><span class="hljs-attribute">NETMASK</span>=255.255.255.0<br><span class="hljs-attribute">GATEWAY</span>=10.4.7.254<br><span class="hljs-attribute">DNS1</span>=10.4.7.xx<br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-设置yum源"><a href="#2-2-4-设置yum源" class="headerlink" title="2.2.4.设置yum源"></a>2.2.4.设置yum源</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~]# yum install epel-release<br>或者<br>~]# wget -O <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/CentOS-Base.repo  http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>repo/Centos-<span class="hljs-number">7</span>.repo<br>~]# wget -O <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/epel.repo  http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>repo/epel-<span class="hljs-number">7</span>.repo<br>~]# yum clean all<br>~]# yum makecache<br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-安装常用工具"><a href="#2-2-5-安装常用工具" class="headerlink" title="2.2.5.安装常用工具"></a>2.2.5.安装常用工具</h4><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">~]# yum install wget <span class="hljs-built_in">net</span>-tools telnet <span class="hljs-built_in">tree</span> nmap sysstat lrzsz dos2unix bind-utils -y<br></code></pre></td></tr></table></figure>

<h3 id="2-3安装bind服务"><a href="#2-3安装bind服务" class="headerlink" title="2.3安装bind服务"></a>2.3安装bind服务</h3>
            <input type="checkbox" disabled checked="checked">主节点hdss7-11.host.com 上
          

<h4 id="2-3-1-安装bind-9"><a href="#2-3-1-安装bind-9" class="headerlink" title="2.3.1.安装bind 9"></a>2.3.1.安装bind 9</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">~]#</span><span class="bash"> yum install <span class="hljs-built_in">bind</span> -y</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-配置bind-9"><a href="#2-3-2-配置bind-9" class="headerlink" title="2.3.2.配置bind 9"></a>2.3.2.配置bind 9</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs clean"><span class="hljs-comment">//主配置文件</span><br>~]# vi /etc/named.conf<br>listen-on port <span class="hljs-number">53</span> &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;; <br>allow-query     &#123; any; &#125;;<br>forwarders      &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.254</span>; &#125;;<br>recursion yes;<br>dnssec-enable no;<br>dnssec-validation no<br><br>##########参数说明#########<br>* dnssec-enable yes; ----&gt; dnssec-enable no; # 是否支持DNSSEC开关 PS：dnssec作用：<span class="hljs-number">1.</span>为DNS数据提供来源验证 <span class="hljs-number">2.</span>为数据提供完整性性验证 <span class="hljs-number">3.</span>为查询提供否定存在验证<br>* dnssec-validation yes; ----&gt; dnssec-validation no; #是否进行DNSSEC确认开关<br>* forwarders      &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.1</span>; &#125;; #用来指定上一层DNS地址，一般指定网关，确保服务能够访问公网<br>* listen-on-v6 port <span class="hljs-number">53</span> &#123; ::<span class="hljs-number">1</span>; &#125;; 如果不用IPV6，可以删除<br>*recursion 递归查询<br>#########################<br><br>~]# named-checkconf<br><br><span class="hljs-comment">//区域配置文件</span><br>~]# vi /etc/named.rfc1912.zones<br>zone <span class="hljs-string">&quot;host.com&quot;</span> IN &#123;<br>        type  master;<br>        file  <span class="hljs-string">&quot;host.com.zone&quot;</span>;<br>        allow-update &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;;<br>&#125;;<br><br>zone <span class="hljs-string">&quot;od.com&quot;</span> IN &#123;<br>        type  master;<br>        file  <span class="hljs-string">&quot;od.com.zone&quot;</span>;<br>        allow-update &#123; <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>; &#125;;<br>&#125;;<br><br><span class="hljs-comment">//配置区域数据文件</span><br>    <span class="hljs-number">1.</span>配置主机域数据文件<br>~]# vi  /var/named/host.com.zone<br>$ORIGIN host.com.<br>$TTL <span class="hljs-number">600</span>	; <span class="hljs-number">10</span> minutes<br>@       IN SOA	dns.host.com. dnsadmin.host.com. (<br>				<span class="hljs-number">2019111001</span> ; serial<br>				<span class="hljs-number">10800</span>      ; refresh (<span class="hljs-number">3</span> hours)<br>				<span class="hljs-number">900</span>        ; retry (<span class="hljs-number">15</span> minutes)<br>				<span class="hljs-number">604800</span>     ; expire (<span class="hljs-number">1</span> week)<br>				<span class="hljs-number">86400</span>      ; minimum (<span class="hljs-number">1</span> day)<br>				)<br>			NS   dns.host.com.<br>$TTL <span class="hljs-number">60</span>	; <span class="hljs-number">1</span> minute<br>dns                A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br>HDSS7<span class="hljs-number">-11</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br>HDSS7<span class="hljs-number">-12</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.12</span><br>HDSS7<span class="hljs-number">-21</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.21</span><br>HDSS7<span class="hljs-number">-22</span>           A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.22</span><br>HDSS7<span class="hljs-number">-200</span>          A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span>  <br>    <span class="hljs-number">2.</span>配置业务域数据文件<br>~]# vi  /var/named/od.com.zone<br>$ORIGIN od.com.<br>$TTL <span class="hljs-number">600</span>	; <span class="hljs-number">10</span> minutes<br>@   		IN SOA	dns.od.com. dnsadmin.od.com. (<br>				<span class="hljs-number">2019111001</span> ; serial<br>				<span class="hljs-number">10800</span>      ; refresh (<span class="hljs-number">3</span> hours)<br>				<span class="hljs-number">900</span>        ; retry (<span class="hljs-number">15</span> minutes)<br>				<span class="hljs-number">604800</span>     ; expire (<span class="hljs-number">1</span> week)<br>				<span class="hljs-number">86400</span>      ; minimum (<span class="hljs-number">1</span> day)<br>				)<br>				NS   dns.od.com.<br>$TTL <span class="hljs-number">60</span>	; <span class="hljs-number">1</span> minute<br>dns                A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span>    <br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-检查配置并启动bind-9"><a href="#2-3-3-检查配置并启动bind-9" class="headerlink" title="2.3.3.检查配置并启动bind 9"></a>2.3.3.检查配置并启动bind 9</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir">~]<span class="hljs-comment"># named-checkconf</span><br>~]<span class="hljs-comment"># systemctl start named</span><br>~]<span class="hljs-comment"># netstat -nltup|grep 53</span><br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><span class="hljs-symbol">:</span><span class="hljs-number">53</span>            0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">953</span>           0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">53</span>                   ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">18279</span>/named         <br>tcp6       0      0 ::<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">953</span>                 ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">18279</span>/named         <br>udp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><span class="hljs-symbol">:</span><span class="hljs-number">53</span>            0.0.0.0<span class="hljs-symbol">:*</span>                           <span class="hljs-number">18279</span>/named         <br>udp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">53</span>                   ::<span class="hljs-symbol">:*</span>                                <span class="hljs-number">18279</span>/named <br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-检查"><a href="#2-3-4-检查" class="headerlink" title="2.3.4.检查"></a>2.3.4.检查</h4><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">21</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span> +short<br><span class="hljs-number">10.4.7.21</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">200</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.200</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A hdss7-<span class="hljs-number">11</span>.host.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.11</span><br><span class="hljs-string">[root@hdss7-11 ~]</span># dig -t A dns.od.com @<span class="hljs-number">10</span>.<span class="hljs-number">4</span>.<span class="hljs-number">7</span>.<span class="hljs-number">11</span>  +short<br><span class="hljs-number">10.4.7.11</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-5-配置DNS客户端"><a href="#2-3-5-配置DNS客户端" class="headerlink" title="2.3.5.配置DNS客户端"></a>2.3.5.配置DNS客户端</h4><h5 id="linux主机所有"><a href="#linux主机所有" class="headerlink" title="linux主机所有"></a>linux主机所有</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-11</span> ~]# vi /etc/resolv.conf <br># <span class="hljs-keyword">Generated</span> <span class="hljs-keyword">by</span> NetworkManager<br><span class="hljs-keyword">search</span> host.com<br>nameserver <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.11</span><br><br>~] systemctl <span class="hljs-keyword">restart</span> network 五台都设置重启<br></code></pre></td></tr></table></figure>

<h5 id="windows主机"><a href="#windows主机" class="headerlink" title="windows主机"></a>windows主机</h5><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">更改适配器设置  → 属性 → ipv4 → 更改dns <br>自动跃点 10 优先从vmnet 8出网<br></code></pre></td></tr></table></figure>

<h4 id="2-3-6-检查"><a href="#2-3-6-检查" class="headerlink" title="2.3.6.检查"></a>2.3.6.检查</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">~]<span class="hljs-comment"># ping hdss7-200.host.com</span><br>~]<span class="hljs-comment"># ping dns.od.com</span><br><span class="hljs-comment">#若windows ping不到，把本地网卡dns设置成10.4.7.11</span><br></code></pre></td></tr></table></figure>

<h3 id="2-4-准备签发证书环境"><a href="#2-4-准备签发证书环境" class="headerlink" title="2.4.准备签发证书环境"></a>2.4.准备签发证书环境</h3>
            <input type="checkbox" disabled checked="checked">运维主机hdss7-200.host.com 上
          

<h4 id="2-4-1-安装CFSSL"><a href="#2-4-1-安装CFSSL" class="headerlink" title="2.4.1.安装CFSSL"></a>2.4.1.安装CFSSL</h4><p><strong>证书签发工具CFSSL：R1.2</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">HDSS7<span class="hljs-number">-200</span>上:<br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl          //cfssl下载地址</span></span><br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json    //cfssl-json下载地址</span></span><br>~]<span class="hljs-meta"># wget https:<span class="hljs-comment">//pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo     //cfssl-certinfo下载地址</span></span><br>~]<span class="hljs-meta"># chmod +x /usr/bin/cfssl*</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4-2-创建生成CA证书签名请求（csr）的json配置文件"><a href="#2-4-2-创建生成CA证书签名请求（csr）的json配置文件" class="headerlink" title="2.4.2.创建生成CA证书签名请求（csr）的json配置文件"></a>2.4.2.创建生成CA证书签名请求（csr）的json配置文件</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs clean">vi  /opt/certs/ca-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;OldboyEdu&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-string">&quot;ca&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span><br>    &#125;<br>&#125;<br><br>##############配置说明###########<br>CN：Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名，很重要，浏览器使用该字段验证网站是否合法<br>C：Country 国家<br>ST：State 州，省<br>L：Locality 地区，城市<br>O：Organization Name 组织名称，公司名称<br>OU：Organization Unit Name 组织单位名称，部门<br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-生成CA证书和私钥"><a href="#2-4-3-生成CA证书和私钥" class="headerlink" title="2.4.3.生成CA证书和私钥"></a>2.4.3.生成CA证书和私钥</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs clean">mkdir /opt/certs<br>cd /opt/certs<br>certs]#  cfssl gencert -initca ca-csr.json | cfssl-json -bare ca<br>certs]# ll<br>ca.csr  <br>ca-csr.json  <br>ca-key.pem                                 <span class="hljs-comment">//根证书的私钥  </span><br>ca.pem                                      <span class="hljs-comment">//根证书</span><br>##########<br>ca.pem     <span class="hljs-comment">//根证书</span><br>ca-key.pem:<br></code></pre></td></tr></table></figure>

<h3 id="2-5-部署docker环境"><a href="#2-5-部署docker环境" class="headerlink" title="2.5.部署docker环境"></a>2.5.部署docker环境</h3>
            <input type="checkbox" disabled checked="checked">hdss7-200.host.com 上
          

            <input type="checkbox" disabled checked="checked">hdss7-21.host.com 上
          

            <input type="checkbox" disabled checked="checked">hdss7-22.host.com 上
          

<h4 id="2-5-1-安装"><a href="#2-5-1-安装" class="headerlink" title="2.5.1.安装"></a>2.5.1.安装</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> ~]<span class="hljs-comment"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><br><span class="hljs-comment"># Executing docker install script, commit: f45d7c11389849ff46a6b4d94e0dd1ffebca32c1</span><br>+ sh -c <span class="hljs-string">&#x27;yum install -y -q yum-utils&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&#x27;</span><br>Loaded plugins: fastestmirror<br>adding repo from: https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo<br>grabbing file https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo to <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br>repo saved to <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br>+ <span class="hljs-string">&#x27;[&#x27;</span> stable <span class="hljs-string">&#x27;!=&#x27;</span> stable <span class="hljs-string">&#x27;]&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum makecache&#x27;</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: mirrors.aliyun.com<br>base                                                                                                   | <span class="hljs-number">3.6</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>docker-ce-stable                                                                                       | <span class="hljs-number">3.5</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>epel                                                                                                   | <span class="hljs-number">5.4</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>extras                                                                                                 | <span class="hljs-number">2.9</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>updates                                                                                                | <span class="hljs-number">2.9</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">1</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/updateinfo                                                             |   <span class="hljs-number">55</span> B  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">2</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/filelists_db                                                           |  <span class="hljs-number">18</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">3</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/primary_db                                                             |  <span class="hljs-number">37</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">4</span><span class="hljs-regexp">/14): docker-ce-stable/</span>x86_64/other_db                                                               | <span class="hljs-number">111</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">5</span><span class="hljs-regexp">/14): epel/</span>x86_64/prestodelta                                                                        | <span class="hljs-number">4.0</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">6</span><span class="hljs-regexp">/14): base/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                         | <span class="hljs-number">2.6</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">7</span><span class="hljs-regexp">/14): epel/</span>x86_64/other_db                                                                           | <span class="hljs-number">3.3</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">02</span>     <br>(<span class="hljs-number">8</span><span class="hljs-regexp">/14): extras/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                       | <span class="hljs-number">100</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">9</span><span class="hljs-regexp">/14): extras/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                   | <span class="hljs-number">207</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">10</span><span class="hljs-regexp">/14): updates/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>other_db                                                                     | <span class="hljs-number">243</span> kB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <br>(<span class="hljs-number">11</span><span class="hljs-regexp">/14): epel/</span>x86_64/updateinfo_zck                                                                    | <span class="hljs-number">1.5</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">12</span><span class="hljs-regexp">/14): updates/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                 | <span class="hljs-number">2.1</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span>     <br>(<span class="hljs-number">13</span><span class="hljs-regexp">/14): base/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>filelists_db                                                                    | <span class="hljs-number">7.3</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">04</span>     <br>(<span class="hljs-number">14</span><span class="hljs-regexp">/14): epel/</span>x86_64/filelists_db                                                                      |  <span class="hljs-number">12</span> MB  <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span>     <br>Metadata Cache Created<br>+ <span class="hljs-string">&#x27;[&#x27;</span> -n <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-string">&#x27;]&#x27;</span><br>+ sh -c <span class="hljs-string">&#x27;yum install -y -q docker-ce&#x27;</span><br>warning: <span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/yum/</span>x86_64<span class="hljs-regexp">/7/</span>docker-ce-stable<span class="hljs-regexp">/packages/</span>docker-ce-<span class="hljs-number">19.03</span>.<span class="hljs-number">5</span>-<span class="hljs-number">3</span>.el7.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID <span class="hljs-number">621</span>e9f35: NOKEY<br>Public key <span class="hljs-keyword">for</span> docker-ce-<span class="hljs-number">19.03</span>.<span class="hljs-number">5</span>-<span class="hljs-number">3</span>.el7.x86_64.rpm is not installed<br>Importing GPG key <span class="hljs-number">0</span>x621E9F35:<br> Userid     : <span class="hljs-string">&quot;Docker Release (CE rpm) &lt;docker@docker.com&gt;&quot;</span><br> Fingerprint: <span class="hljs-number">060</span>a <span class="hljs-number">61</span>c5 <span class="hljs-number">1</span>b55 <span class="hljs-number">8</span>a7f <span class="hljs-number">742</span>b <span class="hljs-number">77</span>aa c52f eb6b <span class="hljs-number">621</span>e <span class="hljs-number">9</span>f35<br> From       : https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/g</span>pg<br>setsebool:  SELinux is disabled.<br>If you would like to use Docker as a non-root user, you should now consider<br>adding your user to the <span class="hljs-string">&quot;docker&quot;</span> group with something like:<br><br>  sudo usermod -aG docker your-user<br><br>Remember that you will have to log out and back <span class="hljs-keyword">in</span> <span class="hljs-keyword">for</span> this to take effect!<br><br>WARNING: Adding a user to the <span class="hljs-string">&quot;docker&quot;</span> group will grant the ability to run<br>         containers which can be used to obtain root privileges on the<br>         docker host.<br>         Refer to https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>security<span class="hljs-regexp">/security/</span><span class="hljs-comment">#docker-daemon-attack-surface</span><br>         <span class="hljs-keyword">for</span> more information.<br></code></pre></td></tr></table></figure>

<p>报错：<br><img src="/img/blog_image/Linux_k8S_Bin_contentImage/error.png" srcset="/img/loading.gif" alt="报错"></p>
<p>解决：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -f  <span class="hljs-regexp">/etc/yum</span>.repos.d/local.repo   <span class="hljs-comment">#再重新安装</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-2-配置"><a href="#2-5-2-配置" class="headerlink" title="2.5.2.配置"></a>2.5.2.配置</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">mkdir  /etc/docker<br>vi  /etc/docker/daemon.json<br>&#123;<br>  <span class="hljs-string">&quot;graph&quot;</span>: <span class="hljs-string">&quot;/data/docker&quot;</span>,<br>  <span class="hljs-string">&quot;storage-driver&quot;</span>: <span class="hljs-string">&quot;overlay2&quot;</span>,<br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;registry.access.redhat.com&quot;</span>,<span class="hljs-string">&quot;quay.io&quot;</span>,<span class="hljs-string">&quot;harbor.od.com&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;</span>],<br>  <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;172.7.21.1/24&quot;</span>,<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;live-restore&quot;</span>: true<br>&#125;<br>############配置说明###############<br>bip要根据宿主机ip变化 <br>注意：hdss7<span class="hljs-number">-21.</span>host.com   bip <span class="hljs-number">172.7</span><span class="hljs-number">.21</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>     hdss7<span class="hljs-number">-22.</span>host.com   bip <span class="hljs-number">172.7</span><span class="hljs-number">.22</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>     hdss7<span class="hljs-number">-200.</span>host.com  bip <span class="hljs-number">172.7</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span>/<span class="hljs-number">24</span><br>#################################<br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-启动"><a href="#2-5-3-启动" class="headerlink" title="2.5.3.启动"></a>2.5.3.启动</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">docker]#</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">/data/docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">start</span> <span class="hljs-string">docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">enable</span> <span class="hljs-string">docker</span><br><span class="hljs-string">docker]#</span> <span class="hljs-string">docker</span> <span class="hljs-string">--version</span><br><span class="hljs-string">Docker</span> <span class="hljs-string">version</span> <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><span class="hljs-string">,</span> <span class="hljs-string">build</span> <span class="hljs-string">9013bf583a</span><br>[<span class="hljs-string">root@hdss7-200</span> <span class="hljs-string">docker</span>]<span class="hljs-comment"># docker version</span><br><span class="hljs-attr">Client:</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Engine</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Community</span><br> <span class="hljs-attr">Version:</span>           <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><br> <span class="hljs-attr">API version:</span>       <span class="hljs-number">1.40</span><br> <span class="hljs-attr">Go version:</span>        <span class="hljs-string">go1.12.10</span><br> <span class="hljs-attr">Git commit:</span>        <span class="hljs-string">9013bf583a</span><br> <span class="hljs-attr">Built:</span>             <span class="hljs-string">Fri</span> <span class="hljs-string">Oct</span> <span class="hljs-number">18</span> <span class="hljs-number">15</span><span class="hljs-string">:52:22</span> <span class="hljs-number">2019</span><br> <span class="hljs-attr">OS/Arch:</span>           <span class="hljs-string">linux/amd64</span><br> <span class="hljs-attr">Experimental:</span>      <span class="hljs-literal">false</span><br><br><span class="hljs-attr">Server:</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Engine</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Community</span><br> <span class="hljs-attr">Engine:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">19.03</span><span class="hljs-number">.5</span><br>  <span class="hljs-attr">API version:</span>      <span class="hljs-number">1.40</span> <span class="hljs-string">(minimum</span> <span class="hljs-string">version</span> <span class="hljs-number">1.12</span><span class="hljs-string">)</span><br>  <span class="hljs-attr">Go version:</span>       <span class="hljs-string">go1.12.12</span><br>  <span class="hljs-attr">Git commit:</span>       <span class="hljs-string">633a0ea</span><br>  <span class="hljs-attr">Built:</span>            <span class="hljs-string">Wed</span> <span class="hljs-string">Nov</span> <span class="hljs-number">13</span> <span class="hljs-number">07</span><span class="hljs-string">:24:18</span> <span class="hljs-number">2019</span><br>  <span class="hljs-attr">OS/Arch:</span>          <span class="hljs-string">linux/amd64</span><br>  <span class="hljs-attr">Experimental:</span>     <span class="hljs-literal">false</span><br> <span class="hljs-attr">containerd:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">1.2</span><span class="hljs-number">.10</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">b34a5c8af56e510852c35414db4c1f4fa6172339</span><br> <span class="hljs-attr">runc:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-string">-rc8+dev</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br> <span class="hljs-attr">docker-init:</span><br>  <span class="hljs-attr">Version:</span>          <span class="hljs-number">0.18</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">GitCommit:</span>        <span class="hljs-string">fec3683</span><br></code></pre></td></tr></table></figure>

<h3 id="2-6-部署docker镜像私有仓库harbor"><a href="#2-6-部署docker镜像私有仓库harbor" class="headerlink" title="2.6.部署docker镜像私有仓库harbor"></a>2.6.部署docker镜像私有仓库harbor</h3>
            <input type="checkbox" disabled checked="checked">运维主机hdss7-200.host.com 上
          

<h4 id="2-6-1-下载软件二进制包并解压"><a href="#2-6-1-下载软件二进制包并解压" class="headerlink" title="2.6.1.下载软件二进制包并解压"></a>2.6.1.下载软件二进制包并解压</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vim">强烈建议下载<span class="hljs-number">1.7</span>.<span class="hljs-number">5</span>以上版本<br>harbor官网github地址<br>http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/goharbor/harbor<br><br>src]# tar xf harbor-offline-installer-v1.<span class="hljs-number">8.3</span>.tgz -C /<span class="hljs-keyword">opt</span>/<br><span class="hljs-keyword">opt</span>]# mv harbor/ harbor-v1.<span class="hljs-number">8.3</span><br><span class="hljs-keyword">opt</span>]# <span class="hljs-keyword">ln</span> -s /<span class="hljs-keyword">opt</span>/harbor-v1.<span class="hljs-number">8.3</span>/ /<span class="hljs-keyword">opt</span>/harbor<br></code></pre></td></tr></table></figure>

<h4 id="2-6-2-配置"><a href="#2-6-2-配置" class="headerlink" title="2.6.2.配置"></a>2.6.2.配置</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts">[root@hdss7<span class="hljs-number">-200</span> opt]<span class="hljs-meta"># vi /opt/harbor/harbor.yml</span><br><span class="hljs-symbol">hostname:</span> harbor.od.com<br><span class="hljs-symbol">http:</span><br><span class="hljs-symbol">  port:</span> <span class="hljs-number">180</span><br><span class="hljs-symbol"> harbor_admin_password:</span>Harbor12345<br><span class="hljs-symbol">data_volume:</span> <span class="hljs-meta-keyword">/data/</span>harbor<br><span class="hljs-symbol">log:</span><br><span class="hljs-symbol">    level:</span>  info<br><span class="hljs-symbol">    rotate_count:</span>  <span class="hljs-number">50</span><br><span class="hljs-symbol">    rotate_size:</span><span class="hljs-number">200</span>M<br><span class="hljs-symbol">    location:</span> <span class="hljs-meta-keyword">/data/</span>harbor/logs<br><br>[root@hdss7<span class="hljs-number">-200</span> opt]<span class="hljs-meta"># mkdir -p /data/harbor/logs</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-3-安装docker-compose"><a href="#2-6-3-安装docker-compose" class="headerlink" title="2.6.3.安装docker-compose"></a>2.6.3.安装docker-compose</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> <span class="hljs-keyword">opt</span>]# yum install docker-compose -<span class="hljs-keyword">y</span><br>Loaded plugin<span class="hljs-variable">s:</span> fastestmirror<br>Loading mirror speeds from cached hostfile<br> * base: mirrors.aliyun.<span class="hljs-keyword">com</span><br> * extra<span class="hljs-variable">s:</span> mirrors.aliyun.<span class="hljs-keyword">com</span><br> * <span class="hljs-keyword">update</span><span class="hljs-variable">s:</span> mirrors.aliyun.<span class="hljs-keyword">com</span><br>Package docker-compose-<span class="hljs-number">1.18</span>.<span class="hljs-number">0</span>-<span class="hljs-number">4</span>.el7.noarch already installed <span class="hljs-built_in">and</span> latest <span class="hljs-keyword">version</span><br>Nothing <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-4-安装harbor"><a href="#2-6-4-安装harbor" class="headerlink" title="2.6.4.安装harbor"></a>2.6.4.安装harbor</h4><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs gams">[root@hdss7<span class="hljs-number">-200</span> harbor]# ./install.sh <br><br>[Step <span class="hljs-number">0</span>]: checking installation environment ...<br><br>Note: docker version: <span class="hljs-number">19.03</span><span class="hljs-number">.4</span><br><br>Note: docker-compose version: <span class="hljs-number">1.18</span><span class="hljs-number">.0</span><br>................<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-portal ... done<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> nginx ... done<br><span class="hljs-function"><span class="hljs-title">Creating</span></span> registry ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> registryctl ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-db ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> redis ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-core ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-portal ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> harbor-jobservice ... <br><span class="hljs-function"><span class="hljs-title">Creating</span></span> nginx ... <br><br>?.----Harbor has been installed <span class="hljs-keyword">and</span> started successfully.----<br><br>Now you should be able to visit the admin portal at http:<span class="hljs-comment">//harbor.od.com. </span><br><span class="hljs-keyword">For</span> more details, please visit https:<span class="hljs-comment">//github.com/goharbor/harbor .</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-5-检查harbor启动情况"><a href="#2-6-5-检查harbor启动情况" class="headerlink" title="2.6.5.检查harbor启动情况"></a>2.6.5.检查harbor启动情况</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs stata">[root@hdss7-200 harbor]# docker-compose ps                     <span class="hljs-comment">//docker给起了一堆容器，单机编排</span><br>      Name                     Command               State             Ports          <br>--------------------------------------------------------------------------------------<br>harbor-core         /harbor/start.<span class="hljs-keyword">sh</span>                 Up                               <br>harbor-<span class="hljs-keyword">db</span>           /entrypoint.<span class="hljs-keyword">sh</span> postgres          Up      5432/tcp                 <br>harbor-jobservice   /harbor/start.<span class="hljs-keyword">sh</span>                 Up                               <br>harbor-<span class="hljs-keyword">log</span>          /bin/<span class="hljs-keyword">sh</span> -c /usr/<span class="hljs-keyword">local</span>/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp<br>harbor-portal       nginx -<span class="hljs-keyword">g</span> daemon off;             Up      80/tcp                   <br>nginx               nginx -<span class="hljs-keyword">g</span> daemon off;             Up      0.0.0.0:180-&gt;80/tcp      <br>redis               docker-entrypoint.<span class="hljs-keyword">sh</span> redis ...   Up      6379/tcp                 <br>registry            /entrypoint.<span class="hljs-keyword">sh</span> /etc/regist ...   Up      5000/tcp   <br><br><br>[root@hdss7-200 harbor]# docker ps -a                               <span class="hljs-comment">//可以看到180映射到本机80port                     </span><br>CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS                   PORTS                       NAMES<br>d6880cca7143        goharbor/nginx-photon:v1.8.3                        &quot;nginx -<span class="hljs-keyword">g</span> &#x27;daemon of??   3 minutes ago       Up 3 minutes (healthy)   0.0.0.0:180-&gt;80/tcp         nginx<br>a5d166ffb68e        goharbor/harbor-jobservice:v1.8.3                   <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes                                         harbor-jobservice<br>e0ab65359cc4        goharbor/harbor-portal:v1.8.3                       &quot;nginx -<span class="hljs-keyword">g</span> &#x27;daemon of??   3 minutes ago       Up 3 minutes (healthy)   80/tcp                      harbor-portal<br>ef032bf896c0        goharbor/harbor-core:v1.8.3                         <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes (healthy)                               harbor-core<br>6c334c42ac9d        goharbor/redis-photon:v1.8.3                        &quot;docker-entrypoint.s??   3 minutes ago       Up 3 minutes             6379/tcp                    redis<br>257f4c4ef4d7        goharbor/harbor-<span class="hljs-keyword">db</span>:v1.8.3                           &quot;/entrypoint.<span class="hljs-keyword">sh</span> <span class="hljs-keyword">post</span>??   3 minutes ago       Up 3 minutes (healthy)   5432/tcp                    harbor-<span class="hljs-keyword">db</span><br>7e741324bb39        goharbor/registry-photon:v2.7.1-patch-2819-v1.8.3   &quot;/entrypoint.<span class="hljs-keyword">sh</span> /etc??   3 minutes ago       Up 3 minutes (healthy)   5000/tcp                    registry<br>a468bf625584        goharbor/harbor-registryctl:v1.8.3                  <span class="hljs-string">&quot;/harbor/start.sh&quot;</span>       3 minutes ago       Up 3 minutes (healthy)                               registryctl<br>41a1e79fc5d1        goharbor/harbor-<span class="hljs-keyword">log</span>:v1.8.3                          &quot;/bin/<span class="hljs-keyword">sh</span> -c /usr/<span class="hljs-keyword">loc</span>??   3 minutes ago       Up 3 minutes (healthy)   127.0.0.1:1514-&gt;10514/tcp   harbor-<span class="hljs-keyword">log</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-6-配置harbor的dns内网解析"><a href="#2-6-6-配置harbor的dns内网解析" class="headerlink" title="2.6.6.配置harbor的dns内网解析"></a>2.6.6.配置harbor的dns内网解析</h4>
            <input type="checkbox" disabled checked="checked">hdss7-11.host.com 上
          


<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># vi /var/named/od.com.zone</span><br><span class="hljs-number">2019111002</span> ; serial<br>harbor             A    <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span><br><span class="hljs-comment">//注意serial前滚一个序号</span><br><br>[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># systemctl restart named</span><br>[<span class="hljs-meta">root@hdss7-11 ~</span>]<span class="hljs-meta"># dig -t A harbor.od.com +short</span><br><span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.200</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-7-安装nginx并配置"><a href="#2-6-7-安装nginx并配置" class="headerlink" title="2.6.7.安装nginx并配置"></a>2.6.7.安装nginx并配置</h4><blockquote>
<p>注意所在主机</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># yum install nginx</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># vi /etc/nginx/conf.d/harbor.od.com.conf</span><br>server &#123;<br>    listen       <span class="hljs-number">80</span>;<br>    server_name  harbor.od.com;<br><br>    client_max_body_size <span class="hljs-number">1000</span>m;<br><br>    location / &#123;<br>        proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">180</span>;<br>    &#125;<br>&#125;<br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># systemctl start nginx</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># systemctl enable nginx</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/nginx.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>nginx.service.<br></code></pre></td></tr></table></figure>

<h4 id="2-6-8-浏览器打开http：-harbor-od-com"><a href="#2-6-8-浏览器打开http：-harbor-od-com" class="headerlink" title="2.6.8.浏览器打开http：//harbor.od.com"></a>2.6.8.浏览器打开http：<a target="_blank" rel="noopener" href="http://harbor.od.com/">//harbor.od.com</a></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-11 ~]# curl harbor.od.com<br><span class="hljs-meta">&lt;!doctype <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Harbor<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">base</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;image/x-icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;favicon.ico?v=2&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;styles.c1fdd265f24063370a49.css&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">harbor-app</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;spinner spinner-lg app-loading&quot;</span>&gt;</span><br>            Loading...<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">harbor-app</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;runtime.26209474bfa8dc87a77c.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;scripts.c04548c4e6d1db502313.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;main.144e8ccd474a28572e81.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>1、浏览器输入：harbor.od.com 用户名：admin 密码：Harbor12345</strong></p>
<p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/login.png" srcset="/img/loading.gif" alt="登录"></p>
<p><strong>2、新建项目</strong></p>
<p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/new_P.png" srcset="/img/loading.gif" alt="新建项目"></p>
<p><strong>3、下载测试镜像并打给镜像打一个tag</strong></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> harbor]# docker pull nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br><span class="hljs-number">1.7</span>.<span class="hljs-number">9</span>: Pulling from library/nginx<br>Image docker.io/library/nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span> uses outdated schema1 manifest format. Please upgrade <span class="hljs-keyword">to</span> <span class="hljs-keyword">a</span> schema2 image <span class="hljs-keyword">for</span> better future compatibility. More information at http<span class="hljs-variable">s:</span>//docs.docker.<span class="hljs-keyword">com</span>/registry/spec/deprecated-schema-v1/<br>a3ed95caeb02: Pull <span class="hljs-built_in">complete</span> <br><span class="hljs-number">6</span>f5424ebd796: Pull <span class="hljs-built_in">complete</span> <br>d15444df170<span class="hljs-variable">a:</span> Pull <span class="hljs-built_in">complete</span> <br>e83f073daa67: Pull <span class="hljs-built_in">complete</span> <br>a4d93e421023: Pull <span class="hljs-built_in">complete</span> <br><span class="hljs-number">084</span>adbca2647: Pull <span class="hljs-built_in">complete</span> <br>c9cec474c523: Pull <span class="hljs-built_in">complete</span> <br>Diges<span class="hljs-variable">t:</span> <span class="hljs-built_in">sha256</span>:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451<br>Statu<span class="hljs-variable">s:</span> Downloaded newer image <span class="hljs-keyword">for</span> nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>docker.io/library/nginx:<span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>[root@hdss7-<span class="hljs-number">200</span> harbor]# docker images |<span class="hljs-keyword">grep</span> <span class="hljs-number">1.7</span>.<span class="hljs-number">9</span><br>nginx                           <span class="hljs-number">1.7</span>.<span class="hljs-number">9</span>                      <span class="hljs-number">84581</span>e99d807        <span class="hljs-number">4</span> years ago         <span class="hljs-number">91.7</span>MB<br>[root@hdss7-<span class="hljs-number">200</span> harbor]# docker <span class="hljs-keyword">tag</span> <span class="hljs-number">84581</span>e99d807 harbor.od.<span class="hljs-keyword">com</span>/public/nginx:v1.<span class="hljs-number">7.9</span><br></code></pre></td></tr></table></figure>

<p><strong>4、登陆harbor并推送到仓库</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># docker login harbor.od.com</span><br>Username: admin<br>Password: <br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> <span class="hljs-regexp">/root/</span>.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https:<span class="hljs-regexp">//</span>docs.docker.com<span class="hljs-regexp">/engine/</span>reference<span class="hljs-regexp">/commandline/</span>login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br>[root@hdss7-<span class="hljs-number">200</span> harbor]<span class="hljs-comment"># docker push harbor.od.com/public/nginx:v1.7.9</span><br>The push refers to repository [harbor.od.com<span class="hljs-regexp">/public/</span>nginx]<br><span class="hljs-number">5</span>f70bf18a086: Pushed <br><span class="hljs-number">4</span>b26ab29a475: Pushed <br>ccb1d68e3fb7: Pushed <br>e387107e2065: Pushed <br><span class="hljs-number">63</span>bf84221cce: Pushed <br>e02dce553481: Pushed <br>dea2e4984e29: Pushed <br>v1.<span class="hljs-number">7.9</span>: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: <span class="hljs-number">3012</span><br></code></pre></td></tr></table></figure>

<h4 id="2-6-9-检查"><a href="#2-6-9-检查" class="headerlink" title="2.6.9.检查"></a>2.6.9.检查</h4><p><strong>可以看到nginx镜像已推送到public下</strong></p>
<p><img src="/img/blog_image/Linux_k8S_Bin_contentImage/nginx.png" srcset="/img/loading.gif" alt="Public"></p>
<h2 id="3-部署Master节点服务"><a href="#3-部署Master节点服务" class="headerlink" title="3.部署Master节点服务"></a>3.部署Master节点服务</h2><h3 id="3-1-部署etcd集群"><a href="#3-1-部署etcd集群" class="headerlink" title="3.1.部署etcd集群"></a>3.1.部署etcd集群</h3><h4 id="3-1-1-集群规划"><a href="#3-1-1-集群规划" class="headerlink" title="3.1.1.集群规划"></a>3.1.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip地址</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-12.host.com</td>
<td>etcd lead</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>hdss7-21.host.com</td>
<td>etcd follow</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>etcd follow</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：这里部署文档以hdss7-12.host.com为例，另外两台部署方法类似</strong></p>
<h4 id="3-1-2-创建基于根证书的config配置文件"><a href="#3-1-2-创建基于根证书的config配置文件" class="headerlink" title="3.1.2.创建基于根证书的config配置文件"></a>3.1.2.创建基于根证书的config配置文件</h4>
            <input type="checkbox" disabled checked="checked">hdss7-200.host.com 上
          

<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> ~]# vi /opt/certs/ca-config.json<br>&#123;<br>    <span class="hljs-string">&quot;signing&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;default&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;profiles&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;server&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;server auth&quot;</span><br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;client&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;client auth&quot;</span><br>                ]<br>            &#125;,<br>            <span class="hljs-string">&quot;peer&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;expiry&quot;</span>: <span class="hljs-string">&quot;175200h&quot;</span>,<br>                <span class="hljs-string">&quot;usages&quot;</span>: [<br>                    <span class="hljs-string">&quot;signing&quot;</span>,<br>                    <span class="hljs-string">&quot;key encipherment&quot;</span>,<br>                    <span class="hljs-string">&quot;server auth&quot;</span>,<br>                    <span class="hljs-string">&quot;client auth&quot;</span><br>                ]<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;    <br></code></pre></td></tr></table></figure>

<h4 id="3-1-3-创建生成自签证书的签名请求（csr）的-json配置文件"><a href="#3-1-3-创建生成自签证书的签名请求（csr）的-json配置文件" class="headerlink" title="3.1.3.创建生成自签证书的签名请求（csr）的 json配置文件"></a>3.1.3.创建生成自签证书的签名请求（csr）的 json配置文件</h4><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> ~]# vi /opt/certs/etcd-peer-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-etcd&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>        <span class="hljs-string">&quot;10.4.7.11&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.12&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br>        <span class="hljs-string">&quot;10.4.7.22&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-4-生成etcd证书和私钥"><a href="#3-1-4-生成etcd证书和私钥" class="headerlink" title="3.1.4.生成etcd证书和私钥"></a>3.1.4.生成etcd证书和私钥</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-200</span> ~]# cd /opt/certs/<br>[root@hdss7<span class="hljs-number">-200</span> certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-<span class="hljs-type">json</span> -bare etcd-peer<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] generate received request<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] received CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] generating key: rsa<span class="hljs-number">-2048</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] encoded CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-keyword">INFO</span>] signed certificate <span class="hljs-keyword">with</span> <span class="hljs-type">serial</span> number <span class="hljs-number">319260464385476820097369736582871670367101389147</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">03</span>:<span class="hljs-number">17</span> [<span class="hljs-built_in">WARNING</span>] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable <span class="hljs-keyword">for</span><br>websites. <span class="hljs-keyword">For</span> more information see the Baseline Requirements <span class="hljs-keyword">for</span> the Issuance <span class="hljs-keyword">and</span> Management<br><span class="hljs-keyword">of</span> Publicly-<span class="hljs-keyword">Trusted</span> Certificates, v<span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.6</span>, <span class="hljs-keyword">from</span> the CA/Browser Forum (https://cabforum.org);<br>specifically, section <span class="hljs-number">10.2</span><span class="hljs-number">.3</span> (&quot;Information Requirements&quot;).<br></code></pre></td></tr></table></figure>

<h4 id="3-1-5-检查生成的证书和私钥"><a href="#3-1-5-检查生成的证书和私钥" class="headerlink" title="3.1.5.检查生成的证书和私钥"></a>3.1.5.检查生成的证书和私钥</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 36<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure>

<h4 id="3-1-6-创建etcd用户"><a href="#3-1-6-创建etcd用户" class="headerlink" title="3.1.6.创建etcd用户"></a>3.1.6.创建etcd用户</h4>
            <input type="checkbox" disabled checked="checked">hdss7-12.host.com 上
          


<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-12 opt]</span><span class="hljs-comment"># useradd -s /sbin/nologin -M etcd</span><br><span class="hljs-section">[root@hdss7-12 opt]</span><span class="hljs-comment"># id etcd</span><br><span class="hljs-attr">uid</span>=<span class="hljs-number">1000</span>(etcd) gid=<span class="hljs-number">1000</span>(etcd) groups=<span class="hljs-number">1000</span>(etcd)<br></code></pre></td></tr></table></figure>

<h4 id="3-1-7-下载软件，解压，做软链接"><a href="#3-1-7-下载软件，解压，做软链接" class="headerlink" title="3.1.7.下载软件，解压，做软链接"></a>3.1.7.下载软件，解压，做软链接</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">https://github.com/etcd-io/etcd/tags   //这里用的3.1.20版本，目前不建议超过3.3的版本<br>[root@hdss7-12 src]<span class="hljs-comment"># tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/</span><br>[root@hdss7-12 src]<span class="hljs-comment"># cd ..</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span><br>[root@hdss7-12 opt]<span class="hljs-comment"># ll</span><br>total 0<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root   root  <span class="hljs-number"> 18 </span>Nov<span class="hljs-number"> 16 </span>14:22 etcd -&gt; /opt/etcd-v3.1.20/<br>drwxr-xr-x<span class="hljs-number"> 3 </span>478493<span class="hljs-number"> 89939 </span>123 Oct<span class="hljs-number"> 11 </span><span class="hljs-number"> 2018 </span>etcd-v3.1.20<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root   root  <span class="hljs-number"> 45 </span>Nov<span class="hljs-number"> 16 </span>14:20 src<br></code></pre></td></tr></table></figure>

<h4 id="3-1-8-创建目录，拷贝证书，私钥"><a href="#3-1-8-创建目录，拷贝证书，私钥" class="headerlink" title="3.1.8.创建目录，拷贝证书，私钥"></a>3.1.8.创建目录，拷贝证书，私钥</h4><h5 id="创建证书目录、数据目录、日志目录"><a href="#创建证书目录、数据目录、日志目录" class="headerlink" title="创建证书目录、数据目录、日志目录"></a>创建证书目录、数据目录、日志目录</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">12</span> opt]# mkdir -p <span class="hljs-regexp">/opt/</span>etcd<span class="hljs-regexp">/certs /</span>data<span class="hljs-regexp">/etcd /</span>data<span class="hljs-regexp">/logs/</span>etcd-server<br></code></pre></td></tr></table></figure>

<h5 id="拷贝3-1-4生成的证书文件"><a href="#拷贝3-1-4生成的证书文件" class="headerlink" title="拷贝3.1.4生成的证书文件"></a>拷贝3.1.4生成的证书文件</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/etcd-peer.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># scp hdss7-200:/opt/certs/etcd-peer-kry.pem .</span><br>[root@hdss7-12 certs]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 16 </span>14:31 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:34 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:33 etcd-peer.pem<br></code></pre></td></tr></table></figure>

<h4 id="3-1-9-创建etcd服务启动脚本"><a href="#3-1-9-创建etcd服务启动脚本" class="headerlink" title="3.1.9.创建etcd服务启动脚本"></a>3.1.9.创建etcd服务启动脚本</h4><p><strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># vi /opt/etcd/etcd-server-startup.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br>./etcd --name etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span> \<br>       --data-dir <span class="hljs-regexp">/data/</span>etcd/etcd-server \<br>       --listen-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --listen-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --quota-backend-bytes <span class="hljs-number">8000000000</span> \<br>       --initial-advertise-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --advertise-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --initial-cluster  etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> \<br>       --ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --client-cert-auth  \<br>       --trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --peer-key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --peer-client-cert-auth \<br>       --peer-trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --log-output stdout<br>       <br>       <span class="hljs-comment">#############配置说明#########</span><br>       --listen-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \            <span class="hljs-regexp">//</span>内部通信起的<span class="hljs-number">2380</span>端口                                                   <br>       --listen-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \ <span class="hljs-regexp">//</span>对外通信起的<span class="hljs-number">2379</span>端口<br>       --quota-backend-bytes <span class="hljs-number">8000000000</span> \                        <span class="hljs-regexp">//</span> 后端配额       <br>       --initial-advertise-peer-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> \<br>       --advertise-client-urls https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span>,http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span> \<br>       --initial-cluster  etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span>,etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span>=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> \<br>       --ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --client-cert-auth  \<br>       --trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --peer-cert-file .<span class="hljs-regexp">/certs/</span>etcd-peer.pem \<br>       --peer-key-file .<span class="hljs-regexp">/certs/</span>etcd-peer-key.pem \<br>       --peer-client-cert-auth \<br>       --peer-trusted-ca-file .<span class="hljs-regexp">/certs/</span>ca.pem \<br>       --log-output stdout<br> <br>[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># chmod +x /opt/etcd/etcd-server.startup.sh </span><br>[root@hdss7-<span class="hljs-number">12</span> ~]<span class="hljs-comment"># ll /opt/etcd/etcd-server.startup.sh </span><br>-rwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">981</span> Nov <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">39</span> <span class="hljs-regexp">/opt/</span>etcd/etcd-server.startup.sh   <br></code></pre></td></tr></table></figure>

<h4 id="3-1-10-调整目录权限"><a href="#3-1-10-调整目录权限" class="headerlink" title="3.1.10.调整目录权限"></a>3.1.10.调整目录权限</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">12</span> ~]# chown -R etcd.etcd <span class="hljs-regexp">/opt/</span>etcd-v3.<span class="hljs-number">1.20</span><span class="hljs-regexp">/   /</span>data<span class="hljs-regexp">/etcd/</span>  <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/etcd-server/</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-11-安装supervison软件"><a href="#3-1-11-安装supervison软件" class="headerlink" title="3.1.11.安装supervison软件"></a>3.1.11.安装supervison软件</h4><p><strong>supervison是一个管理后台进程的软件，etcd进程掉了会自动拉起来</strong></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># yum install supervisor -y</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># systemctl start supervisord</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-meta"># systemctl enable supervisord</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-12-创建etcd-server的启动配置"><a href="#3-1-12-创建etcd-server的启动配置" class="headerlink" title="3.1.12.创建etcd-server的启动配置"></a>3.1.12.创建etcd-server的启动配置</h4><p><strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-12 ~]</span><span class="hljs-comment"># vi /etc/supervisord.d/etcd-server.ini</span><br><br><span class="hljs-section">[program:etcd-server-7-12]</span><br><span class="hljs-attr">command</span>=/opt/etcd/etcd-server-startup.sh                        <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                      <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/etcd                                             <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                  <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                    <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                  <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                   <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                 <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                 <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=etcd                                                       <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                            <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/etcd-server/etcd.stdout.log           <span class="hljs-comment">; stdout log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                    <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                        <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                     <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                     <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-13-启动etcd服务并检查"><a href="#3-1-13-启动etcd服务并检查" class="headerlink" title="3.1.13.启动etcd服务并检查"></a>3.1.13.启动etcd服务并检查</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl update</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>: added process group<br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>                 STARTING  <br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-12</span>                 RUNNING   pid <span class="hljs-number">20350</span>, uptime 0<span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">14</span><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-12</span> ~]<span class="hljs-comment"># netstat -luntp|grep etcd</span><br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><span class="hljs-symbol">:</span><span class="hljs-number">2379</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd        <br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">2379</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd        <br>tcp        0      0 <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><span class="hljs-symbol">:</span><span class="hljs-number">2380</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">22657</span>/./etcd RTING  <br></code></pre></td></tr></table></figure>

<h4 id="3-1-14-安装部署启动检查所有集群"><a href="#3-1-14-安装部署启动检查所有集群" class="headerlink" title="3.1.14.安装部署启动检查所有集群"></a>3.1.14.安装部署启动检查所有集群</h4><p><strong>和上述无区别,最主要是修改两个配置文件:</strong><br>1、/opt/etcd/etcd-server-startup.sh的ip地址，<br>2、/etc/supervisord.d/etcd-server.ini</p>
<p><strong>//修改supervisord启动ini文件的program标签，是为了更好区分主机，生产规范，强迫症患者的福音，不修改不会造成启动失败</strong></p>
<h4 id="3-1-15-检查集群状态"><a href="#3-1-15-检查集群状态" class="headerlink" title="3.1.15.检查集群状态"></a>3.1.15.检查集群状态</h4><p><strong>任意节点输入</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> etcd]<span class="hljs-comment"># ./etcdctl  cluster-health</span><br>member <span class="hljs-number">988139385</span>f78284 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>member <span class="hljs-number">5</span>a0ef2a004fc4349 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>member f4a0cb0a765574a8 is healthy: got healthy result from http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span><br>cluster is healthy<br><br><br>[root@hdss7-<span class="hljs-number">21</span> etcd]<span class="hljs-comment"># ./etcdctl member list</span><br><span class="hljs-number">988139385</span>f78284: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">22</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.22</span>:<span class="hljs-number">2379</span> isLeader=false<br><span class="hljs-number">5</span>a0ef2a004fc4349: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">21</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.21</span>:<span class="hljs-number">2379</span> isLeader=false<br>f4a0cb0a765574a8: name=etcd-server-<span class="hljs-number">7</span>-<span class="hljs-number">12</span> peerURLs=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2380</span> clientURLs=http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span>:<span class="hljs-number">2379</span> isLeader=true<br></code></pre></td></tr></table></figure>

<h3 id="3-2-部署kube-apiserver集群"><a href="#3-2-部署kube-apiserver集群" class="headerlink" title="3.2.部署kube-apiserver集群"></a>3.2.部署kube-apiserver集群</h3><h4 id="3-2-1-集群规划"><a href="#3-2-1-集群规划" class="headerlink" title="3.2.1.集群规划"></a>3.2.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
<th>vip</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-21.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.21</td>
<td>无</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.22</td>
<td>无</td>
</tr>
<tr>
<td>hdss7-11.host.com</td>
<td>L4</td>
<td>10.4.7.11</td>
<td>10.4.7.10</td>
</tr>
<tr>
<td>hdss7-12.host.com</td>
<td>L4</td>
<td>10.4.7.12</td>
<td>10.4.7.10</td>
</tr>
</tbody></table>
<p>注意：hdss7-11和hdss7-12使用nginx做4层负载均衡器，keepalived跑一个VIP：10.4.7.10，代理两个kube-apiserver，实现高可用。<br><strong>这里以hdss21为例，另外一台运算节点部署方法类似</strong></p>
<h4 id="3-2-2-下载软件，解压，做软链接"><a href="#3-2-2-下载软件，解压，做软链接" class="headerlink" title="3.2.2.下载软件，解压，做软链接"></a>3.2.2.下载软件，解压，做软链接</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs tap">官方github地址：github.com/kubernetes/releasses/tag/v1.15.4    //这里是v1.15.2版本<br>下载方法：点击版本号 → CHANGELOG-1.15.md → DOWNLOAD → server binaries → 找到kubenetes-server-linux-amd64.tar.gz<br><br>[root@hdss7-21 src]<span class="hljs-comment"># tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz  -C /opt</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># mv kubernetes/ kubernetes-v1.15.2</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes</span><br>[root@hdss7-21 opt]<span class="hljs-comment"># ll</span><br>total 0<br>drwx--x--x<span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 28 </span>Nov<span class="hljs-number"> 16 </span>03:06 containerd<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 18 </span>Nov<span class="hljs-number"> 16 </span>15:44 etcd -&gt; /opt/etcd-v3.1.20/<br>drwxr-xr-x<span class="hljs-number"> 4 </span>etcd etcd<span class="hljs-number"> 166 </span>Nov<span class="hljs-number"> 17 </span>00:39 etcd-v3.1.20<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 24 </span>Nov<span class="hljs-number"> 17 </span>01:35 kubernetes -&gt; /opt/kubernetes-v1.15.2/<br>drwxr-xr-x<span class="hljs-number"> 4 </span>root root <span class="hljs-number"> 79 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubernetes-v1.15.2<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root<span class="hljs-number"> 306 </span>Nov<span class="hljs-number"> 16 </span>15:41 src<br><br><br>//删掉无用的源码包，bin下无用的tag，tar文件，不用adm方式部署，所以可以删除<br>[root@hdss7-21 opt]<span class="hljs-comment"># cd kubernetes</span><br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># ls</span><br>addons  kubernetes-src.tar.gz  LICENSES  server<br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># rm -rf kubernetes-src.tar.gz </span><br>[root@hdss7-21 kubernetes]<span class="hljs-comment"># ll</span><br>total 1180<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root      <span class="hljs-number"> 6 </span>Aug <span class="hljs-number"> 5 </span>18:01 addons<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1205293 </span>Aug <span class="hljs-number"> 5 </span>18:01 LICENSES<br>drwxr-xr-x<span class="hljs-number"> 3 </span>root root     <span class="hljs-number"> 17 </span>Aug <span class="hljs-number"> 5 </span>17:57 server<br>[root@hdss7-21 bin]<span class="hljs-comment"># rm -f *.tar</span><br>[root@hdss7-21 bin]<span class="hljs-comment"># rm -f *_tag</span><br>[root@hdss7-21 bin]<span class="hljs-comment"># ll</span><br>total 884636<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 43534816 </span>Aug <span class="hljs-number"> 5 </span>18:01 apiextensions-apiserver<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 100548640 </span>Aug <span class="hljs-number"> 5 </span>18:01 cloud-controller-manager<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 200648416 </span>Aug <span class="hljs-number"> 5 </span>18:01 hyperkube<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 40182208 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubeadm<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 164501920 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-apiserver<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 116397088 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-controller-manager<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 42985504 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubectl<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 119616640 </span>Aug <span class="hljs-number"> 5 </span>18:01 kubelet<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 36987488 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-proxy<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 38786144 </span>Aug <span class="hljs-number"> 5 </span>18:01 kube-scheduler<br>-rwxr-xr-x<span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 1648224 </span>Aug <span class="hljs-number"> 5 </span>18:01 mounter<br></code></pre></td></tr></table></figure>

<h4 id="3-2-3-签发client证书"><a href="#3-2-3-签发client证书" class="headerlink" title="3.2.3.签发client证书"></a>3.2.3.签发client证书</h4>
            <input type="checkbox" disabled checked="checked">运维主机hdss7-200上
          

<h5 id="3-2-3-1-创建生成证书签名请求（csr）的json配置文件"><a href="#3-2-3-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="3.2.3.1.创建生成证书签名请求（csr）的json配置文件"></a>3.2.3.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]#  vi /opt/certs/client-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-node&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-2-3-2-生成clent证书和私钥"><a href="#3-2-3-2-生成clent证书和私钥" class="headerlink" title="3.2.3.2.生成clent证书和私钥"></a>3.2.3.2.生成clent证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=client client-csr.json |cfssl-json -bare client<br></code></pre></td></tr></table></figure>

<h5 id="3-2-3-3-检查生成的证书和私钥"><a href="#3-2-3-3-检查生成的证书和私钥" class="headerlink" title="3.2.3.3.检查生成的证书和私钥"></a>3.2.3.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 52<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 280 </span>Nov<span class="hljs-number"> 16 </span>17:45 client-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:47 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure>

<h4 id="3-2-4-签发kube-apiserver证书"><a href="#3-2-4-签发kube-apiserver证书" class="headerlink" title="3.2.4.签发kube-apiserver证书"></a>3.2.4.签发kube-apiserver证书</h4>
            <input type="checkbox" disabled checked="checked">运维主机hdss7-200上
          


<h5 id="3-2-4-1-创建生成证书签名请求（csr）的-json配置文件"><a href="#3-2-4-1-创建生成证书签名请求（csr）的-json配置文件" class="headerlink" title="3.2.4.1.创建生成证书签名请求（csr）的 json配置文件"></a>3.2.4.1.创建生成证书签名请求（csr）的 json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]# vi /opt/certs/apiserver-csr.json <br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-apiserver&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>	<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>	<span class="hljs-string">&quot;192.168.0.1&quot;</span>,<br>	<span class="hljs-string">&quot;kubernetes.default&quot;</span>,<br>	<span class="hljs-string">&quot;kubernetes.default.svc&quot;</span>,<br>	<span class="hljs-string">&quot;kubernetes.default.svc.cluster&quot;</span>,<br>	<span class="hljs-string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,<br>	<span class="hljs-string">&quot;10.4.7.10&quot;</span>,<br>	<span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br>	<span class="hljs-string">&quot;10.4.7.22&quot;</span>,<br>	<span class="hljs-string">&quot;10.4.7.23&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-2-生成kube-apiserver证书和私钥"><a href="#3-2-4-2-生成kube-apiserver证书和私钥" class="headerlink" title="3.2.4.2.生成kube-apiserver证书和私钥"></a>3.2.4.2.生成kube-apiserver证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=server apiserver-csr.json |cfssl-json -bare apiserver<br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-3-检查生成的证书和私钥"><a href="#3-2-4-3-检查生成的证书和私钥" class="headerlink" title="3.2.4.3.检查生成的证书和私钥"></a>3.2.4.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 68<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1249 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 567 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 16 </span>17:55 apiserver.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 836 </span>Nov<span class="hljs-number"> 16 </span>13:52 ca-config.json<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 328 </span>Nov<span class="hljs-number"> 11 </span>00:29 ca-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 11 </span>00:30 ca.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 993 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 280 </span>Nov<span class="hljs-number"> 16 </span>17:45 client-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>17:47 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 16 </span>17:47 client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1062 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 363 </span>Nov<span class="hljs-number"> 16 </span>13:59 etcd-peer-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1428 </span>Nov<span class="hljs-number"> 16 </span>14:03 etcd-peer.pem<br></code></pre></td></tr></table></figure>

<h4 id="3-2-5-拷贝证书至各运算节点，并创建配置"><a href="#3-2-5-拷贝证书至各运算节点，并创建配置" class="headerlink" title="3.2.5.拷贝证书至各运算节点，并创建配置"></a>3.2.5.拷贝证书至各运算节点，并创建配置</h4><h5 id="3-2-5-1-拷贝3套证书到…-bin-cert目录"><a href="#3-2-5-1-拷贝3套证书到…-bin-cert目录" class="headerlink" title="3.2.5.1.拷贝3套证书到…/bin/cert目录"></a>3.2.5.1.拷贝3套证书到…/bin/cert目录</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/ca-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/client.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/client-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/apiserver.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/apiserver-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 24<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:11 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 17 </span>02:08 apiserver.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:07 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 17 </span>02:06 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:08 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 17 </span>02:07 client.pem<br></code></pre></td></tr></table></figure>

<h5 id="3-2-5-2-创建配置"><a href="#3-2-5-2-创建配置" class="headerlink" title="3.2.5.2.创建配置"></a>3.2.5.2.创建配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">bin</span>]<span class="hljs-comment"># mkdir conf</span><br>[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">conf</span>]<span class="hljs-comment"># vi audit.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">audit.k8s.io/v1beta1</span> <span class="hljs-comment"># This is required.</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span><br><span class="hljs-comment"># Don&#x27;t generate audit events for all requests in RequestReceived stage.</span><br><span class="hljs-attr">omitStages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Log pod changes at RequestResponse level</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">RequestResponse</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-comment"># Resource &quot;pods&quot; doesn&#x27;t match requests to any subresource of pods,</span><br>      <span class="hljs-comment"># which is consistent with the RBAC policy.</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]<br>  <span class="hljs-comment"># Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods/log&quot;</span>, <span class="hljs-string">&quot;pods/status&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log requests to a configmap called &quot;controller-leader&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>      <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;controller-leader&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">users:</span> [<span class="hljs-string">&quot;system:kube-proxy&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;watch&quot;</span>]<br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>, <span class="hljs-string">&quot;services&quot;</span>]<br><br>  <span class="hljs-comment"># Don&#x27;t log authenticated requests to certain non-resource URL paths.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">userGroups:</span> [<span class="hljs-string">&quot;system:authenticated&quot;</span>]<br>    <span class="hljs-attr">nonResourceURLs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/api*&quot;</span> <span class="hljs-comment"># Wildcard matching.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/version&quot;</span><br><br>  <span class="hljs-comment"># Log the request body of configmap changes in kube-system.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Request</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>    <span class="hljs-comment"># This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br>    <span class="hljs-comment"># The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br>    <span class="hljs-attr">namespaces:</span> [<span class="hljs-string">&quot;kube-system&quot;</span>]<br><br>  <span class="hljs-comment"># Log configmap and secret changes in all other namespaces at the Metadata level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>      <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;secrets&quot;</span>, <span class="hljs-string">&quot;configmaps&quot;</span>]<br><br>  <span class="hljs-comment"># Log all other resources in core and extensions at the Request level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Request</span><br>    <span class="hljs-attr">resources:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># core API group</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;extensions&quot;</span> <span class="hljs-comment"># Version of group should NOT be included.</span><br><br>  <span class="hljs-comment"># A catch-all rule to log all other requests at the Metadata level.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span><br>    <span class="hljs-comment"># Long-running requests like watches that fall under this rule will not</span><br>    <span class="hljs-comment"># generate an audit event in RequestReceived.</span><br>    <span class="hljs-attr">omitStages:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;RequestReceived&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-6-创建apiserver启动脚本"><a href="#3-2-6-创建apiserver启动脚本" class="headerlink" title="3.2.6.创建apiserver启动脚本"></a>3.2.6.创建apiserver启动脚本</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@hdss7-21 bin]<span class="hljs-comment"># vi /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-string">./kube-apiserver</span> \<br>  <span class="hljs-params">--apiserver-count</span> 2 \<br>  <span class="hljs-params">--audit-log-path</span> <span class="hljs-string">/data/logs/kubernetes/kube-apiserver/audit-log</span> \<br>  <span class="hljs-params">--audit-policy-file</span> <span class="hljs-string">./conf/audit.yaml</span> \<br>  <span class="hljs-params">--authorization-mode</span> RBAC \<br>  <span class="hljs-params">--client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--requestheader-client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--enable-admission-plugins</span> NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \<br>  <span class="hljs-params">--etcd-cafile</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--etcd-certfile</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--etcd-keyfile</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--etcd-servers</span> https:<span class="hljs-string">//10.4.7.12</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.21</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.22</span><span class="hljs-function">:2379</span> \<br>  <span class="hljs-params">--service-account-key-file</span> <span class="hljs-string">./cert/ca-key.pem</span> \<br>  <span class="hljs-params">--service-cluster-ip-range</span> 192.168.0.0/16 \<br>  <span class="hljs-params">--service-node-port-range</span> 3000-29999 \<br>  <span class="hljs-params">--target-ram-mb=1024</span> \<br>  <span class="hljs-params">--kubelet-client-certificate</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--kubelet-client-key</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--log-dir</span>  <span class="hljs-string">/data/logs/kubernetes/kube-apiserver</span> \<br>  <span class="hljs-params">--tls-cert-file</span> <span class="hljs-string">./cert/apiserver.pem</span> \<br>  <span class="hljs-params">--tls-private-key-file</span> <span class="hljs-string">./cert/apiserver-key.pem</span> \<br>  <span class="hljs-params">--v</span> 2<br> <br> <span class="hljs-comment">#################参数说明############</span><br>    <span class="hljs-params">--apiserver-count</span> 2 \                     <span class="hljs-string">//</span> apiserver数量，有资源可以给3个                 <br>  <span class="hljs-params">--audit-log-path</span> <span class="hljs-string">/data/logs/kubernetes/kube-apiserver/audit-log</span> \   <span class="hljs-string">//</span>日志目录<br>  <span class="hljs-params">--audit-policy-file</span> <span class="hljs-string">./conf/audit.yaml</span> \                   <span class="hljs-string">//</span>日志审计规则<br>  <span class="hljs-params">--authorization-mode</span> RBAC \                           <span class="hljs-string">//RBAC</span> --基于角色访问的控制<br>  <span class="hljs-params">--client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--requestheader-client-ca-file</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--enable-admission-plugins</span> NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \<br>  <span class="hljs-params">--etcd-cafile</span> <span class="hljs-string">./cert/ca.pem</span> \<br>  <span class="hljs-params">--etcd-certfile</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--etcd-keyfile</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--etcd-servers</span> https:<span class="hljs-string">//10.4.7.12</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.21</span><span class="hljs-function">:2379</span>,https:<span class="hljs-string">//10.4.7.22</span><span class="hljs-function">:2379</span> \<br>  <span class="hljs-params">--service-account-key-file</span> <span class="hljs-string">./cert/ca-key.pem</span> \<br>  <span class="hljs-params">--service-cluster-ip-range</span> 192.168.0.0/16 \<br>  <span class="hljs-params">--service-node-port-range</span> 3000-29999 \<br>  <span class="hljs-params">--target-ram-mb=1024</span> \                                              <br>  <span class="hljs-params">--kubelet-client-certificate</span> <span class="hljs-string">./cert/client.pem</span> \<br>  <span class="hljs-params">--kubelet-client-key</span> <span class="hljs-string">./cert/client-key.pem</span> \<br>  <span class="hljs-params">--log-dir</span>  <span class="hljs-string">/data/logs/kubernetes/kube-apiserver</span> \<br>  <span class="hljs-params">--tls-cert-file</span> <span class="hljs-string">./cert/apiserver.pem</span> \<br>  <span class="hljs-params">--tls-private-key-file</span> <span class="hljs-string">./cert/apiserver-key.pem</span> \<br>  <span class="hljs-params">--v</span> 2                                 <span class="hljs-string">//log</span> Level  是v 2 <br>  更多说明请看例子：<br>  [root@hdss7-21 bin]<span class="hljs-comment"># ./kube-apiserver  --help|grep -A 5 target-ram-mb</span><br>      <span class="hljs-params">--target-ram-mb</span> int                            Memory limit for apiserver in MB <span class="hljs-params">(used to configure sizes of caches, etc.)</span><br><br>Etcd flags:<br><br>      <span class="hljs-params">--default-watch-cache-size</span> int             Default watch cache size. If zero, watch cache will be disabled for resources that do not have a default watch size <span class="hljs-keyword">set</span>. <span class="hljs-params">(default 100)</span><br>      <span class="hljs-params">--delete-collection-workers</span> int            Number of workers spawned for DeleteCollection call. These are used to speed up namespace cleanup. <span class="hljs-params">(default 1)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-7-调整权限和目录"><a href="#3-2-7-调整权限和目录" class="headerlink" title="3.2.7.调整权限和目录"></a>3.2.7.调整权限和目录</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-meta"># chmod +x kube-apiserver.sh</span><br>[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-meta"># mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-8-创建supervisor配置"><a href="#3-2-8-创建supervisor配置" class="headerlink" title="3.2.8.创建supervisor配置"></a>3.2.8.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment">#  vi /etc/supervisord.d/kube-apiserver.ini</span><br><span class="hljs-section">[program:kube-apiserver-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-apiserver.sh            <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                      <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                            <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                  <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                    <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                  <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                   <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                 <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                 <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                       <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                            <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                    <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                        <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                     <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                     <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-9-启动服务并检查"><a href="#3-2-9-启动服务并检查" class="headerlink" title="3.2.9.启动服务并检查"></a>3.2.9.启动服务并检查</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># supervisorctl update</span><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># supervisorctl status</span><br>etcd-server<span class="hljs-number">-7</span><span class="hljs-number">-21</span>                 RUNNING   pid <span class="hljs-number">1716</span>, uptime <span class="hljs-number">2</span><span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">19</span><br>kube-apiserver<span class="hljs-number">-7</span><span class="hljs-number">-21</span>              RUNNING   pid <span class="hljs-number">2032</span>, uptime 0<span class="hljs-symbol">:</span>01<span class="hljs-symbol">:</span><span class="hljs-number">33</span><br><br>[root<span class="hljs-variable">@hdss7</span><span class="hljs-number">-21</span> bin]<span class="hljs-comment"># netstat -nltup|grep kube-api</span><br>tcp        0      0 <span class="hljs-number">127.0</span>.0.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-number">8080</span>          0.0.0.0<span class="hljs-symbol">:*</span>               LISTEN      <span class="hljs-number">2033</span>/./kube-apiserv <br>tcp6       0      0 ::<span class="hljs-symbol">:</span><span class="hljs-number">6443</span>                 ::<span class="hljs-symbol">:*</span>                    LISTEN      <span class="hljs-number">2033</span>/./kube-apiserv <br></code></pre></td></tr></table></figure>

<h4 id="3-2-10-安装部署启动检查所有集群"><a href="#3-2-10-安装部署启动检查所有集群" class="headerlink" title="3.2.10.安装部署启动检查所有集群"></a>3.2.10.安装部署启动检查所有集群</h4><p><strong>hdss7-22 跟上述基本相同</strong><br>/etc/supervisord.d/kube-apiserver.ini<br>需要更改成[program:kube-apiserver-7-22]</p>
<h4 id="3-2-11-配四层反向代理"><a href="#3-2-11-配四层反向代理" class="headerlink" title="3.2.11.配四层反向代理"></a>3.2.11.配四层反向代理</h4><p><strong>VIP 10.4.7.10：7443代理 两台apiserver的6443端口，此处会用到keepalived</strong></p>
<h5 id="3-2-11-1安装nginx和keepalived"><a href="#3-2-11-1安装nginx和keepalived" class="headerlink" title="3.2.11.1安装nginx和keepalived"></a>3.2.11.1安装nginx和keepalived</h5><h6 id="hdss7-11和hdss7-12都安装nginx和keepalived"><a href="#hdss7-11和hdss7-12都安装nginx和keepalived" class="headerlink" title="hdss7-11和hdss7-12都安装nginx和keepalived"></a>hdss7-11和hdss7-12都安装nginx和keepalived</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-12</span> etcd]<span class="hljs-meta"># yum install nginx -y</span><br></code></pre></td></tr></table></figure>

<h6 id="hdss7-11和hdss7-12配置nginx-conf"><a href="#hdss7-11和hdss7-12配置nginx-conf" class="headerlink" title="hdss7-11和hdss7-12配置nginx.conf"></a>hdss7-11和hdss7-12配置nginx.conf</h6><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dts">[root@hdss7<span class="hljs-number">-11</span> conf.d]<span class="hljs-meta"># vi /etc/nginx/nginx.conf        <span class="hljs-comment">//最后追加</span></span><br><span class="hljs-class">stream </span>&#123;<br>    upstream kube-<span class="hljs-class">apiserver </span>&#123;<br>        server <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.21</span>:<span class="hljs-number">6443</span>     max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s;<br>        server <span class="hljs-number">10.4</span><span class="hljs-number">.7</span><span class="hljs-number">.22</span>:<span class="hljs-number">6443</span>     max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s;<br>    &#125;<br>    <span class="hljs-class">server </span>&#123;<br>        listen <span class="hljs-number">7443</span>;<br>        proxy_connect_timeout <span class="hljs-number">2</span>s;<br>        proxy_timeout <span class="hljs-number">900</span>s;<br>        proxy_pass kube-apiserver;<br>    &#125;<br>&#125;<br>[root@hdss7<span class="hljs-number">-12</span> etcd]<span class="hljs-meta"># nginx -t</span><br><span class="hljs-symbol">nginx:</span> the configuration file <span class="hljs-meta-keyword">/etc/</span>nginx/nginx.conf syntax is ok<br><span class="hljs-symbol">nginx:</span> configuration file <span class="hljs-meta-keyword">/etc/</span>nginx/nginx.conf test is successful<br></code></pre></td></tr></table></figure>

<h6 id="hdss7-11和hdss7-12配置keepalived"><a href="#hdss7-11和hdss7-12配置keepalived" class="headerlink" title="hdss7-11和hdss7-12配置keepalived"></a>hdss7-11和hdss7-12配置keepalived</h6><p>检查脚本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># vi /etc/keepalived/check_port.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#keepalived 监控端口脚本</span><br><span class="hljs-comment">#使用方法：</span><br><span class="hljs-comment">#在keepalived的配置文件中</span><br><span class="hljs-comment">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="hljs-comment">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span><br><span class="hljs-comment">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="hljs-comment">#&#125;</span><br>CHK_PORT=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;$CHK_PORT&quot;</span> ];then<br>        PORT_PROCESS=`ss -lnt|grep <span class="hljs-variable">$CHK_PORT</span>|wc -l`<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$PORT_PROCESS</span> -eq <span class="hljs-number">0</span> ];then<br>                echo <span class="hljs-string">&quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br>                <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>        fi<br><span class="hljs-keyword">else</span><br>        echo <span class="hljs-string">&quot;Check Port Cant Be Empty!&quot;</span><br>fi<br><br>[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># chmod +x /etc/keepalived/check_port.sh </span><br></code></pre></td></tr></table></figure>

<p>配置文件</p>
<blockquote>
<p>interface eth0  eth0要和系统网卡名称匹配</p>
</blockquote>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs puppet">keepalived 主:<br>[root@hdss7-11 conf.d]<span class="hljs-comment"># vi /etc/keepalived/keepalived.conf </span><br><br>! Configuration File for keepalived<br><br><span class="hljs-keyword">global_defs</span> &#123;<br>   router_id <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><br><br>&#125;<br><br><span class="hljs-keyword">vrrp_script</span> <span class="hljs-keyword">chk_nginx</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_port.sh 7443&quot;</span><br>    interval <span class="hljs-number">2</span><br>    weight -<span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-keyword">vrrp_instance</span> <span class="hljs-keyword">VI_1</span> &#123;<br>    state MASTER<br>    interface eth<span class="hljs-number">0</span> ←----------------------------这个要和系统网卡名称匹配<br>    virtual_router_id <span class="hljs-number">251</span><br>    <span class="hljs-literal">priority</span> <span class="hljs-number">100</span><br>    advert_int <span class="hljs-number">1</span><br>    mcast_src_ip <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span><br>    nopreempt<br><br>    authentication &#123;<br>        <span class="hljs-literal">auth_type</span> PASS<br>        auth_pass <span class="hljs-number">11111111</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>         chk_nginx<br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span><br>    &#125;<br>&#125;<br><br><br><br>keepalived从:<br>[root@hdss7-12 conf.d]<span class="hljs-comment"># vi /etc/keepalived/keepalived.conf </span><br><br>! Configuration File for keepalived<br><span class="hljs-keyword">global_defs</span> &#123;<br>	router_id <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><br>&#125;<br><span class="hljs-keyword">vrrp_script</span> <span class="hljs-keyword">chk_nginx</span> &#123;<br>	script <span class="hljs-string">&quot;/etc/keepalived/check_port.sh 7443&quot;</span><br>	interval <span class="hljs-number">2</span><br>	weight -<span class="hljs-number">20</span><br>&#125;<br><span class="hljs-keyword">vrrp_instance</span> <span class="hljs-keyword">VI_1</span> &#123;<br>	state BACKUP<br>	interface eth<span class="hljs-number">0</span><br>	virtual_router_id <span class="hljs-number">251</span><br>	mcast_src_ip <span class="hljs-number">10.4</span>.<span class="hljs-number">7.12</span><br>	<span class="hljs-literal">priority</span> <span class="hljs-number">90</span><br>	advert_int <span class="hljs-number">1</span><br>	authentication &#123;<br>		<span class="hljs-literal">auth_type</span> PASS<br>		auth_pass <span class="hljs-number">11111111</span><br>	&#125;<br>	<span class="hljs-keyword">track_script</span> &#123;<br>		chk_nginx<br>	&#125;<br>	<span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>		<span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-12-启动代理并检查"><a href="#3-2-12-启动代理并检查" class="headerlink" title="3.2.12.启动代理并检查"></a>3.2.12.启动代理并检查</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>hdss7-<span class="hljs-number">11</span>和hdss7-<span class="hljs-number">12</span>上启动nginx<br>~]<span class="hljs-comment"># systemctl start nginx</span><br>~]<span class="hljs-comment"># systemctl enable nginx</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/nginx.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>nginx.service.<br>~]<span class="hljs-comment"># netstat -nltup|grep nginx</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">80</span>              <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">21520</span>/nginx: master <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">7443</span>            <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">21520</span>/nginx: master <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">21520</span>/nginx: master <br><br><span class="hljs-regexp">//</span>hdss7-<span class="hljs-number">11</span>和hdss7-<span class="hljs-number">12</span>上启动keepalived<br>~]<span class="hljs-comment"># systemctl start keepalived.service</span><br>~]<span class="hljs-comment"># systemctl enable  keepalived</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/keepalived.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>keepalived.service.<br><br><span class="hljs-regexp">//</span>检查<br>[root@hdss7-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># ip addr</span><br><span class="hljs-number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">4</span>c:f4:<span class="hljs-number">9</span>e brd ff:ff:ff:ff:ff:ff<br>    inet <span class="hljs-number">10.4</span>.<span class="hljs-number">7.11</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.4</span>.<span class="hljs-number">7.255</span> scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet <span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>/<span class="hljs-number">32</span> scope global eth0<br>       valid_lft forever preferred_lft forever<br><br><span class="hljs-regexp">//</span>VIP漂移测试<br>nginx -s stop测试，略。。。<br></code></pre></td></tr></table></figure>

<p><strong>注意：keepalived hdss7-11配置 nopreempt，意为非抢占式</strong><br><strong>原因：如果抢占式，假如生产网络抖动原因，check_port脚本探测不到，VIP有可能会动触发报警，VIP漂移在生产上属于重大生产事故，是要写故障报告的，是无法忍受的</strong></p>
<h3 id="3-3-部署controller-manager"><a href="#3-3-部署controller-manager" class="headerlink" title="3.3.部署controller-manager"></a>3.3.部署controller-manager</h3><h4 id="3-3-1-集群规划"><a href="#3-3-1-集群规划" class="headerlink" title="3.3.1.集群规划"></a>3.3.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-21.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
</tbody></table>
<p>注意：这里部署文档以hdss7-21为例，另外一台类似</p>
<h4 id="3-3-2-创建启动脚本"><a href="#3-3-2-创建启动脚本" class="headerlink" title="3.3.2.创建启动脚本"></a>3.3.2.创建启动脚本</h4><ul>
<li><input disabled="" type="checkbox"> <strong>hdss7-21.host.com上</strong></li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-controller-manager.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kube-controller-manager \<br>  --cluster-cidr <span class="hljs-number">172.7</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span> \<br>  --leader-elect <span class="hljs-keyword">true</span> \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-controller-manager \<br>  --master http:<span class="hljs-comment">//127.0.0.1:8080 \</span><br>  --service-account-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca-key.pem \<br>  --service-cluster-ip-range <span class="hljs-number">192.168</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span> \<br>  --root-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --v <span class="hljs-number">2</span> <br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-调整文件权限，创建目录"><a href="#3-3-3-调整文件权限，创建目录" class="headerlink" title="3.3.3.调整文件权限，创建目录"></a>3.3.3.调整文件权限，创建目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-controller-manager.sh <br>[root@hdss7-<span class="hljs-number">21</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-controller-manager<br></code></pre></td></tr></table></figure>

<h4 id="3-3-4-创建supervisor配置"><a href="#3-3-4-创建supervisor配置" class="headerlink" title="3.3.4.创建supervisor配置"></a>3.3.4.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-conntroller-manager.ini</span><br><span class="hljs-section">[program:kube-controller-manager-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-controller-manager.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                                        <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                              <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                                    <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                                  <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                                      <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                                    <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                                     <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                                   <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                                   <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                                         <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                              <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                                      <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                                          <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                                       <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                                       <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-启动服务并检查"><a href="#3-3-5-启动服务并检查" class="headerlink" title="3.3.5.启动服务并检查"></a>3.3.5.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br><br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 1716, uptime 3:44:21<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 2032, uptime 1:44:35<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 2196, uptime 0:00:50<br></code></pre></td></tr></table></figure>

<h4 id="3-3-6-安装部署启动检查所有集群规划主机"><a href="#3-3-6-安装部署启动检查所有集群规划主机" class="headerlink" title="3.3.6.安装部署启动检查所有集群规划主机"></a>3.3.6.安装部署启动检查所有集群规划主机</h4><ul>
<li><input disabled="" type="checkbox"> <strong>hdss7-22.host.com 跟上述基本相同</strong><br>/etc/supervisord.d/ kube-conntroller-manager.ini<br>需要更改成[program:kube-conntroller-manager-7-22]</li>
</ul>
<h3 id="3-4-部署kube-scheduler"><a href="#3-4-部署kube-scheduler" class="headerlink" title="3.4.部署kube-scheduler"></a>3.4.部署kube-scheduler</h3><h4 id="3-4-1-集群规划"><a href="#3-4-1-集群规划" class="headerlink" title="3.4.1.集群规划"></a>3.4.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-21.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：这里部署文档以hdss7-21为例，另一运算节点类似</strong></p>
<h4 id="3-4-2-创建启动脚本"><a href="#3-4-2-创建启动脚本" class="headerlink" title="3.4.2.创建启动脚本"></a>3.4.2.创建启动脚本</h4><p><strong>hdss7-21上</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-scheduler.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kube-scheduler \<br>  --leader-elect  \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-scheduler \<br>  --master http:<span class="hljs-comment">//127.0.0.1:8080 \</span><br>  --v <span class="hljs-number">2</span><br>  <br>  <br>  <br>  <span class="hljs-comment">//如果主控节点组件在不同的地方，是需要证书验证的，实验环境是在一个宿主机，所以这里无需证书</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-调整文件权限，创建目录"><a href="#3-4-3-调整文件权限，创建目录" class="headerlink" title="3.4.3.调整文件权限，创建目录"></a>3.4.3.调整文件权限，创建目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x  <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-scheduler.sh<br>[root@hdss7-<span class="hljs-number">21</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-scheduler<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-创建supervisor配置"><a href="#3-4-4-创建supervisor配置" class="headerlink" title="3.4.4.创建supervisor配置"></a>3.4.4.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-scheduler.ini</span><br><span class="hljs-section">[program:kube-scheduler-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-scheduler.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                               <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                     <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                           <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                         <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                             <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                           <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                            <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                          <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                          <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                                <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                     <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                             <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                                 <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                              <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                              <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-启动服务并检查"><a href="#3-4-5-启动服务并检查" class="headerlink" title="3.4.5.启动服务并检查"></a>3.4.5.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 1716, uptime 4:11:22<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2032, uptime 2:11:36<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2196, uptime 0:27:51<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span> RUNNING pid 2284, uptime 0:00:33<br></code></pre></td></tr></table></figure>

<h4 id="3-4-6-安装部署启动检查所有集群规划主机"><a href="#3-4-6-安装部署启动检查所有集群规划主机" class="headerlink" title="3.4.6.安装部署启动检查所有集群规划主机"></a>3.4.6.安装部署启动检查所有集群规划主机</h4>
            <input type="checkbox" disabled checked="checked">hdss7-22.host.com跟上述基本相同
          
<p>  /etc/supervisord.d/ kube-scheduler.ini<br>  需要更改成[program:kube-scheduler-7-22]</p>
<h3 id="3-5-检查主控节点"><a href="#3-5-检查主控节点" class="headerlink" title="3.5.检查主控节点"></a>3.5.检查主控节点</h3><h4 id="3-5-1-建立kubectl软链接"><a href="#3-5-1-建立kubectl软链接" class="headerlink" title="3.5.1.建立kubectl软链接"></a>3.5.1.建立kubectl软链接</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> bin]#  ln -s <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/kubectl /u</span>sr<span class="hljs-regexp">/bin/</span>kubectl<br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-检查主控节点"><a href="#3-5-2-检查主控节点" class="headerlink" title="3.5.2.检查主控节点"></a>3.5.2.检查主控节点</h4><h5 id="检查集群健康状态-cs（cluster-status）"><a href="#检查集群健康状态-cs（cluster-status）" class="headerlink" title="检查集群健康状态 cs（cluster status）"></a>检查集群健康状态 cs（cluster status）</h5><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs puppet">[root@hdss7-21 bin]<span class="hljs-comment"># kubectl get cs</span><br>NAME                 STATUS    MESSAGE              ERROR<br>controller-manager   Healthy   ok                   <br>scheduler            Healthy   ok                   <br>etcd-2               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br><span class="hljs-keyword">etcd</span>-0               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br><span class="hljs-keyword">etcd</span>-1               <span class="hljs-keyword">Healthy</span>   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125; <br></code></pre></td></tr></table></figure>

<h2 id="4-部署node节点服务"><a href="#4-部署node节点服务" class="headerlink" title="4.部署node节点服务"></a>4.部署node节点服务</h2><h3 id="4-1-部署kubelet"><a href="#4-1-部署kubelet" class="headerlink" title="4.1.部署kubelet"></a>4.1.部署kubelet</h3><h4 id="4-1-1-集群规划"><a href="#4-1-1-集群规划" class="headerlink" title="4.1.1.集群规划"></a>4.1.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-21.host.com</td>
<td>kubelet</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>kubelet</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：这里部署文档以 hdss7-21主机为例，另外一台运算节点安装部署方法类似</strong></p>
<h4 id="4-1-2-签发kubelet证书"><a href="#4-1-2-签发kubelet证书" class="headerlink" title="4.1.2.签发kubelet证书"></a>4.1.2.签发kubelet证书</h4><ul>
<li><input disabled="" type="checkbox"> <strong>运维主机hdss7-200上</strong></li>
</ul>
<h5 id="4-1-2-1-创建生成证书签名请求（csr）的json配置文件"><a href="#4-1-2-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="4.1.2.1.创建生成证书签名请求（csr）的json配置文件"></a>4.1.2.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[root@hdss7<span class="hljs-number">-200</span> certs]# vi kubelet-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;k8s-kubelet&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>    <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.10&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.21&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.22&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.23&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.24&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.25&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.26&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.27&quot;</span>,<br>    <span class="hljs-string">&quot;10.4.7.28&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4-1-2-2-生成kubelet证书和私钥"><a href="#4-1-2-2-生成kubelet证书和私钥" class="headerlink" title="4.1.2.2.生成kubelet证书和私钥"></a>4.1.2.2.生成kubelet证书和私钥</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-200 certs]# cfssl gencert <span class="hljs-attribute">-ca</span>=ca.pem <span class="hljs-attribute">-ca-key</span>=ca-key.pem <span class="hljs-attribute">-config</span>=ca-config.json <span class="hljs-attribute">-profile</span>=server kubelet-csr.json | cfssl-json -bare kubelet<br></code></pre></td></tr></table></figure>

<h5 id="4-1-2-3-检查生成的证书和私钥"><a href="#4-1-2-3-检查生成的证书和私钥" class="headerlink" title="4.1.2.3.检查生成的证书和私钥"></a>4.1.2.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>total 84<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1115 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet.csr<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 452 </span>Nov<span class="hljs-number"> 16 </span>21:59 kubelet-csr.json<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1468 </span>Nov<span class="hljs-number"> 16 </span>22:03 kubelet.pem<br></code></pre></td></tr></table></figure>

<h4 id="4-1-3-拷贝证书到各运算节点，并创建配置"><a href="#4-1-3-拷贝证书到各运算节点，并创建配置" class="headerlink" title="4.1.3.拷贝证书到各运算节点，并创建配置"></a>4.1.3.拷贝证书到各运算节点，并创建配置</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com 上
          

<h5 id="4-1-3-1-拷贝证书，私钥，注意私钥文件属性600"><a href="#4-1-3-1-拷贝证书，私钥，注意私钥文件属性600" class="headerlink" title="4.1.3.1.拷贝证书，私钥，注意私钥文件属性600"></a>4.1.3.1.拷贝证书，私钥，注意私钥文件属性600</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kubelet.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kubelet-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 32<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:11 apiserver-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1598 </span>Nov<span class="hljs-number"> 17 </span>02:08 apiserver.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:07 ca-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1346 </span>Nov<span class="hljs-number"> 17 </span>02:06 ca.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>02:08 client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1363 </span>Nov<span class="hljs-number"> 17 </span>02:07 client.pem<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1679 </span>Nov<span class="hljs-number"> 17 </span>06:12 kubelet-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1468 </span>Nov<span class="hljs-number"> 17 </span>06:11 kubelet.pem<br></code></pre></td></tr></table></figure>

<h5 id="4-1-3-2-创建配置—分四步"><a href="#4-1-3-2-创建配置—分四步" class="headerlink" title="4.1.3.2.创建配置—分四步"></a>4.1.3.2.创建配置—分四步</h5>
            <input type="checkbox" disabled checked="checked">都在conf目录下
          

<h6 id="4-1-3-2-1-set-cluster"><a href="#4-1-3-2-1-set-cluster" class="headerlink" title="4.1.3.2.1.set-cluster"></a>4.1.3.2.1.set-cluster</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-cluster myk8s \</span><br>--certificate-authority=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>ca.pem \<br>--embed-certs=true \<br>--server=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>:<span class="hljs-number">7443</span> \<br>--kubeconfig=kubelet.kubeconfig<br><br>返回结果：<br>Cluster <span class="hljs-string">&quot;myk8s&quot;</span> set.<br></code></pre></td></tr></table></figure>

<h6 id="4-1-3-2-2-set-credentials"><a href="#4-1-3-2-2-set-credentials" class="headerlink" title="4.1.3.2.2.set-credentials"></a>4.1.3.2.2.set-credentials</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-credentials k8s-node \</span><br>--client-certificate=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>client.pem \<br>--client-key=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>client-key.pem \<br>--embed-certs=true \<br>--kubeconfig=kubelet.kubeconfig <br><br>返回结果：<br>User <span class="hljs-string">&quot;k8s-node&quot;</span> set.<br></code></pre></td></tr></table></figure>

<h6 id="4-1-3-2-3-set-context"><a href="#4-1-3-2-3-set-context" class="headerlink" title="4.1.3.2.3.set-context"></a>4.1.3.2.3.set-context</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-21 conf]# kubectl<span class="hljs-built_in"> config </span>set-context myk8s-context \<br><span class="hljs-attribute">--cluster</span>=myk8s \<br><span class="hljs-attribute">--user</span>=k8s-node \<br><span class="hljs-attribute">--kubeconfig</span>=kubelet.kubeconfig<br><br>返回结果：<br>Context <span class="hljs-string">&quot;myk8s-context&quot;</span> created.<br></code></pre></td></tr></table></figure>

<h6 id="4-1-3-2-4-use-context"><a href="#4-1-3-2-4-use-context" class="headerlink" title="4.1.3.2.4.use-context"></a>4.1.3.2.4.use-context</h6><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">[root@hdss7-<span class="hljs-number">21</span> conf]# kubectl config <span class="hljs-keyword">use</span>-<span class="hljs-keyword">context</span> myk8s-<span class="hljs-keyword">context</span> <span class="hljs-comment">--kubeconfig=kubelet.kubeconfig</span><br><br>返回结果：<br>Switched <span class="hljs-keyword">to</span> <span class="hljs-keyword">context</span> <span class="hljs-string">&quot;myk8s-context&quot;</span>.<br></code></pre></td></tr></table></figure>

<h6 id="4-1-3-2-5-查看生成的kubelet-kubeconfig"><a href="#4-1-3-2-5-查看生成的kubelet-kubeconfig" class="headerlink" title="4.1.3.2.5.查看生成的kubelet.kubeconfig"></a>4.1.3.2.5.查看生成的kubelet.kubeconfig</h6><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 conf]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2223 </span>Nov<span class="hljs-number"> 17 </span>02:18 audit.yaml<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 6199 </span>Nov<span class="hljs-number"> 17 </span>06:32 kubelet.kubeconfig<br></code></pre></td></tr></table></figure>

<p><strong>cat下面的这段实际上就是ca.pem 经过base64编译以后的编码</strong></p>
<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code1.png" srcset="/img/loading.gif"></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code2.png" srcset="/img/loading.gif"></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="/img/blog_image/Linux_k8S_Bin_contentImage/code3.png" srcset="/img/loading.gif"></div></div></div>

<h6 id="4-1-3-2-6-k8s-node-yaml"><a href="#4-1-3-2-6-k8s-node-yaml" class="headerlink" title="4.1.3.2.6.k8s-node.yaml"></a>4.1.3.2.6.k8s-node.yaml</h6><p><strong>1、创建配置文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">conf</span>]<span class="hljs-comment"># vi k8s-node.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s-node</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:node</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">User</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s-node</span><br></code></pre></td></tr></table></figure>

<p><strong>2、根据配置文件创建用户</strong></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl create -f k8s-node.yaml            //-f 指定配置文件</span><br>clusterrolebinding.rbac.authorization.k8s.io/k8s-<span class="hljs-keyword">node</span> <span class="hljs-title">created</span>    //创建角色后会存到etcd里<br></code></pre></td></tr></table></figure>

<p><strong>3、查询集群角色和查看角色属性</strong></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl get clusterrolebinding k8s-node</span><br>NAME       AGE<br>k8s-<span class="hljs-keyword">node</span>   <span class="hljs-title">7m54s</span><br><br>[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl get clusterrolebinding k8s-node -o yaml</span><br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding                       //定义了一个集群绑定资源，k8s一切皆资源<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2019-11-16T22:53:06Z&quot;</span><br>  name: k8s-<span class="hljs-keyword">node</span>                                <span class="hljs-title">//资源的名称为k8s-node</span><br>  resourceVersion: <span class="hljs-string">&quot;11262&quot;</span><br>  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-<span class="hljs-keyword">node</span><span class="hljs-title"></span><br><span class="hljs-title">  uid</span>: <span class="hljs-number">2</span>b87d554-de37-<span class="hljs-number">494</span>d-b6dd-<span class="hljs-number">7</span>c5d0ecdd5d6<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:<span class="hljs-keyword">node</span>                                  <span class="hljs-title">//给k8s-node</span>集群用户绑定了一个集群角色，叫system：<span class="hljs-keyword">node</span><span class="hljs-title">，意思是让下面k8s-node</span>用户具备这个集群里运算节点的权限<br>subjects:<br>- apiGroup: rbac.authorization.k8s.io<br>  kind: User<br>  name: k8s-<span class="hljs-keyword">node</span>                                 <span class="hljs-title"></span><br></code></pre></td></tr></table></figure>

<p><strong>4、拷贝kubelet.kubeconfig 到hdss7-22上</strong></p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-22 conf]<span class="hljs-comment"># scp hdss7-21:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .</span><br>[root@hdss7-22 conf]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 2223 </span>Nov<span class="hljs-number"> 16 </span>18:48 audit.yaml<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 6199 </span>Nov<span class="hljs-number"> 16 </span>23:14 kubelet.kubeconfig<br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-准备pause基础镜像"><a href="#4-1-4-准备pause基础镜像" class="headerlink" title="4.1.4.准备pause基础镜像"></a>4.1.4.准备pause基础镜像</h4>
            <input type="checkbox" disabled checked="checked">运维主机 hdss7-200.host.com上
          

<p><strong>为什么需要这个pause基础镜像？</strong><br>原因：需要用一个pause基础镜像把这台机器的pod拉起来，因为kubelet是干活的节点，它帮我们调度docker引擎，边车模式，让kebelet控制一个小镜像，先于我们的业务容器起来，让它帮我们业务容器去设置：UTC、NET、IPC，让它先把命名空间占上，业务容易还没起来的时候，pod的ip已经分配出来了。</p>
<h5 id="4-1-4-1-下载pause镜像"><a href="#4-1-4-1-下载pause镜像" class="headerlink" title="4.1.4.1.下载pause镜像"></a>4.1.4.1.下载pause镜像</h5>
            <input type="checkbox" disabled checked="checked">运维主机 hdss7-200.host.com上
          

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@hdss7-<span class="hljs-number">200</span> ~]# docker pull kubernetes/pause<br>Using default <span class="hljs-keyword">ta</span><span class="hljs-variable">g:</span> latest<br>lates<span class="hljs-variable">t:</span> Pulling from kubernetes/pause<br><span class="hljs-number">4</span>f4fb700ef54: Pull <span class="hljs-built_in">complete</span> <br>b9c8ec465f6<span class="hljs-variable">b:</span> Pull <span class="hljs-built_in">complete</span> <br>Diges<span class="hljs-variable">t:</span> <span class="hljs-built_in">sha256</span>:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105<br>Statu<span class="hljs-variable">s:</span> Downloaded newer image <span class="hljs-keyword">for</span> kubernetes/pause:latest<br>docker.io/kubernetes/pause:latest<br></code></pre></td></tr></table></figure>

<h5 id="4-1-4-2-提交至docker私有仓库（harbor）中"><a href="#4-1-4-2-提交至docker私有仓库（harbor）中" class="headerlink" title="4.1.4.2.提交至docker私有仓库（harbor）中"></a>4.1.4.2.提交至docker私有仓库（harbor）中</h5><h6 id="4-1-4-2-1-给镜像打tag"><a href="#4-1-4-2-1-给镜像打tag" class="headerlink" title="4.1.4.2.1.给镜像打tag"></a>4.1.4.2.1.给镜像打tag</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">200</span> ~]<span class="hljs-comment"># docker tag f9d5de079539 harbor.od.com/public/pause:latest</span><br>[root@hdss7-<span class="hljs-number">200</span> ~]<span class="hljs-comment"># docker images -a</span><br>REPOSITORY                      <span class="hljs-keyword">TAG</span>                        <span class="hljs-title">IMAGE</span> ID            CREATED             SIZE<br>...                                                                     <br>kubernetes/pause                latest                     f9d5de079539        <span class="hljs-number">5</span> years ago         <span class="hljs-number">240</span>kB<br>harbor.od.com/public/pause      latest                     f9d5de079539        <span class="hljs-number">5</span> years ago         <span class="hljs-number">240</span>kB<br></code></pre></td></tr></table></figure>

<h6 id="4-1-4-2-2-推到harbor上"><a href="#4-1-4-2-2-推到harbor上" class="headerlink" title="4.1.4.2.2.推到harbor上"></a>4.1.4.2.2.推到harbor上</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">200</span> ~]# docker <span class="hljs-keyword">push</span> harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest<br>The <span class="hljs-keyword">push</span> refers to repository [harbor.od.com<span class="hljs-regexp">/public/</span>pause]<br><span class="hljs-number">5</span>f70bf18a086: Mounted <span class="hljs-keyword">from</span> <span class="hljs-keyword">public</span>/nginx <br>e16a89738269: Pushed <br>latest: digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105 <span class="hljs-keyword">size</span>: <span class="hljs-number">938</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-5-创建kubelet启动脚本"><a href="#4-1-5-创建kubelet启动脚本" class="headerlink" title="4.1.5.创建kubelet启动脚本"></a>4.1.5.创建kubelet启动脚本</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> conf]# vi <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kubelet.sh<br>#!<span class="hljs-regexp">/bin/</span>sh<br>./kubelet \<br>  --anonymous-auth=<span class="hljs-keyword">false</span> \<br>  --cgroup-driver systemd \<br>  --cluster-dns <span class="hljs-number">192.168</span>.<span class="hljs-number">0.2</span> \<br>  --cluster-domain cluster.local \<br>  --<span class="hljs-keyword">runtime</span>-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --kubelet-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --fail-swap-on=<span class="hljs-string">&quot;false&quot;</span> \<br>  --client-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --tls-cert-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet.pem \<br>  --tls-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet-key.pem \<br>  --hostname-override hdss7-<span class="hljs-number">21</span>.host.com \<br>  --image-gc-high-threshold <span class="hljs-number">20</span> \<br>  --image-gc-low-threshold <span class="hljs-number">10</span> \<br>  --kubeconfig .<span class="hljs-regexp">/conf/</span>kubelet.kubeconfig \<br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet \<br>  --pod-infra-container-image harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest \<br>  --root-dir <span class="hljs-regexp">/data/</span>kubelet<br>  <br>  ###################参数说明############<br>    --anonymous-auth=<span class="hljs-keyword">false</span> \                                  <span class="hljs-comment">//匿名登陆，这里不允许</span><br>  --cgroup-driver systemd \                                    <span class="hljs-comment">//这里和docker的daemon.json保持一直</span><br>  --cluster-dns <span class="hljs-number">192.168</span>.<span class="hljs-number">0.2</span> \                                   <br>  --cluster-domain cluster.local \<br>  --<span class="hljs-keyword">runtime</span>-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --kubelet-cgroups=<span class="hljs-regexp">/systemd/</span>system.slice \<br>  --fail-swap-on=<span class="hljs-string">&quot;false&quot;</span> \                                  <span class="hljs-comment">//正常是关闭swap分区的。这里不关，没有关闭swap分区正常启动，没有报错</span><br>  --client-ca-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>ca.pem \<br>  --tls-cert-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet.pem \<br>  --tls-<span class="hljs-keyword">private</span>-key-<span class="hljs-keyword">file</span> .<span class="hljs-regexp">/cert/</span>kubelet-key.pem \<br>  --hostname-override hdss7-<span class="hljs-number">21</span>.host.com \           <br>  --image-gc-high-threshold <span class="hljs-number">20</span> \<br>  --image-gc-low-threshold <span class="hljs-number">10</span> \<br>  --kubeconfig .<span class="hljs-regexp">/conf/</span>kubelet.kubeconfig \          <br>  --log-dir <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet \<br>  --pod-infra-container-image harbor.od.com<span class="hljs-regexp">/public/</span>pause:latest \<br>  --root-dir <span class="hljs-regexp">/data/</span>kubelet<br></code></pre></td></tr></table></figure>

<p><strong>注意：kubelet集群个主机的启动脚本略不同，其他节点注意修改：–hostname-override</strong></p>
<h4 id="4-1-6-检查配置，权限，创建日志目录"><a href="#4-1-6-检查配置，权限，创建日志目录" class="headerlink" title="4.1.6.检查配置，权限，创建日志目录"></a>4.1.6.检查配置，权限，创建日志目录</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> conf]# ls -l|<span class="hljs-keyword">grep</span> kubelet<br>-rw------- <span class="hljs-number">1</span> root root <span class="hljs-number">6199</span> Nov <span class="hljs-number">17</span> <span class="hljs-number">06</span>:<span class="hljs-number">32</span> kubelet.kubeconfig<br><br>[root@hdss7-<span class="hljs-number">21</span> conf]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kubelet.sh <br>[root@hdss7-<span class="hljs-number">21</span> conf]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-kubelet   <span class="hljs-regexp">/data/</span>kubelet<br></code></pre></td></tr></table></figure>

<h4 id="4-1-7-创建supervisor配置"><a href="#4-1-7-创建supervisor配置" class="headerlink" title="4.1.7.创建supervisor配置"></a>4.1.7.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 conf]</span><span class="hljs-comment">#  vi /etc/supervisord.d/kube-kubelet.ini</span><br><span class="hljs-section">[program:kube-kubelet-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kubelet.sh     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                        <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin              <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                    <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                  <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                      <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                    <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                     <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                   <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                   <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                         <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                              <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                      <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                          <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                       <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                       <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：其他主机部署时请注意修改program标签</strong></p>
<h4 id="4-1-8-启动服务并检查"><a href="#4-1-8-启动服务并检查" class="headerlink" title="4.1.8.启动服务并检查"></a>4.1.8.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> conf]# supervisorctl  update<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>: added process group<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 3270, uptime 0:00:46<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3273, uptime 0:00:46<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 3267, uptime 0:00:46<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                RUNNING   pid 3268, uptime 0:00:46<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3269, uptime 0:00:46<br><br>遇到一个问题，没起来：<br>查看日志原来是我的docker服务没起，systemctl  start docker    systemctl enable docker<br></code></pre></td></tr></table></figure>

<h4 id="4-1-9-检查运算节点"><a href="#4-1-9-检查运算节点" class="headerlink" title="4.1.9.检查运算节点"></a>4.1.9.检查运算节点</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-21</span> bin]# tailf /data/logs/kubernetes/kube-kubelet/kubelet.stdout.<span class="hljs-keyword">log</span> <br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.074479</span>    <span class="hljs-number">3272</span> kubelet_node_status.go:<span class="hljs-number">72</span>] Attempting <span class="hljs-keyword">to</span> register node hdss7<span class="hljs-number">-21.</span>host.com<br>E1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.088198</span>    <span class="hljs-number">3272</span> kubelet.go:<span class="hljs-number">2248</span>] node &quot;hdss7-21.host.com&quot; <span class="hljs-keyword">not</span> <span class="hljs-built_in">found</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.088590</span>    <span class="hljs-number">3272</span> kubelet_node_status.go:<span class="hljs-number">75</span>] Successfully registered node hdss7<span class="hljs-number">-21.</span>host.com<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119351</span>    <span class="hljs-number">3272</span> cpu_manager.go:<span class="hljs-number">155</span>] [cpumanager] starting <span class="hljs-keyword">with</span> <span class="hljs-keyword">none</span> <span class="hljs-keyword">policy</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119363</span>    <span class="hljs-number">3272</span> cpu_manager.go:<span class="hljs-number">156</span>] [cpumanager] reconciling every <span class="hljs-number">10</span>s<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.119382</span>    <span class="hljs-number">3272</span> policy_none.go:<span class="hljs-number">42</span>] [cpumanager] <span class="hljs-keyword">none</span> <span class="hljs-keyword">policy</span>: <span class="hljs-keyword">Start</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.155413</span>    <span class="hljs-number">3272</span> kubelet.go:<span class="hljs-number">1822</span>] skipping pod synchronization - container runtime status <span class="hljs-keyword">check</span> may <span class="hljs-keyword">not</span> have completed yet<br>W1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.374787</span>    <span class="hljs-number">3272</span> manager.go:<span class="hljs-number">546</span>] Failed <span class="hljs-keyword">to</span> retrieve <span class="hljs-keyword">checkpoint</span> <span class="hljs-keyword">for</span> &quot;kubelet_internal_checkpoint&quot;: <span class="hljs-keyword">checkpoint</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">found</span><br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.375126</span>    <span class="hljs-number">3272</span> plugin_manager.go:<span class="hljs-number">116</span>] Starting Kubelet Plugin Manager<br>I1117 <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.690595</span>    <span class="hljs-number">3272</span> reconciler.go:<span class="hljs-number">150</span>] Reconciler: <span class="hljs-keyword">start</span> <span class="hljs-keyword">to</span> sync state<br></code></pre></td></tr></table></figure>

<h4 id="4-1-10-安装部署启动检查所有集群规划主机"><a href="#4-1-10-安装部署启动检查所有集群规划主机" class="headerlink" title="4.1.10.安装部署启动检查所有集群规划主机"></a>4.1.10.安装部署启动检查所有集群规划主机</h4><p><strong>其他节点类似，有些需要稍许调整，上面有标注：</strong><br>/opt/kubernetes/server/bin/conf/kubelet.kubeconfig<br>/opt/kubernetes/server/bin/kubelet.sh<br>/etc/supervisord.d/kube-kubelet.ini</p>
<h4 id="4-1-11-检查所有运算节点"><a href="#4-1-11-检查所有运算节点" class="headerlink" title="4.1.11.检查所有运算节点"></a>4.1.11.检查所有运算节点</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES    AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br><br>// 角色是none，打个标签，标签是特色管理功能之一<br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=</span><br><span class="hljs-keyword">node</span><span class="hljs-title">/hdss7-21</span>.host.com labeled<br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES    AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-keyword">master</span>   <span class="hljs-title">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>   <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=</span><br><span class="hljs-keyword">node</span><span class="hljs-title">/hdss7-21</span>.host.com labeled<br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get nodes</span><br>NAME                STATUS   ROLES         AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">8h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-tag">&lt;none&gt;</span>        <span class="hljs-number">8h</span>    v1.<span class="hljs-number">15.2</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-部署kube-proxy"><a href="#4-2-部署kube-proxy" class="headerlink" title="4.2.部署kube-proxy"></a>4.2.部署kube-proxy</h3><p><strong>联结pod网络和集群网络</strong></p>
<h4 id="4-2-1-集群规划"><a href="#4-2-1-集群规划" class="headerlink" title="4.2.1.集群规划"></a>4.2.1.集群规划</h4><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-21.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>hdss7-22.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
</tbody></table>
<p><strong>注意：这里部署以hdss7-21主机为例，其他运算节点类似</strong></p>
<h4 id="4-2-2-签发kube-proxy证书"><a href="#4-2-2-签发kube-proxy证书" class="headerlink" title="4.2.2.签发kube-proxy证书"></a>4.2.2.签发kube-proxy证书</h4>
            <input type="checkbox" disabled checked="checked">hdss7-200.host.com上
          

<h5 id="4-2-2-1-创建生成证书签名请求（csr）的json配置文件"><a href="#4-2-2-1-创建生成证书签名请求（csr）的json配置文件" class="headerlink" title="4.2.2.1.创建生成证书签名请求（csr）的json配置文件"></a>4.2.2.1.创建生成证书签名请求（csr）的json配置文件</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@hdss7</span><span class="hljs-number">-200</span> certs]<span class="hljs-meta"># vi kube-proxy-csr.json</span><br>&#123;<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;system:kube-proxy&quot;</span>,<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2048</span><br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;beijing&quot;</span>,<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;od&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;ops&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4-2-2-2-生成kubelet证书和私钥"><a href="#4-2-2-2-生成kubelet证书和私钥" class="headerlink" title="4.2.2.2.生成kubelet证书和私钥"></a>4.2.2.2.生成kubelet证书和私钥</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@hdss7<span class="hljs-number">-200</span> certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-<span class="hljs-type">json</span> -bare kube-proxy-client<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] generate received request<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] received CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] generating key: rsa<span class="hljs-number">-2048</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] encoded CSR<br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-keyword">INFO</span>] signed certificate <span class="hljs-keyword">with</span> <span class="hljs-type">serial</span> number <span class="hljs-number">490532965938220149616881213802710440162344647640</span><br><span class="hljs-number">2019</span>/<span class="hljs-number">11</span>/<span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">58</span>:<span class="hljs-number">31</span> [<span class="hljs-built_in">WARNING</span>] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable <span class="hljs-keyword">for</span><br>websites. <span class="hljs-keyword">For</span> more information see the Baseline Requirements <span class="hljs-keyword">for</span> the Issuance <span class="hljs-keyword">and</span> Management<br><span class="hljs-keyword">of</span> Publicly-<span class="hljs-keyword">Trusted</span> Certificates, v<span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.6</span>, <span class="hljs-keyword">from</span> the CA/Browser Forum (https://cabforum.org);<br>specifically, section <span class="hljs-number">10.2</span><span class="hljs-number">.3</span> (&quot;Information Requirements&quot;).<br></code></pre></td></tr></table></figure>

<h5 id="4-2-2-3-检查生成的证书和私钥"><a href="#4-2-2-3-检查生成的证书和私钥" class="headerlink" title="4.2.2.3.检查生成的证书和私钥"></a>4.2.2.3.检查生成的证书和私钥</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-200 certs]<span class="hljs-comment"># ll</span><br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1005 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client.csr<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1675 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1375 </span>Nov<span class="hljs-number"> 17 </span>00:58 kube-proxy-client.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 267 </span>Nov<span class="hljs-number"> 17 </span>00:57 kube-proxy-csr.json<br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-拷贝证书至各运算节点，并创建配置"><a href="#4-2-3-拷贝证书至各运算节点，并创建配置" class="headerlink" title="4.2.3.拷贝证书至各运算节点，并创建配置"></a>4.2.3.拷贝证书至各运算节点，并创建配置</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<h5 id="4-2-3-1-拷贝证书-私钥，注意私钥文件属性600"><a href="#4-2-3-1-拷贝证书-私钥，注意私钥文件属性600" class="headerlink" title="4.2.3.1.拷贝证书,私钥，注意私钥文件属性600"></a>4.2.3.1.拷贝证书,私钥，注意私钥文件属性600</h5><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kube-proxy-client.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># scp hdss7-200:/opt/certs/kube-proxy-client-key.pem .</span><br>[root@hdss7-21 cert]<span class="hljs-comment"># ll</span><br>total 40<br>-rw-------<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1675 </span>Nov<span class="hljs-number"> 17 </span>09:10 kube-proxy-client-key.pem<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1375 </span>Nov<span class="hljs-number"> 17 </span>09:10 kube-proxy-client.pem<br></code></pre></td></tr></table></figure>

<h5 id="4-2-3-2-创建配置"><a href="#4-2-3-2-创建配置" class="headerlink" title="4.2.3.2.创建配置"></a>4.2.3.2.创建配置</h5><p><strong>注意必须在conf目录下，否则报错</strong></p>
<h6 id="4-2-3-2-1-set-cluster"><a href="#4-2-3-2-1-set-cluster" class="headerlink" title="4.2.3.2.1.set-cluster"></a>4.2.3.2.1.set-cluster</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment"># kubectl config set-cluster myk8s \</span><br>--certificate-authority=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>ca.pem \<br>--embed-certs=true \<br>--server=https:<span class="hljs-regexp">//</span><span class="hljs-number">10.4</span>.<span class="hljs-number">7.10</span>:<span class="hljs-number">7443</span> \<br>--kubeconfig=kube-proxy.kubeconfig<br><br>返回结果：<br>Cluster <span class="hljs-string">&quot;myk8s&quot;</span> set.<br></code></pre></td></tr></table></figure>

<h6 id="4-2-3-2-2-set-credentials"><a href="#4-2-3-2-2-set-credentials" class="headerlink" title="4.2.3.2.2.set-credentials"></a>4.2.3.2.2.set-credentials</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@hdss7-<span class="hljs-number">21</span> conf]<span class="hljs-comment">#  kubectl config set-credentials kube-proxy \</span><br>  --client-certificate=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>kube-proxy-client.pem \<br>  --client-key=<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/cert/</span>kube-proxy-client-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=kube-proxy.kubeconfig<br>  <br>  返回结果：<br>  User <span class="hljs-string">&quot;kube-proxy&quot;</span> set.<br></code></pre></td></tr></table></figure>

<h6 id="4-2-3-2-3-set-context"><a href="#4-2-3-2-3-set-context" class="headerlink" title="4.2.3.2.3.set-context"></a>4.2.3.2.3.set-context</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@hdss7-21 conf]# kubectl<span class="hljs-built_in"> config </span>set-context myk8s-context \<br><span class="hljs-attribute">--cluster</span>=myk8s \<br><span class="hljs-attribute">--user</span>=kube-proxy \<br><span class="hljs-attribute">--kubeconfig</span>=kube-proxy.kubeconfig<br><br>返回结果：<br>Context <span class="hljs-string">&quot;myk8s-context&quot;</span> created.<br></code></pre></td></tr></table></figure>

<h6 id="4-2-3-2-4-use-context"><a href="#4-2-3-2-4-use-context" class="headerlink" title="4.2.3.2.4.use-context"></a>4.2.3.2.4.use-context</h6><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">[root@hdss7-<span class="hljs-number">21</span> conf]# kubectl config <span class="hljs-keyword">use</span>-<span class="hljs-keyword">context</span> myk8s-<span class="hljs-keyword">context</span> <span class="hljs-comment">--kubeconfig=kube-proxy.kubeconfig</span><br><br>返回结果<br>Switched <span class="hljs-keyword">to</span> <span class="hljs-keyword">context</span> <span class="hljs-string">&quot;myk8s-context&quot;</span>.<br></code></pre></td></tr></table></figure>

<h6 id="4-2-3-2-5-拷贝kube-proxy-kubeconfig-到-hdss7-22的conf目录下"><a href="#4-2-3-2-5-拷贝kube-proxy-kubeconfig-到-hdss7-22的conf目录下" class="headerlink" title="4.2.3.2.5.拷贝kube-proxy.kubeconfig 到 hdss7-22的conf目录下"></a>4.2.3.2.5.拷贝kube-proxy.kubeconfig 到 hdss7-22的conf目录下</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> conf]# scp hdss7-<span class="hljs-number">21</span>:<span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/conf/</span>kube-proxy.kubeconfig .<br></code></pre></td></tr></table></figure>

<h4 id="4-2-4-创建kube-proxy启动脚本"><a href="#4-2-4-创建kube-proxy启动脚本" class="headerlink" title="4.2.4.创建kube-proxy启动脚本"></a>4.2.4.创建kube-proxy启动脚本</h4>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<h5 id="4-2-4-1-加载ipvs模块"><a href="#4-2-4-1-加载ipvs模块" class="headerlink" title="4.2.4.1.加载ipvs模块"></a>4.2.4.1.加载ipvs模块</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">21</span> bin]# lsmod |<span class="hljs-keyword">grep</span> ip_vs<br>[root@hdss7-<span class="hljs-number">21</span> bin]# vi <span class="hljs-regexp">/root/i</span>pvs.sh<br>#!<span class="hljs-regexp">/bin/</span>bash<br>ipvs_mods_dir=<span class="hljs-string">&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</span><br><span class="hljs-keyword">for</span> i in $(ls $ipvs_mods_dir|<span class="hljs-keyword">grep</span> -o <span class="hljs-string">&quot;^[^.]*&quot;</span>)<br><span class="hljs-keyword">do</span><br>  <span class="hljs-regexp">/sbin/m</span>odinfo -F filename $i &amp;&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>  <span class="hljs-keyword">if</span> [ $? -eq <span class="hljs-number">0</span> ];then<br>    <span class="hljs-regexp">/sbin/m</span>odprobe $i<br>  fi<br>done    <br><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]# chmod +x <span class="hljs-regexp">/root/i</span>pvs.sh <br>[root@hdss7-<span class="hljs-number">21</span> bin]# sh <span class="hljs-regexp">/root/i</span>pvs.sh <br><br>[root@hdss7-<span class="hljs-number">21</span> bin]# lsmod |<span class="hljs-keyword">grep</span> ip_vs<br>ip_vs_wrr              <span class="hljs-number">12697</span>  <span class="hljs-number">0</span> <br>ip_vs_wlc              <span class="hljs-number">12519</span>  <span class="hljs-number">0</span> <br>ip_vs_sh               <span class="hljs-number">12688</span>  <span class="hljs-number">0</span> <br>ip_vs_sed              <span class="hljs-number">12519</span>  <span class="hljs-number">0</span> <br>......<br></code></pre></td></tr></table></figure>

<h5 id="4-2-4-2-创建启动脚本"><a href="#4-2-4-2-创建启动脚本" class="headerlink" title="4.2.4.2.创建启动脚本"></a>4.2.4.2.创建启动脚本</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@hdss7-21 bin]<span class="hljs-comment"># vi /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br><span class="hljs-string">./kube-proxy</span> \<br>  <span class="hljs-params">--cluster-cidr</span> 172.7.0.0/16 \<br>  <span class="hljs-params">--hostname-override</span> hdss7-21.host.com \<br>  <span class="hljs-params">--proxy-mode=ipvs</span> \<br>  <span class="hljs-params">--ipvs-scheduler=nq</span> \<br>  <span class="hljs-params">--kubeconfig</span> <span class="hljs-string">./conf/kube-proxy.kubeconfig</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-5-检查配置，权限，创建日志目录"><a href="#4-2-5-检查配置，权限，创建日志目录" class="headerlink" title="4.2.5.检查配置，权限，创建日志目录"></a>4.2.5.检查配置，权限，创建日志目录</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@hdss7-<span class="hljs-number">22</span> bin]# ls -l <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin<span class="hljs-regexp">/conf/</span>|<span class="hljs-keyword">grep</span> kube-proxy<br>-rw------- <span class="hljs-number">1</span> root root <span class="hljs-number">6215</span> Nov <span class="hljs-number">17</span> <span class="hljs-number">01</span>:<span class="hljs-number">22</span> kube-proxy.kubeconfig<br><br>[root@hdss7-<span class="hljs-number">22</span> bin]# chmod +x <span class="hljs-regexp">/opt/</span>kubernetes<span class="hljs-regexp">/server/</span>bin/kube-proxy.sh <br>[root@hdss7-<span class="hljs-number">22</span> bin]# mkdir -p <span class="hljs-regexp">/data/</span>logs<span class="hljs-regexp">/kubernetes/</span>kube-proxy<br></code></pre></td></tr></table></figure>

<h4 id="4-2-6-创建supervisor配置"><a href="#4-2-6-创建supervisor配置" class="headerlink" title="4.2.6.创建supervisor配置"></a>4.2.6.创建supervisor配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@hdss7-21 bin]</span><span class="hljs-comment"># vi /etc/supervisord.d/kube-proxy.ini</span><br><span class="hljs-section">[program:kube-proxy-7-21]</span><br><span class="hljs-attr">command</span>=/opt/kubernetes/server/bin/kube-proxy.sh                     <span class="hljs-comment">; the program (relative uses PATH, can take args)</span><br><span class="hljs-attr">numprocs</span>=<span class="hljs-number">1</span>                                                           <span class="hljs-comment">; number of processes copies to start (def 1)</span><br><span class="hljs-attr">directory</span>=/opt/kubernetes/server/bin                                 <span class="hljs-comment">; directory to cwd to before exec (def no cwd)</span><br><span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>                                                       <span class="hljs-comment">; start at supervisord start (default: true)</span><br><span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>                                                     <span class="hljs-comment">; retstart at unexpected quit (default: true)</span><br><span class="hljs-attr">startsecs</span>=<span class="hljs-number">30</span>                                                         <span class="hljs-comment">; number of secs prog must stay running (def. 1)</span><br><span class="hljs-attr">startretries</span>=<span class="hljs-number">3</span>                                                       <span class="hljs-comment">; max # of serial start failures (default 3)</span><br><span class="hljs-attr">exitcodes</span>=<span class="hljs-number">0</span>,<span class="hljs-number">2</span>                                                        <span class="hljs-comment">; &#x27;expected&#x27; exit codes for process (default 0,2)</span><br><span class="hljs-attr">stopsignal</span>=QUIT                                                      <span class="hljs-comment">; signal used to kill process (default TERM)</span><br><span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">10</span>                                                      <span class="hljs-comment">; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="hljs-attr">user</span>=root                                                            <span class="hljs-comment">; setuid to this UNIX account to run the program</span><br><span class="hljs-attr">redirect_stderr</span>=<span class="hljs-literal">true</span>                                                 <span class="hljs-comment">; redirect proc stderr to stdout (default false)</span><br><span class="hljs-attr">stdout_logfile</span>=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     <span class="hljs-comment">; stderr log path, NONE for none; default AUTO</span><br><span class="hljs-attr">stdout_logfile_maxbytes</span>=<span class="hljs-number">64</span>MB                                         <span class="hljs-comment">; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="hljs-attr">stdout_logfile_backups</span>=<span class="hljs-number">4</span>                                             <span class="hljs-comment">; # of stdout logfile backups (default 10)</span><br><span class="hljs-attr">stdout_capture_maxbytes</span>=<span class="hljs-number">1</span>MB                                          <span class="hljs-comment">; number of bytes in &#x27;capturemode&#x27; (default 0)</span><br><span class="hljs-attr">stdout_events_enabled</span>=<span class="hljs-literal">false</span>                                          <span class="hljs-comment">; emit events on stdout writes (default false)</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-7-启动服务并检查"><a href="#4-2-7-启动服务并检查" class="headerlink" title="4.2.7.启动服务并检查"></a>4.2.7.启动服务并检查</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl update<br>[root@hdss7<span class="hljs-string">-21</span> bin]# supervisorctl status<br>etcd-server<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                 RUNNING   pid 3270, uptime 1:22:21<br>kube-apiserver<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3273, uptime 1:22:21<br>kube-controller-manager<span class="hljs-string">-7</span><span class="hljs-string">-21</span>     RUNNING   pid 3267, uptime 1:22:21<br>kube-kubelet<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                RUNNING   pid 3268, uptime 1:22:21<br>kube-proxy<span class="hljs-string">-7</span><span class="hljs-string">-21</span>                  RUNNING   pid 19580, uptime 0:00:31<br>kube-scheduler<span class="hljs-string">-7</span><span class="hljs-string">-21</span>              RUNNING   pid 3269, uptime 1:22:21<br><br>[root@hdss7<span class="hljs-string">-21</span> bin]# yum install ipvsadm -y<br>[root@hdss7<span class="hljs-string">-21</span> bin]# ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  192.168.0.1:443 nq<br>  -&gt; 10.4.7.21:6443               Masq    1      0          0         <br>  -&gt; 10.4.7.22:6443               Masq    1      0          0   <br>  <br>  <br>[root@hdss7<span class="hljs-string">-21</span> bin]# kubectl get svc<br>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   192.168.0.1   &lt;none&gt;        443/TCP   7h11m<br></code></pre></td></tr></table></figure>

<h4 id="4-2-8-安装部署启动检查所有集群规划主机"><a href="#4-2-8-安装部署启动检查所有集群规划主机" class="headerlink" title="4.2.8.安装部署启动检查所有集群规划主机"></a>4.2.8.安装部署启动检查所有集群规划主机</h4><p><strong>hdss7-22 跟上述基本相同</strong><br>/etc/supervisord.d/kube-proxy.ini<br>需要更改成[program:kube-proxy-7-21]</p>
<p>/opt/kubernetes/server/bin/kube-proxy.sh<br>需要改成 –hostname-override hdss7-22.host.com</p>
<h2 id="5-验证kubernetes集群"><a href="#5-验证kubernetes集群" class="headerlink" title="5.验证kubernetes集群"></a>5.验证kubernetes集群</h2><h3 id="5-1-在任意一个运算节点，创建一个资源配置清单"><a href="#5-1-在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="5.1.在任意一个运算节点，创建一个资源配置清单"></a>5.1.在任意一个运算节点，创建一个资源配置清单</h3>
            <input type="checkbox" disabled checked="checked">hdss7-21.host.com上
          

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@hdss7-21</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vi /root/nginx-ds.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ds</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-ds</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">harbor.od.com/public/nginx:v1.7.9</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-应用资源配置，并检查"><a href="#5-2-应用资源配置，并检查" class="headerlink" title="5.2.应用资源配置，并检查"></a>5.2.应用资源配置，并检查</h3><h4 id="5-2-1-hdss7-21上的操作"><a href="#5-2-1-hdss7-21上的操作" class="headerlink" title="5.2.1.hdss7-21上的操作"></a>5.2.1.hdss7-21上的操作</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-21 bin]# kubectl create -f /root/nginx-ds.yaml<br><br>返回结果：<br>daemonset.extensions/nginx-ds created<br><br><br><br>[root@hdss7-21 bin]# kubectl get pods<br>NAME             READY   STATUS    RESTARTS   AGE<br>nginx-ds-mcvxt   1/1     Running   0          8h<br>nginx-ds-zsnz9   1/1     Running   0          8h<br><br><br>[root@hdss7-21 bin]# kubectl get pods -o wide<br>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES<br>nginx-ds-mcvxt   1/1     Running   0          8h    172.7.21.2   hdss7-21.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>nginx-ds-zsnz9   1/1     Running   0          8h    172.7.22.2   hdss7-22.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br><br>[root@hdss7-21 bin]# curl 172.7.21.2<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br>[root@hdss7-21 bin]# curl 172.7.22.2<br>^C   <br>//curl 不到？<br>原因是跨宿主机，docker容器还不能通信，下篇：flannel解决这个问题<br></code></pre></td></tr></table></figure>

<h4 id="5-2-2-hdss7-22上的操作"><a href="#5-2-2-hdss7-22上的操作" class="headerlink" title="5.2.2.hdss7-22上的操作"></a>5.2.2.hdss7-22上的操作</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@hdss7-22 bin]# kubectl get pods -o wide<br>NAME             READY   STATUS    RESTARTS   AGE     IP           NODE                NOMINATED NODE   READINESS GATES<br>nginx-ds-mcvxt   1/1     Running   0          6m45s   172.7.21.2   hdss7-21.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>nginx-ds-zsnz9   1/1     Running   0          6m45s   172.7.22.2   hdss7-22.host.com   <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">none</span>&gt;</span><br>[root@hdss7-22 bin]# curl 172.7.22.2<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br>[root@hdss7-22 bin]# curl 172.7.21.2<br>^C<br>//curl 不到，上述已有解释<br></code></pre></td></tr></table></figure>

<h4 id="5-2-3-查看kubernetes集群上篇是否搭建好"><a href="#5-2-3-查看kubernetes集群上篇是否搭建好" class="headerlink" title="5.2.3.查看kubernetes集群上篇是否搭建好"></a>5.2.3.查看kubernetes集群上篇是否搭建好</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get cs</span><br>NAME                 STATUS    MESSAGE              ERROR<br>controller-manager   Healthy   ok                   <br>scheduler            Healthy   ok                   <br>etcd-<span class="hljs-number">1</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-<span class="hljs-number">2</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125;   <br>etcd-<span class="hljs-number">0</span>               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>&#125; <br><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get node</span><br>NAME                STATUS   ROLES         AGE   <span class="hljs-keyword">VERSION</span><br>hdss7-<span class="hljs-number">21</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">9h</span>    v1.<span class="hljs-number">15.2</span><br>hdss7-<span class="hljs-number">22</span>.host.com   Ready    <span class="hljs-literal">master</span>,<span class="hljs-keyword">node</span>   <span class="hljs-title">10h</span>   v1.<span class="hljs-number">15.2</span><br><br>[root@hdss7-<span class="hljs-number">21</span> bin]<span class="hljs-comment"># kubectl get pods</span><br>NAME             READY   STATUS    RESTARTS   AGE<br>nginx-ds-mcvxt   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">8h</span><br>nginx-ds-zsnz9   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">8h</span><br></code></pre></td></tr></table></figure>

<h4 id="5-2-4-FAQ"><a href="#5-2-4-FAQ" class="headerlink" title="5.2.4.FAQ:"></a>5.2.4.FAQ:</h4><h5 id="5-2-4-1-：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错"><a href="#5-2-4-1-：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错" class="headerlink" title="5.2.4.1.：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错"></a>5.2.4.1.：kube-proxy启动之后，用不了ipvs模式，查看日志发现如下报错</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">E1111</span> <span class="hljs-number">12</span>:<span class="hljs-number">27</span>:<span class="hljs-number">38</span>.<span class="hljs-number">031263</span>   <span class="hljs-number">23086</span> server_others.go:<span class="hljs-number">259</span>] can&#x27;t determine whether to use ipvs proxy, error: error getting ipset version, error: executable file not found in $PATH<br><span class="hljs-attribute">W1111</span> <span class="hljs-number">12</span>:<span class="hljs-number">27</span>:<span class="hljs-number">38</span>.<span class="hljs-number">049355</span>   <span class="hljs-number">23086</span> node.go:<span class="hljs-number">113</span>] Failed to retrieve node info: Get https://<span class="hljs-number">10.4.7.10:7443</span>/api/v<span class="hljs-number">1</span>/nodes/hdss<span class="hljs-number">7</span>-<span class="hljs-number">21</span>.host.com: EOF<br><br><span class="hljs-attribute">yum</span> install   ipset  -y，用supervisor重启服务，问题解决<br></code></pre></td></tr></table></figure>



            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/K8S/">K8S</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Linux/">Linux</a>
                    
                      <a class="hover-with-bg" href="/tags/k8S/">k8S</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/5c96f5b1/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Nginx-配置详解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/7012af2a/">
                        <span class="hidden-mobile">Linux-SAMBA服务(壹)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "Mwdu7VOQpQQD3cKW6SsRSt4f-gzGzoHsz",
          app_key: "XAg4RThXdR3JX0BNAF0axveE",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "mp",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        豫ICP备2021006301号
      </a>
    </span>
    
  </div>


  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
